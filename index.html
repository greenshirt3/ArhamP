<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #0078d4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--light); color: var(--dark); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        h1 { color: var(--primary); border-bottom: 2px solid var(--secondary); padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e1e5e9; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: #eee; border-radius: var(--border-radius) var(--border-radius) 0 0; transition: var(--transition); }
        .tab-button.active { background: var(--secondary); color: white; }
        .tab-content { padding: 20px 0; }
        .data-table, .form-group { margin-bottom: 20px; padding: 15px; border: 1px solid #e1e5e9; border-radius: var(--border-radius); }
        .data-table h2 { margin-top: 0; color: var(--dark); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
        th { background-color: var(--primary); color: white; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .data-control { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: var(--border-radius); }
        .data-control label { font-weight: bold; }
        .data-control input[type="file"] { flex-grow: 1; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .settings-grid .form-group { margin-bottom: 0; }
        /* Utility */
        .w-100 { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-screwdriver-wrench"></i> Arham Printers Admin Panel</h1>

        <div class="data-control">
            <label>Data Management:</label>
            <button class="btn btn-primary" onclick="exportAllData()"><i class="fas fa-download"></i> Export All Data (CSV)</button>
            <button class="btn btn-primary" onclick="exportItemsData()"><i class="fas fa-download"></i> Export Items Only (CSV)</button>
            <input type="file" id="csvFile" accept=".csv" style="flex-grow: 1;">
            <button class="btn btn-success" onclick="importData()"><i class="fas fa-upload"></i> Import Data (CSV)</button>
            <button class="btn btn-danger" onclick="resetToDefault()"><i class="fas fa-undo"></i> Reset to Default</button>
            <button class="btn btn-success" onclick="saveToGitHub()" style="background-color: var(--secondary);"><i class="fas fa-globe"></i> SYNC & PUBLISH</button>
        </div>

        <div class="tab-menu">
            <button class="tab-button active" onclick="openTab(event, 'itemsTab')">Items</button>
            <button class="tab-button" onclick="openTab(event, 'sizesTab')">Sizes</button>
            <button class="tab-button" onclick="openTab(event, 'colorsTab')">Colors</button>
            <button class="tab-button" onclick="openTab(event, 'settingsTab')">Settings</button>
        </div>

        <div id="itemsTab" class="tab-content">
            <div class="data-table">
                <h2><i class="fas fa-list"></i> Item Data Table</h2>
                <div id="itemsTableContainer"></div>
            </div>
        </div>

        <div id="sizesTab" class="tab-content" style="display:none">
            <div class="data-table">
                <h2><i class="fas fa-expand"></i> Size/Paper Costs</h2>
                <div id="sizesTableContainer"></div>
            </div>
        </div>

        <div id="colorsTab" class="tab-content" style="display:none">
            <div class="data-table">
                <h2><i class="fas fa-palette"></i> Color/Machine Costs</h2>
                <div id="colorsTableContainer"></div>
            </div>
        </div>

        <div id="settingsTab" class="tab-content" style="display:none">
            <div class="data-table">
                <h2><i class="fas fa-cog"></i> Global Settings</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="rent">Fixed Rent/Overhead (Rs.):</label>
                        <input type="number" id="rent" onchange="updateSettings()">
                    </div>
                    <div class="form-group">
                        <label for="profitMargin">Profit Margin (%):</label>
                        <input type="number" id="profitMargin" onchange="updateSettings()">
                    </div>
                    <div class="form-group">
                        <label for="defaultBinding">Default Binding Cost (Rs.):</label>
                        <input type="number" id="defaultBinding" onchange="updateSettings()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE DATA STRUCTURES ---
        let data = {
            categories: [],
            items: [],
            sizes: {},
            colors: {},
            settings: {
                rent: 200,
                profitMargin: 25,
                defaultBinding: 40
            },
            lastUpdated: new Date().toISOString()
        };

        const defaultData = JSON.parse(JSON.stringify(data)); // A clean copy of the initial state

        // --- 2. LOCAL STORAGE AND SYNCHRONIZATION ---

        function saveAllData() {
            try {
                data.lastUpdated = new Date().toISOString();
                localStorage.setItem('arhamPrintersData', JSON.stringify(data));
                console.log('Data saved locally.');
            } catch (e) {
                console.error('Failed to save data to localStorage:', e);
            }
        }

        function loadAllData() {
            try {
                const storedData = localStorage.getItem('arhamPrintersData');
                if (storedData) {
                    data = JSON.parse(storedData);
                    console.log('Data loaded from localStorage.');
                } else {
                    // Initialize with default if no local data exists
                    data = JSON.parse(JSON.stringify(defaultData));
                    console.log('No local data found, using default data.');
                }
            } catch (e) {
                console.error('Failed to load data from localStorage:', e);
                data = JSON.parse(JSON.stringify(defaultData));
            }
        }

        // --- 3. UI RENDERING AND MANAGEMENT ---

        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            refreshDataTables();
        }

        function refreshDataTables() {
            // Items Table
            document.getElementById('itemsTableContainer').innerHTML = createItemsTableHTML();
            // Sizes Table
            document.getElementById('sizesTableContainer').innerHTML = createSimpleTableHTML(data.sizes, 'sizes', 'Size Name', 'Paper Cost (Rs.)');
            // Colors Table
            document.getElementById('colorsTableContainer').innerHTML = createSimpleTableHTML(data.colors, 'colors', 'Color/Plate Name', 'Cost (Rs.)');
            // Settings Form
            document.getElementById('rent').value = data.settings.rent;
            document.getElementById('profitMargin').value = data.settings.profitMargin;
            document.getElementById('defaultBinding').value = data.settings.defaultBinding;
        }

        function createItemsTableHTML() {
            let html = `<table><thead><tr><th>Main Category</th><th>Subcategory</th><th>Item Name</th><th>Type</th><th>Price (Rs.)</th><th>Design</th><th>Paper</th><th>Binding</th><th>Color</th><th>Actions</th></tr></thead><tbody>`;
            data.items.forEach((item, index) => {
                html += `
                    <tr>
                        <td><input type="text" value="${item.mainCategory}" onchange="updateItem(${index}, 'mainCategory', this.value)"></td>
                        <td><input type="text" value="${item.subcategory}" onchange="updateItem(${index}, 'subcategory', this.value)"></td>
                        <td><input type="text" value="${item.itemName}" onchange="updateItem(${index}, 'itemName', this.value)"></td>
                        <td>
                            <select onchange="updateItem(${index}, 'type', this.value)">
                                <option value="fixed" ${item.type === 'fixed' ? 'selected' : ''}>Fixed</option>
                                <option value="offset" ${item.type === 'offset' ? 'selected' : ''}>Offset/Variable</option>
                            </select>
                        </td>
                        <td><input type="number" value="${item.price}" onchange="updateItem(${index}, 'price', parseFloat(this.value) || 0)"></td>
                        <td><input type="number" value="${item.designCharges}" onchange="updateItem(${index}, 'designCharges', parseFloat(this.value) || 0)"></td>
                        <td><input type="number" value="${item.paperCost}" onchange="updateItem(${index}, 'paperCost', parseFloat(this.value) || 0)"></td>
                        <td><input type="number" value="${item.bindingCost}" onchange="updateItem(${index}, 'bindingCost', parseFloat(this.value) || 0)"></td>
                        <td><input type="number" value="${item.colorCost}" onchange="updateItem(${index}, 'colorCost', parseFloat(this.value) || 0)"></td>
                        <td><button class="btn btn-danger" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
            html += `<tr><td colspan="10" style="text-align: center;"><button class="btn btn-success w-100" onclick="addNewItem()"><i class="fas fa-plus"></i> Add New Item</button></td></tr>`;
            html += `</tbody></table>`;
            return html;
        }

        function createSimpleTableHTML(dataObject, dataType, keyLabel, valueLabel) {
            let html = `<table><thead><tr><th>${keyLabel}</th><th>${valueLabel}</th><th>Actions</th></tr></thead><tbody>`;
            let keys = Object.keys(dataObject);

            keys.forEach(key => {
                html += `
                    <tr>
                        <td><input type="text" value="${key}" onchange="updateSimpleData('${dataType}', '${key}', 'key', this.value)"></td>
                        <td><input type="number" value="${dataObject[key]}" onchange="updateSimpleData('${dataType}', '${key}', 'value', parseFloat(this.value) || 0)"></td>
                        <td><button class="btn btn-danger" onclick="deleteSimpleData('${dataType}', '${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
            html += `<tr><td colspan="3" style="text-align: center;"><button class="btn btn-success w-100" onclick="addNewSimpleData('${dataType}')"><i class="fas fa-plus"></i> Add New ${keyLabel.split(' ')[0]}</button></td></tr>`;
            html += `</tbody></table>`;
            return html;
        }

        // --- 4. DATA MANIPULATION FUNCTIONS ---

        function updateItem(index, key, value) {
            data.items[index][key] = value;
            if (key === 'mainCategory' || key === 'subcategory') {
                updateCategories();
            }
            saveAllData();
            refreshDataTables(); 
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                data.items.splice(index, 1);
                updateCategories();
                saveAllData();
                refreshDataTables();
            }
        }

        function addNewItem() {
            data.items.push({ 
                mainCategory: 'New Category', subcategory: 'New Subcategory', itemName: 'New Item', 
                price: 0, type: 'fixed', designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 
            });
            updateCategories();
            saveAllData();
            refreshDataTables();
        }

        function updateSimpleData(dataType, oldKey, updateType, newValue) {
            if (updateType === 'key') {
                if (newValue !== oldKey) {
                    const value = data[dataType][oldKey];
                    delete data[dataType][oldKey];
                    data[dataType][newValue] = value;
                }
            } else if (updateType === 'value') {
                data[dataType][oldKey] = newValue;
            }
            saveAllData();
            refreshDataTables();
        }

        function deleteSimpleData(dataType, key) {
            if (confirm(`Are you sure you want to delete ${key} from ${dataType}?`)) {
                delete data[dataType][key];
                saveAllData();
                refreshDataTables();
            }
        }

        function addNewSimpleData(dataType) {
            const newKey = `New ${dataType.slice(0, -1)}`;
            data[dataType][newKey] = 0;
            saveAllData();
            refreshDataTables();
        }

        function updateSettings() {
            data.settings.rent = parseFloat(document.getElementById('rent').value) || 0;
            data.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            data.settings.defaultBinding = parseFloat(document.getElementById('defaultBinding').value) || 0;
            saveAllData();
        }

        function updateCategories() {
            const uniqueCategories = new Map();
            data.items.forEach(item => {
                const key = `${item.mainCategory}|${item.subcategory}`;
                if (item.mainCategory && item.subcategory && !uniqueCategories.has(key)) {
                    uniqueCategories.set(key, { mainCategory: item.mainCategory, subcategory: item.subcategory });
                }
            });
            data.categories = Array.from(uniqueCategories.values());
            data.categories.sort((a, b) => 
                (a.mainCategory + a.subcategory).localeCompare(b.mainCategory + b.subcategory)
            );
        }

        // --- 5. IMPORT/EXPORT FUNCTIONS (CSV & JSON) ---
        
        // This function is the key to synchronizing data for the customer calculator.
        function saveToGitHub() {
            // 1. Prepare the data for export
            data.lastUpdated = new Date().toISOString();
            const exportData = JSON.stringify(data, null, 2);
            const blob = new Blob([exportData], { type: 'application/json' });
            
            // 2. Create and download the customer-data.json file
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', 'customer-data.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('Data prepared for public sync! Upload the downloaded "customer-data.json" file to the root of your public GitHub repository for the calculator to sync.');
        }

        // CSV export functions (as provided in the previous turn, updated to use current data)
        function exportAllData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Export Items
                csvContent += 'ITEMS DATA\r\n';
                csvContent += 'mainCategory,subcategory,itemName,price,type,designCharges,paperCost,bindingCost,colorCost\r\n';
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                // Export Sizes
                csvContent += '\r\nSIZES DATA\r\n';
                csvContent += 'sizeName,paperCost\r\n';
                for (let sizeName in data.sizes) {
                    csvContent += `"${sizeName}",${data.sizes[sizeName]}\r\n`;
                }
                
                // Export Colors
                csvContent += '\r\nCOLORS DATA\r\n';
                csvContent += 'colorName,colorCost\r\n';
                for (let colorName in data.colors) {
                    csvContent += `"${colorName}",${data.colors[colorName]}\r\n`;
                }
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_all_data.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        function exportItemsData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'mainCategory,subcategory,itemName,price,type,designCharges,paperCost,bindingCost,colorCost\r\n';
                
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_items.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Items exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting items: ' + error.message);
            }
        }
        
        function importData() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    processCSVData(csvData);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }

        function processCSVData(csvData) {
            try {
                const lines = csvData.split('\n').filter(line => line.trim() !== '');
                let currentSection = '';
                let itemsImported = 0;
                let sizesImported = 0;
                let colorsImported = 0;
                
                const replaceData = confirm('Do you want to REPLACE all existing data with imported data? Click OK to replace, Cancel to merge with existing data.');
                
                if (replaceData) {
                    data.items = [];
                    data.sizes = {};
                    data.colors = {};
                    data.categories = [];
                }
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') continue;
                    
                    if (line === 'ITEMS DATA') {
                        currentSection = 'items';
                        continue;
                    } else if (line === 'SIZES DATA') {
                        currentSection = 'sizes';
                        continue;
                    } else if (line === 'COLORS DATA') {
                        currentSection = 'colors';
                        continue;
                    }
                    
                    if (line.includes('mainCategory,subcategory') || line.includes('sizeName,paperCost') || line.includes('colorName,colorCost')) {
                        continue;
                    }
                    
                    const values = line.split(',').map(value => {
                        return value.replace(/^"(.*)"$/, '$1').trim();
                    });
                    
                    if (currentSection === 'items' && values.length >= 3) {
                        const item = {
                            mainCategory: values[0] || '',
                            subcategory: values[1] || '',
                            itemName: values[2] || '',
                            price: parseFloat(values[3]) || 0,
                            type: values[4] || 'fixed',
                            designCharges: parseFloat(values[5]) || 0,
                            paperCost: parseFloat(values[6]) || 0,
                            bindingCost: parseFloat(values[7]) || 0,
                            colorCost: parseFloat(values[8]) || 0
                        };
                        
                        // Upsert logic
                        const existingItemIndex = data.items.findIndex(
                            existing => existing.mainCategory === item.mainCategory && 
                                        existing.subcategory === item.subcategory && 
                                        existing.itemName === item.itemName
                        );
                        
                        if (existingItemIndex !== -1) {
                            data.items[existingItemIndex] = item;
                        } else {
                            data.items.push(item);
                        }
                        
                        itemsImported++;
                        
                    } else if (currentSection === 'sizes' && values.length >= 2) {
                        const sizeName = values[0];
                        const paperCost = parseFloat(values[1]) || 0;
                        
                        if (sizeName) {
                            data.sizes[sizeName] = paperCost;
                            sizesImported++;
                        }
                        
                    } else if (currentSection === 'colors' && values.length >= 2) {
                        const colorName = values[0];
                        const colorCost = parseFloat(values[1]) || 0;
                        
                        if (colorName) {
                            data.colors[colorName] = colorCost;
                            colorsImported++;
                        }
                    }
                }
                
                updateCategories();
                saveAllData();
                refreshDataTables();
                
                alert(`Data imported successfully!\n\nItems: ${itemsImported}\nSizes: ${sizesImported}\nColors: ${colorsImported}\n\nTotal categories: ${data.categories.length}`);
                
                document.getElementById('csvFile').value = '';
                
            } catch (error) {
                console.error('Process CSV error:', error);
                alert('Error processing CSV file: ' + error.message);
            }
        }


        function resetToDefault() {
            if (confirm('Are you sure you want to reset all data to default? This cannot be undone.')) {
                data = JSON.parse(JSON.stringify(defaultData));
                updateCategories();
                saveAllData();
                refreshDataTables();
                alert('Data reset to default values!');
            }
        }

        // --- 6. INITIALIZATION ---

        window.onload = function() {
            loadAllData();
            updateCategories(); // Ensure categories are correct on load
            refreshDataTables();
            console.log('Arham Printers Admin Panel loaded successfully!');
            // Set initial tab
            document.querySelector('.tab-button').click();
        };
    </script>
</body>
</html>
