<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #0078d4;
            --secondary-light: #1088e4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #0078d4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #1088e4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #dff6dd;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fff4ce;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Updated Grid for 3 Panels */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 30px;
        }

        /* Adjustments for smaller screens */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr 1fr; /* Switch to 2 columns on medium screens */
            }
        }
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr; /* Switch to 1 column on small screens */
            }
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0e6b0e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e6a200; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c02a2e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Cloud Sync</p>
        </header>

        <div class="cloud-section">
            <h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="loginToOneDrive()" id="loginBtn">
                    <i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
                <button class="btn btn-success" onclick="window.syncAllToExcel()" id="syncBtn" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload All Data to Excel
                </button>
                <button class="btn btn-secondary" onclick="syncFromCloud()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Download Data (JSON)
                </button>
                <button class="btn btn-danger" onclick="logoutFromOneDrive()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is synced across all devices via OneDrive.</p>
            </div>
        </div>

        <div class="content-grid">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory" onchange="updateSubcategories()">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory" onchange="updateItemsAndFields()"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantity"><i class="fas fa-boxes"></i> Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
                
                <div class="form-group">
                    <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                    <div class="suggestion-container">
                        <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off">
                        <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                    <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number">
                </div>
                
                <div class="form-group">
                    <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                    <input type="text" id="invoiceNo" readonly>
                </div>
                
                <div class="form-group">
                    <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>

                <h3>Invoice Items</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Rate (Rs.)</th>
                            <th>Qty</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off">
                                </div>
                            </td>
                            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-amount" value="0" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="addInvoiceItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button class="btn btn-secondary" onclick="calculateTotal()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>

                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                    
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>Rs. <span id="subtotalAmount">0.00</span></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="taxRate">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="previousBalance">Previous Balance (Rs.):</label>
                        <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment">Payment Received (Rs.):</label>
                        <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Remaining Balance:</strong></span>
                        <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="saveInvoice()">
                        <i class="fas fa-save"></i> Save & Sync Invoice
                    </button>
                    <button class="btn btn-warning" onclick="clearInvoice()">
                        <i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
                </div>
            </div>
            
            <div class="section-panel expense-panel">
                <h2 class="section-title"><i class="fas fa-money-check-alt"></i> Expense Tracker</h2>
                
                <div class="form-group">
                    <label for="expenseDate"><i class="fas fa-calendar-alt"></i> Date:</label>
                    <input type="date" id="expenseDate">
                </div>
                
                <div class="form-group">
                    <label for="expenseCategory"><i class="fas fa-tags"></i> Category:</label>
                    <select id="expenseCategory">
                        <option value="">Select Category</option>
                        <option value="Business: Materials">Business: Materials/Supplies</option>
                        <option value="Business: Rent">Business: Rent/Utilities</option>
                        <option value="Business: Salaries">Business: Salaries</option>
                        <option value="Business: Other">Business: Other</option>
                        <option value="Personal: Groceries">Personal: Groceries</option>
                        <option value="Personal: Transport">Personal: Transport</option>
                        <option value="Personal: Bills">Personal: Bills/Utilities (Home)</option>
                        <option value="Personal: Other">Personal: Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expenseAmount"><i class="fas fa-rupee-sign"></i> Amount (Rs.):</label>
                    <input type="number" id="expenseAmount" value="0" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription"><i class="fas fa-comment"></i> Description:</label>
                    <textarea id="expenseDescription" placeholder="e.g., A4 paper ream purchase, electricity bill" list="expenseDescriptionList"></textarea>
                    <datalist id="expenseDescriptionList"></datalist>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="saveExpense()">
                        <i class="fas fa-save"></i> Save & Sync Expense
                    </button>
                    <button class="btn btn-danger" onclick="clearExpenseForm()">
                        <i class="fas fa-trash-alt"></i> Clear Form
                    </button>
                </div>
                
                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-chart-line"></i> Budget Snapshot</h3>
                    <div id="budgetDisplay">
                        <p>No budget set. Go to Admin > Settings.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="login-section">
            <h2 class="section-title"><i class="fas fa-lock"></i> Administrator Access</h2>
            <div class="login-form">
                <div>
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="btn btn-warning" onclick="toggleAdmin()">
                    <i class="fas fa-key"></i> Admin Login
                </button>
            </div>
        </div>
        
        <div class="admin-panel" id="adminPanel">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Data & Invoice Management</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="data-management">Data Management</div>
                <div class="tab" data-tab="invoice-list">Invoice List</div>
                <div class="tab" data-tab="expenses-list">Expense List</div>
                <div class="tab" data-tab="history">Calculation History</div>
                <div class="tab" data-tab="settings">Settings</div>
                <div class="tab" data-tab="import-export">Import/Export</div>
            </div>
            
            <div class="tab-content active" id="data-management-tab">
                <div class="data-form admin-section">
                    <h3>Add New Item</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newMainCategory">Main Category:</label>
                            <input type="text" id="newMainCategory" placeholder="Enter main category" list="newMainCategoryList">
                            <datalist id="newMainCategoryList"></datalist>
                        </div>
                        <div class="form-field">
                            <label for="newSubCategory">Subcategory:</label>
                            <input type="text" id="newSubCategory" placeholder="Enter subcategory" list="newSubCategoryList">
                            <datalist id="newSubCategoryList"></datalist>
                        </div>
                        <div class="form-field">
                            <label for="newItemName">Item Name:</label>
                            <input type="text" id="newItemName" placeholder="Enter item name" list="newItemNameList">
                            <datalist id="newItemNameList"></datalist>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="newItemPrice">Price (Rs.):</label><input type="number" id="newItemPrice" min="0" value="0"></div>
                        <div class="form-field"><label for="newDesignCharges">Design Charges (Rs.):</label><input type="number" id="newDesignCharges" min="0" value="0"></div>
                    </div>
                    <button class="btn btn-success" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Items</h3>
                    <table class="data-table" id="itemsTable"></table>
                </div>
            </div>
            
            <div class="tab-content" id="invoice-list-tab">
                <h3>Saved Invoices</h3>
                <div id="invoiceList">
                    <p>Load the Invoice List to manage customer records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="loadInvoiceList()">
                        <i class="fas fa-list"></i> Load Invoices
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="expenses-list-tab">
                <h3>Expense Records</h3>
                <div id="expenseList">
                    <p>Load the Expense List to view purchase records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="loadExpenseList()">
                        <i class="fas fa-list"></i> Load Expenses
                    </button>
                    <button class="btn btn-danger" onclick="clearAllExpenses()">
                        <i class="fas fa-trash"></i> Clear All Expenses
                    </button>
                </div>
            </div>

            <div class="tab-content" id="history-tab">
                <h3>Calculation History</h3>
                <div class="actions">
                    <button class="btn btn-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                <div id="historyList"></div>
            </div>
            
            <div class="tab-content" id="settings-tab">
                <h3>Application Settings</h3>
                <div class="admin-section">
                    <h4>Price Settings</h4>
                    <div class="form-group">
                        <label>Rent Cost (Rs.)</label>
                        <input type="number" id="rentCost" value="200">
                    </div>
                    <div class="form-group">
                        <label>Profit Margin (%)</label>
                        <input type="number" id="profitMargin" value="25">
                    </div>
                </div>
                
                <div class="admin-section">
                    <h4>Monthly Budget (Rs.)</h4>
                    <div class="form-group">
                        <label>Business Budget:</label>
                        <input type="number" id="budgetBusiness" min="0" value="50000">
                    </div>
                    <div class="form-group">
                        <label>Personal Budget:</label>
                        <input type="number" id="budgetPersonal" min="0" value="30000">
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="import-export-tab">
                <h3>Import/Export Data</h3>
                
                <div class="import-export-section">
                    <h4>Export Data</h4>
                    <div class="actions">
                        <button class="btn btn-warning" onclick="exportAllData()">
                            <i class="fas fa-file-export"></i> Export All Data (CSV)
                        </button>
                        <button class="btn btn-success" onclick="exportCustomerDataForGitHub()">
                            <i class="fas fa-cloud-upload"></i> Export Price Data (JSON)
                        </button>
                    </div>
                    <p><small>Export JSON for external/customer calculator sync. Export CSV for backup.</small></p>
                </div>
                
                <div class="import-export-section">
                    <h4>Reset Data</h4>
                    <p>Reset all data to default values. This cannot be undone.</p>
                    <div class="actions">
                        <button class="btn btn-danger" onclick="resetToDefault()">
                            <i class="fas fa-undo"></i> Reset to Default Data
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Save & Cloud Sync All
                </button>
                <button class="btn btn-secondary" onclick="toggleAdmin()">
                    <i class="fas fa-times"></i> Close Admin Panel
                </button>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto hide after duration
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, duration);
        }

        // =============================================
        // ONEDRIVE EXCEL SYNC CLASS
        // =============================================
        class OneDriveExcelSync {
            constructor() {
                this.excelFileId = null;
                this.excelFileName = 'Arham_Printers_Database.xlsx';
                this.excelFilePath = `/ArhamPrinters/${this.excelFileName}`;
                this.sheets = {
                    ITEMS: 'Calculator_Items',
                    INVOICES: 'Invoices',
                    CUSTOMERS: 'Customers',
                    SETTINGS: 'Settings',
                    HISTORY: 'Calculation_History',
                    EXPENSES: 'Expenses' 
                };
            }

            async ensureExcelFile() {
                const MAX_RETRIES = 3;
                const INITIAL_DELAY = 5000;
                let fileInfo = null;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        fileInfo = await this.getExcelFileInfo();
                        if (fileInfo) {
                            this.excelFileId = fileInfo.id;
                            await this.initializeSheets();
                            return true;
                        }

                        if (i === 0) {
                            console.log('Excel file not found. Attempting creation...');
                            const createSuccess = await this.createExcelFile();
                            if (createSuccess) {
                                fileInfo = await this.getExcelFileInfo();
                                this.excelFileId = fileInfo.id;
                            }
                        }

                        if (!this.excelFileId) {
                            throw new Error('File ID still not available after creation attempt.');
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, INITIAL_DELAY * (i + 1)));
                        await this.initializeSheets();
                        
                        return true;

                    } catch (error) {
                        console.warn(`Attempt ${i + 1} failed to ensure Excel file.`, error.message);
                        if (i === MAX_RETRIES - 1) {
                            console.error('Max retries reached. Failed to ensure Excel file.', error);
                            return false;
                        }
                    }
                }
                return false;
            }

            async getExcelFileInfo() {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return null;

                try {
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:${this.excelFilePath}`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    return response.ok ? await response.json() : null;
                } catch (error) {
                    return null;
                }
            }

            async createExcelFile() {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return false;

                try {
                    await this.ensureOneDriveFolder('/ArhamPrinters');
                    const emptyXLSXBlob = new Uint8Array([0x50, 0x4b, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]).buffer;

                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/${this.excelFileName}:/content`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                            },
                            body: emptyXLSXBlob
                        }
                    );
                    if (response.ok || response.status === 201) {
                        this.excelFileId = (await response.json()).id;
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error creating Excel file:', error);
                    return false;
                }
            }

            async ensureOneDriveFolder(folderPath) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return;

                try {
                    const checkResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:${folderPath}`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    if (checkResponse.ok) return;

                    await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: folderPath.substring(folderPath.lastIndexOf('/') + 1),
                            folder: {},
                            '@microsoft.graph.conflictBehavior': 'ignore'
                        })
                    });
                } catch (error) {
                    console.error(`Error ensuring folder ${folderPath}:`, error);
                }
            }

            async initializeSheets() {
                if (!this.excelFileId) return;
                
                const sheetPromises = [
                    this.updateSheetHeaders(this.sheets.ITEMS, ['Main Category', 'Subcategory', 'Item Name', 'Price', 'Type', 'Design Charges', 'Last Updated']),
                    this.updateSheetHeaders(this.sheets.INVOICES, ['Invoice Number', 'Date', 'Due Date', 'Customer Name', 'Customer Phone', 'Customer Address', 'Items Count', 'Subtotal', 'Tax', 'Total Amount', 'Previous Balance', 'Payment Received', 'Remaining Balance', 'Status', 'Created Date']),
                    this.updateSheetHeaders(this.sheets.CUSTOMERS, ['Customer Name', 'Phone', 'Address', 'Total Invoices', 'Current Balance', 'Last Invoice Date', 'Created Date']),
                    this.updateSheetHeaders(this.sheets.SETTINGS, ['Setting Name', 'Value', 'Last Updated']),
                    this.updateSheetHeaders(this.sheets.HISTORY, ['Date', 'Main Category', 'Subcategory', 'Item Name', 'Quantity', 'Design Charges', 'Total Price', 'Calculated By']),
                    this.updateSheetHeaders(this.sheets.EXPENSES, ['Date', 'Type', 'Category', 'Amount', 'Description', 'Month/Year', 'Recorded By'])
                ];
                await Promise.allSettled(sheetPromises);
            }

            async syncAllDataToExcel(calculatorData, invoices, customers, history, expenses) {
                if (!await this.ensureExcelFile()) { 
                    showNotification('Failed to connect to OneDrive Excel', 'error');
                    return false; 
                }

                try {
                    const itemSync = this.syncCalculatorItems(calculatorData.items);
                    const invoiceSync = this.syncInvoices(invoices);
                    const customerSync = this.syncCustomers(customers);
                    const settingSync = this.syncSettings(calculatorData.settings);
                    const historySync = this.syncHistory(history);
                    const expenseSync = this.syncExpenses(expenses);

                    await Promise.all([itemSync, invoiceSync, customerSync, settingSync, historySync, expenseSync]);
                    showNotification('All data successfully synced to OneDrive Excel!', 'success');
                    return true;
                } catch (error) {
                    console.error('Error syncing all data to Excel:', error);
                    showNotification('Failed to sync data to OneDrive Excel', 'error');
                    return false;
                }
            }

            async syncCalculatorItems(items) {
                const rows = items.map(item => [
                    item.mainCategory || '', 
                    item.subcategory || '', 
                    item.itemName || '', 
                    item.price || 0, 
                    item.type || 'fixed', 
                    item.designCharges || 0, 
                    new Date().toISOString()
                ]);
                await this.updateSheetData(this.sheets.ITEMS, rows);
            }

            async syncInvoices(invoices) {
                const rows = invoices.map(invoice => [invoice.invoiceNo || '', invoice.date || '', invoice.dueDate || '', invoice.customerName || 'N/A', invoice.customerPhone || '', invoice.customerAddress || '', invoice.items?.length || 0, invoice.subtotal || 0, invoice.taxAmount || 0, invoice.total || 0, invoice.previousBalance || 0, invoice.payment || 0, invoice.remainingBalance || 0, invoice.status || 'pending', invoice.created || new Date().toISOString()]);
                await this.updateSheetData(this.sheets.INVOICES, rows);
            }

            async syncCustomers(customers) {
                const rows = customers.map(customer => [customer.name || '', customer.phone || '', customer.address || '', customer.invoicesCount || 0, customer.balance || 0, customer.lastInvoiceDate || '', customer.created || new Date().toISOString()]);
                await this.updateSheetData(this.sheets.CUSTOMERS, rows);
            }

            async syncSettings(settings) {
                const rows = Object.entries(settings).map(([key, value]) => [key, value, new Date().toISOString()]);
                await this.updateSheetData(this.sheets.SETTINGS, rows);
            }

            async syncHistory(history) {
                const rows = history.map(record => [record.timestamp || new Date().toLocaleString(), record.mainCategory || '', record.subcategory || '', record.itemName || '', record.quantity || 1, record.designCharges || 0, record.total || 0, currentUser?.name || 'Admin']);
                await this.updateSheetData(this.sheets.HISTORY, rows);
            }
            
            // NEW METHOD: Sync Expenses
            async syncExpenses(expenses) {
                const rows = expenses.map(e => {
                    const [type, category] = e.category.split(': ');
                    const date = new Date(e.date);
                    const monthYear = `${date.toLocaleString('en-US', { month: 'short' })}-${date.getFullYear()}`;
                    return [
                        e.date || '',
                        type || '',
                        category || e.category,
                        e.amount || 0,
                        e.description || '',
                        monthYear,
                        currentUser?.name || 'Admin'
                    ];
                });
                await this.updateSheetData(this.sheets.EXPENSES, rows);
            }

            async uploadPublicJson(publicData) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return false;

                try {
                    await this.ensureOneDriveFolder('/ArhamPrinters');

                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/customer-data.json:/content`,
                        {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(publicData, null, 2)
                        }
                    );
                    return response.ok;
                } catch (error) {
                    console.error("Public JSON upload failed:", error);
                    return false;
                }
            }

            async updateSheetHeaders(sheetName, headers) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;

                const headerRange = `A1:${String.fromCharCode(64 + headers.length)}1`;
                const endpoint = `https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='${headerRange}')`;

                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [headers] })
                });

                if (!response.ok) {
                    await this.addWorksheet(sheetName);
                    await fetch(endpoint, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: [headers] })
                    });
                }
            }
            
            async addWorksheet(sheetName) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;

                await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: sheetName })
                });
            }

            async updateSheetData(sheetName, rows) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;

                await this.clearSheetData(sheetName);

                if (rows.length > 0) {
                    const startCell = 'A2';
                    const endCell = `${String.fromCharCode(64 + rows[0].length)}${rows.length + 1}`;
                    const dataRange = `${startCell}:${endCell}`;
                    const endpoint = `https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='${dataRange}')`;

                    await fetch(endpoint, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: rows })
                    });
                }
            }

            async clearSheetData(sheetName) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;

                await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='A2:Z5000')/clear`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ applyTo: 'contents' })
                });
            }
        }

        // =============================================
        // AZURE CONFIGURATION & GLOBAL DATA/FUNCTIONS
        // =============================================
        // ðŸš¨ CRITICAL: REPLACE THE PLACEHOLDER BELOW WITH YOUR LIVE DOMAIN URL 
        const LIVE_DOMAIN_URL = "https://arhamprinter.netlify.app/index.html";
        
        const AZURE_CLIENT_ID = "26b3dde9-366f-487b-a485-79d1bf1ab857";
        const msalConfig = {
            auth: {
                clientId: AZURE_CLIENT_ID,
                authority: "https://login.microsoftonline.com/common",
                redirectUri: LIVE_DOMAIN_URL,
                knownAuthorities: ["https://login.microsoftonline.com/common/"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const excelSync = new OneDriveExcelSync();
        const ADMIN_PASSWORD = "admin123";

        // Local Storage Keys
        const LOCAL_CALC_DATA_KEY = 'arhamPrintersData';
        const LOCAL_HISTORY_KEY = 'arhamPrintersHistory';
        const LOCAL_CUSTOMER_KEY = 'arhamPrintersCustomers';
        const LOCAL_INVOICE_KEY = 'arhamPrintersInvoices';
        const LOCAL_NEXT_INV_KEY = 'arhamNextInvoiceNumber';
        const LOCAL_EXPENSES_KEY = 'arhamPrintersExpenses'; 
        const LOCAL_BUDGET_KEY = 'arhamPrintersBudget'; 
        const LOCAL_EXCEL_TRIGGER_KEY = 'arhamPrintersExcelSyncTrigger';
        // New Keys for Datalists
        const LOCAL_DATALISTS_KEY = 'arhamPrintersDatalists';

        let isOnline = false;
        let currentUser = null;

        // Shared Data Structures
        let data = {};
        let calculationHistory = [];
        let customers = [];
        let invoices = [];
        let expenses = []; 
        let budget = {}; 
        let nextInvoiceNumber = 1001;
        let currentCustomer = null;
        let datalists = {}; // New object for previous input entries

        const defaultData = {
            categories: [
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards" },
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads" },
                { mainCategory: "Panaflex", subcategory: "China" },
                { mainCategory: "Social Media Posts", subcategory: "Design Only" }
            ],
            items: [
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Double Side", price: 2500, type: "fixed", designCharges: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x4 Panaflex", price: 280, type: "fixed", designCharges: 0 },
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Instagram Post", price: 400, type: "fixed", designCharges: 0 }
            ],
            settings: {
                rent: 200,
                profitMargin: 25
            },
            budget: { 
                business: 50000,
                personal: 30000
            }
        };
        
        const defaultDatalists = {
            newMainCategoryList: ["Offset Paper Printing", "Digital Printing", "Sign Boards", "Social Media"],
            newSubCategoryList: ["Visiting Cards", "Letterheads", "Flyers", "China", "Korean", "Design Only"],
            newItemNameList: ["Mat Double Side", "Gloss Single Side", "A4 Size", "3x6 Panaflex", "Facebook Ad", "Business Card Design"],
            expenseDescriptionList: ["A4 paper ream purchase", "Electricity bill (shop)", "Staff salary - Jan", "Diesel for generator"]
        };


        // --- Auth Token Functions ---
        async function getOneDriveAccessToken() {
            const request = { scopes: ["Files.ReadWrite.All"], account: currentUser };
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (popupError) {
                    console.error("Popup token acquisition failed:", popupError);
                    return null;
                }
            }
        }

        // --- Authentication Functions ---
        async function loginToOneDrive() {
            try {
                const loginRequest = { scopes: ["Files.ReadWrite.All"] };
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                currentUser = loginResponse.account;
                isOnline = true;
                updateUIAfterLogin();
            } catch (error) {
                console.error("Login failed:", error);
                showNotification("Login failed. Please try again.", "error");
            }
        }

        function logoutFromOneDrive() {
            if (currentUser) {
                msalInstance.logoutPopup();
                currentUser = null;
                isOnline = false;
                updateUIAfterLogout();
                showNotification("Signed out successfully", "info");
            }
        }

        // --- Core Sync Functions ---
        async function syncToCloud() {
            if (!isOnline || !currentUser) { 
                showNotification("Please sign in to sync with OneDrive", "warning");
                return false; 
            }
            const accessToken = await getOneDriveAccessToken();
            if (!accessToken) { 
                showNotification("Could not get access token", "error");
                return false; 
            }

            try {
                const allData = {
                    calculatorData: data,
                    history: calculationHistory,
                    invoices: invoices,
                    customers: customers,
                    expenses: expenses, 
                    budget: budget, 
                    datalists: datalists, // Include datalists in cloud sync
                    lastSync: new Date().toISOString()
                };

                await excelSync.ensureOneDriveFolder('/ArhamPrinters'); 

                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(allData)
                    }
                );
                if (response.ok) { 
                    showNotification('Data successfully synced to OneDrive JSON!', 'success');
                    return true; 
                } 
                else { throw new Error('Failed to upload JSON to OneDrive'); }
            } catch (error) {
                console.error("JSON Sync failed:", error);
                showNotification('Failed to sync JSON data to OneDrive: ' + error.message, 'error');
                return false;
            }
        }

        async function syncFromCloud() {
            if (!isOnline || !currentUser) { 
                showNotification("Please sign in to sync with OneDrive", "warning");
                return; 
            }
            const accessToken = await getOneDriveAccessToken();
            if (!accessToken) { 
                showNotification("Could not get access token", "error");
                return; 
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );

                if (response.ok) {
                    const cloudData = await response.json();
                    
                    if (confirm('Do you want to replace your local data with cloud data? This will overwrite local Invoices, Expenses, and Settings.')) {
                        data = cloudData.calculatorData || data;
                        calculationHistory = cloudData.history || calculationHistory;
                        invoices = cloudData.invoices || invoices; 
                        customers = cloudData.customers || customers; 
                        expenses = cloudData.expenses || expenses; 
                        budget = cloudData.budget || budget; 
                        datalists = cloudData.datalists || datalists; // Load datalists

                        // Save all data back to local storage
                        localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data));
                        localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory));
                        localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices));
                        localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers));
                        localStorage.setItem(LOCAL_EXPENSES_KEY, JSON.stringify(expenses));
                        localStorage.setItem(LOCAL_BUDGET_KEY, JSON.stringify(budget));
                        localStorage.setItem(LOCAL_DATALISTS_KEY, JSON.stringify(datalists)); // Save datalists

                        refreshAllDisplays();
                        refreshDataTables();
                        loadBudgetSnapshot(); 
                        showNotification('All data successfully synced from OneDrive (JSON)!', 'success');
                    }
                } else {
                    throw new Error('Failed to download JSON from OneDrive');
                }
            } catch (error) {
                console.error("JSON Sync failed:", error);
                showNotification('Failed to sync data from OneDrive: ' + error.message, 'error');
            }
        }

        window.syncAllToExcel = async function(isAutomatic = false) {
             if (!isOnline || !currentUser) {
                 if (!isAutomatic) showNotification("Please sign in to OneDrive to sync data.", "warning");
                 return false;
             }
             
             document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing to Excel...';
             
             loadAllInvoiceData();
             
             // Pass expenses array to the sync function
             const success = await excelSync.syncAllDataToExcel(data, invoices, customers, calculationHistory, expenses); 
             
             if (success) {
                 document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Connected to OneDrive (Excel Synced)';
             } else {
                 document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Excel Sync Failed';
             }
             
             return success;
        }

        // --- Authentication/UI Functions ---
        async function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'inline-flex';
            document.getElementById('downloadBtn').style.display = 'inline-flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('syncStatus').className = 'sync-status sync-online';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Initializing Cloud and Excel...';
            
            await excelSync.ensureExcelFile(); 
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Connected to OneDrive';

            saveAllData(); 
        }

        function updateUIAfterLogout() {
            document.getElementById('loginBtn').style.display = 'inline-flex';
            document.getElementById('syncBtn').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncStatus').className = 'sync-status sync-offline';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Offline Mode - Data stored locally';
        }

        // --- Main Data Management ---
        function loadAllData() {
            try {
                const savedCalc = localStorage.getItem(LOCAL_CALC_DATA_KEY);
                const savedHistory = localStorage.getItem(LOCAL_HISTORY_KEY);
                const savedExpenses = localStorage.getItem(LOCAL_EXPENSES_KEY); 
                const savedBudget = localStorage.getItem(LOCAL_BUDGET_KEY); 
                const savedDatalists = localStorage.getItem(LOCAL_DATALISTS_KEY);
                
                data = savedCalc ? JSON.parse(savedCalc) : JSON.parse(JSON.stringify(defaultData));
                calculationHistory = savedHistory ? JSON.parse(savedHistory) : [];
                expenses = savedExpenses ? JSON.parse(savedExpenses) : []; 
                budget = savedBudget ? JSON.parse(savedBudget) : defaultData.budget; 
                datalists = savedDatalists ? JSON.parse(savedDatalists) : defaultDatalists;

                loadAllInvoiceData();
                loadNextInvoiceNumber();
                loadBudgetSnapshot(); 
                populateDatalists();

            } catch (e) {
                console.error("Error loading local data:", e);
                data = JSON.parse(JSON.stringify(defaultData));
                calculationHistory = [];
                expenses = [];
                budget = defaultData.budget;
                datalists = defaultDatalists;
            }
        }

        function loadAllInvoiceData() {
            customers = JSON.parse(localStorage.getItem(LOCAL_CUSTOMER_KEY) || '[]');
            invoices = JSON.parse(localStorage.getItem(LOCAL_INVOICE_KEY) || '[]');
        }

        function saveAllData() {
            // New logic to update datalists from current data
            updateDatalistValues();
            
            localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data));
            localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory));
            localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers));
            localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices));
            localStorage.setItem(LOCAL_EXPENSES_KEY, JSON.stringify(expenses)); 
            localStorage.setItem(LOCAL_BUDGET_KEY, JSON.stringify(budget)); 
            localStorage.setItem(LOCAL_DATALISTS_KEY, JSON.stringify(datalists));

            if (isOnline && currentUser) {
                setTimeout(async () => {
                    await syncToCloud();
                    await window.syncAllToExcel(true);
                }, 1000);
            }
        }
        
        // --- DATALIST MANAGEMENT FUNCTIONS ---
        function populateDatalists() {
            for (const listId in datalists) {
                const datalist = document.getElementById(listId);
                if (datalist) {
                    datalist.innerHTML = '';
                    datalists[listId].forEach(value => {
                        datalist.innerHTML += `<option value="${value}">`;
                    });
                }
            }
        }

        function updateDatalist(listName, newValue) {
            if (newValue && newValue.trim() !== '') {
                const normalizedValue = newValue.trim();
                let list = datalists[listName] || [];
                if (!list.includes(normalizedValue)) {
                    list.unshift(normalizedValue);
                    if (list.length > 20) { // Keep list size manageable
                        list = list.slice(0, 20);
                    }
                    datalists[listName] = list;
                    populateDatalists(); // Re-render the datalists
                }
            }
        }
        
        function updateDatalistValues() {
            // Update datalists from form fields (Admin Panel data)
            const newMainCategory = document.getElementById('newMainCategory').value.trim();
            const newSubCategory = document.getElementById('newSubCategory').value.trim();
            const newItemName = document.getElementById('newItemName').value.trim();
            const expenseDescription = document.getElementById('expenseDescription').value.trim();
            
            updateDatalist('newMainCategoryList', newMainCategory);
            updateDatalist('newSubCategoryList', newSubCategory);
            updateDatalist('newItemNameList', newItemName);
            updateDatalist('expenseDescriptionList', expenseDescription);
        }

        // --- ADMIN LOGIN ---
        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            const input = document.getElementById('adminPassword').value;
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else if (input === ADMIN_PASSWORD) {
                panel.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                loadAllInvoiceData();
                refreshDataTables();
                updateHistoryDisplay();
                loadSettings();
                loadBudgetSnapshot();
                populateDatalists(); // Ensure datalists are populated when admin panel opens
                showNotification('Admin panel unlocked', 'success');
            } else {
                showNotification('Incorrect admin password', 'error');
            }
        }
        
        // =============================================
        // CALCULATOR LOGIC (unchanged)
        // =============================================
        function refreshAllDisplays() {
            updateMainCategories();
            updateSubcategories();
            updateItemsAndFields();
            setupCustomerAutocomplete();
            setupItemAutocomplete();
        }

        function updateMainCategories() {
            const mainSelect = document.getElementById('mainCategory');
            mainSelect.innerHTML = '<option value="">Select Main Category</option>';
            const mainCategories = [...new Set(data.categories.map(cat => cat.mainCategory))];
            mainCategories.forEach(cat => mainSelect.add(new Option(cat, cat)));
        }

        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subSelect = document.getElementById('subCategory');
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            if (!mainCategory) return;
            const subcategories = [...new Set(data.categories.filter(cat => cat.mainCategory === mainCategory).map(cat => cat.subcategory))];
            subcategories.forEach(sub => subSelect.add(new Option(sub, sub)));
            updateItemsAndFields();
        }

        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subcategory) {
                const items = data.items.filter(item => item.mainCategory === mainCategory && item.subcategory === subcategory);
                items.forEach(item => itemSelect.add(new Option(item.itemName, item.itemName)));
            }
        }

        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!mainCategory || !subcategory || !itemName) { 
                showNotification("Please select all required fields", "warning");
                return; 
            }
            
            const item = data.items.find(i => i.mainCategory === mainCategory && i.subcategory === subcategory && i.itemName === itemName);
            if (!item) { 
                document.getElementById('result').textContent = "Item not found"; 
                document.getElementById('result').style.display = 'block'; 
                return; 
            }
            
            let basePrice = item.price;
            let breakdown = [];
            
            breakdown.push(`Item Price: Rs. ${basePrice}`);
            
            if (item.designCharges > 0) {
                breakdown.push(`Design Charges: Rs. ${item.designCharges}`);
                basePrice += item.designCharges;
            }
            
            const subtotal = basePrice * quantity;
            const profit = subtotal * (data.settings.profitMargin / 100);
            const total = subtotal + profit;
            
            breakdown.push(`Quantity: ${quantity}`);
            breakdown.push(`Subtotal: Rs. ${Math.round(subtotal)}`);
            breakdown.push(`Profit (${data.settings.profitMargin}%): Rs. ${Math.round(profit)}`);
            breakdown.push(`Total: Rs. ${Math.round(total)}`);
            
            document.getElementById('result').textContent = `Total Price: Rs. ${Math.round(total)}`;
            document.getElementById('result').style.display = 'block';
            
            document.getElementById('breakdownContent').innerHTML = breakdown.map(item => `<div class="breakdown-item">${item}</div>`).join('');
            document.getElementById('priceBreakdown').style.display = 'block';
            
            addToHistory({ mainCategory, subcategory, itemName, quantity, designCharges: item.designCharges || 0, total: Math.round(total), timestamp: new Date().toLocaleString() });
        }

        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantity').value = '1';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            showNotification('Calculator form cleared', 'info');
        }

        // --- History Management ---
        function addToHistory(calculation) {
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 50) calculationHistory = calculationHistory.slice(0, 50);
            saveAllData();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (calculationHistory.length === 0) { historyList.innerHTML = '<p>No calculations yet</p>'; return; }
            
            historyList.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div class="history-header"><span>${calc.itemName}</span><span>Rs. ${calc.total}</span></div>
                    <div class="history-details">${calc.mainCategory} > ${calc.subcategory} | Qty: ${calc.quantity} | Design: Rs. ${calc.designCharges} | ${calc.timestamp}</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all calculation history?')) {
                calculationHistory = [];
                saveAllData();
                updateHistoryDisplay();
                showNotification('Calculation history cleared', 'success');
            }
        }
        
        // =============================================
        // EXPENSE TRACKER LOGIC (NEW)
        // =============================================

        // Sets the default date on load
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];

        function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value.trim();

            if (!date || !category || amount <= 0 || !description) {
                showNotification('Please fill all fields with valid data.', 'warning');
                return;
            }

            const expenseType = category.split(':')[0].trim(); // Business or Personal

            const newExpense = {
                id: Date.now().toString(),
                date: date,
                category: category,
                amount: amount,
                description: description,
                type: expenseType
            };

            expenses.unshift(newExpense);
            updateDatalist('expenseDescriptionList', description); // Save description to datalist
            saveAllData();
            clearExpenseForm();
            loadBudgetSnapshot();
            showNotification(`${expenseType} expense of Rs. ${amount.toFixed(2)} saved and synced!`, 'success');
        }

        function clearExpenseForm() {
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseAmount').value = '0';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        function loadExpenseList() {
            const listContainer = document.getElementById('expenseList');
            if (expenses.length === 0) { listContainer.innerHTML = '<p>No expenses saved yet.</p>'; return; }

            const tableHtml = `
                <table class="data-table">
                    <thead><tr><th>Date</th><th>Category</th><th>Amount (Rs.)</th><th>Description</th><th>Action</th></tr></thead>
                    <tbody>
                        ${expenses.map(e => `
                            <tr>
                                <td>${e.date}</td>
                                <td><span style="color:${e.type === 'Business' ? 'purple' : 'teal'};">${e.category}</span></td>
                                <td>${e.amount.toFixed(2)}</td>
                                <td>${e.description}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deleteExpense('${e.id}')"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            listContainer.innerHTML = tableHtml;
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense record?')) {
                expenses = expenses.filter(e => e.id !== id);
                saveAllData();
                loadExpenseList();
                loadBudgetSnapshot();
                showNotification('Expense deleted.', 'success');
            }
        }

        function clearAllExpenses() {
            if (confirm('WARNING: Are you sure you want to delete ALL expense records? This is permanent.')) {
                expenses = [];
                saveAllData();
                loadExpenseList();
                loadBudgetSnapshot();
                showNotification('All expense records cleared.', 'success');
            }
        }

        function loadBudgetSnapshot() {
            const display = document.getElementById('budgetDisplay');
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyExpenses = expenses.filter(e => {
                const date = new Date(e.date);
                // Check if the expense is from the current month/year
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const totals = monthlyExpenses.reduce((acc, expense) => {
                const type = expense.type.toLowerCase();
                acc[type] = (acc[type] || 0) + expense.amount;
                return acc;
            }, { business: 0, personal: 0 });

            const remainingBusiness = budget.business - totals.business;
            const remainingPersonal = budget.personal - totals.personal;
            
            display.innerHTML = `
                <p><strong>Month:</strong> ${new Date().toLocaleString('en-US', { month: 'long', year: 'numeric' })}</p>
                
                <div class="breakdown-item">
                    <span><i class="fas fa-briefcase"></i> Business Budget:</span>
                    <span>Rs. ${budget.business.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Business Spent:</span>
                    <span>Rs. ${totals.business.toFixed(2)}</span>
                </div>
                <div class="total-row" style="color: ${remainingBusiness < 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                    <span>Remaining (Business):</span>
                    <span>Rs. ${remainingBusiness.toFixed(2)}</span>
                </div>
                
                <hr style="margin: 15px 0; border-top: 1px dashed #ddd;">

                <div class="breakdown-item">
                    <span><i class="fas fa-home"></i> Personal Budget:</span>
                    <span>Rs. ${budget.personal.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Personal Spent:</span>
                    <span>Rs. ${totals.personal.toFixed(2)}</span>
                </div>
                <div class="total-row" style="color: ${remainingPersonal < 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">
                    <span>Remaining (Personal):</span>
                    <span>Rs. ${remainingPersonal.toFixed(2)}</span>
                </div>
            `;
        }

        // =============================================
        // INVOICE LOGIC
        // =============================================
        // --- Item Auto-complete ---
        function setupItemAutocomplete() {
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const input = row.querySelector('.item-name');
                const td = row.querySelector('td:first-child');
                
                let suggestionsContainer = td.querySelector('.item-suggestions');
                if (!suggestionsContainer) {
                    suggestionsContainer = document.createElement('div');
                    suggestionsContainer.className = 'customer-suggestions item-suggestions';
                    td.appendChild(suggestionsContainer);
                }

                input.oninput = function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    suggestionsContainer.innerHTML = '';
                    
                    if (searchTerm.length < 2) { suggestionsContainer.style.display = 'none'; return; }
                    
                    const matches = data.items.filter(item => item.itemName.toLowerCase().includes(searchTerm)).slice(0, 10);
                    
                    if (matches.length > 0) {
                        matches.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'customer-suggestion';
                            const suggestedPrice = item.price; 
                            div.textContent = `${item.itemName} (Rs. ${suggestedPrice.toFixed(2)})`;
                            div.onclick = function() {
                                selectInvoiceItem(row, item, suggestedPrice);
                                suggestionsContainer.style.display = 'none';
                            };
                            suggestionsContainer.appendChild(div);
                        });
                        suggestionsContainer.style.display = 'block';
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                };
            });
        }
        
        function selectInvoiceItem(row, item, price) {
            row.querySelector('.item-name').value = item.itemName;
            row.querySelector('.item-rate').value = price.toFixed(2);
            calculateTotal(); 
        }

        // --- Customer Auto-complete ---
        function setupCustomerAutocomplete() {
            const customerInput = document.getElementById('invoiceCustomerName');
            const suggestionsContainer = document.getElementById('customerSuggestions');
            
            customerInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                suggestionsContainer.innerHTML = '';
                
                if (searchTerm.length < 2) { suggestionsContainer.style.display = 'none'; return; }
                
                const matches = customers.filter(customer => customer.name.toLowerCase().includes(searchTerm));
                
                if (matches.length > 0) {
                    matches.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'customer-suggestion';
                        div.textContent = customer.name;
                        div.onclick = function() { selectCustomerForInvoice(customer); suggestionsContainer.style.display = 'none'; };
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else { suggestionsContainer.style.display = 'none'; }
            });
        }

        function selectCustomerForInvoice(customer) {
            document.getElementById('invoiceCustomerName').value = customer.name;
            document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
            document.getElementById('previousBalance').value = customer.balance || 0;
            currentCustomer = customer;
            calculateTotal();
            showNotification(`Customer ${customer.name} loaded`, 'success');
        }

        // --- Invoice Item/Calculation Management ---
        function loadNextInvoiceNumber() {
            nextInvoiceNumber = parseInt(localStorage.getItem(LOCAL_NEXT_INV_KEY)) || 1001;
            if (invoices.length > 0) {
                const lastInvoiceNo = invoices.reduce((max, inv) => Math.max(max, parseInt(inv.invoiceNo) || 0), nextInvoiceNumber);
                nextInvoiceNumber = lastInvoiceNo + 1;
            }
            document.getElementById('invoiceNo').value = nextInvoiceNumber.toString().padStart(4, '0');
        }

        function addInvoiceItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off">
                    </div>
                </td>
                <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-amount" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
            `;
            setupItemAutocomplete();
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            if (document.querySelectorAll('#itemsTableBody tr').length > 1) {
                row.remove();
                calculateTotal();
            } else {
                showNotification('At least one item is required', 'warning');
            }
        }

        function calculateTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const amount = rate * quantity;
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const totalAmount = subtotal + taxAmount;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = totalAmount + previousBalance - payment;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
        }

        function saveInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const customerPhone = document.getElementById('invoiceCustomerPhone').value.trim();
            
            if (!customerName || !invoiceDate) { 
                showNotification('Please enter customer name and invoice date', 'warning');
                return; 
            }
            
            const items = [];
            let hasValidItem = false;
            
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                if (name && (rate > 0 || quantity > 0)) {
                    items.push({ name, rate, quantity, amount: rate * quantity });
                    hasValidItem = true;
                }
            });
            
            if (!hasValidItem) { 
                showNotification('Please add at least one valid item', 'warning');
                return; 
            }
            calculateTotal();

            let customer = customers.find(c => c.name === customerName);
            if (!customer) {
                customer = { id: Date.now().toString(), name: customerName, phone: customerPhone, balance: 0, invoicesCount: 0 };
                customers.push(customer);
            } else {
                customer.phone = customerPhone;
            }
            
            const invoice = {
                id: Date.now().toString(),
                invoiceNo: document.getElementById('invoiceNo').value,
                date: invoiceDate,
                customerName: customer.name,
                customerPhone: customer.phone,
                items: items,
                total: parseFloat(document.getElementById('totalAmount').textContent),
                previousBalance: parseFloat(document.getElementById('previousBalance').value) || 0,
                payment: parseFloat(document.getElementById('payment').value) || 0,
                remainingBalance: parseFloat(document.getElementById('remainingBalance').textContent),
                status: (parseFloat(document.getElementById('remainingBalance').textContent) <= 0 ? 'paid' : 'pending'),
                created: new Date().toISOString()
            };

            const existingIndex = invoices.findIndex(inv => inv.invoiceNo === invoice.invoiceNo);
            if (existingIndex !== -1) { invoices[existingIndex] = invoice; } else { invoices.push(invoice); }
            
            customer.balance = invoice.remainingBalance;
            customer.invoicesCount = (customer.invoicesCount || 0) + 1;
            
            nextInvoiceNumber++;
            localStorage.setItem(LOCAL_NEXT_INV_KEY, nextInvoiceNumber.toString()); // Save next invoice number immediately
            saveAllData(); 
            loadNextInvoiceNumber();
            
            // Trigger Excel sync check on next page load/interval
            localStorage.setItem(LOCAL_EXCEL_TRIGGER_KEY, 'true');
            showNotification('Invoice saved and cloud sync initiated!', 'success');
        }

        function clearInvoice() {
            if (confirm('Are you sure you want to clear the current invoice?')) {
                document.getElementById('invoiceCustomerName').value = '';
                document.getElementById('invoiceCustomerPhone').value = '';
                document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('taxRate').value = '0';
                document.getElementById('previousBalance').value = '0';
                document.getElementById('payment').value = '0';
                
                const tableBody = document.getElementById('itemsTableBody');
                tableBody.innerHTML = '';
                addInvoiceItem();
                loadNextInvoiceNumber();
                calculateTotal();
                showNotification('Invoice form cleared', 'info');
            }
        }

        function loadInvoiceList() {
            const listContainer = document.getElementById('invoiceList');
            if (invoices.length === 0) { listContainer.innerHTML = '<p>No invoices saved yet.</p>'; return; }
            
            const tableHtml = `
                <table class="data-table">
                    <thead><tr><th>#</th><th>Customer</th><th>Total</th><th>Balance</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${invoices.map(inv => `
                            <tr>
                                <td>${inv.invoiceNo}</td>
                                <td>${inv.customerName}</td>
                                <td>Rs. ${inv.total.toFixed(2)}</td>
                                <td>Rs. ${inv.remainingBalance.toFixed(2)}</td>
                                <td>${inv.date}</td>
                                <td><span style="color:${inv.status === 'paid' ? 'green' : 'red'};">${inv.status.toUpperCase()}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="alert('Invoice Details: ' + JSON.stringify(invoices.find(i => i.id === \'${inv.id}\'), null, 2))">View</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${inv.id}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            listContainer.innerHTML = tableHtml;
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice? This cannot be undone.')) {
                invoices = invoices.filter(inv => inv.id !== id);
                saveAllData();
                loadInvoiceList();
                showNotification('Invoice deleted', 'success');
            }
        }

        // =============================================
        // ADMIN DATA MANAGEMENT FUNCTIONS (Updated)
        // =============================================
        function addNewItem() {
            const newMainCategoryInput = document.getElementById('newMainCategory');
            const newSubCategoryInput = document.getElementById('newSubCategory');
            const newItemNameInput = document.getElementById('newItemName');
            
            const mainCategory = newMainCategoryInput.value.trim();
            const subCategory = newSubCategoryInput.value.trim();
            const itemName = newItemNameInput.value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value) || 0;
            const designCharges = parseFloat(document.getElementById('newDesignCharges').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) { 
                showNotification('Please fill in all required fields', 'warning');
                return; 
            }
            
            if (!data.categories.some(cat => cat.mainCategory === mainCategory && cat.subcategory === subCategory)) {
                data.categories.push({ mainCategory, subcategory: subCategory });
            }
            
            data.items.push({ 
                mainCategory, 
                subcategory: subCategory, 
                itemName, 
                price, 
                type: "fixed", 
                designCharges 
            });
            
            // Update datalists with new values
            updateDatalist('newMainCategoryList', mainCategory);
            updateDatalist('newSubCategoryList', subCategory);
            updateDatalist('newItemNameList', itemName);
            
            newMainCategoryInput.value = '';
            newSubCategoryInput.value = '';
            newItemNameInput.value = '';
            document.getElementById('newItemPrice').value = '0';
            document.getElementById('newDesignCharges').value = '0';
            
            refreshDataTables();
            refreshAllDisplays();
            saveAllData();
            showNotification('Item added successfully!', 'success');
        }

        function refreshDataTables() {
            const itemsTable = document.getElementById('itemsTable');
            itemsTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Main Category</th>
                        <th>Subcategory</th>
                        <th>Item Name</th>
                        <th>Price (Rs.)</th>
                        <th>Design Charges (Rs.)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.items.map((item, index) => `
                        <tr>
                            <td>${item.mainCategory}</td>
                            <td>${item.subcategory}</td>
                            <td>${item.itemName}</td>
                            <td><input type="number" value="${item.price}" onchange="data.items[${index}].price=parseFloat(this.value); saveAllData();"></td>
                            <td><input type="number" value="${item.designCharges}" onchange="data.items[${index}].designCharges=parseFloat(this.value); saveAllData();"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function deleteItem(index) { 
            if (confirm('Delete this item?')) { 
                data.items.splice(index, 1); 
                refreshDataTables(); 
                refreshAllDisplays(); 
                saveAllData(); 
                showNotification('Item deleted', 'success');
            } 
        }

        function loadSettings() {
            document.getElementById('rentCost').value = data.settings.rent;
            document.getElementById('profitMargin').value = data.settings.profitMargin;
            document.getElementById('budgetBusiness').value = budget.business;
            document.getElementById('budgetPersonal').value = budget.personal;
        }

        function saveSettings() {
            data.settings.rent = parseFloat(document.getElementById('rentCost').value);
            data.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value);
            
            budget.business = parseFloat(document.getElementById('budgetBusiness').value);
            budget.personal = parseFloat(document.getElementById('budgetPersonal').value);
            
            saveAllData();
            loadBudgetSnapshot();
            showNotification('Settings saved successfully!', 'success');
        }

        // --- Import/Export ---
        window.exportCustomerDataForGitHub = async function() {
            if (!isOnline || !currentUser) {
                showNotification('Please sign in to OneDrive first to save the public data file.', 'error');
                return;
            }

            const publicData = { categories: data.categories, items: data.items, settings: data.settings, lastUpdated: new Date().toISOString() };
            
            const success = await excelSync.uploadPublicJson(publicData);
            
            if (success) {
                showNotification('Price data saved to OneDrive as customer-data.json! Now push this file to GitHub.', 'success', 8000);
            } else {
                showNotification('Failed to save public JSON to OneDrive. Check your connection.', 'error');
            }
        }

        function exportAllData() {
            let csvContent = 'data:text/csv;charset=utf-8,';
            
            csvContent += 'ITEMS DATA\r\nMain Category,Subcategory,Item Name,Price,Type,Design Charges\r\n';
            data.items.forEach(item => {
                csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges}\r\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'arham_printers_all_data.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data exported successfully!', 'success');
        }

        function resetToDefault() {
            if (confirm('WARNING: This will reset all calculator data (items, settings) to default values. Are you sure?')) {
                data = JSON.parse(JSON.stringify(defaultData));
                datalists = defaultDatalists; // Reset datalists to default
                calculationHistory = [];
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                showNotification('Calculator data reset to default values!', 'success');
            }
        }

        // =============================================
        // INITIALIZATION AND SYNC CHECK
        // =============================================
        function checkInvoiceSyncTrigger() {
            const trigger = localStorage.getItem(LOCAL_EXCEL_TRIGGER_KEY);
            if (trigger === 'true') {
                if (isOnline && currentUser) {
                    localStorage.removeItem(LOCAL_EXCEL_TRIGGER_KEY);
                    console.log("Trigger detected: Starting Invoice/Customer Excel sync.");
                    window.syncAllToExcel(true); 
                } else {
                    document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Invoice Saved: Sign in to sync to Excel.';
                }
            }
        }

        // Initialize MSAL and start the application
        msalInstance.initialize().then(() => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentUser = accounts[0];
                isOnline = true;
                updateUIAfterLogin();
            }
            
            loadAllData();
            refreshAllDisplays();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            setInterval(checkInvoiceSyncTrigger, 5000); 

            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('item-name') && !e.target.closest('.item-suggestions')) {
                    document.querySelectorAll('.item-suggestions').forEach(box => box.style.display = 'none');
                }
                if (!e.target.id === 'invoiceCustomerName' && !e.target.closest('.customer-suggestions')) {
                    document.getElementById('customerSuggestions').style.display = 'none';
                }
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
