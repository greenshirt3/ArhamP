<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Arham Printers - Complete Shop Management</title>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Arham Printers" name="apple-mobile-web-app-title"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="#2c3e50" name="theme-color"/>
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='.9em' font-size='90'&gt;🧮&lt;/text&gt;&lt;/svg&gt;" rel="icon"/>
<link href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='.9em' font-size='90'&gt;🧮&lt;/text&gt;&lt;/svg&gt;" rel="apple-touch-icon"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
<style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #0078d4;
            --secondary-light: #1088e4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #0078d4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #1088e4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #dff6dd;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fff4ce;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Updated Grid for 3 Panels */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 30px;
        }

        /* Adjustments for smaller screens */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr 1fr; /* Switch to 2 columns on medium screens */
            }
        }
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr; /* Switch to 1 column on small screens */
            }
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0e6b0e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e6a200; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c02a2e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }

        /* Financial Hub Styling */
        .dashboard-metric {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
        }
        
        .dashboard-metric span {
            display: block;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .metric-income {
            border-color: var(--success);
            background-color: #e6f4ea;
        }
        
        .metric-expense {
            border-color: var(--danger);
            background-color: #fde2e2;
        }
        
        .metric-profit {
            border-color: var(--secondary);
            background-color: #e8f0fe;
        }
        
        .metric-net {
            border-color: var(--warning);
            background-color: #fff8e1;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Item Editor Specific Styles */
        #itemEditor {
            border-top: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tier-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .tier-row input {
            padding: 8px;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<div class="container">
<header>
<h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
<p class="subtitle">Complete Price Calculator, Invoicing, and Financial Management</p>
</header>
<div class="cloud-section">
<h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
<div class="sync-status sync-offline" id="syncStatus">
<i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
<div class="actions">
<button class="btn btn-primary" id="loginBtn" onclick="loginToOneDrive()">
<i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
<button class="btn btn-success" id="syncBtn" onclick="window.syncAllToExcel()" style="display: none;">
<i class="fas fa-cloud-upload-alt"></i> Upload All Data to Excel
                </button>
<button class="btn btn-secondary" id="downloadBtn" onclick="syncFromCloud()" style="display: none;">
<i class="fas fa-cloud-download-alt"></i> Download Data (JSON)
                </button>
<button class="btn btn-danger" id="logoutBtn" onclick="logoutFromOneDrive()" style="display: none;">
<i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
</div>
<div class="user-info" id="userInfo" style="display: none;">
<h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
<p>Your data is synced across all devices via OneDrive.</p>
</div>
</div>
<div class="content-grid">
<div class="section-panel">
<h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
<div class="form-group">
<label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
<select id="mainCategory" onchange="updateSubcategories()">
<option value="">Select Main Category</option>
</select>
</div>
<div class="form-group">
<label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
<select id="subCategory" onchange="updateItemsAndFields()"></select>
</div>
<div class="form-group">
<label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
<select id="itemName" onchange="updateQuantityInput()"></select>
</div>
<div class="form-group">
<label for="quantityInputContainer"><i class="fas fa-boxes"></i> Quantity / Set:</label>
<div id="quantityInputContainer" style="flex: 2;">
<input id="quantity" min="1" oninput="clearTierTag()" type="number" value="1"/>
</div>
</div>
<div class="form-group" id="priceTierTagGroup" style="margin-top: -10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f9f9f9; display: none;">
<label><i class="fas fa-tag"></i> Selected Set:</label>
<span id="priceTierTag" style="font-weight: bold; color: var(--danger);">Select a set.</span>
</div>
<div class="form-group">
<label for="designCharges"><i class="fas fa-paint-brush"></i> Design Charges (Rs.):</label>
<input id="designCharges" min="0" step="0.01" type="number" value="0"/>
</div>
<div class="actions">
<button class="btn btn-primary" onclick="calculatePrice()">
<i class="fas fa-calculator"></i> Calculate Price
                    </button>
<button class="btn btn-secondary" onclick="window.print()">
<i class="fas fa-print"></i> Print Quote
                    </button>
<button class="btn btn-danger" onclick="clearForm()">
<i class="fas fa-trash"></i> Clear Form
                    </button>
</div>
<div class="result" id="result"></div>
<div class="price-breakdown" id="priceBreakdown">
<h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
<div id="breakdownContent"></div>
</div>
</div>
<div class="section-panel">
<h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
<div class="form-group">
<label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
<div class="suggestion-container">
<input autocomplete="off" id="invoiceCustomerName" list="customerNameList" placeholder="Start typing customer name..." type="text"/>
<div class="customer-suggestions" id="customerSuggestions" style="display: none;"></div>
</div>
</div>
<div class="form-group">
<label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
<input id="invoiceCustomerPhone" list="customerPhoneList" placeholder="Customer phone number" type="tel"/>
</div>
<div class="form-group">
<label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
<input id="invoiceNo" readonly="" type="text"/>
</div>
<div class="form-group">
<label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
<input id="invoiceDate" type="date"/>
</div>
<h3>Invoice Items</h3>
<table class="items-table">
<thead>
<tr>
<th>Description</th>
<th>Rate (Rs.)</th>
<th>Qty</th>
<th>Design Charges (Rs.)</th>
<th>Amount</th>
<th>Action</th>
</tr>
</thead>
<tbody id="itemsTableBody">
<tr>
<td>
<div style="position: relative;">
<input autocomplete="off" class="item-name" list="invoiceItemList" placeholder="Enter item description" type="text"/>
</div>
</td>
<td><input class="item-rate" min="0" oninput="calculateTotal()" step="0.01" type="number" value="0"/></td>
<td><input class="item-quantity" min="1" oninput="calculateTotal()" type="number" value="1"/></td>
<td><input class="item-design-charges" min="0" oninput="calculateTotal()" step="0.01" type="number" value="0"/></td>
<td><input class="item-amount" readonly="" type="number" value="0"/></td>
<td><button class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)" type="button"><i class="fas fa-trash"></i></button></td>
</tr>
</tbody>
</table>
<div class="actions">
<button class="btn btn-success" onclick="addInvoiceItem()">
<i class="fas fa-plus"></i> Add Item
                    </button>
<button class="btn btn-secondary" onclick="calculateTotal()">
<i class="fas fa-calculator"></i> Recalculate
                    </button>
</div>
<div class="totals-section">
<h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
<div class="total-row">
<span>Subtotal:</span>
<span>Rs. <span id="subtotalAmount">0.00</span></span>
</div>
<div class="form-group">
<label for="taxRate">Tax Rate (%):</label>
<input id="taxRate" max="100" min="0" oninput="calculateTotal()" step="0.1" type="number" value="0"/>
</div>
<div class="total-row">
<span><strong>Total Amount:</strong></span>
<span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
</div>
<div class="form-group">
<label for="previousBalance">Previous Balance (Rs.):</label>
<input id="previousBalance" min="0" oninput="calculateTotal()" step="0.01" type="number" value="0"/>
</div>
<div class="form-group">
<label for="payment">Payment Received (Rs.):</label>
<input id="payment" min="0" oninput="calculateTotal()" step="0.01" type="number" value="0"/>
</div>
<div class="total-row">
<span><strong>Remaining Balance:</strong></span>
<span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
</div>
</div>
<div class="actions">
<button class="btn btn-primary" onclick="saveInvoice()">
<i class="fas fa-save"></i> Save &amp; Sync Invoice
                    </button>
<button class="btn btn-warning" onclick="clearInvoice()">
<i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
</div>
</div>
<div class="section-panel" id="FinancialHub">
<h2 class="section-title"><i class="fas fa-chart-line"></i> Financial Hub</h2>
<div class="tabs">
<div class="tab active" onclick="switchFinancialTab(this, 'dashboard')">Dashboard</div>
<div class="tab" onclick="switchFinancialTab(this, 'logTransaction')">Log Transaction</div>
<div class="tab" onclick="switchFinancialTab(this, 'managePayables')">Manage Payables</div>
</div>
<div class="tab-content active" id="dashboard" style="padding-top: 20px;">
<h4>Summary for <span id="dashboardMonth"></span></h4>
<div id="financialDashboardContainer"></div>
</div>
<div class="tab-content" id="logTransaction">
<div class="form-group">
<label for="entryType">Entry Type:</label>
<select id="entryType" onchange="togglePaymentPayable()">
<option value="Income">Income</option>
<option value="Expense">General Expense</option>
<option value="Payment">Payment (for Payable)</option>
</select>
</div>
<div class="form-group" id="paymentPayableGroup" style="display:none;">
<label for="paymentPayableSelect">For:</label>
<select id="paymentPayableSelect"></select>
</div>
<div class="form-group">
<label for="entryCategory">Category:</label>
<select id="entryCategory">
<option value="Income: Invoice Payment">Income: Invoice Payment</option>
<option value="Income: Army Pension">Income: Army Pension</option>
<option value="Income: Other">Income: Other</option>
<option value="Expense: Business Materials">Expense: Business Materials</option>
<option value="Expense: Business Rent">Expense: Business Rent</option>
<option value="Expense: Business Salaries">Expense: Business Salaries</option>
<option value="Expense: Business Other">Expense: Business Other</option>
<option value="Expense: Personal Groceries">Expense: Personal Groceries</option>
<option value="Expense: Personal Transport">Expense: Personal Transport</option>
<option value="Expense: Personal Bills">Expense: Personal Bills</option>
<option value="Expense: Personal Other">Expense: Personal Other</option>
</select>
</div>
<div class="form-group">
<label for="entryDate">Date:</label>
<input id="entryDate" type="date"/>
</div>
<div class="form-group">
<label for="entryAmount">Amount (Rs.):</label>
<input id="entryAmount" min="0" step="0.01" type="number" value="0"/>
</div>
<div class="form-group">
<label for="entryDescription">Description:</label>
<textarea id="entryDescription" list="expenseDescriptionList" placeholder="e.g., Monthly shop loan, School fee"></textarea>
</div>
<div class="actions">
<button class="btn btn-success" onclick="saveFinancialEntry()">
<i class="fas fa-save"></i> Save Entry
                        </button>
</div>
</div>
<div class="tab-content" id="managePayables">
<div class="form-group">
<label for="payableDescription">Description:</label>
<input id="payableDescription" placeholder="e.g., Rent, Loan, Bill" type="text"/>
</div>
<div class="form-group">
<label for="payableAmount">Amount (Rs.):</label>
<input id="payableAmount" min="0" step="0.01" type="number" value="0"/>
</div>
<div class="form-group">
<label for="payableDueDate">Due Date:</label>
<input id="payableDueDate" type="date"/>
</div>
<div class="actions">
<button class="btn btn-success" onclick="addPayable()">
<i class="fas fa-plus"></i> Add Payable
                        </button>
</div>
<div id="payablesList"></div>
</div>
</div>
</div>
<div class="section-panel">
<h2 class="section-title"><i class="fas fa-history"></i> Recent Activity</h2>
<div id="recentActivity"></div>
</div>
<div class="section-panel">
<h2 class="section-title"><i class="fas fa-cogs"></i> Admin Panel</h2>
<div class="login-section" id="adminLoginSection">
<h3>Admin Login</h3>
<div class="login-form">
<div>
<label for="adminUsername">Username:</label>
<input id="adminUsername" placeholder="Enter username" type="text"/>
</div>
<div>
<label for="adminPassword">Password:</label>
<input id="adminPassword" placeholder="Enter password" type="password"/>
</div>
<button class="btn btn-primary" onclick="adminLogin()">
<i class="fas fa-sign-in-alt"></i> Login
                    </button>
</div>
</div>
<div class="admin-panel" id="adminPanel">
<div class="tabs">
<div class="tab active" onclick="switchAdminTab(this, 'manageItems')">Manage Items</div>
<div class="tab" onclick="switchAdminTab(this, 'manageCategories')">Manage Categories</div>
<div class="tab" onclick="switchAdminTab(this, 'manageCustomers')">Manage Customers</div>
<div class="tab" onclick="switchAdminTab(this, 'manageInvoices')">Manage Invoices</div>
<div class="tab" onclick="switchAdminTab(this, 'manageFinancials')">Manage Financials</div>
<div class="tab" onclick="switchAdminTab(this, 'dataBackup')">Data Backup</div>
</div>
<div class="tab-content active" id="manageItems">
<div class="admin-section">
<h3>Add/Edit Item</h3>
<div class="form-row">
<div class="form-field">
<label for="itemCategory">Category:</label>
<select id="itemCategory"></select>
</div>
<div class="form-field">
<label for="itemSubcategory">Subcategory:</label>
<select id="itemSubcategory"></select>
</div>
<div class="form-field">
<label for="itemNameAdmin">Item Name:</label>
<input id="itemNameAdmin" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-field">
<label for="itemBasePrice">Base Price (Rs.):</label>
<input id="itemBasePrice" min="0" step="0.01" type="number" value="0"/>
</div>
<div class="form-field">
<label for="itemUnit">Unit:</label>
<input id="itemUnit" placeholder="e.g., per page, per set" type="text"/>
</div>
</div>
<h4>Price Tiers</h4>
<div id="priceTiersContainer">
<div class="tier-row">
<input class="tier-min" min="1" placeholder="Min Qty" type="number"/>
<input class="tier-max" min="1" placeholder="Max Qty" type="number"/>
<input class="tier-price" min="0" placeholder="Price" step="0.01" type="number"/>
<button class="btn btn-danger btn-sm" onclick="removeTierRow(this)"><i class="fas fa-trash"></i></button>
</div>
</div>
<div class="actions">
<button class="btn btn-success" onclick="addTierRow()">
<i class="fas fa-plus"></i> Add Tier
                            </button>
<button class="btn btn-primary" onclick="saveItem()">
<i class="fas fa-save"></i> Save Item
                            </button>
<button class="btn btn-warning" onclick="clearItemForm()">
<i class="fas fa-trash"></i> Clear Form
                            </button>
</div>
</div>
<div class="admin-section">
<h3>Existing Items</h3>
<div id="itemsList"></div>
</div>
</div>
<div class="tab-content" id="manageCategories">
<div class="admin-section">
<h3>Add Category</h3>
<div class="form-row">
<div class="form-field">
<label for="newCategoryName">Category Name:</label>
<input id="newCategoryName" placeholder="e.g., Printing" type="text"/>
</div>
<div class="form-field">
<label for="newSubcategoryName">Subcategory Name:</label>
<input id="newSubcategoryName" placeholder="e.g., Business Cards" type="text"/>
</div>
</div>
<button class="btn btn-success" onclick="addCategory()">
<i class="fas fa-plus"></i> Add Category
                        </button>
</div>
<div class="admin-section">
<h3>Existing Categories</h3>
<div id="categoriesList"></div>
</div>
</div>
<div class="tab-content" id="manageCustomers">
<div class="admin-section">
<h3>Customer List</h3>
<div id="customersList"></div>
</div>
</div>
<div class="tab-content" id="manageInvoices">
<div class="admin-section">
<h3>Invoice History</h3>
<div id="invoiceHistory"></div>
</div>
</div>
<div class="tab-content" id="manageFinancials">
<div class="admin-section">
<h3>Financial Entries</h3>
<div id="financialEntries"></div>
</div>
</div>
<div class="tab-content" id="dataBackup">
<div class="import-export-section">
<h3>Data Export</h3>
<div class="actions">
<button class="btn btn-success" onclick="exportData()">
<i class="fas fa-download"></i> Export All Data
                            </button>
<button class="btn btn-primary" onclick="exportToExcel()">
<i class="fas fa-file-excel"></i> Export to Excel
                            </button>
</div>
</div>
<div class="import-export-section">
<h3>Data Import</h3>
<div class="form-group">
<label for="importFile">Select JSON file:</label>
<input accept=".json" id="importFile" type="file"/>
</div>
<button class="btn btn-warning" onclick="importData()">
<i class="fas fa-upload"></i> Import Data
                        </button>
</div>
<!-- ADD THIS NEW CUSTOMER DATA SECTION -->
<div class="import-export-section">
<h3>Customer Data Export</h3>
<div class="actions">
<button class="btn btn-success" onclick="exportCustomerData()">
<i class="fas fa-download"></i> Export Customer Data (JSON)
                            </button>
<button class="btn btn-primary" onclick="uploadCustomerDataToOneDrive()">
<i class="fas fa-cloud-upload-alt"></i> Upload to OneDrive
                            </button>
</div>
<p><small>Exports price categories and items for customer-facing applications</small></p>
</div>
<div class="import-export-section">
<h3>Data Reset</h3>
<p>Warning: This will permanently delete all data. This action cannot be undone.</p>
<button class="btn btn-danger" onclick="resetData()">
<i class="fas fa-trash"></i> Reset All Data
                        </button>
</div>
</div>
</div>
</div>
</div>
<div class="notification" id="notification"></div>
<script>
        // Global variables
        let categories = {};
        let customers = [];
        let invoices = [];
        let financialEntries = [];
        let payables = [];
        let recentActivity = [];
        let isAdmin = false;
        let currentEditingItem = null;
        
        // MSAL Configuration for OneDrive
        const msalConfig = {
            auth: {
                clientId: "YOUR_CLIENT_ID_HERE", // Replace with your Azure AD app client ID
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };
        
        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let isLoggedIn = false;
        let userName = "";

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadData();
            updateRecentActivity();
            updateInvoiceNo();
            updateDashboard();
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            
            // Check if user is already logged in
            checkLoginStatus();
        });

        // Initialize the application
        function initializeApp() {
            // Initialize categories if not present
            if (!localStorage.getItem('categories')) {
                const defaultCategories = {
                    "Printing": {
                        "Business Cards": {
                            "Standard Business Card": {
                                basePrice: 500,
                                unit: "per 100 cards",
                                priceTiers: [
                                    { min: 1, max: 100, price: 500 },
                                    { min: 101, max: 500, price: 450 },
                                    { min: 501, max: 1000, price: 400 }
                                ]
                            },
                            "Premium Business Card": {
                                basePrice: 800,
                                unit: "per 100 cards",
                                priceTiers: [
                                    { min: 1, max: 100, price: 800 },
                                    { min: 101, max: 500, price: 700 },
                                    { min: 501, max: 1000, price: 600 }
                                ]
                            }
                        },
                        "Flyers": {
                            "A4 Flyer": {
                                basePrice: 300,
                                unit: "per 100 flyers",
                                priceTiers: [
                                    { min: 1, max: 100, price: 300 },
                                    { min: 101, max: 500, price: 250 },
                                    { min: 501, max: 1000, price: 200 }
                                ]
                            },
                            "A5 Flyer": {
                                basePrice: 200,
                                unit: "per 100 flyers",
                                priceTiers: [
                                    { min: 1, max: 100, price: 200 },
                                    { min: 101, max: 500, price: 180 },
                                    { min: 501, max: 1000, price: 150 }
                                ]
                            }
                        }
                    },
                    "Photocopy": {
                        "Black & White": {
                            "A4 B&W": {
                                basePrice: 5,
                                unit: "per page",
                                priceTiers: [
                                    { min: 1, max: 10, price: 5 },
                                    { min: 11, max: 50, price: 4 },
                                    { min: 51, max: 100, price: 3.5 }
                                ]
                            },
                            "A3 B&W": {
                                basePrice: 10,
                                unit: "per page",
                                priceTiers: [
                                    { min: 1, max: 10, price: 10 },
                                    { min: 11, max: 50, price: 9 },
                                    { min: 51, max: 100, price: 8 }
                                ]
                            }
                        },
                        "Color": {
                            "A4 Color": {
                                basePrice: 20,
                                unit: "per page",
                                priceTiers: [
                                    { min: 1, max: 10, price: 20 },
                                    { min: 11, max: 50, price: 18 },
                                    { min: 51, max: 100, price: 15 }
                                ]
                            },
                            "A3 Color": {
                                basePrice: 40,
                                unit: "per page",
                                priceTiers: [
                                    { min: 1, max: 10, price: 40 },
                                    { min: 11, max: 50, price: 35 },
                                    { min: 51, max: 100, price: 30 }
                                ]
                            }
                        }
                    }
                };
                localStorage.setItem('categories', JSON.stringify(defaultCategories));
            }
            
            // Initialize other data if not present
            if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify([]));
            if (!localStorage.getItem('invoices')) localStorage.setItem('invoices', JSON.stringify([]));
            if (!localStorage.getItem('financialEntries')) localStorage.setItem('financialEntries', JSON.stringify([]));
            if (!localStorage.getItem('payables')) localStorage.setItem('payables', JSON.stringify([]));
            if (!localStorage.getItem('recentActivity')) localStorage.setItem('recentActivity', JSON.stringify([]));
            
            // Populate main category dropdown
            updateMainCategoryDropdown();
            
            // Set up customer name autocomplete
            setupCustomerAutocomplete();
            
            // Set up item autocomplete for invoice
            setupItemAutocomplete();
        }

        // Load data from localStorage
        function loadData() {
            categories = JSON.parse(localStorage.getItem('categories')) || {};
            customers = JSON.parse(localStorage.getItem('customers')) || [];
            invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            financialEntries = JSON.parse(localStorage.getItem('financialEntries')) || [];
            payables = JSON.parse(localStorage.getItem('payables')) || [];
            recentActivity = JSON.parse(localStorage.getItem('recentActivity')) || [];
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('financialEntries', JSON.stringify(financialEntries));
            localStorage.setItem('payables', JSON.stringify(payables));
            localStorage.setItem('recentActivity', JSON.stringify(recentActivity));
        }

        // Update main category dropdown
        function updateMainCategoryDropdown() {
            const mainCategorySelect = document.getElementById('mainCategory');
            mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
            
            for (const category in categories) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            }
        }

        // Update subcategory dropdown based on selected main category
        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (mainCategory && categories[mainCategory]) {
                for (const subcategory in categories[mainCategory]) {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subCategorySelect.appendChild(option);
                }
            }
            
            // Clear item dropdown
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
        }

        // Update items and fields based on selected subcategory
        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemNameSelect = document.getElementById('itemName');
            itemNameSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subCategory && categories[mainCategory] && categories[mainCategory][subCategory]) {
                for (const item in categories[mainCategory][subCategory]) {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    itemNameSelect.appendChild(option);
                }
            }
        }

        // Update quantity input based on selected item
        function updateQuantityInput() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            
            if (mainCategory && subCategory && itemName && categories[mainCategory] && 
                categories[mainCategory][subCategory] && categories[mainCategory][subCategory][itemName]) {
                
                const item = categories[mainCategory][subCategory][itemName];
                document.getElementById('quantityInputContainer').innerHTML = 
                    `<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">`;
                
                // Show price tier tag if there are tiers
                if (item.priceTiers && item.priceTiers.length > 0) {
                    document.getElementById('priceTierTagGroup').style.display = 'block';
                    updatePriceTierTag();
                } else {
                    document.getElementById('priceTierTagGroup').style.display = 'none';
                }
            }
        }

        // Clear the price tier tag when quantity changes
        function clearTierTag() {
            document.getElementById('priceTierTag').textContent = 'Select a set.';
            document.getElementById('priceTierTag').style.color = 'var(--danger)';
        }

        // Update price tier tag based on quantity
        function updatePriceTierTag() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (mainCategory && subCategory && itemName && categories[mainCategory] && 
                categories[mainCategory][subCategory] && categories[mainCategory][subCategory][itemName]) {
                
                const item = categories[mainCategory][subCategory][itemName];
                if (item.priceTiers && item.priceTiers.length > 0) {
                    for (const tier of item.priceTiers) {
                        if (quantity >= tier.min && quantity <= tier.max) {
                            document.getElementById('priceTierTag').textContent = 
                                `Set ${tier.min}-${tier.max} (Rs. ${tier.price} per ${item.unit})`;
                            document.getElementById('priceTierTag').style.color = 'var(--success)';
                            return;
                        }
                    }
                    
                    // If no tier matches, show base price
                    document.getElementById('priceTierTag').textContent = 
                        `Base Price (Rs. ${item.basePrice} per ${item.unit})`;
                    document.getElementById('priceTierTag').style.color = 'var(--warning)';
                }
            }
        }

        // Calculate price based on selected item and quantity
        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const designCharges = parseFloat(document.getElementById('designCharges').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) {
                showNotification('Please select a category, subcategory, and item.', 'error');
                return;
            }
            
            if (!categories[mainCategory] || !categories[mainCategory][subCategory] || 
                !categories[mainCategory][subCategory][itemName]) {
                showNotification('Selected item not found.', 'error');
                return;
            }
            
            const item = categories[mainCategory][subCategory][itemName];
            let unitPrice = item.basePrice;
            
            // Check if quantity falls within any price tier
            if (item.priceTiers && item.priceTiers.length > 0) {
                for (const tier of item.priceTiers) {
                    if (quantity >= tier.min && quantity <= tier.max) {
                        unitPrice = tier.price;
                        break;
                    }
                }
            }
            
            const itemCost = unitPrice * quantity;
            const total = itemCost + designCharges;
            
            // Display result
            document.getElementById('result').innerHTML = `
                <h3>Price Calculation Result</h3>
                <p><strong>Item:</strong> ${itemName}</p>
                <p><strong>Quantity:</strong> ${quantity} ${item.unit}</p>
                <p><strong>Unit Price:</strong> Rs. ${unitPrice.toFixed(2)}</p>
                <p><strong>Design Charges:</strong> Rs. ${designCharges.toFixed(2)}</p>
                <p><strong>Total Price:</strong> Rs. ${total.toFixed(2)}</p>
            `;
            document.getElementById('result').style.display = 'block';
            
            // Display price breakdown
            document.getElementById('breakdownContent').innerHTML = `
                <div class="breakdown-item">
                    <span>Item Cost (${quantity} × Rs. ${unitPrice.toFixed(2)}):</span>
                    <span>Rs. ${itemCost.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Design Charges:</span>
                    <span>Rs. ${designCharges.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Total:</span>
                    <span>Rs. ${total.toFixed(2)}</span>
                </div>
            `;
            document.getElementById('priceBreakdown').style.display = 'block';
            
            // Add to recent activity
            addRecentActivity(`Calculated price for ${itemName}`, 'calculator');
            
            showNotification('Price calculated successfully!', 'success');
        }

        // Clear the form
        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantity').value = 1;
            document.getElementById('designCharges').value = 0;
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            document.getElementById('priceTierTagGroup').style.display = 'none';
            
            showNotification('Form cleared.', 'info');
        }

        // Add recent activity
        function addRecentActivity(description, type) {
            const activity = {
                id: Date.now(),
                description: description,
                type: type,
                timestamp: new Date().toISOString()
            };
            
            recentActivity.unshift(activity);
            if (recentActivity.length > 10) {
                recentActivity = recentActivity.slice(0, 10);
            }
            
            saveData();
            updateRecentActivity();
        }

        // Update recent activity display
        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';
            
            if (recentActivity.length === 0) {
                container.innerHTML = '<p>No recent activity.</p>';
                return;
            }
            
            recentActivity.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const icon = getActivityIcon(activity.type);
                const time = new Date(activity.timestamp).toLocaleString();
                
                item.innerHTML = `
                    <div class="history-header">
                        <span>${icon} ${activity.description}</span>
                        <span>${time}</span>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        // Get icon for activity type
        function getActivityIcon(type) {
            switch(type) {
                case 'calculator': return '<i class="fas fa-calculator"></i>';
                case 'invoice': return '<i class="fas fa-file-invoice"></i>';
                case 'financial': return '<i class="fas fa-chart-line"></i>';
                case 'customer': return '<i class="fas fa-user"></i>';
                default: return '<i class="fas fa-history"></i>';
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // OneDrive Integration Functions
        async function loginToOneDrive() {
            try {
                const loginRequest = {
                    scopes: ["User.Read", "Files.ReadWrite"]
                };
                
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                isLoggedIn = true;
                userName = loginResponse.account.name;
                
                updateLoginUI();
                showNotification(`Successfully signed in as ${userName}`, 'success');
            } catch (error) {
                console.error("Login failed:", error);
                showNotification('Login failed. Please try again.', 'error');
            }
        }

        function logoutFromOneDrive() {
            msalInstance.logoutPopup();
            isLoggedIn = false;
            userName = "";
            updateLoginUI();
            showNotification('Signed out successfully.', 'info');
        }

        function checkLoginStatus() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                isLoggedIn = true;
                userName = accounts[0].name;
                updateLoginUI();
            }
        }

        function updateLoginUI() {
            const syncStatus = document.getElementById('syncStatus');
            const loginBtn = document.getElementById('loginBtn');
            const syncBtn = document.getElementById('syncBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userInfo = document.getElementById('userInfo');
            const userNameSpan = document.getElementById('userName');
            
            if (isLoggedIn) {
                syncStatus.innerHTML = '<i class="fas fa-cloud"></i> Online - Connected to OneDrive';
                syncStatus.className = 'sync-status sync-online';
                loginBtn.style.display = 'none';
                syncBtn.style.display = 'inline-flex';
                downloadBtn.style.display = 'inline-flex';
                logoutBtn.style.display = 'inline-flex';
                userInfo.style.display = 'block';
                userNameSpan.textContent = userName;
            } else {
                syncStatus.innerHTML = '<i class="fas fa-cloud"></i> Offline Mode - Data stored locally';
                syncStatus.className = 'sync-status sync-offline';
                loginBtn.style.display = 'inline-flex';
                syncBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                logoutBtn.style.display = 'none';
                userInfo.style.display = 'none';
            }
        }

        async function syncAllToExcel() {
            if (!isLoggedIn) {
                showNotification('Please sign in first.', 'error');
                return;
            }
            
            try {
                showNotification('Syncing data to OneDrive...', 'info');
                
                // Create Excel-compatible data
                const dataToSync = {
                    categories: categories,
                    customers: customers,
                    invoices: invoices,
                    financialEntries: financialEntries,
                    payables: payables,
                    recentActivity: recentActivity,
                    lastSync: new Date().toISOString()
                };
                
                // Convert to JSON string
                const jsonData = JSON.stringify(dataToSync, null, 2);
                
                // Create a blob
                const blob = new Blob([jsonData], { type: 'application/json' });
                
                // Upload to OneDrive
                await uploadFileToOneDrive('ArhamPrintersData.json', blob);
                
                showNotification('Data successfully synced to OneDrive!', 'success');
            } catch (error) {
                console.error('Sync failed:', error);
                showNotification('Failed to sync data. Please try again.', 'error');
            }
        }

        async function uploadFileToOneDrive(filename, blob) {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error('No user signed in');
                }
                
                const request = {
                    scopes: ["Files.ReadWrite"],
                    account: accounts[0]
                };
                
                const response = await msalInstance.acquireTokenSilent(request);
                const accessToken = response.accessToken;
                
                // Upload to OneDrive
                const uploadResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${filename}:/content`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: blob
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`Upload failed: ${uploadResponse.statusText}`);
                }
                
                return await uploadResponse.json();
            } catch (error) {
                console.error('Upload failed:', error);
                throw error;
            }
        }

        async function syncFromCloud() {
            if (!isLoggedIn) {
                showNotification('Please sign in first.', 'error');
                return;
            }
            
            try {
                showNotification('Downloading data from OneDrive...', 'info');
                
                // Download from OneDrive
                const data = await downloadFileFromOneDrive('ArhamPrintersData.json');
                
                // Parse and load data
                const parsedData = JSON.parse(data);
                
                categories = parsedData.categories || categories;
                customers = parsedData.customers || customers;
                invoices = parsedData.invoices || invoices;
                financialEntries = parsedData.financialEntries || financialEntries;
                payables = parsedData.payables || payables;
                recentActivity = parsedData.recentActivity || recentActivity;
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateMainCategoryDropdown();
                updateRecentActivity();
                updateDashboard();
                
                showNotification('Data successfully downloaded from OneDrive!', 'success');
            } catch (error) {
                console.error('Download failed:', error);
                showNotification('Failed to download data. Please try again.', 'error');
            }
        }

        async function downloadFileFromOneDrive(filename) {
            try {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    throw new Error('No user signed in');
                }
                
                const request = {
                    scopes: ["Files.ReadWrite"],
                    account: accounts[0]
                };
                
                const response = await msalInstance.acquireTokenSilent(request);
                const accessToken = response.accessToken;
                
                // Download from OneDrive
                const downloadResponse = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${filename}:/content`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!downloadResponse.ok) {
                    throw new Error(`Download failed: ${downloadResponse.statusText}`);
                }
                
                return await downloadResponse.text();
            } catch (error) {
                console.error('Download failed:', error);
                throw error;
            }
        }

        // Invoice System Functions
        function setupCustomerAutocomplete() {
            const customerNameInput = document.getElementById('invoiceCustomerName');
            const customerSuggestions = document.getElementById('customerSuggestions');
            
            customerNameInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                customerSuggestions.innerHTML = '';
                
                if (query.length < 2) {
                    customerSuggestions.style.display = 'none';
                    return;
                }
                
                const matches = customers.filter(customer => 
                    customer.name.toLowerCase().includes(query)
                );
                
                if (matches.length > 0) {
                    matches.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'customer-suggestion';
                        div.textContent = customer.name;
                        div.addEventListener('click', function() {
                            customerNameInput.value = customer.name;
                            document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
                            customerSuggestions.style.display = 'none';
                        });
                        customerSuggestions.appendChild(div);
                    });
                    customerSuggestions.style.display = 'block';
                } else {
                    customerSuggestions.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== customerNameInput) {
                    customerSuggestions.style.display = 'none';
                }
            });
        }

        function setupItemAutocomplete() {
            // This would set up autocomplete for invoice items
            // Implementation would be similar to customer autocomplete
        }

        function addInvoiceItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                    </div>
                </td>
                <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-amount" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
            `;
            
            tableBody.appendChild(newRow);
            calculateTotal();
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            row.remove();
            calculateTotal();
        }

        function calculateTotal() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = (rate * quantity) + designCharges;
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = total + previousBalance - payment;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
        }

        function updateInvoiceNo() {
            const lastInvoiceNo = localStorage.getItem('lastInvoiceNo') || 0;
            const newInvoiceNo = parseInt(lastInvoiceNo) + 1;
            document.getElementById('invoiceNo').value = `INV-${newInvoiceNo.toString().padStart(4, '0')}`;
        }

        function saveInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value;
            const customerPhone = document.getElementById('invoiceCustomerPhone').value;
            const invoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            
            if (!customerName || !invoiceNo) {
                showNotification('Please enter customer name and invoice number.', 'error');
                return;
            }
            
            // Save customer if new
            const existingCustomer = customers.find(c => c.name === customerName);
            if (!existingCustomer) {
                customers.push({
                    id: Date.now(),
                    name: customerName,
                    phone: customerPhone,
                    createdAt: new Date().toISOString()
                });
            }
            
            // Collect invoice items
            const items = [];
            const rows = document.querySelectorAll('#itemsTableBody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('.item-name').value;
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                
                if (name) {
                    items.push({
                        name,
                        rate,
                        quantity,
                        designCharges,
                        amount
                    });
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one item to the invoice.', 'error');
                return;
            }
            
            // Calculate totals
            const subtotal = parseFloat(document.getElementById('subtotalAmount').textContent) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const total = parseFloat(document.getElementById('totalAmount').textContent) || 0;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').textContent) || 0;
            
            // Create invoice object
            const invoice = {
                id: Date.now(),
                invoiceNo,
                customerName,
                customerPhone,
                date: invoiceDate,
                items,
                subtotal,
                taxRate,
                taxAmount,
                total,
                previousBalance,
                payment,
                remainingBalance,
                createdAt: new Date().toISOString()
            };
            
            // Save invoice
            invoices.push(invoice);
            localStorage.setItem('lastInvoiceNo', invoiceNo.split('-')[1]);
            
            // Add financial entry for income
            if (payment > 0) {
                const financialEntry = {
                    id: Date.now(),
                    type: 'Income',
                    category: 'Income: Invoice Payment',
                    date: invoiceDate,
                    amount: payment,
                    description: `Payment for invoice ${invoiceNo} from ${customerName}`,
                    createdAt: new Date().toISOString()
                };
                
                financialEntries.push(financialEntry);
            }
            
            // Save data
            saveData();
            
            // Add to recent activity
            addRecentActivity(`Created invoice ${invoiceNo} for ${customerName}`, 'invoice');
            
            // Clear form and update invoice number
            clearInvoice();
            updateInvoiceNo();
            
            showNotification('Invoice saved successfully!', 'success');
        }

        function clearInvoice() {
            document.getElementById('invoiceCustomerName').value = '';
            document.getElementById('invoiceCustomerPhone').value = '';
            document.getElementById('taxRate').value = 0;
            document.getElementById('previousBalance').value = 0;
            document.getElementById('payment').value = 0;
            
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            addInvoiceItem();
            
            calculateTotal();
            
            showNotification('Invoice form cleared.', 'info');
        }

        // Financial Hub Functions
        function switchFinancialTab(tabElement, tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('#FinancialHub .tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('#FinancialHub .tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
            
            // Update dashboard if switching to it
            if (tabId === 'dashboard') {
                updateDashboard();
            }
            
            // Update payables list if switching to it
            if (tabId === 'managePayables') {
                updatePayablesList();
            }
        }

        function togglePaymentPayable() {
            const entryType = document.getElementById('entryType').value;
            const paymentPayableGroup = document.getElementById('paymentPayableGroup');
            
            if (entryType === 'Payment') {
                paymentPayableGroup.style.display = 'flex';
                updatePaymentPayableSelect();
            } else {
                paymentPayableGroup.style.display = 'none';
            }
        }

        function updatePaymentPayableSelect() {
            const select = document.getElementById('paymentPayableSelect');
            select.innerHTML = '';
            
            payables.forEach(payable => {
                if (payable.remainingAmount > 0) {
                    const option = document.createElement('option');
                    option.value = payable.id;
                    option.textContent = `${payable.description} - Rs. ${payable.remainingAmount.toFixed(2)}`;
                    select.appendChild(option);
                }
            });
        }

        function saveFinancialEntry() {
            const entryType = document.getElementById('entryType').value;
            const category = document.getElementById('entryCategory').value;
            const date = document.getElementById('entryDate').value;
            const amount = parseFloat(document.getElementById('entryAmount').value) || 0;
            const description = document.getElementById('entryDescription').value;
            
            if (!date || amount <= 0 || !description) {
                showNotification('Please fill all fields with valid values.', 'error');
                return;
            }
            
            let financialEntry = {
                id: Date.now(),
                type: entryType,
                category: category,
                date: date,
                amount: amount,
                description: description,
                createdAt: new Date().toISOString()
            };
            
            // Handle payment for payable
            if (entryType === 'Payment') {
                const payableId = parseInt(document.getElementById('paymentPayableSelect').value);
                const payable = payables.find(p => p.id === payableId);
                
                if (payable) {
                    payable.paidAmount = (payable.paidAmount || 0) + amount;
                    payable.remainingAmount = payable.amount - payable.paidAmount;
                    
                    if (payable.remainingAmount <= 0) {
                        payable.status = 'Paid';
                    }
                    
                    financialEntry.payableId = payableId;
                    financialEntry.payableDescription = payable.description;
                }
            }
            
            financialEntries.push(financialEntry);
            saveData();
            
            // Clear form
            document.getElementById('entryAmount').value = 0;
            document.getElementById('entryDescription').value = '';
            
            // Update dashboard
            updateDashboard();
            
            // Add to recent activity
            addRecentActivity(`Added ${entryType} entry: ${description}`, 'financial');
            
            showNotification('Financial entry saved successfully!', 'success');
        }

        function addPayable() {
            const description = document.getElementById('payableDescription').value;
            const amount = parseFloat(document.getElementById('payableAmount').value) || 0;
            const dueDate = document.getElementById('payableDueDate').value;
            
            if (!description || amount <= 0 || !dueDate) {
                showNotification('Please fill all fields with valid values.', 'error');
                return;
            }
            
            const payable = {
                id: Date.now(),
                description: description,
                amount: amount,
                paidAmount: 0,
                remainingAmount: amount,
                dueDate: dueDate,
                status: 'Pending',
                createdAt: new Date().toISOString()
            };
            
            payables.push(payable);
            saveData();
            
            // Clear form
            document.getElementById('payableDescription').value = '';
            document.getElementById('payableAmount').value = 0;
            document.getElementById('payableDueDate').value = '';
            
            // Update payables list
            updatePayablesList();
            
            // Add to recent activity
            addRecentActivity(`Added payable: ${description}`, 'financial');
            
            showNotification('Payable added successfully!', 'success');
        }

        function updatePayablesList() {
            const container = document.getElementById('payablesList');
            container.innerHTML = '';
            
            if (payables.length === 0) {
                container.innerHTML = '<p>No payables found.</p>';
                return;
            }
            
            payables.forEach(payable => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const statusClass = payable.status === 'Paid' ? 'sync-online' : 'sync-offline';
                
                item.innerHTML = `
                    <div class="history-header">
                        <span>${payable.description}</span>
                        <span class="${statusClass}" style="padding: 5px 10px; border-radius: 4px;">${payable.status}</span>
                    </div>
                    <div class="history-details">
                        <div>Amount: Rs. ${payable.amount.toFixed(2)}</div>
                        <div>Paid: Rs. ${payable.paidAmount.toFixed(2)}</div>
                        <div>Remaining: Rs. ${payable.remainingAmount.toFixed(2)}</div>
                        <div>Due Date: ${new Date(payable.dueDate).toLocaleDateString()}</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function updateDashboard() {
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            document.getElementById('dashboardMonth').textContent = currentMonth;
            
            const currentMonthStr = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0');
            
            // Filter entries for current month
            const monthEntries = financialEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                const entryMonthStr = entryDate.getFullYear() + '-' + (entryDate.getMonth() + 1).toString().padStart(2, '0');
                return entryMonthStr === currentMonthStr;
            });
            
            // Calculate totals
            const income = monthEntries
                .filter(entry => entry.type === 'Income')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const expenses = monthEntries
                .filter(entry => entry.type === 'Expense' || entry.type === 'Payment')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const profit = income - expenses;
            
            // Update dashboard metrics
            const dashboardContainer = document.getElementById('financialDashboardContainer');
            dashboardContainer.innerHTML = `
                <div class="dashboard-metric metric-income">
                    <span>Income</span>
                    <span class="metric-value">Rs. ${income.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-expense">
                    <span>Expenses</span>
                    <span class="metric-value">Rs. ${expenses.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-profit">
                    <span>Profit</span>
                    <span class="metric-value">Rs. ${profit.toFixed(2)}</span>
                </div>
            `;
        }

        // Admin Panel Functions
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Simple authentication (in a real app, this would be more secure)
            if (username === 'admin' && password === 'admin123') {
                isAdmin = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                showNotification('Admin login successful!', 'success');
                
                // Load admin data
                loadAdminData();
            } else {
                showNotification('Invalid username or password.', 'error');
            }
        }

        function switchAdminTab(tabElement, tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('#adminPanel .tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('#adminPanel .tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
            
            // Load specific data for the tab
            if (tabId === 'manageItems') {
                loadItemsList();
                populateCategoryDropdowns();
            } else if (tabId === 'manageCategories') {
                loadCategoriesList();
            } else if (tabId === 'manageCustomers') {
                loadCustomersList();
            } else if (tabId === 'manageInvoices') {
                loadInvoiceHistory();
            } else if (tabId === 'manageFinancials') {
                loadFinancialEntries();
            }
        }

        function loadAdminData() {
            populateCategoryDropdowns();
            loadItemsList();
            loadCategoriesList();
            loadCustomersList();
            loadInvoiceHistory();
            loadFinancialEntries();
        }

        function populateCategoryDropdowns() {
            const itemCategorySelect = document.getElementById('itemCategory');
            const itemSubcategorySelect = document.getElementById('itemSubcategory');
            
            itemCategorySelect.innerHTML = '<option value="">Select Category</option>';
            itemSubcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            for (const category in categories) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                itemCategorySelect.appendChild(option);
            }
            
            itemCategorySelect.addEventListener('change', function() {
                const category = this.value;
                itemSubcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                
                if (category && categories[category]) {
                    for (const subcategory in categories[category]) {
                        const option = document.createElement('option');
                        option.value = subcategory;
                        option.textContent = subcategory;
                        itemSubcategorySelect.appendChild(option);
                    }
                }
            });
        }

        function addTierRow() {
            const container = document.getElementById('priceTiersContainer');
            const row = document.createElement('div');
            row.className = 'tier-row';
            row.innerHTML = `
                <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                <button class="btn btn-danger btn-sm" onclick="removeTierRow(this)"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(row);
        }

        function removeTierRow(button) {
            const row = button.closest('.tier-row');
            row.remove();
        }

        function saveItem() {
            const category = document.getElementById('itemCategory').value;
            const subcategory = document.getElementById('itemSubcategory').value;
            const itemName = document.getElementById('itemNameAdmin').value;
            const basePrice = parseFloat(document.getElementById('itemBasePrice').value) || 0;
            const unit = document.getElementById('itemUnit').value;
            
            if (!category || !subcategory || !itemName || basePrice <= 0 || !unit) {
                showNotification('Please fill all fields with valid values.', 'error');
                return;
            }
            
            // Collect price tiers
            const priceTiers = [];
            const tierRows = document.querySelectorAll('#priceTiersContainer .tier-row');
            
            tierRows.forEach(row => {
                const min = parseInt(row.querySelector('.tier-min').value) || 0;
                const max = parseInt(row.querySelector('.tier-max').value) || 0;
                const price = parseFloat(row.querySelector('.tier-price').value) || 0;
                
                if (min > 0 && max >= min && price > 0) {
                    priceTiers.push({ min, max, price });
                }
            });
            
            // Sort tiers by min quantity
            priceTiers.sort((a, b) => a.min - b.min);
            
            // Create or update item
            if (!categories[category]) {
                categories[category] = {};
            }
            
            if (!categories[category][subcategory]) {
                categories[category][subcategory] = {};
            }
            
            categories[category][subcategory][itemName] = {
                basePrice,
                unit,
                priceTiers: priceTiers.length > 0 ? priceTiers : undefined
            };
            
            saveData();
            
            // Update UI
            updateMainCategoryDropdown();
            loadItemsList();
            clearItemForm();
            
            showNotification('Item saved successfully!', 'success');
        }

        function clearItemForm() {
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemSubcategory').value = '';
            document.getElementById('itemNameAdmin').value = '';
            document.getElementById('itemBasePrice').value = 0;
            document.getElementById('itemUnit').value = '';
            document.getElementById('priceTiersContainer').innerHTML = `
                <div class="tier-row">
                    <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                    <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                    <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                    <button class="btn btn-danger btn-sm" onclick="removeTierRow(this)"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            currentEditingItem = null;
        }

        function loadItemsList() {
            const container = document.getElementById('itemsList');
            container.innerHTML = '';
            
            for (const category in categories) {
                for (const subcategory in categories[category]) {
                    for (const itemName in categories[category][subcategory]) {
                        const item = categories[category][subcategory][itemName];
                        const itemElement = document.createElement('div');
                        itemElement.className = 'history-item';
                        
                        let tiersInfo = '';
                        if (item.priceTiers && item.priceTiers.length > 0) {
                            tiersInfo = `<div>Price Tiers: ${item.priceTiers.map(t => `${t.min}-${t.max}: Rs. ${t.price}`).join(', ')}</div>`;
                        }
                        
                        itemElement.innerHTML = `
                            <div class="history-header">
                                <span>${itemName} (${category} > ${subcategory})</span>
                                <div>
                                    <button class="btn btn-warning btn-sm" onclick="editItem('${category}', '${subcategory}', '${itemName}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${category}', '${subcategory}', '${itemName}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            <div class="history-details">
                                <div>Base Price: Rs. ${item.basePrice.toFixed(2)} per ${item.unit}</div>
                                ${tiersInfo}
                            </div>
                        `;
                        
                        container.appendChild(itemElement);
                    }
                }
            }
        }

        function editItem(category, subcategory, itemName) {
            const item = categories[category][subcategory][itemName];
            
            document.getElementById('itemCategory').value = category;
            document.getElementById('itemSubcategory').value = subcategory;
            document.getElementById('itemNameAdmin').value = itemName;
            document.getElementById('itemBasePrice').value = item.basePrice;
            document.getElementById('itemUnit').value = item.unit;
            
            // Populate price tiers
            const tiersContainer = document.getElementById('priceTiersContainer');
            tiersContainer.innerHTML = '';
            
            if (item.priceTiers && item.priceTiers.length > 0) {
                item.priceTiers.forEach(tier => {
                    const row = document.createElement('div');
                    row.className = 'tier-row';
                    row.innerHTML = `
                        <input type="number" class="tier-min" placeholder="Min Qty" min="1" value="${tier.min}">
                        <input type="number" class="tier-max" placeholder="Max Qty" min="1" value="${tier.max}">
                        <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01" value="${tier.price}">
                        <button class="btn btn-danger btn-sm" onclick="removeTierRow(this)"><i class="fas fa-trash"></i></button>
                    `;
                    tiersContainer.appendChild(row);
                });
            } else {
                addTierRow();
            }
            
            currentEditingItem = { category, subcategory, itemName };
            
            // Scroll to item editor
            document.getElementById('manageItems').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteItem(category, subcategory, itemName) {
            if (confirm(`Are you sure you want to delete "${itemName}"?`)) {
                delete categories[category][subcategory][itemName];
                
                // If subcategory is empty, remove it
                if (Object.keys(categories[category][subcategory]).length === 0) {
                    delete categories[category][subcategory];
                }
                
                // If category is empty, remove it
                if (Object.keys(categories[category]).length === 0) {
                    delete categories[category];
                }
                
                saveData();
                updateMainCategoryDropdown();
                loadItemsList();
                
                showNotification('Item deleted successfully!', 'success');
            }
        }

        function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value;
            const subcategoryName = document.getElementById('newSubcategoryName').value;
            
            if (!categoryName || !subcategoryName) {
                showNotification('Please enter both category and subcategory names.', 'error');
                return;
            }
            
            if (!categories[categoryName]) {
                categories[categoryName] = {};
            }
            
            if (!categories[categoryName][subcategoryName]) {
                categories[categoryName][subcategoryName] = {};
            } else {
                showNotification('Subcategory already exists in this category.', 'warning');
                return;
            }
            
            saveData();
            updateMainCategoryDropdown();
            loadCategoriesList();
            
            // Clear form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newSubcategoryName').value = '';
            
            showNotification('Category added successfully!', 'success');
        }

        function loadCategoriesList() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            
            for (const category in categories) {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'history-item';
                
                let subcategoriesList = '';
                for (const subcategory in categories[category]) {
                    subcategoriesList += `<div>• ${subcategory}</div>`;
                }
                
                categoryElement.innerHTML = `
                    <div class="history-header">
                        <span>${category}</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteCategory('${category}')">
                            <i class="fas fa-trash"></i> Delete Category
                        </button>
                    </div>
                    <div class="history-details">
                        ${subcategoriesList}
                    </div>
                `;
                
                container.appendChild(categoryElement);
            }
        }

        function deleteCategory(category) {
            if (confirm(`Are you sure you want to delete the category "${category}" and all its subcategories and items?`)) {
                delete categories[category];
                saveData();
                updateMainCategoryDropdown();
                loadCategoriesList();
                
                showNotification('Category deleted successfully!', 'success');
            }
        }

        function loadCustomersList() {
            const container = document.getElementById('customersList');
            container.innerHTML = '';
            
            if (customers.length === 0) {
                container.innerHTML = '<p>No customers found.</p>';
                return;
            }
            
            customers.forEach(customer => {
                const customerElement = document.createElement('div');
                customerElement.className = 'history-item';
                
                customerElement.innerHTML = `
                    <div class="history-header">
                        <span>${customer.name}</span>
                        <span>${customer.phone || 'No phone'}</span>
                    </div>
                    <div class="history-details">
                        Created: ${new Date(customer.createdAt).toLocaleDateString()}
                    </div>
                `;
                
                container.appendChild(customerElement);
            });
        }

        function loadInvoiceHistory() {
            const container = document.getElementById('invoiceHistory');
            container.innerHTML = '';
            
            if (invoices.length === 0) {
                container.innerHTML = '<p>No invoices found.</p>';
                return;
            }
            
            invoices.forEach(invoice => {
                const invoiceElement = document.createElement('div');
                invoiceElement.className = 'history-item';
                
                invoiceElement.innerHTML = `
                    <div class="history-header">
                        <span>${invoice.invoiceNo} - ${invoice.customerName}</span>
                        <span>Rs. ${invoice.total.toFixed(2)}</span>
                    </div>
                    <div class="history-details">
                        <div>Date: ${new Date(invoice.date).toLocaleDateString()}</div>
                        <div>Balance: Rs. ${invoice.remainingBalance.toFixed(2)}</div>
                    </div>
                `;
                
                container.appendChild(invoiceElement);
            });
        }

        function loadFinancialEntries() {
            const container = document.getElementById('financialEntries');
            container.innerHTML = '';
            
            if (financialEntries.length === 0) {
                container.innerHTML = '<p>No financial entries found.</p>';
                return;
            }
            
            financialEntries.forEach(entry => {
                const entryElement = document.createElement('div');
                entryElement.className = 'history-item';
                
                const typeClass = entry.type === 'Income' ? 'sync-online' : 'sync-offline';
                
                entryElement.innerHTML = `
                    <div class="history-header">
                        <span>${entry.description}</span>
                        <span class="${typeClass}" style="padding: 5px 10px; border-radius: 4px;">${entry.type}</span>
                    </div>
                    <div class="history-details">
                        <div>Category: ${entry.category}</div>
                        <div>Amount: Rs. ${entry.amount.toFixed(2)}</div>
                        <div>Date: ${new Date(entry.date).toLocaleDateString()}</div>
                    </div>
                `;
                
                container.appendChild(entryElement);
            });
        }

        // Data Backup Functions
        function exportData() {
            const dataToExport = {
                categories,
                customers,
                invoices,
                financialEntries,
                payables,
                recentActivity,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ArhamPrinters_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Data exported successfully!', 'success');
        }

        function exportToExcel() {
            // This would convert data to Excel format
            // For now, we'll just export as JSON
            exportData();
        }
                function exportCustomerData() {
            // Create public-facing data (excluding sensitive information)
            const customerData = {
                categories: categories,
                lastUpdated: new Date().toISOString(),
                version: "1.0"
            };
            
            const dataStr = JSON.stringify(customerData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'customer-data.json';
            link.click();
            
            showNotification('Customer data exported successfully!', 'success');
        }

        async function uploadCustomerDataToOneDrive() {
            if (!isLoggedIn) {
                showNotification('Please sign in to OneDrive first.', 'error');
                return;
            }
            
            try {
                const customerData = {
                    categories: categories,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0"
                };
                
                const jsonData = JSON.stringify(customerData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                
                await uploadFileToOneDrive('customer-data.json', blob);
                showNotification('Customer data uploaded to OneDrive!', 'success');
            } catch (error) {
                console.error('Customer data upload failed:', error);
                showNotification('Failed to upload customer data.', 'error');
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to import.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate imported data structure
                    if (!importedData.categories || !importedData.customers || !importedData.invoices || 
                        !importedData.financialEntries || !importedData.payables || !importedData.recentActivity) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Replace current data with imported data
                    categories = importedData.categories;
                    customers = importedData.customers;
                    invoices = importedData.invoices;
                    financialEntries = importedData.financialEntries;
                    payables = importedData.payables;
                    recentActivity = importedData.recentActivity;
                    
                    // Save to localStorage
                    saveData();
                    
                    // Update UI
                    updateMainCategoryDropdown();
                    updateRecentActivity();
                    updateDashboard();
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    showNotification('Data imported successfully!', 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Failed to import data. Please check the file format.', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
                localStorage.clear();
                initializeApp();
                loadData();
                updateRecentActivity();
                updateDashboard();
                
                showNotification('All data has been reset.', 'info');
            }
        }
    </script>
<script>
        // =============================================
        // AZURE APP CONFIGURATION
        // =============================================
        const AZURE_CLIENT_ID = "26b3dde9-366f-487b-a485-79d1bf1ab857";
        
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: AZURE_CLIENT_ID,
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://greenshirt3.github.io/ArhamP/",
                knownAuthorities: ["https://login.microsoftonline.com/common/"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let isOnline = false;
        let currentUser = null;

        // Complete Default Data Structure
        const defaultData = {
            categories: [
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads" },
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars" },
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops" },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards" },
                { mainCategory: "Offset Paper Printing", subcategory: "Stickers" },
                { mainCategory: "Offset Paper Printing", subcategory: "Bill Books" },
                { mainCategory: "Offset Paper Printing", subcategory: "PhotoPapers" },
                { mainCategory: "Offset Paper Printing", subcategory: "weddind cards" },
                { mainCategory: "Panaflex", subcategory: "China" },
                { mainCategory: "Panaflex", subcategory: "Star" },
                { mainCategory: "Panaflex", subcategory: "Venyl" },
                { mainCategory: "Panaflex", subcategory: "One Vision" },
                { mainCategory: "Panaflex", subcategory: "Backlit" },
                { mainCategory: "Others", subcategory: "Miscellaneous" },
                { mainCategory: "Social Media Posts", subcategory: "Design Only" }
            ],
            items: [
                // Offset Paper Printing - LetterPads
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads", itemName: "LetterPads", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 40, colorCost: 0 },
                
                // Offset Paper Printing - Ishtihars
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars", itemName: "Paper Ishtihars", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars", itemName: "Art Paper Ishtihars", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Offset Paper Printing - Envelops
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops", itemName: "Envelop 9x4", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops", itemName: "Envelop 7x5", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Offset Paper Printing - Visiting Cards (Fixed Prices)
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Shine", price: 1800, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Single Side", price: 1900, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Double Side", price: 2500, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Panaflex - China
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x2", price: 140, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x3", price: 210, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x4", price: 280, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Social Media Posts
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Facebook Post", price: 300, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Instagram Post", price: 400, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 }
            ],
            sizes: {
                "A4/2 68g": 625,
                "A4 68g": 1250,
                "A4/4 68g": 312.5,
                "Legal 100g": 3600,
                "A4 Art Paper 113g": 3700,
                "News Paper 9x3.5": 400
            },
            colors: {
                "1": 700,
                "2": 1400,
                "3": 2100,
                "4": 2800,
                "Blue": 850,
                "Green": 850,
                "Brown": 850
            },
            settings: {
                rent: 200,
                profitMargin: 25,
                defaultBinding: 40
            }
        };

        let data = JSON.parse(JSON.stringify(defaultData));
        let calculationHistory = [];
        const ADMIN_PASSWORD = "admin123";

        // =============================================
        // CUSTOMER DATA EXPORT FOR GITHUB SYNC
        // =============================================

        // Export data for customer sync
        function exportCustomerDataForGitHub() {
            const customerData = {
                categories: data.categories,
                items: data.items,
                sizes: data.sizes,
                colors: data.colors,
                settings: data.settings,
                lastUpdated: new Date().toISOString()
            };
            
            // Create a downloadable JSON file
            const blob = new Blob([JSON.stringify(customerData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'customer-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Customer data exported! Upload this file to GitHub to update customer prices.');
        }

        // =============================================
        // ONEDRIVE CLOUD SYNC FUNCTIONS
        // =============================================

        async function loginToOneDrive() {
            try {
                const loginRequest = {
                    scopes: ["User.Read", "Files.ReadWrite.All"],
                    prompt: "select_account"
                };
                
                const response = await msalInstance.loginPopup(loginRequest);
                currentUser = response.account;
                isOnline = true;
                
                updateUIAfterLogin();
                await checkOneDriveFile();
                
            } catch (error) {
                console.error("Login failed:", error);
                alert("Login failed. Please try again. Error: " + error.message);
            }
        }

        async function logoutFromOneDrive() {
            try {
                await msalInstance.logoutPopup();
                currentUser = null;
                isOnline = false;
                updateUIAfterLogout();
                alert("Successfully signed out from OneDrive.");
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'inline-flex';
            document.getElementById('downloadBtn').style.display = 'inline-flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('syncStatus').className = 'sync-status sync-online';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Online - Connected to OneDrive';
        }

        function updateUIAfterLogout() {
            document.getElementById('loginBtn').style.display = 'inline-flex';
            document.getElementById('syncBtn').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncStatus').className = 'sync-status sync-offline';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Offline Mode - Data stored locally';
        }

        async function getAccessToken() {
            const request = {
                scopes: ["Files.ReadWrite.All"],
                account: currentUser
            };
            
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                console.error("Token acquisition failed:", error);
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (popupError) {
                    console.error("Popup token acquisition failed:", popupError);
                    return null;
                }
            }
        }

        async function checkOneDriveFile() {
            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.status === 200) {
                    if (confirm('Cloud data found! Do you want to download and replace your local data?')) {
                        await syncFromCloud();
                    }
                } else {
                    if (confirm('No cloud data found. Do you want to upload your current data to OneDrive?')) {
                        await syncToCloud();
                    }
                }
            } catch (error) {
                console.error("Error checking OneDrive file:", error);
            }
        }

        async function syncToCloud() {
            if (!isOnline || !currentUser) {
                alert("Please sign in to sync with OneDrive");
                return;
            }

            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const allData = {
                    calculatorData: data,
                    history: calculationHistory,
                    lastSync: new Date().toISOString(),
                    syncDevice: navigator.userAgent
                };

                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(allData)
                    }
                );

                if (response.ok) {
                    alert('✅ Data successfully synced to OneDrive!');
                } else {
                    throw new Error('Failed to upload to OneDrive');
                }
            } catch (error) {
                console.error("Sync failed:", error);
                alert('❌ Failed to sync data to OneDrive: ' + error.message);
            }
        }

        async function syncFromCloud() {
            if (!isOnline || !currentUser) {
                alert("Please sign in to sync with OneDrive");
                return;
            }

            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const cloudData = await response.json();
                    
                    if (confirm('Do you want to replace your local data with cloud data?')) {
                        data = cloudData.calculatorData || data;
                        calculationHistory = cloudData.history || calculationHistory;
                        
                        saveAllData();
                        refreshAllDisplays();
                        refreshDataTables();
                        
                        alert('✅ Data successfully synced from OneDrive!');
                    }
                } else {
                    throw new Error('Failed to download from OneDrive');
                }
            } catch (error) {
                console.error("Sync failed:", error);
                alert('❌ Failed to sync data from OneDrive: ' + error.message);
            }
        }

        // =============================================
        // CORE APPLICATION FUNCTIONS
        // =============================================

        // Auto-save function with cloud sync
        function saveAllData() {
            localStorage.setItem('arhamPrintersData', JSON.stringify(data));
            localStorage.setItem('arhamPrintersHistory', JSON.stringify(calculationHistory));
            
            if (isOnline && currentUser) {
                setTimeout(() => {
                    syncToCloud().catch(error => {
                        console.error("Auto-sync failed:", error);
                    });
                }, 1000);
            }
        }

        // Initialize MSAL and check for existing session
        msalInstance.initialize().then(() => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentUser = accounts[0];
                isOnline = true;
                updateUIAfterLogin();
            }
            
            loadAllData();
            setupEventListeners();
            refreshAllDisplays();
        });

        // Load data from localStorage
        function loadAllData() {
            const savedData = localStorage.getItem('arhamPrintersData');
            const savedHistory = localStorage.getItem('arhamPrintersHistory');
            
            if (savedData) {
                try {
                    data = JSON.parse(savedData);
                } catch (e) {
                    console.error("Error loading data:", e);
                    data = JSON.parse(JSON.stringify(defaultData));
                }
            }
            
            if (savedHistory) {
                try {
                    calculationHistory = JSON.parse(savedHistory);
                } catch (e) {
                    console.error("Error loading history:", e);
                    calculationHistory = [];
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (!this.classList.contains('active')) {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                        
                        if (this.dataset.tab === 'data-management') {
                            refreshDataTables();
                        } else if (this.dataset.tab === 'history') {
                            updateHistoryDisplay();
                        } else if (this.dataset.tab === 'settings') {
                            loadSettings();
                        }
                    }
                });
            });
            
            document.getElementById('mainCategory').addEventListener('change', updateSubcategories);
            document.getElementById('subCategory').addEventListener('change', updateItemsAndFields);
        }

        // Refresh all UI displays
        function refreshAllDisplays() {
            updateMainCategories();
            updateSubcategories();
            updateItemsAndFields();
            updateSizesDropdown();
            updateColorsDropdown();
        }

        // Update main categories dropdown
        function updateMainCategories() {
            const mainSelect = document.getElementById('mainCategory');
            mainSelect.innerHTML = '<option value="">Select Main Category</option>';
            
            const mainCategories = [...new Set(data.categories.map(cat => cat.mainCategory))];
            mainCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                mainSelect.appendChild(option);
            });
        }

        // Update subcategories dropdown
        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subSelect = document.getElementById('subCategory');
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (!mainCategory) return;
            
            const subcategories = [...new Set(
                data.categories
                    .filter(cat => cat.mainCategory === mainCategory)
                    .map(cat => cat.subcategory)
            )];
            
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subSelect.appendChild(option);
            });
            
            updateItemsAndFields();
        }

        // Update items dropdown and field visibility
        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subcategory) {
                const items = data.items.filter(
                    item => item.mainCategory === mainCategory && item.subcategory === subcategory
                );
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemName;
                    option.textContent = item.itemName;
                    itemSelect.appendChild(option);
                });
            }
            
            const offsetFields = document.getElementById('offsetFields');
            if (mainCategory === "Offset Paper Printing" && 
                ["LetterPads", "Ishtihars", "Bill Books"].includes(subcategory)) {
                offsetFields.style.display = 'block';
            } else {
                offsetFields.style.display = 'none';
            }
        }

        // Update sizes dropdown
        function updateSizesDropdown() {
            const sizeSelect = document.getElementById('size');
            sizeSelect.innerHTML = '<option value="">Select Size</option>';
            
            for (let size in data.sizes) {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            }
        }

        // Update colors dropdown
        function updateColorsDropdown() {
            const colorSelect = document.getElementById('color');
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            
            for (let color in data.colors) {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            }
        }

        // Calculate price
        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!mainCategory || !subcategory || !itemName) {
                alert("Please select all required fields");
                return;
            }
            
            const item = data.items.find(i => 
                i.mainCategory === mainCategory && 
                i.subcategory === subcategory && 
                i.itemName === itemName
            );
            
            if (!item) {
                document.getElementById('result').textContent = "Item not found";
                document.getElementById('result').style.display = 'block';
                return;
            }
            
            let basePrice = 0;
            let breakdown = [];
            
            if (item.type === "fixed") {
                basePrice = item.price;
                breakdown.push(`Item Price: Rs. ${basePrice}`);
            } else {
                const size = document.getElementById('size').value;
                const color = document.getElementById('color').value;
                
                if (!size || !color) {
                    alert("Please select size and color for this item");
                    return;
                }
                
                const paperCost = data.sizes[size] || item.paperCost || 0;
                const bindingCost = item.bindingCost || data.settings.defaultBinding || 0;
                const colorCost = data.colors[color] || item.colorCost || 0;
                
                basePrice = paperCost + bindingCost + colorCost + data.settings.rent;
                
                breakdown.push(`Paper Cost: Rs. ${paperCost}`);
                if (bindingCost > 0) breakdown.push(`Binding Cost: Rs. ${bindingCost}`);
                breakdown.push(`Color Cost: Rs. ${colorCost}`);
                breakdown.push(`Rent: Rs. ${data.settings.rent}`);
                breakdown.push(`Base Cost: Rs. ${basePrice}`);
            }
            
            if (item.designCharges > 0) {
                breakdown.push(`Design Charges: Rs. ${item.designCharges}`);
                basePrice += item.designCharges;
            }
            
            const subtotal = basePrice * quantity;
            const profit = subtotal * (data.settings.profitMargin / 100);
            const total = subtotal + profit;
            
            breakdown.push(`Quantity: ${quantity}`);
            breakdown.push(`Subtotal: Rs. ${Math.round(subtotal)}`);
            breakdown.push(`Profit (${data.settings.profitMargin}%): Rs. ${Math.round(profit)}`);
            breakdown.push(`Total: Rs. ${Math.round(total)}`);
            
            document.getElementById('result').textContent = `Total Price: Rs. ${Math.round(total)}`;
            document.getElementById('result').style.display = 'block';
            
            document.getElementById('breakdownContent').innerHTML = breakdown.map(item => 
                `<div class="breakdown-item">${item}</div>`
            ).join('');
            document.getElementById('priceBreakdown').style.display = 'block';
            
            addToHistory({
                mainCategory,
                subcategory,
                itemName,
                quantity,
                designCharges: item.designCharges || 0,
                total: Math.round(total),
                timestamp: new Date().toLocaleString()
            });
        }

        // Add to history
        function addToHistory(calculation) {
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            saveAllData();
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<p>No calculations yet</p>';
                return;
            }
            
            historyList.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div class="history-header">
                        <span>${calc.itemName}</span>
                        <span>Rs. ${calc.total}</span>
                    </div>
                    <div class="history-details">
                        ${calc.mainCategory} > ${calc.subcategory} | Qty: ${calc.quantity} | 
                        Design: Rs. ${calc.designCharges} | ${calc.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all calculation history?')) {
                calculationHistory = [];
                saveAllData();
                updateHistoryDisplay();
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('size').value = '';
            document.getElementById('color').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
        }

        // Export to Excel
        function exportToExcel() {
            const main = document.getElementById('mainCategory').value;
            const sub = document.getElementById('subCategory').value;
            const item = document.getElementById('itemName').value;
            const qty = parseInt(document.getElementById('quantity').value) || 1;
            const result = document.getElementById('result').textContent;
            
            const exportData = [
                ['Arham Printers - Price Calculation'],
                ['Main Category', main],
                ['Subcategory', sub],
                ['Item', item],
                ['Quantity', qty],
                [result],
                ['Exported on', new Date().toLocaleString()],
                ['Synced with OneDrive', isOnline ? 'Yes' : 'No']
            ];
            
            let csvContent = 'data:text/csv;charset=utf-8,';
            exportData.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\r\n';
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'arham_printers_quote.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =============================================
        // ADMIN PANEL FUNCTIONS
        // =============================================

        function toggleAdmin() {
            const input = document.getElementById('adminPassword').value;
            if (input === ADMIN_PASSWORD) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                refreshDataTables();
                updateHistoryDisplay();
                loadSettings();
            } else {
                alert('Incorrect admin password');
            }
        }

        // Load settings
        function loadSettings() {
            document.getElementById('rentCost').value = data.settings.rent;
            document.getElementById('profitMargin').value = data.settings.profitMargin;
            document.getElementById('defaultBinding').value = data.settings.defaultBinding;
        }

        // Save settings
        function saveSettings() {
            data.settings.rent = parseFloat(document.getElementById('rentCost').value);
            data.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value);
            data.settings.defaultBinding = parseFloat(document.getElementById('defaultBinding').value);
            saveAllData();
            alert('Settings saved successfully!');
        }

        // Data Management Functions
        function addNewItem() {
            const mainCategory = document.getElementById('newMainCategory').value.trim();
            const subCategory = document.getElementById('newSubCategory').value.trim();
            const itemName = document.getElementById('newItemName').value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value) || 0;
            const type = document.getElementById('newItemType').value;
            const designCharges = parseFloat(document.getElementById('newDesignCharges').value) || 0;
            const paperCost = parseFloat(document.getElementById('newPaperCost').value) || 0;
            const bindingCost = parseFloat(document.getElementById('newBindingCost').value) || 0;
            const colorCost = parseFloat(document.getElementById('newColorCost').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!data.categories.some(cat => cat.mainCategory === mainCategory && cat.subcategory === subCategory)) {
                data.categories.push({ mainCategory, subcategory: subCategory });
            }
            
            data.items.push({
                mainCategory,
                subcategory: subCategory,
                itemName,
                price,
                type,
                designCharges,
                paperCost,
                bindingCost,
                colorCost
            });
            
            document.getElementById('newMainCategory').value = '';
            document.getElementById('newSubCategory').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '0';
            document.getElementById('newDesignCharges').value = '0';
            document.getElementById('newPaperCost').value = '0';
            document.getElementById('newBindingCost').value = '0';
            document.getElementById('newColorCost').value = '0';
            
            refreshDataTables();
            refreshAllDisplays();
            saveAllData();
            alert('Item added successfully!');
        }

        function addNewSize() {
            const sizeName = document.getElementById('newSizeName').value.trim();
            const paperCost = parseFloat(document.getElementById('newSizePaper').value) || 0;
            
            if (!sizeName) {
                alert('Please enter a size name');
                return;
            }
            
            data.sizes[sizeName] = paperCost;
            
            document.getElementById('newSizeName').value = '';
            document.getElementById('newSizePaper').value = '0';
            
            refreshDataTables();
            updateSizesDropdown();
            saveAllData();
            alert('Size added successfully!');
        }

        function addNewColor() {
            const colorName = document.getElementById('newColorName').value.trim();
            const colorCost = parseFloat(document.getElementById('newColorCost').value) || 0;
            
            if (!colorName) {
                alert('Please enter a color name');
                return;
            }
            
            data.colors[colorName] = colorCost;
            
            document.getElementById('newColorName').value = '';
            document.getElementById('newColorCost').value = '0';
            
            refreshDataTables();
            updateColorsDropdown();
            saveAllData();
            alert('Color added successfully!');
        }

        // Refresh data tables
        function refreshDataTables() {
            const itemsTable = document.getElementById('itemsTable');
            itemsTable.innerHTML = '';
            
            data.items.forEach((item, index) => {
                const row = itemsTable.insertRow();
                row.innerHTML = `
                    <td>${item.mainCategory}</td>
                    <td>${item.subcategory}</td>
                    <td>${item.itemName}</td>
                    <td><input type="number" value="${item.price}" onchange="data.items[${index}].price=parseFloat(this.value); saveAllData();"></td>
                    <td>${item.type}</td>
                    <td><input type="number" value="${item.designCharges}" onchange="data.items[${index}].designCharges=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.paperCost}" onchange="data.items[${index}].paperCost=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.bindingCost}" onchange="data.items[${index}].bindingCost=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.colorCost}" onchange="data.items[${index}].colorCost=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            const sizesTable = document.getElementById('sizesTable');
            sizesTable.innerHTML = '';
            
            for (let sizeName in data.sizes) {
                const row = sizesTable.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${sizeName}" onchange="renameSize('${sizeName}', this.value)"></td>
                    <td><input type="number" value="${data.sizes[sizeName]}" onchange="data.sizes['${sizeName}']=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteSize('${sizeName}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }
            
            const colorsTable = document.getElementById('colorsTable');
            colorsTable.innerHTML = '';
            
            for (let colorName in data.colors) {
                const row = colorsTable.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${colorName}" onchange="renameColor('${colorName}', this.value)"></td>
                    <td><input type="number" value="${data.colors[colorName]}" onchange="data.colors['${colorName}']=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteColor('${colorName}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                data.items.splice(index, 1);
                refreshDataTables();
                refreshAllDisplays();
                saveAllData();
            }
        }

        function deleteSize(sizeName) {
            if (confirm('Are you sure you want to delete this size?')) {
                delete data.sizes[sizeName];
                refreshDataTables();
                updateSizesDropdown();
                saveAllData();
            }
        }

        function deleteColor(colorName) {
            if (confirm('Are you sure you want to delete this color?')) {
                delete data.colors[colorName];
                refreshDataTables();
                updateColorsDropdown();
                saveAllData();
            }
        }

        function renameSize(oldName, newName) {
            if (oldName !== newName && newName.trim() !== '') {
                data.sizes[newName] = data.sizes[oldName];
                delete data.sizes[oldName];
                refreshDataTables();
                updateSizesDropdown();
                saveAllData();
            }
        }

        function renameColor(oldName, newName) {
            if (oldName !== newName && newName.trim() !== '') {
                data.colors[newName] = data.colors[oldName];
                delete data.colors[oldName];
                refreshDataTables();
                updateColorsDropdown();
                saveAllData();
            }
        }

        // =============================================
        // IMPORT/EXPORT FUNCTIONS
        // =============================================

        function exportAllData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Export Items
                csvContent += 'ITEMS DATA\r\n';
                csvContent += 'mainCategory,subcategory,itemName,price,type,designCharges,paperCost,bindingCost,colorCost\r\n';
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                // Export Sizes
                csvContent += '\r\nSIZES DATA\r\n';
                csvContent += 'sizeName,paperCost\r\n';
                for (let sizeName in data.sizes) {
                    csvContent += `"${sizeName}",${data.sizes[sizeName]}\r\n`;
                }
                
                // Export Colors
                csvContent += '\r\nCOLORS DATA\r\n';
                csvContent += 'colorName,colorCost\r\n';
                for (let colorName in data.colors) {
                    csvContent += `"${colorName}",${data.colors[colorName]}\r\n`;
                }
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_all_data.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        function exportItemsData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'mainCategory,subcategory,itemName,price,type,designCharges,paperCost,bindingCost,colorCost\r\n';
                
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_items.csv');
                link.click();
                document.body.removeChild(link);
                
                alert('Items exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting items: ' + error.message);
            }
        }

        function importData() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    processCSVData(csvData);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }

        function processCSVData(csvData) {
            try {
                const lines = csvData.split('\n').filter(line => line.trim() !== '');
                let currentSection = '';
                let itemsImported = 0;
                let sizesImported = 0;
                let colorsImported = 0;
                
                const replaceData = confirm('Do you want to REPLACE all existing data with imported data? Click OK to replace, Cancel to merge with existing data.');
                
                if (replaceData) {
                    data.items = [];
                    data.sizes = {};
                    data.colors = {};
                    data.categories = [];
                }
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') continue;
                    
                    if (line === 'ITEMS DATA') {
                        currentSection = 'items';
                        continue;
                    } else if (line === 'SIZES DATA') {
                        currentSection = 'sizes';
                        continue;
                    } else if (line === 'COLORS DATA') {
                        currentSection = 'colors';
                        continue;
                    }
                    
                    if (line.includes('mainCategory,subcategory') || 
                        line.includes('sizeName,paperCost') || 
                        line.includes('colorName,colorCost')) {
                        continue;
                    }
                    
                    const values = line.split(',').map(value => {
                        return value.replace(/^"(.*)"$/, '$1').trim();
                    });
                    
                    if (currentSection === 'items' && values.length >= 3) {
                        const item = {
                            mainCategory: values[0] || '',
                            subcategory: values[1] || '',
                            itemName: values[2] || '',
                            price: parseFloat(values[3]) || 0,
                            type: values[4] || 'fixed',
                            designCharges: parseFloat(values[5]) || 0,
                            paperCost: parseFloat(values[6]) || 0,
                            bindingCost: parseFloat(values[7]) || 0,
                            colorCost: parseFloat(values[8]) || 0
                        };
                        
                        if (item.mainCategory && item.subcategory) {
                            const categoryExists = data.categories.some(
                                cat => cat.mainCategory === item.mainCategory && cat.subcategory === item.subcategory
                            );
                            
                            if (!categoryExists) {
                                data.categories.push({
                                    mainCategory: item.mainCategory,
                                    subcategory: item.subcategory
                                });
                            }
                        }
                        
                        const existingItemIndex = data.items.findIndex(
                            existing => existing.mainCategory === item.mainCategory && 
                                       existing.subcategory === item.subcategory && 
                                       existing.itemName === item.itemName
                        );
                        
                        if (existingItemIndex !== -1) {
                            data.items[existingItemIndex] = item;
                        } else {
                            data.items.push(item);
                        }
                        
                        itemsImported++;
                        
                    } else if (currentSection === 'sizes' && values.length >= 2) {
                        const sizeName = values[0];
                        const paperCost = parseFloat(values[1]) || 0;
                        
                        if (sizeName) {
                            data.sizes[sizeName] = paperCost;
                            sizesImported++;
                        }
                        
                    } else if (currentSection === 'colors' && values.length >= 2) {
                        const colorName = values[0];
                        const colorCost = parseFloat(values[1]) || 0;
                        
                        if (colorName) {
                            data.colors[colorName] = colorCost;
                            colorsImported++;
                        }
                    }
                }
                
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                
                alert(`Data imported successfully!\n\nItems: ${itemsImported}\nSizes: ${sizesImported}\nColors: ${colorsImported}\n\nTotal categories: ${data.categories.length}`);
                
                document.getElementById('csvFile').value = '';
                
            } catch (error) {
                console.error('Process CSV error:', error);
                alert('Error processing CSV file: ' + error.message);
            }
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset all data to default? This cannot be undone.')) {
                data = JSON.parse(JSON.stringify(defaultData));
                calculationHistory = [];
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                alert('Data reset to default values!');
            }
        }

        // Initialize the application
        window.onload = function() {
            console.log('Arham Printers Complete Calculator loaded successfully!');
        };
    </script><script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script></body>
</html>
