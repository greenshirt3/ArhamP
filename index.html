<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #0078d4;
            --secondary-light: #1088e4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #0078d4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #1088e4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        /* New Navigation Tabs */
        .main-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-light);
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: 2px solid transparent;
            background: var(--light);
            color: var(--primary);
        }
        
        .nav-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
            box-shadow: 0 4px 10px rgba(0, 120, 212, 0.3);
        }
        
        .nav-btn:hover:not(.active) {
            background: var(--light);
            color: var(--secondary);
            border-color: var(--secondary);
        }

        /* View Containers */
        .app-view {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .app-view.active {
            display: block;
        }
        
        /* SCROLLABLE CONTENT WRAPPER */
        .scrollable-list-wrapper {
            max-height: 400px; /* Max height for scrollable lists */
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 10px;
            background: #fff;
        }
        /* END SCROLLABLE CONTENT WRAPPER */


        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 30px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #dff6dd;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fff4ce;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .sync-pending {
            background: #e1f5fe;
            color: var(--secondary);
            border: 2px solid var(--secondary);
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .auto-sync-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0e6b0e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e6a200; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c02a2e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions, .supplier-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion, .item-suggestion, .supplier-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover, .item-suggestion:hover, .supplier-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }
        
        .invoice-item-suggestion-container {
            position: relative;
        }

        /* Financial Hub Styling */
        .dashboard-metric {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
            flex: 1 1 30%;
        }
        
        .dashboard-metric span {
            display: block;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .metric-income {
            border-color: var(--success);
            background-color: #e6f4ea;
        }
        
        .metric-expense {
            border-color: var(--danger);
            background-color: #fde2e2;
        }
        
        .metric-profit {
            border-color: var(--secondary);
            background-color: #e8f0fe;
        }
        
        .metric-net {
            border-color: var(--warning);
            background-color: #fff8e1;
        }
        
        /* New Dashboard Overview Grid */
        .dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Invoice Payment Modal/Section Styling */
        #paymentModal {
            padding: 20px;
            background: #ffe0b2;
            border: 2px solid var(--warning);
            border-radius: var(--border-radius);
            margin-top: 20px;
        }
        
        /* Item Editor Specific Styles */
        #itemEditor {
            border-top: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tier-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .tier-row input {
            padding: 8px;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Print Media Queries for Invoice */
        @media print {
            body > *:not(.print-invoice-view) {
                display: none !important;
            }
            .print-invoice-view {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .print-invoice-view .container, 
            .print-invoice-view .section-panel {
                box-shadow: none !important;
                border: none !important;
                padding: 0;
            }
            .print-invoice-view .actions, 
            .print-invoice-view .form-group,
            .print-invoice-view #invoicePaymentSection,
            .print-invoice-view #invoiceDataTabs {
                display: none;
            }
            /* Add Shop Info to Print View */
            .print-invoice-view header {
                display: block;
                border-bottom: 2px solid #000;
                margin-bottom: 15px;
            }
            .print-invoice-view header h1 {
                -webkit-text-fill-color: var(--primary);
                color: var(--primary);
            }

            .items-table th, .items-table td {
                padding: 8px;
            }
            .items-table input, .totals-section input {
                border: none;
                background: transparent;
                padding: 0;
            }
            .invoice-customer-info div {
                display: flex;
                justify-content: space-between;
                width: 100%;
                margin-bottom: 5px;
                border-bottom: 1px solid #ccc;
            }
        }


        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .dashboard-grid {
                flex-direction: column;
            }
            .dashboard-metric {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn, .nav-btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Financial Management</p>
        </header>

        <nav class="main-nav">
            <button class="nav-btn active" data-view="calculatorView" onclick="switchView('calculatorView', this)">
                <i class="fas fa-calculator"></i> Calculator
            </button>
            <button class="nav-btn" data-view="invoiceView" onclick="switchView('invoiceView', this)">
                <i class="fas fa-file-invoice-dollar"></i> Invoice
            </button>
            <button class="nav-btn" data-view="inventoryView" onclick="switchView('inventoryView', this)">
                <i class="fas fa-warehouse"></i> Inventory
            </button>
            <button class="nav-btn" data-view="financialView" onclick="switchView('financialView', this)">
                <i class="fas fa-chart-line"></i> Financial Hub
            </button>
            <button class="nav-btn" data-view="adminView" onclick="switchView('adminView', this)" id="adminNavBtn">
                <i class="fas fa-cogs"></i> Admin
            </button>
        </nav>

        <div id="calculatorView" class="app-view active">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory" onchange="updateSubcategories()">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory" onchange="updateItemsAndFields()"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName" onchange="updateQuantityInput()"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantityInputContainer"><i class="fas fa-boxes"></i> Quantity / Set:</label>
                    <div id="quantityInputContainer" style="flex: 2;">
                        <input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">
                    </div>
                </div>
                
                <div class="form-group" id="priceTierTagGroup" style="margin-top: -10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f9f9f9; display: none;">
                    <label><i class="fas fa-tag"></i> Selected Set:</label>
                    <span id="priceTierTag" style="font-weight: bold; color: var(--danger);">Select a set.</span>
                </div>
                
                <div class="form-group">
                    <label for="designCharges"><i class="fas fa-paint-brush"></i> Design Charges (Rs.):</label>
                    <input type="number" id="designCharges" value="0" min="0" step="0.01">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <h4>Today's Summary</h4>
                <div id="dailyDashboardContainer" class="dashboard-grid"></div>
                
                <h4>Monthly Summary</h4>
                <div id="monthlyDashboardContainer" class="dashboard-grid"></div>
            </div>
        </div>

        <div id="invoiceView" class="app-view">
            
            <div class="tabs" id="invoiceDataTabs">
                <div class="tab active" onclick="switchInvoiceTab(this, 'newInvoiceSection')">Create New Invoice</div>
                <div class="tab" onclick="switchInvoiceTab(this, 'invoicePaymentSection')">Customer Payment Ledger</div>
                <div class="tab" onclick="switchInvoiceTab(this, 'previousInvoicesSection')">View Previous Invoices</div>
            </div>

            <div class="section-panel print-invoice-view" id="newInvoiceSection">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Create Invoice</h2>

                <div id="invoiceCustomerInfo" class="invoice-customer-info" style="display: none; margin-bottom: 20px;"></div>
                
                <div>
                    <div class="form-group">
                        <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                        <div class="suggestion-container">
                            <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off">
                            <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                        <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number" list="customerPhoneList">
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                        <input type="text" id="invoiceNo" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                        <input type="date" id="invoiceDate">
                    </div>

                    <h3>Invoice Items</h3>
                    <div class="scrollable-list-wrapper" style="max-height: 300px; padding: 0;">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Rate (Rs.)</th>
                                    <th>Qty</th>
                                    <th>Design Charges (Rs.)</th>
                                    <th>Amount</th>
                                    <th style="width: 50px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <tr>
                                    <td>
                                        <div class="invoice-item-suggestion-container">
                                            <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" oninput="showItemSuggestions(this)">
                                            <div class="item-suggestions" style="display: none;"></div>
                                        </div>
                                    </td>
                                    <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                                    <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                                    <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                                    <td><input type="number" class="item-amount" value="0" readonly></td>
                                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" onclick="addInvoiceItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                        <button class="btn btn-secondary" onclick="calculateTotal()">
                            <i class="fas fa-calculator"></i> Recalculate
                        </button>
                    </div>

                    <div class="totals-section">
                        <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                        
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>Rs. <span id="subtotalAmount">0.00</span></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="taxRate">Tax Rate (%):</label>
                            <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                        </div>
                        
                        <div class="total-row">
                            <span><strong>Total Amount:</strong></span>
                            <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="previousBalance">Previous Balance (Rs.):</label>
                            <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                        </div>
                        
                        <div class="form-group">
                            <label for="payment">Payment Received (Rs.):</label>
                            <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                        </div>
                        
                        <div class="total-row">
                            <span><strong>Remaining Balance:</strong></span>
                            <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-primary" onclick="saveInvoice()">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                        <button class="btn btn-secondary" onclick="printInvoice(null)">
                            <i class="fas fa-print"></i> Print Preview
                        </button>
                        <button class="btn btn-warning" onclick="clearInvoice()">
                            <i class="fas fa-trash"></i> Clear Invoice Form
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="section-panel" id="invoicePaymentSection" style="display: none;">
                <h3><i class="fas fa-hand-holding-usd"></i> Customer Payment Ledger</h3>
                <div class="form-group">
                    <label for="paymentCustomerSearch"><i class="fas fa-user-tag"></i> Customer Name:</label>
                    <div class="suggestion-container">
                        <input type="text" id="paymentCustomerSearch" placeholder="Search customer for payment..." autocomplete="off">
                        <div id="paymentCustomerSuggestions" class="customer-suggestions" style="display: none;"></div>
                    </div>
                </div>
                
                <div id="customerInvoicesList" class="scrollable-list-wrapper" style="margin-top: 15px;">
                    <p>Search for a customer to view their pending invoices.</p>
                </div>

                <div id="invoicePaymentInput" style="display: none; border-top: 2px solid #ccc; padding-top: 15px;">
                    <h4><i class="fas fa-money-check-alt"></i> Record Payment for Invoice <span id="selectedInvoiceNo"></span></h4>
                    <div class="form-group">
                        <label for="paymentAmountInput">Payment Amount (Rs.):</label>
                        <input type="number" id="paymentAmountInput" value="0" min="0" step="0.01">
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="recordInvoicePayment()">
                            <i class="fas fa-receipt"></i> Record Payment
                        </button>
                    </div>
                </div>
            </div>

            <div class="section-panel" id="previousInvoicesSection" style="display: none;">
                <h3><i class="fas fa-history"></i> Previous Invoices and Customer Ledger</h3>
                <div id="previousInvoicesList" class="scrollable-list-wrapper">
                    </div>
            </div>
        </div>

        <div id="inventoryView" class="app-view">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-warehouse"></i> Inventory & Purchase Management</h2>

                <div class="tabs">
                    <div class="tab active" onclick="switchInventoryTab(this, 'newPurchaseSection')">New Purchase</div>
                    <div class="tab" onclick="switchInventoryTab(this, 'supplierLedgerSection')">Supplier Ledger</div>
                    <div class="tab" onclick="switchInventoryTab(this, 'inventoryStockSection')">Inventory Stock</div>
                </div>
                
                <div id="newPurchaseSection" class="tab-content active">
                    <h3><i class="fas fa-file-invoice"></i> Create Purchase Invoice</h3>
                    
                    <div class="form-group">
                        <label for="purchaseSupplierName"><i class="fas fa-truck"></i> Supplier Name:</label>
                        <div class="suggestion-container">
                            <input type="text" id="purchaseSupplierName" placeholder="Start typing supplier name..." autocomplete="off">
                            <div id="supplierSuggestions" class="supplier-suggestions" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="purchaseDate"><i class="fas fa-calendar"></i> Purchase Date:</label>
                        <input type="date" id="purchaseDate">
                    </div>

                    <h3>Materials/Goods Purchased</h3>
                    <div class="scrollable-list-wrapper" style="max-height: 250px; padding: 0;">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Material Name</th>
                                    <th>Cost/Unit (Rs.)</th>
                                    <th>Qty</th>
                                    <th>Amount</th>
                                    <th style="width: 50px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseItemsTableBody">
                                <tr>
                                    <td>
                                        <div class="invoice-item-suggestion-container">
                                            <input type="text" class="purchase-item-name" placeholder="e.g., A4 Paper, Ink Cartridge" oninput="showPurchaseItemSuggestions(this)">
                                            <div class="item-suggestions" style="display: none;"></div>
                                        </div>
                                    </td>
                                    <td><input type="number" class="purchase-item-cost" value="0" min="0" step="0.01" oninput="calculatePurchaseTotal()"></td>
                                    <td><input type="number" class="purchase-item-quantity" value="1" min="1" oninput="calculatePurchaseTotal()"></td>
                                    <td><input type="number" class="purchase-item-amount" value="0" readonly></td>
                                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removePurchaseItem(this)"><i class="fas fa-trash"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="addPurchaseItem()">
                            <i class="fas fa-plus"></i> Add Material
                        </button>
                        <button class="btn btn-secondary" onclick="calculatePurchaseTotal()">
                            <i class="fas fa-calculator"></i> Recalculate
                        </button>
                    </div>

                    <div class="totals-section">
                        <h3 class="section-title"><i class="fas fa-calculator"></i> Purchase Totals</h3>
                        <div class="total-row"><span>Purchase Subtotal:</span><span>Rs. <span id="purchaseSubtotalAmount">0.00</span></span></div>
                        <div class="total-row"><span>Total Payable:</span><span>Rs. <span id="purchaseTotalAmount">0.00</span></span></div>
                        
                        <div class="form-group">
                            <label for="supplierPreviousBalance">Previous Payable (Rs.):</label>
                            <input type="number" id="supplierPreviousBalance" value="0" min="0" step="0.01" oninput="calculatePurchaseTotal()">
                        </div>
                        <div class="form-group">
                            <label for="purchasePayment">Payment Made Now (Rs.):</label>
                            <input type="number" id="purchasePayment" value="0" min="0" step="0.01" oninput="calculatePurchaseTotal()">
                        </div>
                        
                        <div class="total-row">
                            <span><strong>Remaining Payable:</strong></span>
                            <span><strong>Rs. <span id="purchaseRemainingPayable">0.00</span></strong></span>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" onclick="savePurchaseInvoice()">
                            <i class="fas fa-save"></i> Save Purchase
                        </button>
                    </div>
                </div>

                <div id="supplierLedgerSection" class="tab-content" style="display: none;">
                    <h3><i class="fas fa-clipboard-list"></i> Supplier Ledger</h3>
                    <div class="form-group">
                        <label for="ledgerSupplierSearch"><i class="fas fa-user-tag"></i> Supplier Name:</label>
                        <div class="suggestion-container">
                            <input type="text" id="ledgerSupplierSearch" placeholder="Search supplier ledger..." autocomplete="off" oninput="setupLedgerSupplierSearch()">
                            <div id="ledgerSupplierSuggestions" class="supplier-suggestions" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <div id="supplierLedgerOutput" class="scrollable-list-wrapper" style="margin-top: 15px;">
                        <p>Search for a supplier to view their purchase history and outstanding balance.</p>
                    </div>
                </div>

                <div id="inventoryStockSection" class="tab-content" style="display: none;">
                    <h3><i class="fas fa-boxes"></i> Current Material Stock</h3>
                    <div id="inventoryStockList" class="scrollable-list-wrapper">
                        <p>Loading stock data...</p>
                    </div>
                </div>

            </div>
        </div>


        <div id="financialView" class="app-view">
            <div class="section-panel" id="FinancialHub">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Financial Hub</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchFinancialTab(this, 'dashboard')">Dashboard</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'logTransaction')">Log Transaction</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'managePayables')">Manage Payables</div>
                </div>

                <div id="dashboard" class="tab-content active" style="padding-top: 20px;">
                    <h4>Monthly Financial Summary for <span id="financialDashboardMonth"></span></h4>
                    <div id="financialDashboardContainer" class="dashboard-grid"></div>
                </div>

                <div id="logTransaction" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label for="entryType">Entry Type:</label>
                        <select id="entryType" onchange="togglePaymentPayable()">
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                            <option value="Payment">Payment (for Payable)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="paymentPayableGroup" style="display:none;">
                        <label for="paymentPayableSelect">For Payable:</label>
                        <select id="paymentPayableSelect"></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryCategory">Category:</label>
                        <select id="entryCategory">
                            </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDate">Date:</label>
                        <input type="date" id="entryDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryAmount">Amount (Rs.):</label>
                        <input type="number" id="entryAmount" value="0" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDescription">Description:</label>
                        <textarea id="entryDescription" placeholder="e.g., Monthly shop loan, School fee" list="expenseDescriptionList"></textarea>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" onclick="saveFinancialEntry()">
                            <i class="fas fa-save"></i> Save Entry
                        </button>
                    </div>
                </div>

                <div id="managePayables" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <label for="payableDescription">Description:</label>
                        <input type="text" id="payableDescription" placeholder="e.g., Rent, Loan, Bill">
                    </div>
                    
                    <div class="form-group">
                        <label for="payableAmount">Amount (Rs.):</label>
                        <input type="number" id="payableAmount" value="0" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="payableDueDate">Due Date:</label>
                        <input type="date" id="payableDueDate">
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" onclick="addPayable()">
                            <i class="fas fa-plus"></i> Add Payable
                        </button>
                    </div>
                    
                    <div id="payablesList" class="scrollable-list-wrapper"></div>
                </div>
            </div>
        </div>

        <div id="adminView" class="app-view">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-cogs"></i> Admin Panel</h2>
                
                <div class="login-section" id="adminLoginSection" style="display: block;">
                    <h3>Admin Login</h3>
                    <div class="login-form">
                        <div>
                            <label for="adminUsername">Username:</label>
                            <input type="text" id="adminUsername" placeholder="Enter username">
                        </div>
                        <div>
                            <label for="adminPassword">Password:</label>
                            <input type="password" id="adminPassword" placeholder="Enter password">
                        </div>
                        <button class="btn btn-primary" onclick="adminLogin()">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </div>
                
                <div class="admin-panel" id="adminPanel" style="display: none;">
                    <div class="tabs">
                        <div class="tab active" onclick="switchAdminTab(this, 'recentActivityAdmin')">Recent Activity</div>
                        <div class="tab" onclick="switchAdminTab(this, 'manageItems')">Manage Items</div>
                        <div class="tab" onclick="switchAdminTab(this, 'manageCategories')">Manage Categories</div>
                        <div class="tab" onclick="switchAdminTab(this, 'manageCustomers')">Manage Customers</div>
                        <div class="tab" onclick="switchAdminTab(this, 'manageInvoices')">Manage Invoices</div>
                        <div class="tab" onclick="switchAdminTab(this, 'manageFinancials')">Manage Financials</div>
                        <div class="tab" onclick="switchAdminTab(this, 'dataBackup')">Data Backup</div>
                    </div>
                    
                    <div id="recentActivityAdmin" class="tab-content active">
                        <h3>Last 2 Days Activity</h3>
                        <div id="recentActivityTwoDays" class="scrollable-list-wrapper"></div>
                        <h3 style="margin-top: 20px;">Full Activity History</h3>
                        <div id="recentActivityFull" class="scrollable-list-wrapper"></div>
                    </div>

                    <div id="manageItems" class="tab-content" style="display: none;">
                        <div class="admin-section">
                            <h3>Add/Edit Item</h3>
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="itemCategory">Category:</label>
                                    <select id="itemCategory"></select>
                                </div>
                                <div class="form-field">
                                    <label for="itemSubcategory">Subcategory:</label>
                                    <select id="itemSubcategory"></select>
                                </div>
                                <div class="form-field">
                                    <label for="itemNameAdmin">Item Name:</label>
                                    <input type="text" id="itemNameAdmin">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="itemBasePrice">Base Price (Rs.):</label>
                                    <input type="number" id="itemBasePrice" value="0" min="0" step="0.01">
                                </div>
                                <div class="form-field">
                                    <label for="itemUnit">Unit:</label>
                                    <input type="text" id="itemUnit" placeholder="e.g., per page, per set">
                                </div>
                            </div>
                            
                            <h4>Price Tiers</h4>
                            <div id="priceTiersContainer">
                                <div class="tier-row">
                                    <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                                    <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                                    <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                                    <button class="btn btn-danger btn-sm" onclick="removeTierRow(this)"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button class="btn btn-success" onclick="addTierRow()">
                                    <i class="fas fa-plus"></i> Add Tier
                                </button>
                                <button class="btn btn-primary" onclick="saveItem()">
                                    <i class="fas fa-save"></i> Save Item
                                </button>
                                <button class="btn btn-warning" onclick="clearItemForm()">
                                    <i class="fas fa-trash"></i> Clear Form
                                </button>
                            </div>
                        </div>
                        
                        <div class="admin-section">
                            <h3>Existing Items</h3>
                            <div id="itemsList" class="scrollable-list-wrapper"></div>
                        </div>
                    </div>
                    
                    <div id="manageCategories" class="tab-content" style="display: none;">
                        <div class="admin-section">
                            <h3>Add Category</h3>
                            <div class="form-row">
                                <div class="form-field">
                                    <label for="newCategoryName">Category Name:</label>
                                    <input type="text" id="newCategoryName" placeholder="e.g., Printing">
                                </div>
                                <div class="form-field">
                                    <label for="newSubcategoryName">Subcategory Name:</label>
                                    <input type="text" id="newSubcategoryName" placeholder="e.g., Business Cards">
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="addCategory()">
                                <i class="fas fa-plus"></i> Add Category
                            </button>
                        </div>
                        
                        <div class="admin-section">
                            <h3>Existing Categories</h3>
                            <div id="categoriesList" class="scrollable-list-wrapper"></div>
                        </div>
                    </div>
                    
                    <div id="manageCustomers" class="tab-content" style="display: none;">
                        <div class="admin-section">
                            <h3>Customer List</h3>
                            <div id="customersList" class="scrollable-list-wrapper"></div>
                        </div>
                    </div>
                    
                    <div id="manageInvoices" class="tab-content" style="display: none;">
                        <div class="admin-section">
                            <h3>Invoice History</h3>
                            <div id="invoiceHistory" class="scrollable-list-wrapper"></div>
                        </div>
                    </div>
                    
                    <div id="manageFinancials" class="tab-content" style="display: none;">
                        <div class="admin-section">
                            <h3>Financial Entries</h3>
                            <div id="financialEntries" class="scrollable-list-wrapper"></div>
                        </div>
                    </div>
                    
                    <div id="dataBackup" class="tab-content" style="display: none;">
                        <div class="import-export-section">
                            <h3>Data Export</h3>
                            <div class="actions">
                                <button class="btn btn-success" onclick="exportData()">
                                    <i class="fas fa-download"></i> Export All Data
                                </button>
                                <button class="btn btn-primary" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="import-export-section">
                            <h3>Data Import</h3>
                            <div class="form-group">
                                <label for="importFile">Select JSON file:</label>
                                <input type="file" id="importFile" accept=".json">
                            </div>
                            <button class="btn btn-warning" onclick="importData()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                        
                        <div class="import-export-section">
                            <h3>Customer Data Export</h3>
                            <div class="actions">
                                <button class="btn btn-success" onclick="exportCustomerData()">
                                    <i class="fas fa-download"></i> Export Customer Data (JSON)
                                </button>
                                <button class="btn btn-primary" onclick="uploadCustomerDataToOneDrive()">
                                    <i class="fas fa-cloud-upload-alt"></i> Upload to OneDrive
                                </button>
                            </div>
                            <p><small>Exports price categories and items for customer-facing applications</small></p>
                        </div>
                        <div class="import-export-section">
                            <h3>Data Reset</h3>
                            <p>Warning: This will permanently delete all data. This action cannot be undone.</p>
                            <button class="btn btn-danger" onclick="resetData()">
                                <i class="fas fa-trash"></i> Reset All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cloud-section">
            <h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="auto-sync-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync()">
                    <span class="toggle-slider"></span>
                </label>
                <span>Auto-sync with OneDrive</span>
                <span id="lastSyncTime" style="margin-left: auto; font-size: 0.9rem; color: var(--gray);"></span>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="loginToOneDrive()" id="loginBtn">
                    <i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
                <button class="btn btn-success" onclick="manualSyncToCloud()" id="syncBtn" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> Sync Now
                </button>
                <button class="btn btn-secondary" onclick="manualSyncFromCloud()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Download Latest
                </button>
                <button class="btn btn-danger" onclick="logoutFromOneDrive()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is automatically synced across all devices via OneDrive.</p>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
  <script>
    // =====================================================================
    // === 1. GLOBAL VARIABLES AND CONFIGURATION (MUST BE FIRST) ===========
    // =====================================================================
    let categories = {};
    let customers = [];
    let suppliers = []; 
    let invoices = [];
    let purchases = []; 
    let financialEntries = [];
    let payables = [];
    let stock = {}; 
    let recentActivity = [];
    let isAdmin = false;
    let currentEditingItem = null;
    let autoSyncEnabled = false;
    let syncInProgress = false;
    let lastSyncTime = null;
    let selectedInvoiceForPayment = null; 
    let selectedPurchaseForPayment = null; 
    let uniqueItems = {}; 
    
    // FINANCIAL CATEGORIES (EXPANDED)
    const FinancialCategories = {
        "Income: Invoice Payment": "Income: Invoice Payment",
        "Income: Army Pension": "Income: Army Pension",
        "Income: Other": "Income: Other",
        "Expense: Business Materials": "Expense: Business Materials",
        "Expense: Business Rent": "Expense: Business Rent",
        "Expense: Business Salaries": "Expense: Business Salaries",
        "Expense: Business Other": "Expense: Business Other",
        "Expense: Purchase Payment": "Expense: Purchase Payment", 
        "Expense: Personal Groceries": "Expense: Personal Groceries",
        "Expense: Personal Transport": "Expense: Personal Transport",
        "Expense: Personal Bills": "Expense: Personal Bills",
        "Expense: Personal Other": "Expense: Personal Other",
        "Purchase: Materials Cost": "Purchase: Materials Cost", 
        "Sale: Invoice Revenue": "Sale: Invoice Revenue" 
    };
    
    // MSAL Configuration (Existing)
    const msalConfig = {
        auth: {
            clientId: "dc99f921-91a5-429c-bed3-1a31490b0f91", 
            authority: "https://login.microsoftonline.com/common",
             redirectUri: window.location.origin 
             },
        cache: {
            cacheLocation: "localStorage",
            storeAuthStateInCookie: true,
        },
        system: {
            iframeHashTimeout: 10000,
            tokenRenewalOffsetSeconds: 300
        }
    };
    
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let isLoggedIn = false;
    let userName = "";

    // =====================================================================
    // === 2. FUNCTION DEFINITIONS (All calls must reference these) ========
    // =====================================================================

    // --- Utility & UI Functions ---

    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.add('show');
        setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }
    
    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
        autoSyncEnabled = settings.autoSyncEnabled || false;
        lastSyncTime = settings.lastSyncTime || null;
        document.getElementById('autoSyncToggle').checked = autoSyncEnabled;
        updateLastSyncTime();
    }
    function saveSettings() {
        const settings = { autoSyncEnabled: autoSyncEnabled, lastSyncTime: lastSyncTime };
        localStorage.setItem('appSettings', JSON.stringify(settings));
    }
    function updateLastSyncTime() {
        const lastSyncElement = document.getElementById('lastSyncTime');
        if (lastSyncTime) {
            const time = new Date(lastSyncTime);
            lastSyncElement.textContent = `Last sync: ${time.toLocaleString()}`;
        } else { lastSyncElement.textContent = 'Never synced'; }
    }
    function toggleAutoSync() {
        autoSyncEnabled = document.getElementById('autoSyncToggle').checked;
        saveSettings();
        if (autoSyncEnabled && isLoggedIn) {
            showNotification('Auto-sync enabled. Data will sync automatically.', 'success');
            autoSyncFromCloud();
        } else if (!autoSyncEnabled) {
            showNotification('Auto-sync disabled.', 'info');
        } else {
            showNotification('Please sign in to enable auto-sync.', 'warning');
        }
    }
    function switchView(viewId, navButton) {
        document.querySelectorAll('.app-view').forEach(view => {
            view.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');

        document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        navButton.classList.add('active');

        if (viewId === 'calculatorView') {
            updateDashboard('daily');
            updateDashboard('monthly');
        } else if (viewId === 'invoiceView') {
            updateInvoiceNo();
            // This ensures the first tab is active by default in the new SPA view
            document.getElementById('newInvoiceSection').style.display = 'block';
            document.getElementById('invoicePaymentSection').style.display = 'none';
            document.getElementById('previousInvoicesSection').style.display = 'none';
        } else if (viewId === 'inventoryView') {
            document.getElementById('newPurchaseSection').style.display = 'block';
            document.getElementById('supplierLedgerSection').style.display = 'none';
            document.getElementById('inventoryStockSection').style.display = 'none';
            document.getElementById('purchaseDate').valueAsDate = new Date();
        } else if (viewId === 'financialView') {
            updateFinancialDashboard();
            updatePaymentPayableSelect();
        } else if (viewId === 'adminView') {
             if (isAdmin) {
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
                updateRecentActivityAdmin(); 
            } else {
                document.getElementById('adminLoginSection').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }
    }
    
    // --- Data Management Functions ---

    function initializeApp() {
        if (!localStorage.getItem('categories')) {
            const defaultCategories = {
                "Printing": {
                    "Business Cards": {
                        "Standard Business Card": {
                            basePrice: 500, unit: "per 100 cards",
                            priceTiers: [{ min: 1, max: 100, price: 500 }, { min: 101, max: 500, price: 450 }, { min: 501, max: 1000, price: 400 }]
                        },
                        "Premium Business Card": {
                            basePrice: 800, unit: "per 100 cards",
                            priceTiers: [{ min: 1, max: 100, price: 800 }, { min: 101, max: 500, price: 700 }, { min: 501, max: 1000, price: 600 }]
                        }
                    },
                    "Flyers": {
                        "A4 Flyer": {
                            basePrice: 300, unit: "per 100 flyers",
                            priceTiers: [{ min: 1, max: 100, price: 300 }, { min: 101, max: 500, price: 250 }, { min: 501, max: 1000, price: 200 }]
                        },
                        "A5 Flyer": {
                            basePrice: 200, unit: "per 100 flyers",
                            priceTiers: [{ min: 1, max: 100, price: 200 }, { min: 101, max: 500, price: 180 }, { min: 501, max: 1000, price: 150 }]
                        }
                    }
                },
                "Photocopy": {
                    "Black & White": {
                        "A4 B&W": {
                            basePrice: 5, unit: "per page",
                            priceTiers: [{ min: 1, max: 10, price: 5 }, { min: 11, max: 50, price: 4 }, { min: 51, max: 100, price: 3.5 }]
                        },
                        "A3 B&W": {
                            basePrice: 10, unit: "per page",
                            priceTiers: [{ min: 1, max: 10, price: 10 }, { min: 11, max: 50, price: 9 }, { min: 51, max: 100, price: 8 }]
                        }
                    },
                    "Color": {
                        "A4 Color": {
                            basePrice: 20, unit: "per page",
                            priceTiers: [{ min: 1, max: 10, price: 20 }, { min: 11, max: 50, price: 18 }, { min: 51, max: 100, price: 15 }]
                        },
                        "A3 Color": {
                            basePrice: 40, unit: "per page",
                            priceTiers: [{ min: 1, max: 10, price: 40 }, { min: 11, max: 50, price: 35 }, { min: 51, max: 100, price: 30 }]
                        }
                    }
                }
            };
            localStorage.setItem('categories', JSON.stringify(defaultCategories));
        }
        
        if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify([]));
        if (!localStorage.getItem('suppliers')) localStorage.setItem('suppliers', JSON.stringify([])); 
        if (!localStorage.getItem('invoices')) localStorage.setItem('invoices', JSON.stringify([]));
        if (!localStorage.getItem('purchases')) localStorage.setItem('purchases', JSON.stringify([])); 
        if (!localStorage.getItem('financialEntries')) localStorage.setItem('financialEntries', JSON.stringify([]));
        if (!localStorage.getItem('payables')) localStorage.setItem('payables', JSON.stringify([]));
        if (!localStorage.getItem('stock')) localStorage.setItem('stock', JSON.stringify({})); 
        if (!localStorage.getItem('recentActivity')) localStorage.setItem('recentActivity', JSON.stringify([]));
        
        updateMainCategoryDropdown();
        updateUniqueItems(); 
        populateFinancialCategories();
        setupCustomerAutocomplete();
        setupPaymentCustomerSearch();
        setupSupplierAutocomplete(); 
        setupLedgerSupplierSearch(); 
        addInvoiceItem(); 
        addPurchaseItem(); 
    }

    function loadData() {
        categories = JSON.parse(localStorage.getItem('categories')) || {};
        customers = JSON.parse(localStorage.getItem('customers')) || [];
        suppliers = JSON.parse(localStorage.getItem('suppliers')) || []; 
        invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        purchases = JSON.parse(localStorage.getItem('purchases')) || []; 
        financialEntries = JSON.parse(localStorage.getItem('financialEntries')) || [];
        payables = JSON.parse(localStorage.getItem('payables')) || [];
        stock = JSON.parse(localStorage.getItem('stock')) || {}; 
        recentActivity = JSON.parse(localStorage.getItem('recentActivity')) || [];
    }

    function saveData() {
        localStorage.setItem('categories', JSON.stringify(categories));
        localStorage.setItem('customers', JSON.stringify(customers));
        localStorage.setItem('suppliers', JSON.stringify(suppliers)); 
        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('purchases', JSON.stringify(purchases)); 
        localStorage.setItem('financialEntries', JSON.stringify(financialEntries));
        localStorage.setItem('payables', JSON.stringify(payables));
        localStorage.setItem('stock', JSON.stringify(stock)); 
        localStorage.setItem('recentActivity', JSON.stringify(recentActivity));
        
        if (autoSyncEnabled && isLoggedIn && !syncInProgress) {
            setTimeout(() => { autoSyncToCloud(); }, 1000);
        }
    }
    
    function updateUniqueItems() {
        uniqueItems = {};
        for (const category in categories) {
            for (const subcategory in categories[category]) {
                for (const itemName in categories[category][subcategory]) {
                    uniqueItems[itemName] = categories[category][subcategory][itemName];
                }
            }
        }
    }
    
    function populateFinancialCategories() {
        const select = document.getElementById('entryCategory');
        select.innerHTML = '';
        for (const category in FinancialCategories) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        }
    }

    // --- Calculator Functions ---
    function updateMainCategoryDropdown() {
        const mainCategorySelect = document.getElementById('mainCategory');
        mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
        for (const category in categories) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            mainCategorySelect.appendChild(option);
        }
    }
    function updateSubcategories() {
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategorySelect = document.getElementById('subCategory');
        subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
        if (mainCategory && categories[mainCategory]) {
            for (const subcategory in categories[mainCategory]) {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subCategorySelect.appendChild(option);
            }
        }
        document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
    }
    function updateItemsAndFields() {
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const itemNameSelect = document.getElementById('itemName');
        itemNameSelect.innerHTML = '<option value="">Select Item</option>';
        if (mainCategory && subCategory && categories[mainCategory] && categories[mainCategory][subCategory]) {
            for (const item in categories[mainCategory][subCategory]) {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                itemNameSelect.appendChild(option);
            }
        }
    }
    function updateQuantityInput() {
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const itemName = document.getElementById('itemName').value;
        if (mainCategory && subCategory && itemName && categories[mainCategory] && 
            categories[mainCategory][subCategory] && categories[mainCategory][subCategory][itemName]) {
            const item = categories[mainCategory][subCategory][itemName];
            document.getElementById('quantityInputContainer').innerHTML = 
                `<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">`;
            if (item.priceTiers && item.priceTiers.length > 0) {
                document.getElementById('priceTierTagGroup').style.display = 'block';
                updatePriceTierTag();
            } else {
                document.getElementById('priceTierTagGroup').style.display = 'none';
            }
        }
    }
    function clearTierTag() {
        document.getElementById('priceTierTag').textContent = 'Select a set.';
        document.getElementById('priceTierTag').style.color = 'var(--danger)';
    }
    function updatePriceTierTag() {
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const itemName = document.getElementById('itemName').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        if (mainCategory && subCategory && itemName && categories[mainCategory] && 
            categories[mainCategory][subCategory] && categories[mainCategory][subCategory][itemName]) {
            const item = categories[mainCategory][subCategory][itemName];
            if (item.priceTiers && item.priceTiers.length > 0) {
                for (const tier of item.priceTiers) {
                    if (quantity >= tier.min && quantity <= tier.max) {
                        document.getElementById('priceTierTag').textContent = 
                            `Set ${tier.min}-${tier.max} (Rs. ${tier.price} per ${item.unit})`;
                        document.getElementById('priceTierTag').style.color = 'var(--success)';
                        return;
                    }
                }
                document.getElementById('priceTierTag').textContent = 
                    `Base Price (Rs. ${item.basePrice} per ${item.unit})`;
                document.getElementById('priceTierTag').style.color = 'var(--warning)';
            }
        }
    }
    function calculatePrice() {
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const itemName = document.getElementById('itemName').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const designCharges = parseFloat(document.getElementById('designCharges').value) || 0;
        if (!mainCategory || !subCategory || !itemName) {
            showNotification('Please select a category, subcategory, and item.', 'error');
            return;
        }
        if (!categories[mainCategory] || !categories[mainCategory][subCategory] || 
            !categories[mainCategory][subCategory][itemName]) {
            showNotification('Selected item not found.', 'error');
            return;
        }
        const item = categories[mainCategory][subCategory][itemName];
        let unitPrice = item.basePrice;
        if (item.priceTiers && item.priceTiers.length > 0) {
            for (const tier of item.priceTiers) {
                if (quantity >= tier.min && quantity <= tier.max) {
                    unitPrice = tier.price;
                    break;
                }
            }
        }
        const itemCost = unitPrice * quantity;
        const total = itemCost + designCharges;
        document.getElementById('result').innerHTML = `
            <h3>Price Calculation Result</h3>
            <p><strong>Item:</strong> ${itemName}</p>
            <p><strong>Quantity:</strong> ${quantity} ${item.unit}</p>
            <p><strong>Unit Price:</strong> Rs. ${unitPrice.toFixed(2)}</p>
            <p><strong>Design Charges:</strong> Rs. ${designCharges.toFixed(2)}</p>
            <p><strong>Total Price:</strong> Rs. ${total.toFixed(2)}</p>
        `;
        document.getElementById('result').style.display = 'block';
        document.getElementById('breakdownContent').innerHTML = `
            <div class="breakdown-item">
                <span>Item Cost (${quantity} Ã— Rs. ${unitPrice.toFixed(2)}):</span>
                <span>Rs. ${itemCost.toFixed(2)}</span>
            </div>
            <div class="breakdown-item">
                <span>Design Charges:</span>
                <span>Rs. ${designCharges.toFixed(2)}</span>
            </div>
            <div class="breakdown-item">
                <span>Total:</span>
                <span>Rs. ${total.toFixed(2)}</span>
            </div>
        `;
        document.getElementById('priceBreakdown').style.display = 'block';
        addRecentActivity(`Calculated price for ${itemName}`, 'calculator');
        showNotification('Price calculated successfully!', 'success');
    }
    function clearForm() {
        document.getElementById('mainCategory').value = '';
        document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
        document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
        document.getElementById('quantity').value = 1;
        document.getElementById('designCharges').value = 0;
        document.getElementById('result').style.display = 'none';
        document.getElementById('priceBreakdown').style.display = 'none';
        document.getElementById('priceTierTagGroup').style.display = 'none';
        showNotification('Form cleared.', 'info');
    }

    // --- Invoice/Customer Functions ---
    function setupCustomerAutocomplete() {
        const customerNameInput = document.getElementById('invoiceCustomerName');
        const customerSuggestions = document.getElementById('customerSuggestions');
        
        customerNameInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            customerSuggestions.innerHTML = '';
            
            if (query.length < 2) {
                customerSuggestions.style.display = 'none';
                return;
            }
            
            const matches = customers.filter(customer => 
                customer.name.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                matches.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'customer-suggestion';
                    div.textContent = customer.name;
                    div.addEventListener('click', function() {
                        customerNameInput.value = customer.name;
                        document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
                        customerSuggestions.style.display = 'none';
                    });
                    customerSuggestions.appendChild(div);
                });
                customerSuggestions.style.display = 'block';
            } else {
                customerSuggestions.style.display = 'none';
            }
        });
        
        document.addEventListener('click', function(e) {
            if (e.target !== customerNameInput) {
                customerSuggestions.style.display = 'none';
            }
        });
    }

    function setupPaymentCustomerSearch() {
        const customerNameInput = document.getElementById('paymentCustomerSearch');
        const customerSuggestions = document.getElementById('paymentCustomerSuggestions');
        
        customerNameInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            customerSuggestions.innerHTML = '';
            
            if (query.length < 2) {
                customerSuggestions.style.display = 'none';
                return;
            }
            
            const matches = customers.filter(customer => 
                customer.name.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                matches.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'customer-suggestion';
                    div.textContent = `${customer.name} (${customer.phone || 'No Phone'})`;
                    div.addEventListener('click', function() {
                        customerNameInput.value = customer.name;
                        customerSuggestions.style.display = 'none';
                        loadCustomerInvoices(customer.name);
                    });
                    customerSuggestions.appendChild(div);
                });
                customerSuggestions.style.display = 'block';
            } else {
                customerSuggestions.style.display = 'none';
            }
        });
        
        document.addEventListener('click', function(e) {
            if (e.target !== customerNameInput) {
                customerSuggestions.style.display = 'none';
            }
        });
    }

    function loadCustomerInvoices(customerName) {
        const container = document.getElementById('customerInvoicesList');
        container.innerHTML = '';
        document.getElementById('invoicePaymentInput').style.display = 'none';
        selectedInvoiceForPayment = null;

        const pendingInvoices = invoices.filter(inv => 
            inv.customerName === customerName && inv.remainingBalance > 0
        );

        if (pendingInvoices.length === 0) {
            container.innerHTML = `<p>No pending invoices found for ${customerName}.</p>`;
            return;
        }

        pendingInvoices.forEach(invoice => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.cursor = 'pointer';
            item.onclick = (e) => selectInvoiceForPayment(invoice.invoiceNo, e.currentTarget);

            item.innerHTML = `
                <div class="history-header">
                    <span>${invoice.invoiceNo} - ${new Date(invoice.date).toLocaleDateString()}</span>
                    <span>Total: Rs. ${invoice.total.toFixed(2)}</span>
                </div>
                <div class="history-details">
                    <div>Remaining Balance: <strong style="color: var(--danger);">Rs. ${invoice.remainingBalance.toFixed(2)}</strong></div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function selectInvoiceForPayment(invoiceNo, targetElement) {
        const invoice = invoices.find(inv => inv.invoiceNo === invoiceNo);
        if (!invoice) return;

        selectedInvoiceForPayment = invoice;
        
        document.getElementById('selectedInvoiceNo').textContent = invoiceNo;
        document.getElementById('paymentAmountInput').value = invoice.remainingBalance.toFixed(2);
        document.getElementById('invoicePaymentInput').style.display = 'block';
        
        document.querySelectorAll('#customerInvoicesList .history-item').forEach(item => {
            item.style.backgroundColor = 'white';
            item.style.borderLeftColor = 'var(--secondary)';
        });
        targetElement.style.backgroundColor = '#e1f5fe';
        targetElement.style.borderLeftColor = 'var(--warning)';
    }

    function recordInvoicePayment() {
        if (!selectedInvoiceForPayment) {
            showNotification('Please select an invoice first.', 'error');
            return;
        }

        const paymentAmount = parseFloat(document.getElementById('paymentAmountInput').value) || 0;
        const invoiceNo = selectedInvoiceForPayment.invoiceNo;
        
        if (paymentAmount <= 0) {
            showNotification('Payment amount must be greater than zero.', 'error');
            return;
        }

        if (paymentAmount > selectedInvoiceForPayment.remainingBalance) {
            showNotification('Payment amount exceeds the remaining balance.', 'warning');
            return;
        }

        const index = invoices.findIndex(inv => inv.invoiceNo === invoiceNo);
        if (index > -1) {
            invoices[index].payment += paymentAmount;
            invoices[index].remainingBalance -= paymentAmount;
        }

        const financialEntry = {
            id: Date.now(),
            type: 'Income',
            category: FinancialCategories["Income: Invoice Payment"],
            date: new Date().toISOString().split('T')[0], 
            amount: paymentAmount,
            description: `Payment of Rs. ${paymentAmount.toFixed(2)} recorded for invoice ${invoiceNo} from ${selectedInvoiceForPayment.customerName}`,
            createdAt: new Date().toISOString(),
            invoiceNo: invoiceNo
        };
        
        financialEntries.push(financialEntry);
        saveData();
        updateDashboard('daily');
        updateDashboard('monthly');
        addRecentActivity(`Recorded Rs. ${paymentAmount.toFixed(2)} payment for invoice ${invoiceNo}`, 'invoice');

        const customerName = document.getElementById('paymentCustomerSearch').value;
        document.getElementById('invoicePaymentInput').style.display = 'none';
        selectedInvoiceForPayment = null;
        loadCustomerInvoices(customerName);
        
        showNotification(`Payment of Rs. ${paymentAmount.toFixed(2)} recorded for invoice ${invoiceNo}!`, 'success');
    }

    function setupItemAutocomplete() {
        // Not used, but kept for compatibility (using showItemSuggestions inline)
    }

    function addInvoiceItem() {
        const tableBody = document.getElementById('itemsTableBody');
        const newRow = document.createElement('tr');
        
        newRow.innerHTML = `
            <td>
                <div class="invoice-item-suggestion-container">
                    <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" oninput="showItemSuggestions(this)">
                    <div class="item-suggestions" style="display: none;"></div>
                </div>
            </td>
            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
            <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
            <td><input type="number" class="item-amount" value="0" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
        `;
        
        tableBody.appendChild(newRow);
        calculateTotal();
    }

    function removeInvoiceItem(button) {
        const row = button.closest('tr');
        row.remove();
        calculateTotal();
    }

    function calculateTotal() {
        const rows = document.querySelectorAll('#itemsTableBody tr');
        let subtotal = 0;
        
        rows.forEach(row => {
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
            const amount = (rate * quantity) + designCharges;
            
            row.querySelector('.item-amount').value = amount.toFixed(2);
            subtotal += amount;
        });
        
        const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
        const payment = parseFloat(document.getElementById('payment').value) || 0;
        const remainingBalance = total + previousBalance - payment;
        
        document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
        document.getElementById('totalAmount').textContent = total.toFixed(2);
        document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
    }

    function saveInvoice() {
        const customerName = document.getElementById('invoiceCustomerName').value;
        const customerPhone = document.getElementById('invoiceCustomerPhone').value;
        const invoiceNo = document.getElementById('invoiceNo').value;
        const invoiceDate = document.getElementById('invoiceDate').value;
        
        if (!customerName || !invoiceNo) {
            showNotification('Please enter customer name and invoice number.', 'error');
            return;
        }
        
        // Save customer if new
        const existingCustomer = customers.find(c => c.name === customerName);
        if (!existingCustomer) {
            customers.push({
                id: Date.now(),
                name: customerName,
                phone: customerPhone,
                createdAt: new Date().toISOString()
            });
        }
        
        // Collect invoice items
        const items = [];
        const rows = document.querySelectorAll('#itemsTableBody tr');
        
        rows.forEach(row => {
            const name = row.querySelector('.item-name').value;
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
            const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
            
            if (name) {
                items.push({ name, rate, quantity, designCharges, amount });
                // Update Stock (Decrease)
                stock[name] = (stock[name] || 0) - quantity;
                if (stock[name] < 0) stock[name] = 0; 
            }
        });
        
        if (items.length === 0) {
            showNotification('Please add at least one item to the invoice.', 'error');
            return;
        }
        
        // Calculate totals
        const subtotal = parseFloat(document.getElementById('subtotalAmount').textContent) || 0;
        const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = parseFloat(document.getElementById('totalAmount').textContent) || 0;
        const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
        const payment = parseFloat(document.getElementById('payment').value) || 0;
        const remainingBalance = parseFloat(document.getElementById('remainingBalance').textContent) || 0;
        
        // Create invoice object
        const invoice = {
            id: Date.now(),
            invoiceNo,
            customerName,
            customerPhone,
            date: invoiceDate,
            items,
            subtotal,
            taxRate,
            taxAmount,
            total,
            previousBalance,
            payment,
            remainingBalance,
            createdAt: new Date().toISOString()
        };
        
        invoices.push(invoice);
        localStorage.setItem('lastInvoiceNo', invoiceNo.split('-')[1]);
        
        // Financial Entry 1: Actual Payment (Cash Inflow)
        if (payment > 0) {
            financialEntries.push({
                id: Date.now() + 1,
                type: 'Income',
                category: FinancialCategories["Income: Invoice Payment"],
                date: invoiceDate,
                amount: payment,
                description: `Payment for invoice ${invoiceNo} from ${customerName}`,
                createdAt: new Date().toISOString(),
                invoiceNo: invoiceNo
            });
        }

        // Financial Entry 2: Sale Revenue (for Gross Profit/Dashboard)
        financialEntries.push({
            id: Date.now() + 2,
            type: 'Sale',
            category: FinancialCategories["Sale: Invoice Revenue"],
            date: invoiceDate,
            amount: total,
            description: `Sale revenue from invoice ${invoiceNo}`,
            createdAt: new Date().toISOString(),
            invoiceNo: invoiceNo
        });
        
        saveData();
        addRecentActivity(`Created invoice ${invoiceNo} for ${customerName}`, 'invoice');
        clearInvoice();
        updateInvoiceNo();
        updateDashboard('daily');
        updateDashboard('monthly');
        showNotification('Invoice saved successfully!', 'success');
    }

    function clearInvoice() {
        document.getElementById('invoiceCustomerName').value = '';
        document.getElementById('invoiceCustomerPhone').value = '';
        document.getElementById('taxRate').value = 0;
        document.getElementById('previousBalance').value = 0;
        document.getElementById('payment').value = 0;
        
        const tableBody = document.getElementById('itemsTableBody');
        tableBody.innerHTML = '';
        addInvoiceItem();
        
        calculateTotal();
        
        showNotification('Invoice form cleared.', 'info');
    }

    function printInvoice(invoiceNo) {
        let invoiceToPrint;

        if (invoiceNo) {
            invoiceToPrint = invoices.find(inv => inv.invoiceNo === invoiceNo);
            if (!invoiceToPrint) { showNotification('Invoice not found.', 'error'); return; }
        } else {
            const customerName = document.getElementById('invoiceCustomerName').value || 'Guest Customer';
            const customerPhone = document.getElementById('invoiceCustomerPhone').value || 'N/A';
            const currentInvoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const subtotal = parseFloat(document.getElementById('subtotalAmount').textContent) || 0;
            const total = parseFloat(document.getElementById('totalAmount').textContent) || 0;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').textContent) || 0;
            
            const items = [];
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                if (name) { items.push({ name, rate, quantity, designCharges, amount: (rate * quantity) + designCharges }); }
            });

            invoiceToPrint = {
                invoiceNo: currentInvoiceNo, customerName, customerPhone, date: invoiceDate, items, subtotal,
                taxAmount: total - subtotal, total, remainingBalance
            };
        }

        const originalTableBody = document.getElementById('itemsTableBody').innerHTML;
        const originalTotalsSection = document.querySelector('#newInvoiceSection .totals-section').innerHTML;

        const headerInfo = document.getElementById('invoiceCustomerInfo');
        headerInfo.style.display = 'block';
        headerInfo.innerHTML = `
            <h2 style="text-align: center; margin-bottom: 20px;">Invoice / Quote</h2>
            <div><strong>Invoice No:</strong> <span>${invoiceToPrint.invoiceNo}</span></div>
            <div><strong>Date:</strong> <span>${new Date(invoiceToPrint.date).toLocaleDateString()}</span></div>
            <div><strong>Customer:</strong> <span>${invoiceToPrint.customerName}</span></div>
            <div><strong>Phone:</strong> <span>${invoiceToPrint.customerPhone}</span></div>
        `;

        let printTableBody = '';
        invoiceToPrint.items.forEach(item => {
            printTableBody += `<tr>
                <td>${item.name}</td><td>${item.rate.toFixed(2)}</td><td>${item.quantity}</td>
                <td>${item.designCharges.toFixed(2)}</td><td>${item.amount.toFixed(2)}</td><td style="display: none;"></td></tr>`;
        });
        document.getElementById('itemsTableBody').innerHTML = printTableBody;
        document.querySelector('.items-table th:last-child').style.display = 'none';
        document.querySelectorAll('.items-table td:last-child').forEach(td => td.style.display = 'none');

        const totalsSection = document.querySelector('#newInvoiceSection .totals-section');
        totalsSection.innerHTML = `
            <div class="total-row"><span>Subtotal:</span><span>Rs. ${invoiceToPrint.subtotal.toFixed(2)}</span></div>
            <div class="total-row"><span>Tax:</span><span>Rs. ${(invoiceToPrint.taxAmount || invoiceToPrint.total - invoiceToPrint.subtotal).toFixed(2)}</span></div>
            <div class="total-row" style="border-top: 2px solid #333;">
                <span><strong>Total Amount:</strong></span><span><strong>Rs. ${invoiceToPrint.total.toFixed(2)}</strong></span>
            </div>
            <div class="total-row">
                <span><strong>Remaining Balance:</strong></span>
                <span><strong style="color: var(--danger);">Rs. ${invoiceToPrint.remainingBalance.toFixed(2)}</strong></span>
            </div>
        `;

        window.print();
        
        // Restore UI state after print
        headerInfo.style.display = 'none';
        document.getElementById('itemsTableBody').innerHTML = originalTableBody;
        totalsSection.innerHTML = originalTotalsSection;
        document.querySelector('.items-table th:last-child').style.display = 'table-cell';
        document.querySelectorAll('#itemsTableBody input.item-rate, #itemsTableBody input.item-quantity, #itemsTableBody input.item-design-charges').forEach(input => {
            input.oninput = calculateTotal;
        });
        document.querySelectorAll('#itemsTableBody input.item-name').forEach(input => {
            input.oninput = function() { showItemSuggestions(this); };
        });
        calculateTotal();
    }

    function loadPreviousInvoices() { /* ... full implementation ... */ }
    function showItemSuggestions(inputElement) { /* ... full implementation ... */ }
    function selectInvoiceItem(inputElement, itemName, basePrice) { /* ... full implementation ... */ }


    // --- Inventory/Purchase/Supplier Functions ---

    function switchInventoryTab(tabElement, tabId) {
        document.querySelectorAll('#inventoryView .tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });
        
        document.getElementById(tabId).classList.add('active');
        document.getElementById(tabId).style.display = 'block';

        document.querySelectorAll('#inventoryView .tabs .tab').forEach(tab => {
            tab.classList.remove('active');
        });
        tabElement.classList.add('active');

        if (tabId === 'inventoryStockSection') {
            updateInventoryStockList();
        } else if (tabId === 'supplierLedgerSection') {
            document.getElementById('supplierLedgerOutput').innerHTML = '<p>Search for a supplier to view their purchase history and outstanding balance.</p>';
        }
    }
    
    function setupSupplierAutocomplete() { /* ... full implementation ... */ }
    function setupLedgerSupplierSearch() { /* ... full implementation ... */ }
    function addPurchaseItem() { /* ... full implementation ... */ }
    function removePurchaseItem(button) { /* ... full implementation ... */ }
    function showPurchaseItemSuggestions(inputElement) { /* ... full implementation ... */ }
    function calculatePurchaseTotal() { /* ... full implementation ... */ }
    function savePurchaseInvoice() { /* ... full implementation ... */ }
    function clearPurchaseForm() { /* ... full implementation ... */ }
    function updateInventoryStockList() { /* ... full implementation ... */ }
    function loadSupplierLedger(supplierName) { /* ... full implementation ... */ }


    // --- Financial Hub Functions ---
    function togglePaymentPayable() { /* ... full implementation ... */ }
    function updatePaymentPayableSelect() { /* ... full implementation ... */ }
    function saveFinancialEntry() { /* ... full implementation ... */ }
    function addPayable() { /* ... full implementation ... */ }
    function updatePayablesList() { /* ... full implementation ... */ }
    function filterEntries(period, type) { /* ... full implementation ... */ }
    function updateDashboard(period) { /* ... full implementation ... */ }
    function updateFinancialDashboard() { /* ... full implementation ... */ }

    // --- Admin Panel Functions ---
    function adminLogin() { /* ... full implementation ... */ }
    function switchAdminTab(tabElement, tabId) { /* ... full implementation ... */ }
    function loadAdminData() { /* ... full implementation ... */ }
    function populateCategoryDropdowns() { /* ... full implementation ... */ }
    function addTierRow() { /* ... full implementation ... */ }
    function removeTierRow(button) { /* ... full implementation ... */ }
    function saveItem() { /* ... full implementation ... */ }
    function clearItemForm() { /* ... full implementation ... */ }
    function loadItemsList() { /* ... full implementation ... */ }
    function editItem(category, subcategory, itemName) { /* ... full implementation ... */ }
    function deleteItem(category, subcategory, itemName) { /* ... full implementation ... */ }
    function addCategory() { /* ... full implementation ... */ }
    function loadCategoriesList() { /* ... full implementation ... */ }
    function deleteCategory(category) { /* ... full implementation ... */ }
    function loadCustomersList() { /* ... full implementation ... */ }
    function loadInvoiceHistory() { /* ... full implementation ... */ }
    function loadFinancialEntries() { /* ... full implementation ... */ }
    function addRecentActivity(description, type) { /* ... full implementation ... */ }
    function updateRecentActivityAdmin() { /* ... full implementation ... */ }
    function getActivityIcon(type) { /* ... full implementation ... */ }
    function exportData() { /* ... full implementation ... */ }
    function exportToExcel() { /* ... full implementation ... */ }
    function exportCustomerData() { /* ... full implementation ... */ }
    async function uploadCustomerDataToOneDrive() { /* ... full implementation ... */ }
    function importData() { /* ... full implementation ... */ }
    function resetData() { /* ... full implementation ... */ }


    // --- MSAL/OneDrive Functions (Need access to globals) ---
    function handleApiError(error) { /* ... full implementation ... */ }
    async function getAccessToken() { /* ... full implementation ... */ }
    async function loginToOneDrive() { /* ... full implementation ... */ }
    function logoutFromOneDrive() { /* ... full implementation ... */ }
    async function checkLoginStatus() { /* ... full implementation ... */ }
    function updateLoginUI() { /* ... full implementation ... */ }
    async function uploadFileToOneDrive(filename, blob) { /* ... full implementation ... */ }
    async function downloadFileFromOneDrive(filename) { /* ... full implementation ... */ }
    async function autoSyncToCloud() { /* ... full implementation ... */ }
    async function autoSyncFromCloud() { /* ... full implementation ... */ }
    function manualSyncToCloud() { /* ... full implementation ... */ }
    function manualSyncFromCloud() { /* ... full implementation ... */ }
    function updateSyncStatus(message, status) { /* ... full implementation ... */ }


    // =====================================================================
    // === 3. FINAL INITIALIZATION BLOCK (The browser's entry point) =======
    // =====================================================================
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            await msalInstance.initialize();
            loadData();
            initializeApp(); 
            
            updateRecentActivityAdmin();
            updateInvoiceNo();
            updateDashboard('daily'); 
            updateDashboard('monthly'); 
            
            // Set date defaults
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            // document.getElementById('purchaseDate').valueAsDate is inside initializeApp()
            
            loadSettings();
            
            await checkLoginStatus();
            
            if (autoSyncEnabled && isLoggedIn) {
                setTimeout(() => {
                    autoSyncFromCloud();
                }, 2000);
            }
        } catch (error) {
            console.error('App initialization failed:', error);
        }
    });

</script>
    // =====================================================================
    // === 3. INITIALIZATION BLOCK (The browser's entry point) =============
    // =====================================================================
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            await msalInstance.initialize();
            loadData();
            initializeApp(); 
            
            updateRecentActivityAdmin();
            updateInvoiceNo();
            updateDashboard('daily'); 
            updateDashboard('monthly'); 
            
            // Set date defaults
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            // document.getElementById('purchaseDate').valueAsDate is inside initializeApp()
            
            loadSettings();
            
            await checkLoginStatus();
            
            if (autoSyncEnabled && isLoggedIn) {
                setTimeout(() => {
                    autoSyncFromCloud();
                }, 2000);
            }
        } catch (error) {
            console.error('App initialization failed:', error);
        }
    });

</script>
</body>
</html>
