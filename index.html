<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #4285F4; /* Google Blue */
            --secondary-light: #5a95f5;
            --success: #0F9D58;   /* Google Green */
            --success-light: #11ac62;
            --warning: #F4B400;  /* Google Yellow */
            --warning-light: #f6c231;
            --danger: #DB4437;   /* Google Red */
            --danger-light: #e05a4e;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #4285F4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #5a95f5);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e8f0fe, #f1e8fe);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #e6f4ea;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fde2e2;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e8f0fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Updated Grid for 3 Panels */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 30px;
        }

        /* Adjustments for smaller screens */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr 1fr; /* Switch to 2 columns on medium screens */
            }
        }
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr; /* Switch to 1 column on small screens */
            }
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--primary); color: white; }
        .btn-secondary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: var(--success-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: #222; }
        .btn-warning:hover { background: var(--warning-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #e6f4ea, #d0e8d0);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }

        /* Financial Hub Styling */
        .dashboard-metric {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
        }
        
        .dashboard-metric span {
            display: block;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .metric-income {
            border-color: var(--success);
            background-color: #e6f4ea;
        }
        
        .metric-expense {
            border-color: var(--danger);
            background-color: #fde2e2;
        }
        
        .metric-profit {
            border-color: var(--secondary);
            background-color: #e8f0fe;
        }
        
        .metric-net {
            border-color: var(--warning);
            background-color: #fff8e1;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Item Editor Specific Styles */
        #itemEditor {
            border-top: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tier-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .tier-row input {
            padding: 8px;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Financial Management</p>
        </header>

        <div class="cloud-section">
            <h2 class="section-title"><i class="fab fa-google-drive"></i> Google Drive & Sheets Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-exclamation-circle"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="signIn()" id="loginBtn">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                <button class="btn btn-success" onclick="saveAllData(true)" id="syncBtn" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Force Sync Now
                </button>
                <button class="btn btn-danger" onclick="signOut()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is synced across all devices via Google Drive.</p>
            </div>
        </div>

        <div class="content-grid">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory" onchange="updateSubcategories()">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory" onchange="updateItemsAndFields()"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName" onchange="updateQuantityInput()"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantityInputContainer"><i class="fas fa-boxes"></i> Quantity / Set:</label>
                    <div id="quantityInputContainer" style="flex: 2;">
                        <input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">
                    </div>
                </div>
                
                <div class="form-group" id="priceTierTagGroup" style="margin-top: -10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f9f9f9; display: none;">
                    <label><i class="fas fa-tag"></i> Selected Set:</label>
                    <span id="priceTierTag" style="font-weight: bold; color: var(--danger);">Select a set.</span>
                </div>
                
                <div class="form-group">
                    <label for="designCharges"><i class="fas fa-paint-brush"></i> Design Charges (Rs.):</label>
                    <input type="number" id="designCharges" value="0" min="0" step="0.01">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
                
                <div class="form-group">
                    <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                    <div class="suggestion-container">
                        <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off" list="customerNameList">
                        <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                    <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number" list="customerPhoneList">
                </div>
                
                <div class="form-group">
                    <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                    <input type="text" id="invoiceNo" readonly>
                </div>
                
                <div class="form-group">
                    <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>

                <h3>Invoice Items</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Rate (Rs.)</th>
                            <th>Qty</th>
                            <th>Design Charges (Rs.)</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                                </div>
                            </td>
                            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-amount" value="0" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="addInvoiceItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button class="btn btn-secondary" onclick="calculateTotal()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>

                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                    
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>Rs. <span id="subtotalAmount">0.00</span></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="taxRate">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="previousBalance">Previous Balance (Rs.):</label>
                        <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment">Payment Received (Rs.):</label>
                        <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Remaining Balance:</strong></span>
                        <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="saveInvoice()">
                        <i class="fas fa-save"></i> Save & Sync Invoice
                    </button>
                    <button class="btn btn-warning" onclick="clearInvoice()">
                        <i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
                </div>
            </div>
            
            <div class="section-panel" id="FinancialHub">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Financial Hub</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchFinancialTab(this, 'dashboard')">Dashboard</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'logTransaction')">Log Transaction</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'managePayables')">Manage Payables</div>
                </div>

                <div id="dashboard" class="tab-content active" style="padding-top: 20px;">
                    <h4>Summary for <span id="dashboardMonth"></span></h4>
                    <div id="financialDashboardContainer"></div>
                </div>

                <div id="logTransaction" class="tab-content">
                    <div class="form-group">
                        <label for="entryType">Entry Type:</label>
                        <select id="entryType" onchange="togglePaymentPayable()">
                            <option value="Income">Income</option>
                            <option value="Expense">General Expense</option>
                            <option value="Payment">Payment (for Payable)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="paymentPayableGroup" style="display:none;">
                        <label for="paymentPayableSelect">For:</label>
                        <select id="paymentPayableSelect"></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryCategory">Category:</label>
                        <select id="entryCategory">
                            <option value="Income: Invoice Payment">Income: Invoice Payment</option>
                            <option value="Income: Army Pension">Income: Army Pension</option>
                            <option value="Income: Other">Income: Other</option>
                            <option value="Expense: Business Materials">Expense: Business Materials</option>
                            <option value="Expense: Business Rent">Expense: Business Rent</option>
                            <option value="Expense: Business Salaries">Expense: Business Salaries</option>
                            <option value="Expense: Business Other">Expense: Business Other</option>
                            <option value="Expense: Personal Groceries">Expense: Personal Groceries</option>
                            <option value="Expense: Personal Transport">Expense: Personal Transport</option>
                            <option value="Expense: Personal Bills">Expense: Personal Bills</option>
                            <option value="Expense: Personal Other">Expense: Personal Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDate">Date:</label>
                        <input type="date" id="entryDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryAmount">Amount (Rs.):</label>
                        <input type="number" id="entryAmount" value="0" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDescription">Description:</label>
                        <textarea id="entryDescription" placeholder="e.g., Monthly shop loan, School fee" list="expenseDescriptionList"></textarea>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" onclick="saveFinancialEntry()">
                            <i class="fas fa-save"></i> Save Entry
                        </button>
                    </div>
                </div>

                <div id="managePayables" class="tab-content">
                    <div class="admin-section">
                        <h4>Add New Payable</h4>
                        <div class="form-group">
                            <label for="payableName">Name:</label>
                            <input type="text" id="payableName" placeholder="Mobile, Business Loan...">
                        </div>
                        <div class="form-group">
                            <label for="payableAmount">Amount (Rs.):</label>
                            <input type="number" id="payableAmount" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="payableDueDate">Due Date:</label>
                            <input type="date" id="payableDueDate">
                        </div>
                        <div class="form-group">
                            <label for="payableDescription">Description:</label>
                            <textarea id="payableDescription" placeholder="Description of the payable"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="addPayable()">
                            <i class="fas fa-plus"></i> Add Payable
                        </button>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Payables</h4>
                        <div id="payablesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-panel">
            <h2 class="section-title"><i class="fas fa-cog"></i> Admin Panel</h2>
            
            <div class="login-section" id="adminLoginSection">
                <h3>Admin Login</h3>
                <div class="login-form">
                    <div class="form-field">
                        <label for="adminUsername">Username:</label>
                        <input type="text" id="adminUsername" placeholder="Enter admin username">
                    </div>
                    <div class="form-field">
                        <label for="adminPassword">Password:</label>
                        <input type="password" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
            
            <div class="admin-panel" id="adminPanel">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 'manageItems')">Manage Items</div>
                    <div class="tab" onclick="switchTab(this, 'manageCustomers')">Manage Customers</div>
                    <div class="tab" onclick="switchTab(this, 'viewHistory')">View History</div>
                    <div class="tab" onclick="switchTab(this, 'importExport')">Import/Export</div>
                </div>
                
                <div id="manageItems" class="tab-content active">
                    <div class="admin-section">
                        <h4>Add New Item</h4>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newItemMainCategory">Main Category:</label>
                                <input type="text" id="newItemMainCategory" placeholder="e.g., Visiting Cards">
                            </div>
                            <div class="form-field">
                                <label for="newItemSubCategory">Subcategory:</label>
                                <input type="text" id="newItemSubCategory" placeholder="e.g., Standard">
                            </div>
                            <div class="form-field">
                                <label for="newItemName">Item Name:</label>
                                <input type="text" id="newItemName" placeholder="e.g., 500 GSM">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newItemBasePrice">Base Price (Rs.):</label>
                                <input type="number" id="newItemBasePrice" value="0" min="0" step="0.01">
                            </div>
                            <div class="form-field">
                                <label for="newItemUnit">Unit:</label>
                                <input type="text" id="newItemUnit" placeholder="e.g., Set, Piece, Sheet">
                            </div>
                        </div>
                        
                        <h5>Price Tiers</h5>
                        <div id="newItemPriceTiers">
                            <div class="tier-row">
                                <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                                <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                                <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button class="btn btn-success" onclick="addTier()">
                                <i class="fas fa-plus"></i> Add Tier
                            </button>
                            <button class="btn btn-primary" onclick="addNewItem()">
                                <i class="fas fa-save"></i> Save Item
                            </button>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Items</h4>
                        <div id="itemsList"></div>
                    </div>
                </div>
                
                <div id="manageCustomers" class="tab-content">
                    <div class="admin-section">
                        <h4>Add New Customer</h4>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newCustomerName">Name:</label>
                                <input type="text" id="newCustomerName" placeholder="Customer name">
                            </div>
                            <div class="form-field">
                                <label for="newCustomerPhone">Phone:</label>
                                <input type="tel" id="newCustomerPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newCustomerAddress">Address:</label>
                                <textarea id="newCustomerAddress" placeholder="Customer address"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addNewCustomer()">
                            <i class="fas fa-plus"></i> Add Customer
                        </button>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Customers</h4>
                        <div id="customersList"></div>
                    </div>
                </div>
                
                <div id="viewHistory" class="tab-content">
                    <div class="admin-section">
                        <h4>Calculation History</h4>
                        <div id="calculationHistory"></div>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Invoice History</h4>
                        <div id="invoiceHistory"></div>
                    </div>
                </div>
                
                <div id="importExport" class="tab-content">
                    <div class="import-export-section">
                        <h4>Export Data</h4>
                        <div class="actions">
    <button class="btn btn-success" onclick="exportData('items')">
        <i class="fas fa-download"></i> Export Items (JSON)
    </button>
    <button class="btn btn-warning" onclick="exportToGoogleSheets('items')">
        <i class="fab fa-google"></i> Export Items to Sheets
    </button>
    
    <button class="btn btn-success" onclick="exportData('customers')">
        <i class="fas fa-download"></i> Export Customers (JSON)
    </button>
    <button class="btn btn-warning" onclick="exportToGoogleSheets('customers')">
        <i class="fab fa-google"></i> Export Customers to Sheets
    </button>
    
    <button class="btn btn-success" onclick="exportData('invoices')">
        <i class="fas fa-download"></i> Export Invoices (JSON)
    </button>
    <button class="btn btn-warning" onclick="exportToGoogleSheets('invoices')">
        <i class="fab fa-google"></i> Export Invoices to Sheets
    </button>
    
    <button class="btn btn-success" onclick="exportData('financial')">
        <i class="fas fa-download"></i> Export Financial (JSON)
    </button>
    <button class="btn btn-warning" onclick="exportToGoogleSheets('financial')">
        <i class="fab fa-google"></i> Export Financial to Sheets
    </button>
    
    <button class="btn btn-warning" onclick="exportToGoogleSheets('payables')">
        <i class="fab fa-google"></i> Export Payables to Sheets
    </button>
    
    <button class="btn btn-primary" onclick="exportAllToGoogleSheets()">
        <i class="fab fa-google"></i> Export ALL to Google Sheets
    </button>
</div>
                    </div>
                    
                    <div class="import-export-section">
                        <h4>Import Data</h4>
                        <div class="form-group">
                            <label for="importType">Data Type:</label>
                            <select id="importType">
                                <option value="items">Items</option>
                                <option value="customers">Customers</option>
                                <option value="invoices">Invoices</option>
                                <option value="financial">Financial Data</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="importFile">Select File:</label>
                            <input type="file" id="importFile" accept=".json">
                        </div>
                        <button class="btn btn-primary" onclick="importData()">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Datalists for autocomplete -->
    <datalist id="customerNameList"></datalist>
    <datalist id="customerPhoneList"></datalist>
    <datalist id="invoiceItemList"></datalist>
    <datalist id="expenseDescriptionList"></datalist>

    <script>
        // Global variables
        let itemsData = [];
        let customersData = [];
        let invoicesData = [];
        let financialData = [];
        let payablesData = [];
        let calculationHistory = [];
        let isAuthenticated = false;
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let currentUser = null;
        let currentFileId = null;
        let syncInterval;

        // Google API Configuration
        const CLIENT_ID = '575508533509-s61q4570mladu8ntspla2j1rc1ejldc0.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initApp();
            
            // Set current date for invoice
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            
            // Load data from localStorage
            loadLocalData();
            
            // Initialize Google APIs
            initGoogleAPIs();
            
            // Update invoice number
            updateInvoiceNumber();
            
            // Update financial dashboard
            updateFinancialDashboard();
            
            // Load admin panel data if logged in
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminLoginSection').style.display = 'none';
                loadAdminPanelData();
            }
        });

        // Initialize the application
        function initApp() {
            // Initialize default items if none exist
            if (!localStorage.getItem('itemsData')) {
                initializeDefaultItems();
            }
            
            // Initialize default customers if none exist
            if (!localStorage.getItem('customersData')) {
                initializeDefaultCustomers();
            }
            
            // Set up auto-save listeners
            setupAutoSaveListeners();
            
            // Set up sync interval
            syncInterval = setInterval(() => {
                if (isAuthenticated) {
                    saveAllData(false);
                }
            }, 30000); // Auto-sync every 30 seconds
        }

        // Initialize Google APIs
        function initGoogleAPIs() {
            // Load the Google API client library
            gapi.load('client', initializeGapiClient);
            
            // Initialize the Google Identity Services client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // defined later
            });
        }

        // Initialize the Google API client
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing Google API client:', error);
            }
        }

        // Enable buttons when APIs are loaded
        function maybeEnableButtons() {
            if (gapiInited) {
                document.getElementById('loginBtn').disabled = false;
            }
        }

        // Google Sign In
        function signIn() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw resp;
                }
                
                isAuthenticated = true;
                currentUser = gapi.client.getToken().access_token;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('syncStatus').className = 'sync-status sync-online';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Synced with Google Drive';
                
                // Get user info
                try {
                    const userInfo = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                        headers: {
                            'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                        }
                    }).then(res => res.json());
                    
                    document.getElementById('userName').textContent = userInfo.name || userInfo.email;
                } catch (error) {
                    console.error('Error fetching user info:', error);
                    document.getElementById('userName').textContent = 'Google User';
                }
                
                // Load data from Google Drive
                loadFromGoogleDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Google Sign Out
        function signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                isAuthenticated = false;
                currentUser = null;
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('syncStatus').className = 'sync-status sync-offline';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> Offline Mode - Data stored locally';
                
                showNotification('Signed out successfully', 'info');
            }
        }

        // Save all data to Google Drive
        async function saveAllData(forceNotification = false) {
            if (!isAuthenticated) {
                if (forceNotification) {
                    showNotification('Please sign in to sync data', 'warning');
                }
                return;
            }
            
            try {
                // Prepare data for saving
                const dataToSave = {
                    items: itemsData,
                    customers: customersData,
                    invoices: invoicesData,
                    financial: financialData,
                    payables: payablesData,
                    calculationHistory: calculationHistory,
                    lastSync: new Date().toISOString()
                };
                
                // Convert to JSON
                const jsonData = JSON.stringify(dataToSave, null, 2);
                
                // Check if file already exists
                if (currentFileId) {
                    // Update existing file
                    await updateFile(currentFileId, jsonData);
                } else {
                    // Create new file
                    const fileId = await createFile('arham_printers_data.json', jsonData);
                    currentFileId = fileId;
                }
                
                if (forceNotification) {
                    showNotification('Data synced to Google Drive successfully', 'success');
                }
                
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Last synced: ' + new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error saving data to Google Drive:', error);
                if (forceNotification) {
                    showNotification('Error syncing data to Google Drive', 'error');
                }
            }
        }

        // Load data from Google Drive
        async function loadFromGoogleDrive() {
            if (!isAuthenticated) return;
            
            try {
                // Search for existing file
                const files = await listFiles('arham_printers_data.json');
                
                if (files && files.length > 0) {
                    // File exists, load it
                    const fileId = files[0].id;
                    currentFileId = fileId;
                    
                    const fileContent = await getFileContent(fileId);
                    const data = JSON.parse(fileContent);
                    
                    // Update local data
                    if (data.items) itemsData = data.items;
                    if (data.customers) customersData = data.customers;
                    if (data.invoices) invoicesData = data.invoices;
                    if (data.financial) financialData = data.financial;
                    if (data.payables) payablesData = data.payables;
                    if (data.calculationHistory) calculationHistory = data.calculationHistory;
                    
                    // Save to localStorage as backup
                    saveLocalData();
                    
                    // Update UI
                    updateCategories();
                    updateCustomerLists();
                    updateInvoiceLists();
                    updateFinancialDashboard();
                    updatePayablesList();
                    
                    showNotification('Data loaded from Google Drive successfully', 'success');
                } else {
                    // No file exists, create one with current data
                    saveAllData(false);
                }
            } catch (error) {
                console.error('Error loading data from Google Drive:', error);
                showNotification('Error loading data from Google Drive', 'error');
            }
        }

        // Google Drive API functions
        async function createFile(name, content) {
            const file = await gapi.client.drive.files.create({
                resource: {
                    name: name,
                    mimeType: 'application/json'
                },
                media: {
                    mimeType: 'application/json',
                    body: content
                }
            });
            return file.result.id;
        }

        async function updateFile(fileId, content) {
            await gapi.client.drive.files.update({
                fileId: fileId,
                media: {
                    mimeType: 'application/json',
                    body: content
                }
            });
        }

        async function listFiles(name) {
            const response = await gapi.client.drive.files.list({
                q: `name='${name}' and trashed=false`,
                fields: 'files(id, name)'
            });
            return response.result.files;
        }

        async function getFileContent(fileId) {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            return response.body;
        }
        // =============================================
        // GOOGLE SHEETS EXPORT FUNCTIONS
        // =============================================
        
        // Export data to Google Sheets
        async function exportToGoogleSheets(type) {
            if (!isAuthenticated) {
                showNotification('Please sign in to Google to export to Sheets', 'error');
                return;
            }

            try {
                let data, sheetName;
                
                switch(type) {
                    case 'items':
                        data = itemsData;
                        sheetName = 'Items';
                        break;
                    case 'customers':
                        data = customersData;
                        sheetName = 'Customers';
                        break;
                    case 'invoices':
                        data = invoicesData;
                        sheetName = 'Invoices';
                        break;
                    case 'financial':
                        data = financialData;
                        sheetName = 'Financial_Entries';
                        break;
                    case 'payables':
                        data = payablesData;
                        sheetName = 'Payables';
                        break;
                }

                // Create or get spreadsheet
                const spreadsheetId = await createOrGetSpreadsheet();
                
                // Update sheet with data
                await updateSheetData(spreadsheetId, sheetName, data);
                
                showNotification(`${sheetName} data exported to Google Sheets successfully!`, 'success');
            } catch (error) {
                console.error('Error exporting to Google Sheets:', error);
                showNotification('Error exporting to Google Sheets: ' + error.message, 'error');
            }
        }

        // Create or get the main spreadsheet
        async function createOrGetSpreadsheet() {
            const spreadsheetName = 'Arham Printers Master Data';
            
            try {
                // Check if spreadsheet exists
                const response = await gapi.client.drive.files.list({
                    q: `name='${spreadsheetName}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    return response.result.files[0].id;
                } else {
                    // Create new spreadsheet
                    const spreadsheet = await gapi.client.sheets.spreadsheets.create({
                        properties: {
                            title: spreadsheetName
                        },
                        sheets: [
                            { properties: { title: 'Items' } },
                            { properties: { title: 'Customers' } },
                            { properties: { title: 'Invoices' } },
                            { properties: { title: 'Financial_Entries' } },
                            { properties: { title: 'Payables' } }
                        ]
                    });
                    return spreadsheet.result.spreadsheetId;
                }
            } catch (error) {
                console.error('Error creating/getting spreadsheet:', error);
                throw error;
            }
        }

        // Update sheet data
        async function updateSheetData(spreadsheetId, sheetName, data) {
            if (!data || data.length === 0) {
                // Clear the sheet if no data
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: spreadsheetId,
                    range: `${sheetName}!A:Z`
                });
                return;
            }
            
            try {
                // Get headers from first object
                const headers = Object.keys(data[0]);
                const values = [headers];
                
                // Convert data to 2D array
                data.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header];
                        // Handle different data types
                        if (value === null || value === undefined) return '';
                        if (typeof value === 'object') return JSON.stringify(value);
                        return value.toString();
                    });
                    values.push(row);
                });
                
                // Update sheet
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: `${sheetName}!A1`,
                    valueInputOption: 'RAW',
                    resource: {
                        values: values
                    }
                });
                
                // Auto-resize columns
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        requests: [{
                            autoResizeDimensions: {
                                dimensions: {
                                    sheetId: await getSheetId(spreadsheetId, sheetName),
                                    dimension: 'COLUMNS',
                                    startIndex: 0,
                                    endIndex: headers.length
                                }
                            }
                        }]
                    }
                });
                
            } catch (error) {
                console.error('Error updating sheet data:', error);
                throw error;
            }
        }

        // Get sheet ID by name
        async function getSheetId(spreadsheetId, sheetName) {
            const spreadsheet = await gapi.client.sheets.spreadsheets.get({
                spreadsheetId: spreadsheetId
            });
            
            const sheet = spreadsheet.result.sheets.find(s => 
                s.properties.title === sheetName
            );
            
            return sheet ? sheet.properties.sheetId : 0;
        }

        // Export all data to Google Sheets at once
        async function exportAllToGoogleSheets() {
            if (!isAuthenticated) {
                showNotification('Please sign in to Google to export to Sheets', 'error');
                return;
            }

            try {
                showNotification('Starting export to Google Sheets...', 'info');
                
                const spreadsheetId = await createOrGetSpreadsheet();
                
                // Export each data type
                await updateSheetData(spreadsheetId, 'Items', itemsData);
                await updateSheetData(spreadsheetId, 'Customers', customersData);
                await updateSheetData(spreadsheetId, 'Invoices', invoicesData);
                await updateSheetData(spreadsheetId, 'Financial_Entries', financialData);
                await updateSheetData(spreadsheetId, 'Payables', payablesData);
                
                showNotification('All data exported to Google Sheets successfully!', 'success');
            } catch (error) {
                console.error('Error exporting all to Google Sheets:', error);
                showNotification('Error exporting to Google Sheets: ' + error.message, 'error');
            }
        }
        // Local storage functions
        function saveLocalData() {
            localStorage.setItem('itemsData', JSON.stringify(itemsData));
            localStorage.setItem('customersData', JSON.stringify(customersData));
            localStorage.setItem('invoicesData', JSON.stringify(invoicesData));
            localStorage.setItem('financialData', JSON.stringify(financialData));
            localStorage.setItem('payablesData', JSON.stringify(payablesData));
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }

        function loadLocalData() {
            const items = localStorage.getItem('itemsData');
            const customers = localStorage.getItem('customersData');
            const invoices = localStorage.getItem('invoicesData');
            const financial = localStorage.getItem('financialData');
            const payables = localStorage.getItem('payablesData');
            const history = localStorage.getItem('calculationHistory');
            
            if (items) itemsData = JSON.parse(items);
            if (customers) customersData = JSON.parse(customers);
            if (invoices) invoicesData = JSON.parse(invoices);
            if (financial) financialData = JSON.parse(financial);
            if (payables) payablesData = JSON.parse(payables);
            if (history) calculationHistory = JSON.parse(history);
            
            // Update UI with loaded data
            updateCategories();
            updateCustomerLists();
            updateInvoiceLists();
            updateFinancialDashboard();
            updatePayablesList();
        }

        // Initialize default items
        function initializeDefaultItems() {
            itemsData = [
                {
                    mainCategory: "Visiting Cards",
                    subCategory: "Standard",
                    itemName: "500 GSM",
                    basePrice: 350,
                    unit: "Set",
                    priceTiers: [
                        { min: 1, max: 100, price: 350 },
                        { min: 101, max: 250, price: 320 },
                        { min: 251, max: 500, price: 300 },
                        { min: 501, max: 1000, price: 280 }
                    ]
                },
                {
                    mainCategory: "Visiting Cards",
                    subCategory: "Premium",
                    itemName: "600 GSM",
                    basePrice: 500,
                    unit: "Set",
                    priceTiers: [
                        { min: 1, max: 100, price: 500 },
                        { min: 101, max: 250, price: 450 },
                        { min: 251, max: 500, price: 420 },
                        { min: 501, max: 1000, price: 400 }
                    ]
                },
                {
                    mainCategory: "Brochures",
                    subCategory: "A4 Size",
                    itemName: "150 GSM",
                    basePrice: 15,
                    unit: "Piece",
                    priceTiers: [
                        { min: 1, max: 100, price: 15 },
                        { min: 101, max: 500, price: 12 },
                        { min: 501, max: 1000, price: 10 },
                        { min: 1001, max: 5000, price: 8 }
                    ]
                }
            ];
            
            saveLocalData();
        }

        // Initialize default customers
        function initializeDefaultCustomers() {
            customersData = [
                {
                    id: 1,
                    name: "Ali Ahmed",
                    phone: "0300-1234567",
                    address: "Main Market, Lahore"
                },
                {
                    id: 2,
                    name: "Fatima Khan",
                    phone: "0312-7654321",
                    address: "Gulberg, Lahore"
                },
                {
                    id: 3,
                    name: "Bilal Siddiqui",
                    phone: "0333-9876543",
                    address: "Model Town, Lahore"
                }
            ];
            
            saveLocalData();
        }

        // Update categories dropdown
        function updateCategories() {
            const mainCategorySelect = document.getElementById('mainCategory');
            mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
            
            const mainCategories = [...new Set(itemsData.map(item => item.mainCategory))];
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            });
            
            // Also update the invoice item list
            updateInvoiceItemList();
        }

        // Update subcategories based on main category
        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (!mainCategory) return;
            
            const subCategories = [...new Set(itemsData
                .filter(item => item.mainCategory === mainCategory)
                .map(item => item.subCategory))];
                
            subCategories.forEach(subCategory => {
                const option = document.createElement('option');
                option.value = subCategory;
                option.textContent = subCategory;
                subCategorySelect.appendChild(option);
            });
            
            // Clear item selection
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
        }

        // Update items based on subcategory
        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemNameSelect = document.getElementById('itemName');
            itemNameSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (!mainCategory || !subCategory) return;
            
            const items = itemsData.filter(item => 
                item.mainCategory === mainCategory && 
                item.subCategory === subCategory
            );
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.itemName;
                option.textContent = item.itemName;
                itemNameSelect.appendChild(option);
            });
        }

        // Update quantity input based on item unit
        function updateQuantityInput() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            
            if (!mainCategory || !subCategory || !itemName) return;
            
            const item = itemsData.find(item => 
                item.mainCategory === mainCategory && 
                item.subCategory === subCategory && 
                item.itemName === itemName
            );
            
            if (item) {
                const container = document.getElementById('quantityInputContainer');
                container.innerHTML = `<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()" placeholder="Enter quantity">`;
                document.getElementById('priceTierTagGroup').style.display = 'none';
            }
        }

        // Clear tier tag when quantity changes
        function clearTierTag() {
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        // Calculate price based on selected item and quantity
        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const designCharges = parseFloat(document.getElementById('designCharges').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) {
                showNotification('Please select category and item', 'error');
                return;
            }
            
            const item = itemsData.find(item => 
                item.mainCategory === mainCategory && 
                item.subCategory === subCategory && 
                item.itemName === itemName
            );
            
            if (!item) {
                showNotification('Item not found', 'error');
                return;
            }
            
            // Find the appropriate price tier
            let unitPrice = item.basePrice;
            let selectedTier = null;
            
            for (const tier of item.priceTiers) {
                if (quantity >= tier.min && quantity <= tier.max) {
                    unitPrice = tier.price;
                    selectedTier = tier;
                    break;
                }
            }
            
            // If quantity exceeds all tiers, use the last tier price
            if (!selectedTier && item.priceTiers.length > 0) {
                const lastTier = item.priceTiers[item.priceTiers.length - 1];
                if (quantity > lastTier.max) {
                    unitPrice = lastTier.price;
                    selectedTier = { min: lastTier.max + 1, max: Infinity, price: lastTier.price };
                }
            }
            
            // Calculate total price
            const itemPrice = unitPrice * quantity;
            const totalPrice = itemPrice + designCharges;
            
            // Display results
            const resultDiv = document.getElementById('result');
            const breakdownDiv = document.getElementById('priceBreakdown');
            const breakdownContent = document.getElementById('breakdownContent');
            
            resultDiv.innerHTML = `
                <h3><i class="fas fa-receipt"></i> Price Calculation Result</h3>
                <p>Total Price: <strong>Rs. ${totalPrice.toFixed(2)}</strong></p>
            `;
            
            breakdownContent.innerHTML = `
                <div class="breakdown-item">
                    <span>Item: ${itemName}</span>
                    <span>Rs. ${unitPrice.toFixed(2)} Ã— ${quantity} ${item.unit}</span>
                </div>
                <div class="breakdown-item">
                    <span>Item Price:</span>
                    <span>Rs. ${itemPrice.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Design Charges:</span>
                    <span>Rs. ${designCharges.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Total Price:</span>
                    <span>Rs. ${totalPrice.toFixed(2)}</span>
                </div>
            `;
            
            // Show tier information if applicable
            if (selectedTier) {
                const tierTagGroup = document.getElementById('priceTierTagGroup');
                const tierTag = document.getElementById('priceTierTag');
                
                let tierText = '';
                if (selectedTier.max === Infinity) {
                    tierText = `Set ${selectedTier.min}+ (Rs. ${selectedTier.price}/${item.unit})`;
                } else {
                    tierText = `Set ${selectedTier.min}-${selectedTier.max} (Rs. ${selectedTier.price}/${item.unit})`;
                }
                
                tierTag.textContent = tierText;
                tierTagGroup.style.display = 'block';
            }
            
            resultDiv.style.display = 'block';
            breakdownDiv.style.display = 'block';
            
            // Add to calculation history
            const calculation = {
                timestamp: new Date().toISOString(),
                category: mainCategory,
                subcategory: subCategory,
                item: itemName,
                quantity: quantity,
                unitPrice: unitPrice,
                designCharges: designCharges,
                totalPrice: totalPrice
            };
            
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 100) {
                calculationHistory = calculationHistory.slice(0, 100);
            }
            
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
        }

        // Clear the calculator form
        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantity').value = '1';
            document.getElementById('designCharges').value = '0';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        // Invoice System Functions

        // Update invoice number
        function updateInvoiceNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            // Find the highest invoice number for today
            let maxNumber = 0;
            const todayInvoices = invoicesData.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getFullYear() === year && 
                       invDate.getMonth() === today.getMonth() && 
                       invDate.getDate() === today.getDate();
            });
            
            todayInvoices.forEach(inv => {
                const parts = inv.invoiceNo.split('-');
                if (parts.length === 4) {
                    const num = parseInt(parts[3]);
                    if (num > maxNumber) maxNumber = num;
                }
            });
            
            const nextNumber = maxNumber + 1;
            const invoiceNo = `INV-${year}${month}${day}-${String(nextNumber).padStart(3, '0')}`;
            document.getElementById('invoiceNo').value = invoiceNo;
        }

        // Add invoice item row
        function addInvoiceItem() {
            const tbody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                    </div>
                </td>
                <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-amount" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(newRow);
            
            // Add autocomplete to the new item name input
            const itemNameInput = newRow.querySelector('.item-name');
            setupItemAutocomplete(itemNameInput);
        }

        // Remove invoice item row
        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            if (document.getElementById('itemsTableBody').children.length > 1) {
                row.remove();
                calculateTotal();
            } else {
                showNotification('Invoice must have at least one item', 'warning');
            }
        }

        // Calculate invoice totals
        function calculateTotal() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = (rate * quantity) + designCharges;
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = total + previousBalance - payment;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
        }

        // Save invoice
        function saveInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value.trim();
            const customerPhone = document.getElementById('invoiceCustomerPhone').value.trim();
            const invoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            if (!invoiceDate) {
                showNotification('Please select invoice date', 'error');
                return;
            }
            
            // Collect items
            const items = [];
            const rows = document.querySelectorAll('#itemsTableBody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                
                if (name) {
                    items.push({
                        name,
                        rate,
                        quantity,
                        designCharges,
                        amount
                    });
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one item to the invoice', 'error');
                return;
            }
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const taxAmount = subtotal * (taxRate / 100);
            const total = subtotal + taxAmount;
            const remainingBalance = total + previousBalance - payment;
            
            // Create invoice object
            const invoice = {
                id: Date.now(),
                invoiceNo,
                date: invoiceDate,
                customerName,
                customerPhone,
                items,
                subtotal,
                taxRate,
                taxAmount,
                total,
                previousBalance,
                payment,
                remainingBalance,
                timestamp: new Date().toISOString()
            };
            
            // Add to invoices data
            invoicesData.unshift(invoice);
            
            // Check if customer exists, if not add them
            const customerExists = customersData.some(customer => 
                customer.name.toLowerCase() === customerName.toLowerCase()
            );
            
            if (!customerExists && customerName) {
                const newCustomer = {
                    id: Date.now(),
                    name: customerName,
                    phone: customerPhone,
                    address: ''
                };
                customersData.push(newCustomer);
                updateCustomerLists();
            }
            
            // Save data
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
            
            // Show success message
            showNotification('Invoice saved successfully', 'success');
            
            // Clear invoice form
            clearInvoice();
            
            // Update financial dashboard
            updateFinancialDashboard();
        }

        // Clear invoice form
        function clearInvoice() {
            document.getElementById('invoiceCustomerName').value = '';
            document.getElementById('invoiceCustomerPhone').value = '';
            document.getElementById('taxRate').value = '0';
            document.getElementById('previousBalance').value = '0';
            document.getElementById('payment').value = '0';
            
            // Clear items table except first row
            const tbody = document.getElementById('itemsTableBody');
            while (tbody.children.length > 1) {
                tbody.removeChild(tbody.lastChild);
            }
            
            // Reset first row
            const firstRow = tbody.children[0];
            firstRow.querySelector('.item-name').value = '';
            firstRow.querySelector('.item-rate').value = '0';
            firstRow.querySelector('.item-quantity').value = '1';
            firstRow.querySelector('.item-design-charges').value = '0';
            firstRow.querySelector('.item-amount').value = '0';
            
            // Update invoice number and reset totals
            updateInvoiceNumber();
            calculateTotal();
        }

        // Update customer lists for autocomplete
        function updateCustomerLists() {
            const customerNameList = document.getElementById('customerNameList');
            const customerPhoneList = document.getElementById('customerPhoneList');
            
            customerNameList.innerHTML = '';
            customerPhoneList.innerHTML = '';
            
            customersData.forEach(customer => {
                const nameOption = document.createElement('option');
                nameOption.value = customer.name;
                customerNameList.appendChild(nameOption);
                
                if (customer.phone) {
                    const phoneOption = document.createElement('option');
                    phoneOption.value = customer.phone;
                    customerPhoneList.appendChild(phoneOption);
                }
            });
        }

        // Update invoice item list for autocomplete
        function updateInvoiceItemList() {
            const invoiceItemList = document.getElementById('invoiceItemList');
            invoiceItemList.innerHTML = '';
            
            itemsData.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.mainCategory} - ${item.subCategory} - ${item.itemName}`;
                invoiceItemList.appendChild(option);
            });
        }

        // Setup item autocomplete for invoice items
        function setupItemAutocomplete(input) {
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const suggestions = document.getElementById('customerSuggestions');
                
                if (value.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                // Filter items based on input
                const filteredItems = itemsData.filter(item => {
                    const itemText = `${item.mainCategory} - ${item.subCategory} - ${item.itemName}`.toLowerCase();
                    return itemText.includes(value);
                });
                
                if (filteredItems.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                // Show suggestions
                suggestions.innerHTML = '';
                filteredItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'customer-suggestion';
                    div.textContent = `${item.mainCategory} - ${item.subCategory} - ${item.itemName}`;
                    div.onclick = function() {
                        input.value = this.textContent;
                        suggestions.style.display = 'none';
                        
                        // Try to auto-fill rate if possible
                        const row = input.closest('tr');
                        const rateInput = row.querySelector('.item-rate');
                        rateInput.value = item.basePrice;
                        
                        calculateTotal();
                    };
                    suggestions.appendChild(div);
                });
                
                suggestions.style.display = 'block';
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    document.getElementById('customerSuggestions').style.display = 'none';
                }
            });
        }

        // Customer name autocomplete
        document.getElementById('invoiceCustomerName').addEventListener('input', function() {
            const value = this.value.toLowerCase();
            const suggestions = document.getElementById('customerSuggestions');
            
            if (value.length < 2) {
                suggestions.style.display = 'none';
                return;
            }
            
            // Filter customers based on input
            const filteredCustomers = customersData.filter(customer => 
                customer.name.toLowerCase().includes(value)
            );
            
            if (filteredCustomers.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            // Show suggestions
            suggestions.innerHTML = '';
            filteredCustomers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-suggestion';
                div.textContent = customer.name;
                div.onclick = function() {
                    document.getElementById('invoiceCustomerName').value = this.textContent;
                    document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
                    suggestions.style.display = 'none';
                };
                suggestions.appendChild(div);
            });
            
            suggestions.style.display = 'block';
        });

        // Financial Hub Functions

        // Switch financial tabs
        function switchFinancialTab(tabElement, tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('#FinancialHub .tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('#FinancialHub .tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
            
            // Update specific tab content if needed
            if (tabId === 'dashboard') {
                updateFinancialDashboard();
            } else if (tabId === 'managePayables') {
                updatePayablesList();
            }
        }

        // Toggle payment payable selection
        function togglePaymentPayable() {
            const entryType = document.getElementById('entryType').value;
            const paymentPayableGroup = document.getElementById('paymentPayableGroup');
            
            if (entryType === 'Payment') {
                paymentPayableGroup.style.display = 'block';
                updatePaymentPayableSelect();
            } else {
                paymentPayableGroup.style.display = 'none';
            }
        }

        // Update payment payable select options
        function updatePaymentPayableSelect() {
            const select = document.getElementById('paymentPayableSelect');
            select.innerHTML = '';
            
            const activePayables = payablesData.filter(p => !p.paid);
            activePayables.forEach(payable => {
                const option = document.createElement('option');
                option.value = payable.id;
                option.textContent = `${payable.name} - Rs. ${payable.amount.toFixed(2)}`;
                select.appendChild(option);
            });
            
            if (activePayables.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No active payables';
                select.appendChild(option);
            }
        }

        // Save financial entry
        function saveFinancialEntry() {
            const entryType = document.getElementById('entryType').value;
            const category = document.getElementById('entryCategory').value;
            const date = document.getElementById('entryDate').value;
            const amount = parseFloat(document.getElementById('entryAmount').value) || 0;
            const description = document.getElementById('entryDescription').value.trim();
            
            if (!date) {
                showNotification('Please select a date', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!description) {
                showNotification('Please enter a description', 'error');
                return;
            }
            
            // Create financial entry
            const entry = {
                id: Date.now(),
                type: entryType,
                category,
                date,
                amount,
                description,
                timestamp: new Date().toISOString()
            };
            
            // Handle payment entries
            if (entryType === 'Payment') {
                const payableId = parseInt(document.getElementById('paymentPayableSelect').value);
                if (payableId) {
                    const payable = payablesData.find(p => p.id === payableId);
                    if (payable) {
                        entry.payableId = payableId;
                        entry.payableName = payable.name;
                        
                        // Update payable status
                        payable.paidAmount = (payable.paidAmount || 0) + amount;
                        if (payable.paidAmount >= payable.amount) {
                            payable.paid = true;
                            payable.paidDate = date;
                        }
                    }
                }
            }
            
            // Add to financial data
            financialData.unshift(entry);
            
            // Save data
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
            
            // Show success message
            showNotification('Financial entry saved successfully', 'success');
            
            // Clear form
            document.getElementById('entryAmount').value = '0';
            document.getElementById('entryDescription').value = '';
            
            // Update dashboard and payables list
            updateFinancialDashboard();
            updatePayablesList();
        }

        // Add payable
        function addPayable() {
            const name = document.getElementById('payableName').value.trim();
            const amount = parseFloat(document.getElementById('payableAmount').value) || 0;
            const dueDate = document.getElementById('payableDueDate').value;
            const description = document.getElementById('payableDescription').value.trim();
            
            if (!name) {
                showNotification('Please enter payable name', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!dueDate) {
                showNotification('Please select due date', 'error');
                return;
            }
            
            // Create payable
            const payable = {
                id: Date.now(),
                name,
                amount,
                dueDate,
                description,
                paid: false,
                paidAmount: 0,
                timestamp: new Date().toISOString()
            };
            
            // Add to payables data
            payablesData.unshift(payable);
            
            // Save data
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
            
            // Show success message
            showNotification('Payable added successfully', 'success');
            
            // Clear form
            document.getElementById('payableName').value = '';
            document.getElementById('payableAmount').value = '0';
            document.getElementById('payableDueDate').value = '';
            document.getElementById('payableDescription').value = '';
            
            // Update payables list
            updatePayablesList();
        }

        // Update financial dashboard
        function updateFinancialDashboard() {
            const dashboardContainer = document.getElementById('financialDashboardContainer');
            const dashboardMonth = document.getElementById('dashboardMonth');
            
            // Get current month and year
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            dashboardMonth.textContent = currentMonth;
            
            // Calculate monthly totals
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            
            const monthlyIncome = financialData
                .filter(entry => entry.type === 'Income' && entry.date >= monthStart && entry.date <= monthEnd)
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const monthlyExpense = financialData
                .filter(entry => entry.type === 'Expense' && entry.date >= monthStart && entry.date <= monthEnd)
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const monthlyPayment = financialData
                .filter(entry => entry.type === 'Payment' && entry.date >= monthStart && entry.date <= monthEnd)
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const monthlyProfit = monthlyIncome - monthlyExpense - monthlyPayment;
            
            // Calculate net worth (all time)
            const totalIncome = financialData
                .filter(entry => entry.type === 'Income')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const totalExpense = financialData
                .filter(entry => entry.type === 'Expense' || entry.type === 'Payment')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const netWorth = totalIncome - totalExpense;
            
            // Update dashboard
            dashboardContainer.innerHTML = `
                <div class="dashboard-metric metric-income">
                    <span>Monthly Income</span>
                    <span class="metric-value">Rs. ${monthlyIncome.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-expense">
                    <span>Monthly Expenses</span>
                    <span class="metric-value">Rs. ${monthlyExpense.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-profit">
                    <span>Monthly Profit</span>
                    <span class="metric-value">Rs. ${monthlyProfit.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-net">
                    <span>Net Worth (All Time)</span>
                    <span class="metric-value">Rs. ${netWorth.toFixed(2)}</span>
                </div>
            `;
        }

        // Update payables list
        function updatePayablesList() {
            const payablesList = document.getElementById('payablesList');
            
            if (payablesData.length === 0) {
                payablesList.innerHTML = '<p>No payables found.</p>';
                return;
            }
            
            let html = '';
            payablesData.forEach(payable => {
                const dueDate = new Date(payable.dueDate);
                const today = new Date();
                const isOverdue = !payable.paid && dueDate < today;
                
                html += `
                    <div class="history-item ${isOverdue ? 'sync-offline' : ''}">
                        <div class="history-header">
                            <span>${payable.name}</span>
                            <span>Rs. ${payable.amount.toFixed(2)}</span>
                        </div>
                        <div class="history-details">
                            <div>Due: ${dueDate.toLocaleDateString()} ${isOverdue ? '<strong style="color: var(--danger);">(OVERDUE)</strong>' : ''}</div>
                            <div>${payable.description}</div>
                            <div>Status: ${payable.paid ? `Paid on ${new Date(payable.paidDate).toLocaleDateString()}` : `Pending (Paid: Rs. ${payable.paidAmount.toFixed(2)})`}</div>
                        </div>
                        ${!payable.paid ? `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success btn-sm" onclick="markPayablePaid(${payable.id})">
                                <i class="fas fa-check"></i> Mark Paid
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayable(${payable.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            payablesList.innerHTML = html;
        }

        // Mark payable as paid
        function markPayablePaid(id) {
            const payable = payablesData.find(p => p.id === id);
            if (payable) {
                payable.paid = true;
                payable.paidAmount = payable.amount;
                payable.paidDate = new Date().toISOString().split('T')[0];
                
                // Save data
                saveLocalData();
                if (isAuthenticated) {
                    saveAllData(false);
                }
                
                // Update UI
                updatePayablesList();
                showNotification('Payable marked as paid', 'success');
            }
        }

        // Delete payable
        function deletePayable(id) {
            if (confirm('Are you sure you want to delete this payable?')) {
                payablesData = payablesData.filter(p => p.id !== id);
                
                // Save data
                saveLocalData();
                if (isAuthenticated) {
                    saveAllData(false);
                }
                
                // Update UI
                updatePayablesList();
                showNotification('Payable deleted', 'success');
            }
        }

        // Admin Panel Functions

        // Admin login
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Simple authentication (in a real app, this would be more secure)
            if (username === 'admin' && password === 'admin123') {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminLoginSection').style.display = 'none';
                localStorage.setItem('adminLoggedIn', 'true');
                loadAdminPanelData();
                showNotification('Admin login successful', 'success');
            } else {
                showNotification('Invalid username or password', 'error');
            }
        }

        // Switch admin tabs
        function switchTab(tabElement, tabId) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
        }

        // Load admin panel data
        function loadAdminPanelData() {
            loadItemsList();
            loadCustomersList();
            loadCalculationHistory();
            loadInvoiceHistory();
        }

        // Load items list for admin panel
        function loadItemsList() {
            const itemsList = document.getElementById('itemsList');
            
            if (itemsData.length === 0) {
                itemsList.innerHTML = '<p>No items found.</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Main Category</th><th>Subcategory</th><th>Item Name</th><th>Base Price</th><th>Unit</th><th>Price Tiers</th><th>Actions</th></tr></thead><tbody>';
            
            itemsData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.mainCategory}</td>
                        <td>${item.subCategory}</td>
                        <td>${item.itemName}</td>
                        <td>Rs. ${item.basePrice.toFixed(2)}</td>
                        <td>${item.unit}</td>
                        <td>${item.priceTiers.map(tier => 
                            `${tier.min}-${tier.max}: Rs. ${tier.price}`
                        ).join(', ')}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editItem('${item.mainCategory}', '${item.subCategory}', '${item.itemName}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.mainCategory}', '${item.subCategory}', '${item.itemName}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            itemsList.innerHTML = html;
        }

        // Load customers list for admin panel
        function loadCustomersList() {
            const customersList = document.getElementById('customersList');
            
            if (customersData.length === 0) {
                customersList.innerHTML = '<p>No customers found.</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Name</th><th>Phone</th><th>Address</th><th>Actions</th></tr></thead><tbody>';
            
            customersData.forEach(customer => {
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.address}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editCustomer(${customer.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            customersList.innerHTML = html;
        }

        // Load calculation history for admin panel
        function loadCalculationHistory() {
            const calculationHistoryDiv = document.getElementById('calculationHistory');
            
            if (calculationHistory.length === 0) {
                calculationHistoryDiv.innerHTML = '<p>No calculation history found.</p>';
                return;
            }
            
            let html = '';
            calculationHistory.slice(0, 20).forEach(calc => {
                const date = new Date(calc.timestamp);
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span>${calc.item}</span>
                            <span>Rs. ${calc.totalPrice.toFixed(2)}</span>
                        </div>
                        <div class="history-details">
                            <div>${calc.category} - ${calc.subcategory}</div>
                            <div>Quantity: ${calc.quantity}, Unit Price: Rs. ${calc.unitPrice.toFixed(2)}, Design: Rs. ${calc.designCharges.toFixed(2)}</div>
                            <div>${date.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            calculationHistoryDiv.innerHTML = html;
        }

        // Load invoice history for admin panel
        function loadInvoiceHistory() {
            const invoiceHistoryDiv = document.getElementById('invoiceHistory');
            
            if (invoicesData.length === 0) {
                invoiceHistoryDiv.innerHTML = '<p>No invoice history found.</p>';
                return;
            }
            
            let html = '';
            invoicesData.slice(0, 20).forEach(invoice => {
                const date = new Date(invoice.date);
                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <span>${invoice.invoiceNo}</span>
                            <span>Rs. ${invoice.total.toFixed(2)}</span>
                        </div>
                        <div class="history-details">
                            <div>Customer: ${invoice.customerName} ${invoice.customerPhone ? `(${invoice.customerPhone})` : ''}</div>
                            <div>Items: ${invoice.items.length}, Balance: Rs. ${invoice.remainingBalance.toFixed(2)}</div>
                            <div>${date.toLocaleDateString()}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="viewInvoice(${invoice.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            invoiceHistoryDiv.innerHTML = html;
        }

        // Add new item
        function addNewItem() {
            const mainCategory = document.getElementById('newItemMainCategory').value.trim();
            const subCategory = document.getElementById('newItemSubCategory').value.trim();
            const itemName = document.getElementById('newItemName').value.trim();
            const basePrice = parseFloat(document.getElementById('newItemBasePrice').value) || 0;
            const unit = document.getElementById('newItemUnit').value.trim();
            
            if (!mainCategory || !subCategory || !itemName || !unit) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            if (basePrice <= 0) {
                showNotification('Please enter a valid base price', 'error');
                return;
            }
            
            // Collect price tiers
            const priceTiers = [];
            const tierRows = document.querySelectorAll('#newItemPriceTiers .tier-row');
            
            tierRows.forEach(row => {
                const min = parseInt(row.querySelector('.tier-min').value) || 0;
                const max = parseInt(row.querySelector('.tier-max').value) || 0;
                const price = parseFloat(row.querySelector('.tier-price').value) || 0;
                
                if (min > 0 && max >= min && price > 0) {
                    priceTiers.push({ min, max, price });
                }
            });
            
            // Sort price tiers by min quantity
            priceTiers.sort((a, b) => a.min - b.min);
            
            // Create new item
            const newItem = {
                mainCategory,
                subCategory,
                itemName,
                basePrice,
                unit,
                priceTiers
            };
            
            // Add to items data
            itemsData.push(newItem);
            
            // Save data
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
            
            // Update UI
            updateCategories();
            loadItemsList();
            
            // Clear form
            document.getElementById('newItemMainCategory').value = '';
            document.getElementById('newItemSubCategory').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemBasePrice').value = '0';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemPriceTiers').innerHTML = `
                <div class="tier-row">
                    <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                    <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                    <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            showNotification('Item added successfully', 'success');
        }

        // Add new customer
        function addNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            
            if (!name) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            // Create new customer
            const newCustomer = {
                id: Date.now(),
                name,
                phone,
                address
            };
            
            // Add to customers data
            customersData.push(newCustomer);
            
            // Save data
            saveLocalData();
            if (isAuthenticated) {
                saveAllData(false);
            }
            
            // Update UI
            updateCustomerLists();
            loadCustomersList();
            
            // Clear form
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerAddress').value = '';
            
            showNotification('Customer added successfully', 'success');
        }

        // Add price tier
        function addTier() {
            const tiersContainer = document.getElementById('newItemPriceTiers');
            const newTier = document.createElement('div');
            newTier.className = 'tier-row';
            newTier.innerHTML = `
                <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
            `;
            tiersContainer.appendChild(newTier);
        }

        // Remove price tier
        function removeTier(button) {
            const tierRow = button.closest('.tier-row');
            if (document.querySelectorAll('#newItemPriceTiers .tier-row').length > 1) {
                tierRow.remove();
            } else {
                showNotification('At least one price tier is required', 'warning');
            }
        }

        // Edit item (placeholder)
        function editItem(mainCategory, subCategory, itemName) {
            showNotification('Edit functionality coming soon', 'info');
        }

        // Delete item
        function deleteItem(mainCategory, subCategory, itemName) {
            if (confirm('Are you sure you want to delete this item?')) {
                itemsData = itemsData.filter(item => 
                    !(item.mainCategory === mainCategory && 
                      item.subCategory === subCategory && 
                      item.itemName === itemName)
                );
                
                // Save data
                saveLocalData();
                if (isAuthenticated) {
                    saveAllData(false);
                }
                
                // Update UI
                updateCategories();
                loadItemsList();
                
                showNotification('Item deleted successfully', 'success');
            }
        }

        // Edit customer (placeholder)
        function editCustomer(id) {
            showNotification('Edit functionality coming soon', 'info');
        }

        // Delete customer
        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                customersData = customersData.filter(customer => customer.id !== id);
                
                // Save data
                saveLocalData();
                if (isAuthenticated) {
                    saveAllData(false);
                }
                
                // Update UI
                updateCustomerLists();
                loadCustomersList();
                
                showNotification('Customer deleted successfully', 'success');
            }
        }

        // View invoice (placeholder)
        function viewInvoice(id) {
            showNotification('View invoice functionality coming soon', 'info');
        }

        // Delete invoice
        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoicesData = invoicesData.filter(invoice => invoice.id !== id);
                
                // Save data
                saveLocalData();
                if (isAuthenticated) {
                    saveAllData(false);
                }
                
                // Update UI
                loadInvoiceHistory();
                
                showNotification('Invoice deleted successfully', 'success');
            }
        }

        // Export data
        function exportData(type) {
            let data, filename;
            
            switch(type) {
                case 'items':
                    data = itemsData;
                    filename = 'arham_printers_items.json';
                    break;
                case 'customers':
                    data = customersData;
                    filename = 'arham_printers_customers.json';
                    break;
                case 'invoices':
                    data = invoicesData;
                    filename = 'arham_printers_invoices.json';
                    break;
                case 'financial':
                    data = financialData;
                    filename = 'arham_printers_financial.json';
                    break;
                default:
                    return;
            }
            
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Exported ${type} data successfully`, 'success');
        }

        // Import data
        function importData() {
            const fileInput = document.getElementById('importFile');
            const type = document.getElementById('importType').value;
            
            if (!fileInput.files.length) {
                showNotification('Please select a file to import', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    switch(type) {
                        case 'items':
                            itemsData = data;
                            updateCategories();
                            loadItemsList();
                            break;
                        case 'customers':
                            customersData = data;
                            updateCustomerLists();
                            loadCustomersList();
                            break;
                        case 'invoices':
                            invoicesData = data;
                            loadInvoiceHistory();
                            break;
                        case 'financial':
                            financialData = data;
                            updateFinancialDashboard();
                            break;
                    }
                    
                    // Save data
                    saveLocalData();
                    if (isAuthenticated) {
                        saveAllData(false);
                    }
                    
                    showNotification(`Imported ${type} data successfully`, 'success');
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error importing data:', error);
                    showNotification('Error importing data. Please check the file format.', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Setup auto-save listeners
        function setupAutoSaveListeners() {
            // Auto-save when inputs change (with debounce)
            let saveTimeout;
            const inputs = document.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveLocalData();
                    }, 1000);
                });
            });
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Initialize the app when DOM is loaded
        window.onload = function() {
            // Set current date for invoice and financial entry
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            document.getElementById('entryDate').value = today;
            
            // Setup item autocomplete for the first invoice item
            const firstItemInput = document.querySelector('.item-name');
            if (firstItemInput) {
                setupItemAutocomplete(firstItemInput);
            }
            
            // Update dashboard month
            updateFinancialDashboard();
        };
    </script>
</body>
</html>
