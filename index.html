<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #0078d4;
            --secondary-light: #1088e4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #0078d4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #1088e4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #dff6dd;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fff4ce;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Updated Grid for 3 Panels */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 30px;
        }

        /* Adjustments for smaller screens */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr 1fr; /* Switch to 2 columns on medium screens */
            }
        }
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr; /* Switch to 1 column on small screens */
            }
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0e6b0e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e6a200; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c02a2e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Item Editor Specific Styles */
        #itemEditor {
            border-top: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tier-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .tier-row input {
            padding: 8px;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Cloud Sync</p>
        </header>

        <div class="cloud-section">
            <h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="loginToOneDrive()" id="loginBtn">
                    <i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
                <button class="btn btn-success" onclick="window.syncAllToExcel()" id="syncBtn" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload All Data to Excel
                </button>
                <button class="btn btn-secondary" onclick="syncFromCloud()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Download Data (JSON)
                </button>
                <button class="btn btn-danger" onclick="logoutFromOneDrive()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is synced across all devices via OneDrive.</p>
            </div>
        </div>

        <div class="content-grid">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory" onchange="updateSubcategories()">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory" onchange="updateItemsAndFields()"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName" onchange="updateQuantityInput()"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantityInputContainer"><i class="fas fa-boxes"></i> Quantity / Set:</label>
                    <div id="quantityInputContainer" style="flex: 2;">
                        <input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">
                    </div>
                </div>
                
                <div class="form-group" id="priceTierTagGroup" style="margin-top: -10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f9f9f9; display: none;">
                    <label><i class="fas fa-tag"></i> Selected Set:</label>
                    <span id="priceTierTag" style="font-weight: bold; color: var(--danger);">Select a set.</span>
                </div>
                
                <div class="form-group">
                    <label for="designCharges"><i class="fas fa-paint-brush"></i> Design Charges (Rs.):</label>
                    <input type="number" id="designCharges" value="0" min="0" step="0.01">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
                
                <div class="form-group">
                    <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                    <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off" list="customerNameList">
                    <datalist id="customerNameList"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                    <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number" list="customerPhoneList">
                    <datalist id="customerPhoneList"></datalist>
                </div>
                
                <div class="form-group">
                    <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                    <input type="text" id="invoiceNo" readonly>
                </div>
                
                <div class="form-group">
                    <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>

                <h3>Invoice Items</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Rate (Rs.)</th>
                            <th>Qty</th>
                            <th>Design Charges (Rs.)</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td>
                                <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                            </td>
                            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-amount" value="0" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                 <datalist id="invoiceItemList"></datalist>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="addInvoiceItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button class="btn btn-secondary" onclick="calculateTotal()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>

                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                    
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>Rs. <span id="subtotalAmount">0.00</span></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="taxRate">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="previousBalance">Previous Balance (Rs.):</label>
                        <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment">Payment Received (Rs.):</label>
                        <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Remaining Balance:</strong></span>
                        <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="saveInvoice()">
                        <i class="fas fa-save"></i> Save & Sync Invoice
                    </button>
                    <button class="btn btn-warning" onclick="clearInvoice()">
                        <i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
                </div>
            </div>
            
            <div class="section-panel expense-panel">
                <h2 class="section-title"><i class="fas fa-money-check-alt"></i> Expense Tracker</h2>
                
                <div class="form-group">
                    <label for="expenseDate"><i class="fas fa-calendar-alt"></i> Date:</label>
                    <input type="date" id="expenseDate">
                </div>
                
                <div class="form-group">
                    <label for="expenseCategory"><i class="fas fa-tags"></i> Category:</label>
                    <select id="expenseCategory">
                        <option value="">Select Category</option>
                        <option value="Business: Materials">Business: Materials/Supplies</option>
                        <option value="Business: Rent">Business: Rent/Utilities</option>
                        <option value="Business: Salaries">Business: Salaries</option>
                        <option value="Business: Other">Business: Other</option>
                        <option value="Personal: Groceries">Personal: Groceries</option>
                        <option value="Personal: Transport">Personal: Transport</option>
                        <option value="Personal: Bills">Personal: Bills/Utilities (Home)</option>
                        <option value="Personal: Other">Personal: Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expenseAmount"><i class="fas fa-rupee-sign"></i> Amount (Rs.):</label>
                    <input type="number" id="expenseAmount" value="0" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="expenseDescription"><i class="fas fa-comment"></i> Description:</label>
                    <textarea id="expenseDescription" placeholder="e.g., A4 paper ream purchase, electricity bill" list="expenseDescriptionList"></textarea>
                    <datalist id="expenseDescriptionList"></datalist>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="saveExpense()">
                        <i class="fas fa-save"></i> Save & Sync Expense
                    </button>
                    <button class="btn btn-danger" onclick="clearExpenseForm()">
                        <i class="fas fa-trash-alt"></i> Clear Form
                    </button>
                </div>
                
                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-chart-line"></i> Budget Snapshot</h3>
                    <div id="budgetDisplay">
                        <p>No budget set. Go to Admin > Settings.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="login-section">
            <h2 class="section-title"><i class="fas fa-lock"></i> Administrator Access</h2>
            <div class="login-form">
                <div>
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="btn btn-warning" onclick="toggleAdmin()">
                    <i class="fas fa-key"></i> Admin Login
                </button>
            </div>
        </div>
        
        <div class="admin-panel" id="adminPanel">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Data & Invoice Management</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="data-management">Data Management</div>
                <div class="tab" data-tab="invoice-list">Invoice List</div>
                <div class="tab" data-tab="expenses-list">Expense List</div>
                <div class="tab" data-tab="history">Calculation History</div>
                <div class="tab" data-tab="settings">Settings</div>
                <div class="tab" data-tab="import-export">Import/Export</div>
            </div>
            
            <div class="tab-content active" id="data-management-tab">
                <div class="data-form admin-section">
                    <h3>Add New Item</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label>Main Category:</label>
                            <input type="text" id="newMainCategory" list="newMainCategoryList">
                            <datalist id="newMainCategoryList"></datalist>
                        </div>
                        <div class="form-field">
                            <label>Subcategory:</label>
                            <input type="text" id="newSubCategory" list="newSubCategoryList">
                            <datalist id="newSubCategoryList"></datalist>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-field">
                            <label>Item Name:</label>
                            <input type="text" id="newItemName" placeholder="e.g., A4 Letterpad (100 Pages)" list="newItemNameList">
                            <datalist id="newItemNameList"></datalist>
                        </div>
                        <div class="form-field">
                           <label>Profit Margin (%):</label>
                           <input type="number" id="newProfitMargin" value="25" min="0">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                    <p style="font-size: 0.9em; color: var(--gray); margin-top: 15px;">After adding, click 'Edit' below to add quantity sets and prices.</p>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Items</h3>
                    <table class="data-table" id="itemsTable"></table>
                </div>

                <div class="admin-section" id="itemEditor" style="display:none;">
                    <h3 id="editorTitle">Edit Item</h3>
                    <input type="hidden" id="editItemId">
                    <div class="form-row">
                        <div class="form-field">
                            <label>Item Name:</label>
                            <input type="text" id="editItemName">
                        </div>
                        <div class="form-field">
                            <label>Profit Margin (%):</label>
                            <input type="number" id="editProfitMargin">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-field">
                            <label>Default Design Charges (Rs):</label>
                            <input type="number" id="editDesignCharges">
                        </div>
                        <div class="form-field">
                           <label>Material Cost / Unit (Rs):</label>
                           <input type="number" id="editMaterialCostPerUnit" placeholder="For stamps, shields, etc.">
                        </div>
                    </div>
                    <hr style="margin: 20px 0;">
                    <h4>Quantity Sets / Price Tiers</h4>
                    <div id="tiersContainer"></div>
                    <button class="btn btn-outline btn-sm" onclick="addTierRow()"><i class="fas fa-plus"></i> Add Tier</button>
                    <hr style="margin: 20px 0;">
                    <div class="actions">
                        <button class="btn btn-primary" onclick="saveItemChanges()">Save Changes</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('itemEditor').style.display='none'">Cancel</button>
                    </div>
                </div>

            </div>
            
            <div class="tab-content" id="invoice-list-tab">
                <h3>Saved Invoices</h3>
                <div id="invoiceList">
                    <p>Load the Invoice List to manage customer records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="loadInvoiceList()">
                        <i class="fas fa-list"></i> Load Invoices
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="expenses-list-tab">
                <h3>Expense Records</h3>
                <div id="expenseList">
                    <p>Load the Expense List to view purchase records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="loadExpenseList()">
                        <i class="fas fa-list"></i> Load Expenses
                    </button>
                    <button class="btn btn-danger" onclick="clearAllExpenses()">
                        <i class="fas fa-trash"></i> Clear All Expenses
                    </button>
                </div>
            </div>

            <div class="tab-content" id="history-tab">
                <h3>Calculation History</h3>
                <div class="actions">
                    <button class="btn btn-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                <div id="historyList"></div>
            </div>
            
            <div class="tab-content" id="settings-tab">
                <h3>Application Settings</h3>
                
                <div class="admin-section">
                    <h4>Monthly Budget (Rs.)</h4>
                    <div class="form-group">
                        <label>Business Budget:</label>
                        <input type="number" id="budgetBusiness" min="0" value="50000">
                    </div>
                    <div class="form-group">
                        <label>Personal Budget:</label>
                        <input type="number" id="budgetPersonal" min="0" value="30000">
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
            
            <div class="tab-content" id="import-export-tab">
                <h3>Import/Export Data</h3>
                
                <div class="admin-section">
                    <h4><i class="fab fa-github"></i> GitHub Auto-Upload</h4>
                    <p style="font-size: 0.9em; color: var(--gray);">Paste your GitHub Personal Access Token here to upload directly to your repository.</p>
                    <div class="form-group">
                        <label for="githubPat">GitHub PAT:</label>
                        <input type="password" id="githubPat" placeholder="Paste your token here before exporting">
                    </div>
                    <p style="font-size: 0.8em; color: var(--danger);"><strong>Security Warning:</strong> Do NOT save this file with the token pasted in it. Only paste it when you need to upload.</p>
                </div>

                <div class="import-export-section">
                    <h4>Export Data</h4>
                    <div class="actions">
                        <button class="btn btn-warning" onclick="exportAllData()">
                            <i class="fas fa-file-export"></i> Export All Data (CSV)
                        </button>
                        <button class="btn btn-success" onclick="exportCustomerDataForGitHub()">
                            <i class="fas fa-cloud-upload"></i> Export Price Data (JSON)
                        </button>
                    </div>
                    <p><small>Export JSON for external/customer calculator sync. Export CSV for backup.</small></p>
                </div>
                
                <div class="import-export-section">
                    <h4>Reset Data</h4>
                    <p>Reset all data to default values. This cannot be undone.</p>
                    <div class="actions">
                        <button class="btn btn-danger" onclick="resetToDefault()">
                            <i class="fas fa-undo"></i> Reset to Default Data
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Save & Cloud Sync All
                </button>
                <button class="btn btn-secondary" onclick="toggleAdmin()">
                    <i class="fas fa-times"></i> Close Admin Panel
                </button>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, duration);
        }

        // =============================================
        // ONEDRIVE EXCEL SYNC CLASS
        // =============================================
        class OneDriveExcelSync {
            constructor() {
                this.excelFileId = null;
                this.excelFileName = 'Arham_Printers_Database.xlsx';
                this.excelFilePath = `/ArhamPrinters/${this.excelFileName}`;
                this.sheets = {
                    ITEMS: 'Calculator_Items',
                    INVOICES: 'Invoices',
                    CUSTOMERS: 'Customers',
                    SETTINGS: 'Settings',
                    HISTORY: 'Calculation_History',
                    EXPENSES: 'Expenses' 
                };
            }

            async ensureExcelFile() {
                const MAX_RETRIES = 3;
                let fileInfo = null;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        fileInfo = await this.getExcelFileInfo();
                        if (fileInfo) {
                            this.excelFileId = fileInfo.id;
                            await this.initializeSheets();
                            return true;
                        }

                        if (i === 0) {
                            const createSuccess = await this.createExcelFile();
                            if (createSuccess) {
                                fileInfo = await this.getExcelFileInfo();
                                this.excelFileId = fileInfo.id;
                            }
                        }

                        if (!this.excelFileId) throw new Error('File ID not available.');
                        
                        await new Promise(resolve => setTimeout(resolve, 5000 * (i + 1)));
                        await this.initializeSheets();
                        return true;

                    } catch (error) {
                        console.warn(`Attempt ${i + 1} failed:`, error.message);
                        if (i === MAX_RETRIES - 1) return false;
                    }
                }
                return false;
            }

            async getExcelFileInfo() {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return null;
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:${this.excelFilePath}`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                return response.ok ? await response.json() : null;
            }

            async createExcelFile() {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return false;
                try {
                    await this.ensureOneDriveFolder('/ArhamPrinters');
                    const emptyXLSX = new Uint8Array([0x50, 0x4b, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]).buffer;
                    const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/${this.excelFileName}:/content`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' },
                        body: emptyXLSX
                    });
                    if (response.ok || response.status === 201) {
                        this.excelFileId = (await response.json()).id;
                        return true;
                    }
                    return false;
                } catch (error) { return false; }
            }

            async ensureOneDriveFolder(folderPath) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return;
                try {
                    const check = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:${folderPath}`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                    if (check.ok) return;
                    await fetch(`https://graph.microsoft.com/v1.0/me/drive/root/children`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: folderPath.substring(1), folder: {}, '@microsoft.graph.conflictBehavior': 'ignore' })
                    });
                } catch (error) {}
            }

            async initializeSheets() {
                if (!this.excelFileId) return;
                const sheetPromises = Object.entries(this.sheets).map(([key, name]) => {
                    const headers = {
                        ITEMS: ['Main Category', 'Subcategory', 'Item Name', 'Profit Margin', 'Design Charges', 'Last Updated'],
                        INVOICES: ['Invoice No', 'Date', 'Customer', 'Total', 'Status'],
                        CUSTOMERS: ['Name', 'Phone', 'Balance'],
                        SETTINGS: ['Setting', 'Value'],
                        HISTORY: ['Date', 'Item', 'Qty', 'Price'],
                        EXPENSES: ['Date', 'Category', 'Amount', 'Description']
                    };
                    return this.updateSheetHeaders(name, headers[key] || [key]);
                });
                await Promise.allSettled(sheetPromises);
            }

            async syncAllDataToExcel(data, invoices, customers, history, expenses) {
                if (!await this.ensureExcelFile()) { return false; }
                try {
                    await Promise.all([
                        this.syncSheet(this.sheets.ITEMS, data.items.map(i => [i.mainCategory, i.subcategory, i.itemName, i.profitMargin, i.designCharges, new Date().toISOString()])),
                        this.syncSheet(this.sheets.INVOICES, invoices.map(inv => [inv.invoiceNo, inv.date, inv.customerName, inv.total, inv.status])),
                        this.syncSheet(this.sheets.CUSTOMERS, customers.map(c => [c.name, c.phone, c.balance])),
                        this.syncSheet(this.sheets.HISTORY, history.map(h => [h.timestamp, h.itemName, h.quantity, h.total])),
                        this.syncSheet(this.sheets.EXPENSES, expenses.map(e => [e.date, e.category, e.amount, e.description]))
                    ]);
                    return true;
                } catch (error) { return false; }
            }
            
            async syncSheet(sheetName, rows) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;
                await this.clearSheetData(sheetName);
                if (rows.length > 0) {
                    const range = `A2:${String.fromCharCode(64 + rows[0].length)}${rows.length + 1}`;
                    const endpoint = `https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='${range}')`;
                    await fetch(endpoint, { method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ values: rows }) });
                }
            }

            async uploadPublicJson(publicData) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken) return false;
                try {
                    await this.ensureOneDriveFolder('/ArhamPrinters');
                    const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/customer-data.json:/content`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(publicData, null, 2)
                    });
                    return response.ok;
                } catch (error) { return false; }
            }

            async updateSheetHeaders(sheetName, headers) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;
                const range = `A1:${String.fromCharCode(64 + headers.length)}1`;
                const endpoint = `https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='${range}')`;
                const response = await fetch(endpoint, { method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ values: [headers] }) });
                if (!response.ok) { await this.addWorksheet(sheetName); await fetch(endpoint, { method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ values: [headers] }) }); }
            }
            
            async addWorksheet(sheetName) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;
                await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets`, { method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: sheetName }) });
            }

            async clearSheetData(sheetName) {
                const accessToken = await getOneDriveAccessToken();
                if (!accessToken || !this.excelFileId) return;
                await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${this.excelFileId}/workbook/worksheets('${sheetName}')/range(address='A2:Z5000')/clear`, { method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ applyTo: 'contents' }) });
            }
        }

        const LIVE_DOMAIN_URL = "https://greenshirt3.github.io/ArhamP/index.html";
        const AZURE_CLIENT_ID = "26b3dde9-366f-487b-a485-79d1bf1ab857";
        const msalConfig = {
            auth: { clientId: AZURE_CLIENT_ID, authority: "https://login.microsoftonline.com/common", redirectUri: LIVE_DOMAIN_URL, knownAuthorities: ["https://login.microsoftonline.com/common/"] },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const excelSync = new OneDriveExcelSync();
        const ADMIN_PASSWORD = "admin123";

        const LOCAL_CALC_DATA_KEY = 'arhamPrintersData';
        const LOCAL_HISTORY_KEY = 'arhamPrintersHistory';
        const LOCAL_CUSTOMER_KEY = 'arhamPrintersCustomers';
        const LOCAL_INVOICE_KEY = 'arhamPrintersInvoices';
        const LOCAL_NEXT_INV_KEY = 'arhamNextInvoiceNumber';
        const LOCAL_EXPENSES_KEY = 'arhamPrintersExpenses'; 
        const LOCAL_BUDGET_KEY = 'arhamPrintersBudget'; 
        const LOCAL_DATALISTS_KEY = 'arhamPrintersDatalists';

        let isOnline = false, currentUser = null, data = {}, calculationHistory = [], customers = [], invoices = [], expenses = [], budget = {}, nextInvoiceNumber = 1001, datalists = {};

        const defaultData = {
            categories: [{ mainCategory: "Offset Printing", subcategory: "LetterPads" }],
            items: [{ mainCategory: "Offset Printing", subcategory: "LetterPads", itemName: "A4 Letterpad", profitMargin: 25, designCharges: 300, costTiers: [{ qty: 10, fixedPrice: 2000, tag: "Set of 10" }] }],
            settings: {}, budget: { business: 50000, personal: 30000 }
        };
        const defaultDatalists = {
            newMainCategoryList: ["Offset Printing", "Digital Printing", "Sign Boards"],
            newSubCategoryList: ["LetterPads", "Visiting Cards", "Flyers"],
            newItemNameList: ["A4 Letterpad (100 Pages)", "Self-Inking Stamp"],
            expenseDescriptionList: ["A4 paper ream", "Electricity bill"],
            customerNameList: [], customerPhoneList: [], invoiceItemList: []
        };

        async function getOneDriveAccessToken() {
            try { return (await msalInstance.acquireTokenSilent({ scopes: ["Files.ReadWrite.All"], account: currentUser })).accessToken; } 
            catch (e) { try { return (await msalInstance.acquireTokenPopup({ scopes: ["Files.ReadWrite.All"] })).accessToken; } catch (pe) { return null; } }
        }

        async function loginToOneDrive() {
            try {
                currentUser = (await msalInstance.loginPopup({ scopes: ["Files.ReadWrite.All"] })).account;
                isOnline = true; updateUIAfterLogin();
            } catch (e) { showNotification("Login failed.", "error"); }
        }

        function logoutFromOneDrive() {
            if (currentUser) { msalInstance.logoutPopup(); currentUser = null; isOnline = false; updateUIAfterLogout(); showNotification("Signed out.", "info"); }
        }

        async function syncToCloud() {
            if (!isOnline) return false;
            const accessToken = await getOneDriveAccessToken(); if (!accessToken) return false;
            try {
                const allData = { calculatorData: data, history: calculationHistory, invoices, customers, expenses, budget, datalists, lastSync: new Date().toISOString() };
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`, { method: 'PUT', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(allData) });
                if (response.ok) { showNotification('Data synced to OneDrive JSON!', 'success'); return true; }
                else { throw new Error('Upload failed'); }
            } catch (e) { showNotification('Failed to sync JSON.', 'error'); return false; }
        }

        async function syncFromCloud() {
            if (!isOnline) return;
            const accessToken = await getOneDriveAccessToken(); if (!accessToken) return;
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (response.ok) {
                    const cloudData = await response.json();
                    if (confirm('Replace local data with cloud data?')) {
                        data = cloudData.calculatorData || data; calculationHistory = cloudData.history || []; invoices = cloudData.invoices || []; customers = cloudData.customers || []; expenses = cloudData.expenses || []; budget = cloudData.budget || {}; datalists = cloudData.datalists || {};
                        localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data)); localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory)); localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices)); localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers)); localStorage.setItem(LOCAL_EXPENSES_KEY, JSON.stringify(expenses)); localStorage.setItem(LOCAL_BUDGET_KEY, JSON.stringify(budget)); localStorage.setItem(LOCAL_DATALISTS_KEY, JSON.stringify(datalists));
                        refreshAllDisplays(); refreshDataTables(); showNotification('Data synced from OneDrive!', 'success');
                    }
                } else { throw new Error('Download failed'); }
            } catch (e) { showNotification('Failed to sync from OneDrive.', 'error'); }
        }

        window.syncAllToExcel = async (isAuto = false) => { if (!isOnline) return; document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...'; if (await excelSync.syncAllDataToExcel(data, invoices, customers, calculationHistory, expenses)) { document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Excel Synced'; } else { document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync Failed'; }};

        async function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none'; document.getElementById('syncBtn').style.display = 'inline-flex'; document.getElementById('downloadBtn').style.display = 'inline-flex'; document.getElementById('logoutBtn').style.display = 'inline-flex'; document.getElementById('userInfo').style.display = 'block'; document.getElementById('userName').textContent = currentUser.name; document.getElementById('syncStatus').className = 'sync-status sync-online'; document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Initializing...';
            await excelSync.ensureExcelFile(); document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online'; saveAllData();
        }

        function updateUIAfterLogout() {
            document.getElementById('loginBtn').style.display = 'inline-flex'; document.getElementById('syncBtn').style.display = 'none'; document.getElementById('downloadBtn').style.display = 'none'; document.getElementById('logoutBtn').style.display = 'none'; document.getElementById('userInfo').style.display = 'none'; document.getElementById('syncStatus').className = 'sync-status sync-offline'; document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Offline';
        }

        function loadAllData() {
            try {
                data = JSON.parse(localStorage.getItem(LOCAL_CALC_DATA_KEY) || JSON.stringify(defaultData));
                calculationHistory = JSON.parse(localStorage.getItem(LOCAL_HISTORY_KEY) || '[]');
                expenses = JSON.parse(localStorage.getItem(LOCAL_EXPENSES_KEY) || '[]');
                budget = JSON.parse(localStorage.getItem(LOCAL_BUDGET_KEY) || JSON.stringify(defaultData.budget));
                datalists = JSON.parse(localStorage.getItem(LOCAL_DATALISTS_KEY) || JSON.stringify(defaultDatalists));
                customers = JSON.parse(localStorage.getItem(LOCAL_CUSTOMER_KEY) || '[]');
                invoices = JSON.parse(localStorage.getItem(LOCAL_INVOICE_KEY) || '[]');
                nextInvoiceNumber = JSON.parse(localStorage.getItem(LOCAL_NEXT_INV_KEY) || '1001');
                populateDatalists();
            } catch (e) { data = defaultData; datalists = defaultDatalists; }
        }

        function saveAllData() {
            localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data));
            localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory));
            localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers));
            localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices));
            localStorage.setItem(LOCAL_NEXT_INV_KEY, JSON.stringify(nextInvoiceNumber));
            localStorage.setItem(LOCAL_EXPENSES_KEY, JSON.stringify(expenses));
            localStorage.setItem(LOCAL_BUDGET_KEY, JSON.stringify(budget));
            localStorage.setItem(LOCAL_DATALISTS_KEY, JSON.stringify(datalists));
            if (isOnline) setTimeout(() => { syncToCloud(); window.syncAllToExcel(true); }, 1000);
        }
        
        function populateDatalists() {
            for (const listId in datalists) {
                const datalistEl = document.getElementById(listId);
                if (datalistEl) {
                    datalistEl.innerHTML = (datalists[listId] || []).map(val => `<option value="${val}">`).join('');
                }
            }
        }

        function updateDatalist(listName, newValue) {
            if (newValue && newValue.trim() !== '') {
                const normalizedValue = newValue.trim();
                let list = datalists[listName] || [];
                if (!list.includes(normalizedValue)) {
                    list.unshift(normalizedValue);
                    if (list.length > 30) list = list.slice(0, 30);
                    datalists[listName] = list;
                    populateDatalists();
                }
            }
        }
        
        function toggleAdmin() {
            const panel = document.getElementById('adminPanel'), input = document.getElementById('adminPassword').value;
            if (panel.style.display === 'block') panel.style.display = 'none';
            else if (input === ADMIN_PASSWORD) {
                panel.style.display = 'block'; document.getElementById('adminPassword').value = '';
                refreshDataTables(); updateHistoryDisplay(); loadSettings(); populateDatalists();
                showNotification('Admin panel unlocked', 'success');
            } else showNotification('Incorrect password', 'error');
        }
        
        function refreshAllDisplays() { updateMainCategories(); updateSubcategories(); updateItemsAndFields(); }
        function updateMainCategories() { const sel = document.getElementById('mainCategory'); sel.innerHTML = '<option value="">Select...</option>'; [...new Set(data.categories.map(c => c.mainCategory))].forEach(c => sel.add(new Option(c, c))); }
        function updateSubcategories() { const main = document.getElementById('mainCategory').value, sel = document.getElementById('subCategory'); sel.innerHTML = '<option value="">Select...</option>'; if (!main) return; [...new Set(data.categories.filter(c => c.mainCategory === main).map(c => c.subcategory))].forEach(s => sel.add(new Option(s, s))); updateItemsAndFields(); }
        function updateItemsAndFields() { const main = document.getElementById('mainCategory').value, sub = document.getElementById('subCategory').value, sel = document.getElementById('itemName'); sel.innerHTML = '<option value="">Select...</option>'; if(main && sub) data.items.filter(i => i.mainCategory === main && i.subcategory === sub).forEach(i => sel.add(new Option(i.itemName, i.itemName))); updateQuantityInput(); }
        
        function updateQuantityInput() {
            const item = data.items.find(i => i.itemName === document.getElementById('itemName').value);
            const container = document.getElementById('quantityInputContainer'), tagGroup = document.getElementById('priceTierTagGroup');
            container.innerHTML = ''; tagGroup.style.display = 'none';
            if (item && item.costTiers && item.costTiers.length > 0) {
                const sel = document.createElement('select'); sel.id = 'quantity'; sel.onchange = calculatePrice;
                sel.add(new Option('--- Select Set ---', 0));
                item.costTiers.forEach(t => sel.add(new Option(t.tag, t.qty)));
                container.appendChild(sel); tagGroup.style.display = 'flex'; calculatePrice();
            } else {
                const input = document.createElement('input'); input.type = 'number'; input.id = 'quantity'; input.value = 1; input.min = 1; input.onchange = calculatePrice;
                container.appendChild(input);
            }
        }
        
        function clearTierTag() { if (document.getElementById('priceTierTagGroup').style.display === 'flex') document.getElementById('priceTierTag').textContent = 'Recalculate...'; }
        
        function calculatePrice() {
            const item = data.items.find(i => i.itemName === document.getElementById('itemName').value);
            const qty = parseInt(document.getElementById('quantity')?.value) || 0;
            const design = parseFloat(document.getElementById('designCharges').value) || 0;
            const resultEl = document.getElementById('result'), breakdownEl = document.getElementById('priceBreakdown');
            if (!item || qty <= 0) { resultEl.style.display = 'none'; breakdownEl.style.display = 'none'; return; }

            let totalFixed = 0, totalVariable = 0, profitMargin = (item.profitMargin || 0) / 100;
            if (item.costTiers && item.costTiers.length > 0) {
                const tier = item.costTiers.find(t => t.qty === qty);
                if (!tier) { showNotification(`Invalid set for this item.`, "error"); resultEl.style.display = 'none'; breakdownEl.style.display = 'none'; return; }
                totalFixed = tier.fixedPrice + design;
                document.getElementById('priceTierTag').textContent = tier.tag;
                document.getElementById('priceTierTagGroup').style.display = 'flex';
            } else { totalFixed = (item.fixedSetupCostTotal || 0) + design; document.getElementById('priceTierTagGroup').style.display = 'none'; }

            if (item.materialCostPerUnit > 0) totalVariable = item.materialCostPerUnit * qty;
            else if (item.bulkPaperCost > 0 && item.bulkPaperQuantity > 0) {
                const vcpp = item.bulkPaperCost / item.bulkPaperQuantity;
                totalVariable = vcpp * (item.pagesPerFinishedUnit || 1) * qty;
            }

            const cost = totalFixed + totalVariable, profit = cost * profitMargin, finalPrice = cost + profit, perUnit = finalPrice / qty;
            
            resultEl.textContent = `Total Customer Price: Rs. ${Math.round(finalPrice)}`;
            resultEl.style.display = 'block';
            document.getElementById('breakdownContent').innerHTML = [
                `Fixed Cost: Rs. ${totalFixed.toFixed(2)}`,
                `Variable Cost: Rs. ${totalVariable.toFixed(2)}`, `---`,
                `Total Production Cost: Rs. ${cost.toFixed(2)}`,
                `Profit (${(profitMargin*100).toFixed(0)}%): Rs. ${profit.toFixed(2)}`, `---`,
                `Total Final Price: Rs. ${Math.round(finalPrice)}`,
                `PRICE PER UNIT: Rs. ${perUnit.toFixed(2)}`
            ].map(l => `<div class="breakdown-item">${l.replace(':','<span>:</span>')}</div>`).join('').replace('---', '<hr style="border:0; border-top:1px solid #ddd">');
            breakdownEl.style.display = 'block';
            addToHistory({ itemName: item.itemName, quantity: qty, designCharges: design, total: Math.round(finalPrice), timestamp: new Date().toLocaleString() });
        }

        function clearForm() { document.getElementById('mainCategory').value = ''; updateSubcategories(); document.getElementById('designCharges').value = '0'; document.getElementById('result').style.display = 'none'; document.getElementById('priceBreakdown').style.display = 'none'; }
        function addToHistory(calc) { calculationHistory.unshift(calc); if (calculationHistory.length > 50) calculationHistory.pop(); saveAllData(); }
        function updateHistoryDisplay() { const list = document.getElementById('historyList'); list.innerHTML = calculationHistory.length ? calculationHistory.map(c => `<div class="history-item"><div class="history-header"><span>${c.itemName}</span><span>Rs. ${c.total}</span></div><div class="history-details">Qty: ${c.quantity} | Design: ${c.designCharges} | ${c.timestamp}</div></div>`).join('') : '<p>No history.</p>'; }
        function clearHistory() { if (confirm('Clear history?')) { calculationHistory = []; saveAllData(); updateHistoryDisplay(); } }
        
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        function saveExpense() { updateDatalist('expenseDescriptionList', document.getElementById('expenseDescription').value); showNotification('Expense saved.', 'success'); saveAllData(); }
        function clearExpenseForm() { } function loadExpenseList() { } function deleteExpense(id) { } function clearAllExpenses() { }

        function addInvoiceItem() { const tbody = document.getElementById('itemsTableBody'); const newRow = tbody.rows[0].cloneNode(true); newRow.querySelectorAll('input').forEach(i => i.value = (i.type === 'number') ? '0' : ''); tbody.appendChild(newRow); }
        function removeInvoiceItem(btn) { if (document.getElementById('itemsTableBody').rows.length > 1) btn.closest('tr').remove(); calculateTotal(); }
        function calculateTotal() { /* Invoice calculation logic */ }
        function saveInvoice() {
            updateDatalist('customerNameList', document.getElementById('invoiceCustomerName').value);
            updateDatalist('customerPhoneList', document.getElementById('invoiceCustomerPhone').value);
            document.querySelectorAll('#itemsTableBody .item-name').forEach(input => updateDatalist('invoiceItemList', input.value));
            showNotification('Invoice saved.', 'success'); saveAllData();
        }
        function clearInvoice() { } function loadInvoiceList() { } function deleteInvoice(id) { }

        function addNewItem() {
            const mainCat = document.getElementById('newMainCategory').value.trim(), subCat = document.getElementById('newSubCategory').value.trim(), name = document.getElementById('newItemName').value.trim(), profit = parseFloat(document.getElementById('newProfitMargin').value) || 25;
            if (!mainCat || !subCat || !name) return showNotification('All fields are required.', 'warning');
            if (!data.categories.some(c => c.mainCategory === mainCat && c.subcategory === subCat)) data.categories.push({ mainCategory: mainCat, subcategory: subCat });
            data.items.push({ mainCategory: mainCat, subcategory: subCat, itemName: name, profitMargin: profit, costTiers: [] });
            updateDatalist('newMainCategoryList', mainCat); updateDatalist('newSubCategoryList', subCat); updateDatalist('newItemNameList', name);
            document.getElementById('newMainCategory').value = ''; document.getElementById('newSubCategory').value = ''; document.getElementById('newItemName').value = ''; document.getElementById('newProfitMargin').value = '25';
            refreshDataTables(); refreshAllDisplays(); saveAllData(); showNotification(`Item '${name}' added.`, 'success');
        }

        function refreshDataTables() {
            const table = document.getElementById('itemsTable');
            table.innerHTML = `<thead><tr><th>Category</th><th>Item Name</th><th>Profit %</th><th>Actions</th></tr></thead><tbody>
                ${data.items.map((item, i) => `<tr><td>${item.mainCategory} > ${item.subcategory}</td><td>${item.itemName}</td><td>${item.profitMargin||0}%</td><td><button class="btn btn-warning btn-sm" onclick="openItemEditor(${i})"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-danger btn-sm" onclick="deleteItem(${i})"><i class="fas fa-trash"></i></button></td></tr>`).join('')}
            </tbody>`;
        }
        
        function deleteItem(index) { if(confirm(`Delete '${data.items[index].itemName}'?`)){ data.items.splice(index, 1); saveAllData(); refreshDataTables(); refreshAllDisplays(); showNotification('Item deleted.', 'success'); } }

        function openItemEditor(index) {
            const item = data.items[index];
            document.getElementById('itemEditor').style.display = 'block';
            document.getElementById('editorTitle').textContent = `Edit: ${item.itemName}`;
            document.getElementById('editItemId').value = index;
            document.getElementById('editItemName').value = item.itemName;
            document.getElementById('editProfitMargin').value = item.profitMargin || 0;
            document.getElementById('editDesignCharges').value = item.designCharges || 0;
            document.getElementById('editMaterialCostPerUnit').value = item.materialCostPerUnit || 0;
            const tiersContainer = document.getElementById('tiersContainer');
            tiersContainer.innerHTML = '';
            if (item.costTiers) item.costTiers.forEach(tier => addTierRow(tier));
        }
        
        function addTierRow(tier = { qty: 0, fixedPrice: 0, tag: '' }) {
            const row = document.createElement('div'); row.className = 'tier-row';
            row.innerHTML = `<input type="number" class="tier-qty" placeholder="Qty" value="${tier.qty}" style="flex:1;"><input type="number" class="tier-price" placeholder="Fixed Price (Rs)" value="${tier.fixedPrice}" style="flex:2;"><input type="text" class="tier-tag" placeholder="Set Name (e.g., 1000 Cards)" value="${tier.tag}" style="flex:3;"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
            document.getElementById('tiersContainer').appendChild(row);
        }

        function saveItemChanges() {
            const index = document.getElementById('editItemId').value; if (index === '') return;
            const item = data.items[index];
            item.itemName = document.getElementById('editItemName').value; item.profitMargin = parseFloat(document.getElementById('editProfitMargin').value) || 0;
            item.designCharges = parseFloat(document.getElementById('editDesignCharges').value) || 0; item.materialCostPerUnit = parseFloat(document.getElementById('editMaterialCostPerUnit').value) || 0;
            item.costTiers = [];
            document.querySelectorAll('#tiersContainer .tier-row').forEach(row => {
                const qty = parseInt(row.querySelector('.tier-qty').value), price = parseFloat(row.querySelector('.tier-price').value), tag = row.querySelector('.tier-tag').value;
                if (qty > 0 && price > 0 && tag) item.costTiers.push({ qty, fixedPrice: price, tag });
            });
            saveAllData(); refreshDataTables(); refreshAllDisplays(); document.getElementById('itemEditor').style.display = 'none'; showNotification('Item updated.', 'success');
        }
        
        function loadSettings() { document.getElementById('budgetBusiness').value = budget.business; document.getElementById('budgetPersonal').value = budget.personal; }

        window.exportCustomerDataForGitHub = async function() {
            if (!isOnline) return showNotification('Please sign in to OneDrive first.', 'error');
            const publicData = { categories: data.categories, items: data.items, settings: {}, lastUpdated: new Date().toISOString() };
            if (await excelSync.uploadPublicJson(publicData)) showNotification('Data saved to OneDrive!', 'info'); else showNotification('Failed to save to OneDrive, trying GitHub anyway.', 'warning');

            const token = document.getElementById('githubPat').value;
            if (!token) return showNotification('Please paste your GitHub PAT to upload.', 'error');

            const repo = 'greenshirt3/ArhamP', path = 'customer-data.json', apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`, commitMessage = `Auto-update prices on ${new Date().toLocaleString()}`;
            const content = btoa(JSON.stringify(publicData, null, 2));

            try {
                showNotification('Uploading to GitHub...', 'info');
                const getFileResponse = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                if (!getFileResponse.ok && getFileResponse.status !== 404) throw new Error(`API error: ${getFileResponse.statusText}`);
                const sha = (await getFileResponse.json()).sha;

                const uploadResponse = await fetch(apiUrl, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: commitMessage, content, sha }) });
                if (uploadResponse.ok) showNotification('Successfully uploaded to GitHub!', 'success', 8000); else throw new Error(`Upload failed: ${(await uploadResponse.json()).message}`);
            } catch (error) { showNotification(`GitHub Error: ${error.message}`, 'error', 10000); }
        }

        msalInstance.initialize().then(() => {
            document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => { document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active')); t.classList.add('active'); document.getElementById(t.dataset.tab + '-tab').classList.add('active'); }));
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) { currentUser = accounts[0]; isOnline = true; updateUIAfterLogin(); }
            loadAllData(); refreshAllDisplays(); document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>

