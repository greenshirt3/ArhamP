<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #0078d4;
            --secondary-light: #1088e4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #0078d4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #1088e4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #dff6dd;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fff4ce;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #0e6b0e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #e6a200; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c02a2e; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Cloud Sync</p>
        </header>

        <!-- Cloud Sync Section -->
        <div class="cloud-section">
            <h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="loginToOneDrive()" id="loginBtn">
                    <i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
                <button class="btn btn-success" onclick="window.syncAllToExcel()" id="syncBtn" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload All Data to Excel
                </button>
                <button class="btn btn-secondary" onclick="syncFromCloud()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Download Data (JSON)
                </button>
                <button class="btn btn-danger" onclick="logoutFromOneDrive()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is synced across all devices via OneDrive.</p>
            </div>
        </div>

        <div class="content-grid">
            <!-- ---------------------------------------------------- -->
            <!-- ADMIN CALCULATOR PANEL -->
            <!-- ---------------------------------------------------- -->
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantity"><i class="fas fa-boxes"></i> Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <!-- ---------------------------------------------------- -->
            <!-- INVOICE SYSTEM PANEL -->
            <!-- ---------------------------------------------------- -->
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
                
                <div class="form-group">
                    <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                    <div class="suggestion-container">
                        <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off">
                        <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                    <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number">
                </div>
                
                <div class="form-group">
                    <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                    <input type="text" id="invoiceNo" readonly>
                </div>
                
                <div class="form-group">
                    <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>

                <h3>Invoice Items</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Rate (Rs.)</th>
                            <th>Qty</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Initial item row -->
                        <tr>
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off">
                                </div>
                            </td>
                            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-amount" value="0" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="addInvoiceItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button class="btn btn-secondary" onclick="calculateTotal()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>

                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                    
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>Rs. <span id="subtotalAmount">0.00</span></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="taxRate">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="previousBalance">Previous Balance (Rs.):</label>
                        <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment">Payment Received (Rs.):</label>
                        <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Remaining Balance:</strong></span>
                        <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="saveInvoice()">
                        <i class="fas fa-save"></i> Save & Sync Invoice
                    </button>
                    <button class="btn btn-warning" onclick="clearInvoice()">
                        <i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ---------------------------------------------------- -->
        <!-- ADMIN PANEL SECTION -->
        <!-- ---------------------------------------------------- -->
        <div class="login-section">
            <h2 class="section-title"><i class="fas fa-lock"></i> Administrator Access</h2>
            <div class="login-form">
                <div>
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="btn btn-warning" onclick="toggleAdmin()">
                    <i class="fas fa-key"></i> Admin Login
                </button>
            </div>
        </div>
        
        <div class="admin-panel" id="adminPanel">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Data & Invoice Management</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="data-management">Data Management</div>
                <div class="tab" data-tab="invoice-list">Invoice List</div>
                <div class="tab" data-tab="history">Calculation History</div>
                <div class="tab" data-tab="settings">Settings</div>
                <div class="tab" data-tab="import-export">Import/Export</div>
            </div>
            
            <!-- Data Management Tab -->
            <div class="tab-content active" id="data-management-tab">
                <div class="data-form admin-section">
                    <h3>Add New Item</h3>
                    <div class="form-row">
                        <div class="form-field"><label for="newMainCategory">Main Category:</label><input type="text" id="newMainCategory" placeholder="Enter main category"></div>
                        <div class="form-field"><label for="newSubCategory">Subcategory:</label><input type="text" id="newSubCategory" placeholder="Enter subcategory"></div>
                        <div class="form-field"><label for="newItemName">Item Name:</label><input type="text" id="newItemName" placeholder="Enter item name"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-field"><label for="newItemPrice">Price (Rs.):</label><input type="number" id="newItemPrice" min="0" value="0"></div>
                        <div class="form-field"><label for="newDesignCharges">Design Charges (Rs.):</label><input type="number" id="newDesignCharges" min="0" value="0"></div>
                    </div>
                    <button class="btn btn-success" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Items</h3>
                    <table class="data-table" id="itemsTable"></table>
                </div>
            </div>

            <!-- Invoice List Tab -->
            <div class="tab-content" id="invoice-list-tab">
                <h3>Saved Invoices</h3>
                <div id="invoiceList">
                    <p>Load the Invoice List to manage customer records.</p>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="loadInvoiceList()">
                        <i class="fas fa-list"></i> Load Invoices
                    </button>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <h3>Calculation History</h3>
                <div class="actions">
                    <button class="btn btn-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                <div id="historyList"></div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <h3>Application Settings</h3>
                <div class="admin-section">
                    <h4>Global Settings</h4>
                    <div class="form-group">
                        <label>Rent Cost (Rs.)</label>
                        <input type="number" id="rentCost" value="200">
                    </div>
                    <div class="form-group">
                        <label>Profit Margin (%)</label>
                        <input type="number" id="profitMargin" value="25">
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
            
            <!-- Import/Export Tab -->
            <div class="tab-content" id="import-export-tab">
                <h3>Import/Export Data</h3>
                
                <div class="import-export-section">
                    <h4>Export Data</h4>
                    <div class="actions">
                        <button class="btn btn-warning" onclick="exportAllData()">
                            <i class="fas fa-file-export"></i> Export All Data (CSV)
                        </button>
                        <button class="btn btn-success" onclick="exportCustomerDataForGitHub()">
                            <i class="fas fa-cloud-upload"></i> Export Price Data (JSON)
                        </button>
                    </div>
                    <p><small>Export JSON for external/customer calculator sync. Export CSV for backup.</small></p>
                </div>
                
                <div class="import-export-section">
                    <h4>Reset Data</h4>
                    <p>Reset all data to default values. This cannot be undone.</p>
                    <div class="actions">
                        <button class="btn btn-danger" onclick="resetToDefault()">
                            <i class="fas fa-undo"></i> Reset to Default Data
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Save & Cloud Sync All
                </button>
                <button class="btn btn-secondary" onclick="toggleAdmin()">
                    <i class="fas fa-times"></i> Close Admin Panel
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto hide after duration
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, duration);
        }

        // =============================================
        // AZURE CONFIGURATION & GLOBAL DATA/FUNCTIONS
        // =============================================
        const AZURE_CLIENT_ID = "26b3dde9-366f-487b-a485-79d1bf1ab857";
        const msalConfig = {
            auth: {
                clientId: AZURE_CLIENT_ID,
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.href,
                knownAuthorities: ["https://login.microsoftonline.com/common/"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        const excelSync = new OneDriveExcelSync();
        const ADMIN_PASSWORD = "8233";

        // Local Storage Keys
        const LOCAL_CALC_DATA_KEY = 'arhamPrintersData';
        const LOCAL_HISTORY_KEY = 'arhamPrintersHistory';
        const LOCAL_CUSTOMER_KEY = 'arhamPrintersCustomers';
        const LOCAL_INVOICE_KEY = 'arhamPrintersInvoices';
        const LOCAL_NEXT_INV_KEY = 'arhamNextInvoiceNumber';
        const LOCAL_EXCEL_TRIGGER_KEY = 'arhamPrintersExcelSyncTrigger';

        let isOnline = false;
        let currentUser = null;

        // Shared Data Structures
        let data = {};
        let calculationHistory = [];
        let customers = [];
        let invoices = [];
        let nextInvoiceNumber = 1001;
        let currentCustomer = null;

        const defaultData = {
            categories: [
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards" },
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads" },
                { mainCategory: "Panaflex", subcategory: "China" },
                { mainCategory: "Social Media Posts", subcategory: "Design Only" }
            ],
            items: [
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Double Side", price: 2500, type: "fixed", designCharges: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x4 Panaflex", price: 280, type: "fixed", designCharges: 0 },
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Instagram Post", price: 400, type: "fixed", designCharges: 0 }
            ],
            settings: {
                rent: 200,
                profitMargin: 25
            }
        };

        // --- Auth Token Functions ---
        async function getOneDriveAccessToken() {
            const request = { scopes: ["Files.ReadWrite.All"], account: currentUser };
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (popupError) {
                    console.error("Popup token acquisition failed:", popupError);
                    return null;
                }
            }
        }

        // --- Authentication Functions ---
        async function loginToOneDrive() {
            try {
                const loginRequest = { scopes: ["Files.ReadWrite.All"] };
                const loginResponse = await msalInstance.loginPopup(loginRequest);
                currentUser = loginResponse.account;
                isOnline = true;
                updateUIAfterLogin();
            } catch (error) {
                console.error("Login failed:", error);
                showNotification("Login failed. Please try again.", "error");
            }
        }

        function logoutFromOneDrive() {
            if (currentUser) {
                msalInstance.logoutPopup();
                currentUser = null;
                isOnline = false;
                updateUIAfterLogout();
                showNotification("Signed out successfully", "info");
            }
        }

       // --- CORE JSON SYNC FUNCTIONS ---
        async function syncToCloud() {
            if (!isOnline || !currentUser) { 
                showNotification("Please sign in to sync with OneDrive", "warning");
                return false; 
            }
            const accessToken = await getOneDriveAccessToken();
            if (!accessToken) { 
                showNotification("Could not get access token", "error");
                return false; 
            }

            try {
                const allData = {
                    calculatorData: data,
                    history: calculationHistory,
                    customers: customers,
                    invoices: invoices,
                    lastSync: new Date().toISOString()
                };

                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `Bearer ${accessToken}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify(allData)
                    }
                );
                
                if (response.ok) { 
                    showNotification('Data successfully synced to OneDrive!', 'success');
                    return true; 
                } else {
                    throw new Error('Failed to upload JSON to OneDrive');
                }
            } catch (error) {
                console.error("JSON Sync failed:", error);
                showNotification('Failed to sync data to OneDrive: ' + error.message, 'error');
                return false;
            }
        }

        async function syncFromCloud() {
            if (!isOnline || !currentUser) { 
                showNotification("Please sign in to sync with OneDrive", "warning");
                return; 
            }
            const accessToken = await getOneDriveAccessToken();
            if (!accessToken) { 
                showNotification("Could not get access token", "error");
                return; 
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );

                if (response.ok) {
                    const cloudData = await response.json();
                    
                    if (confirm('Do you want to replace your local data with cloud data?')) {
                        data = cloudData.calculatorData || data;
                        calculationHistory = cloudData.history || calculationHistory;
                        customers = cloudData.customers || customers;
                        invoices = cloudData.invoices || invoices;
                        
                        localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data));
                        localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory));
                        localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers));
                        localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices));
                        
                        refreshAllDisplays();
                        refreshDataTables();
                        showNotification('Data successfully synced from OneDrive!', 'success');
                    }
                } else {
                    throw new Error('Failed to download JSON from OneDrive');
                }
            } catch (error) {
                console.error("JSON Sync failed:", error);
                showNotification('Failed to sync data from OneDrive: ' + error.message, 'error');
            }
        }

        // Main sync function (replaces Excel sync)
        async function syncAllData() {
            if (!isOnline || !currentUser) {
                showNotification("Please sign in to OneDrive to sync data.", "warning");
                return false;
            }
            
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing to OneDrive...';
            
            const success = await syncToCloud();
            
            if (success) {
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Data synced to OneDrive';
            } else {
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync Failed';
            }
            
            return success;
        }

        // --- Authentication/UI Functions ---
        async function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'inline-flex';
            document.getElementById('downloadBtn').style.display = 'inline-flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('syncStatus').className = 'sync-status sync-online';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Connected to OneDrive';

            // Auto-sync after login
            setTimeout(() => {
                syncAllData();
            }, 1000);
        }

        function updateUIAfterLogout() {
            document.getElementById('loginBtn').style.display = 'inline-flex';
            document.getElementById('syncBtn').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncStatus').className = 'sync-status sync-offline';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Offline Mode - Data stored locally';
        }
 function loadAllData() {
            try {
                const savedCalc = localStorage.getItem(LOCAL_CALC_DATA_KEY);
                const savedHistory = localStorage.getItem(LOCAL_HISTORY_KEY);
                
                data = savedCalc ? JSON.parse(savedCalc) : JSON.parse(JSON.stringify(defaultData));
                calculationHistory = savedHistory ? JSON.parse(savedHistory) : [];

                loadAllInvoiceData();
                loadNextInvoiceNumber();

            } catch (e) {
                console.error("Error loading local data:", e);
                data = JSON.parse(JSON.stringify(defaultData));
                calculationHistory = [];
            }
        }

        function loadAllInvoiceData() {
            customers = JSON.parse(localStorage.getItem(LOCAL_CUSTOMER_KEY) || '[]');
            invoices = JSON.parse(localStorage.getItem(LOCAL_INVOICE_KEY) || '[]');
        }

        function saveAllData() {
            localStorage.setItem(LOCAL_CALC_DATA_KEY, JSON.stringify(data));
            localStorage.setItem(LOCAL_HISTORY_KEY, JSON.stringify(calculationHistory));
            localStorage.setItem(LOCAL_CUSTOMER_KEY, JSON.stringify(customers));
            localStorage.setItem(LOCAL_INVOICE_KEY, JSON.stringify(invoices));
            localStorage.setItem(LOCAL_NEXT_INV_KEY, nextInvoiceNumber.toString());

            // Auto-sync to cloud when online
            if (isOnline && currentUser) {
                setTimeout(() => {
                    syncAllData();
                }, 1000);
            }
        }

        // --- Export for Customer Calculator ---
        function exportCustomerDataForGitHub() {
            const customerData = {
                categories: data.categories,
                items: data.items,
                settings: data.settings,
                lastUpdated: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(customerData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'customer-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Price data exported! Upload this file to GitHub for customer calculator.', 'success');
        }

        // --- ADMIN LOGIN ---
        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            const input = document.getElementById('adminPassword').value;
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else if (input === ADMIN_PASSWORD) {
                panel.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                loadAllInvoiceData();
                refreshDataTables();
                updateHistoryDisplay();
                loadSettings();
                showNotification('Admin panel unlocked', 'success');
            } else {
                showNotification('Incorrect admin password', 'error');
            }
        }
        
        // =============================================
        // CALCULATOR LOGIC
        // =============================================
        function refreshAllDisplays() {
            updateMainCategories();
            updateSubcategories();
            updateItemsAndFields();
            setupCustomerAutocomplete();
            setupItemAutocomplete();
        }

        function updateMainCategories() {
            const mainSelect = document.getElementById('mainCategory');
            mainSelect.innerHTML = '<option value="">Select Main Category</option>';
            const mainCategories = [...new Set(data.categories.map(cat => cat.mainCategory))];
            mainCategories.forEach(cat => mainSelect.add(new Option(cat, cat)));
        }

        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subSelect = document.getElementById('subCategory');
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            if (!mainCategory) return;
            const subcategories = [...new Set(data.categories.filter(cat => cat.mainCategory === mainCategory).map(cat => cat.subcategory))];
            subcategories.forEach(sub => subSelect.add(new Option(sub, sub)));
            updateItemsAndFields();
        }

        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subcategory) {
                const items = data.items.filter(item => item.mainCategory === mainCategory && item.subcategory === subcategory);
                items.forEach(item => itemSelect.add(new Option(item.itemName, item.itemName)));
            }
        }

        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!mainCategory || !subcategory || !itemName) { 
                showNotification("Please select all required fields", "warning");
                return; 
            }
            
            const item = data.items.find(i => i.mainCategory === mainCategory && i.subcategory === subcategory && i.itemName === itemName);
            if (!item) { 
                document.getElementById('result').textContent = "Item not found"; 
                document.getElementById('result').style.display = 'block'; 
                return; 
            }
            
            let basePrice = item.price;
            let breakdown = [];
            
            breakdown.push(`Item Price: Rs. ${basePrice}`);
            
            if (item.designCharges > 0) {
                breakdown.push(`Design Charges: Rs. ${item.designCharges}`);
                basePrice += item.designCharges;
            }
            
            const subtotal = basePrice * quantity;
            const profit = subtotal * (data.settings.profitMargin / 100);
            const total = subtotal + profit;
            
            breakdown.push(`Quantity: ${quantity}`);
            breakdown.push(`Subtotal: Rs. ${Math.round(subtotal)}`);
            breakdown.push(`Profit (${data.settings.profitMargin}%): Rs. ${Math.round(profit)}`);
            breakdown.push(`Total: Rs. ${Math.round(total)}`);
            
            document.getElementById('result').textContent = `Total Price: Rs. ${Math.round(total)}`;
            document.getElementById('result').style.display = 'block';
            
            document.getElementById('breakdownContent').innerHTML = breakdown.map(item => `<div class="breakdown-item">${item}</div>`).join('');
            document.getElementById('priceBreakdown').style.display = 'block';
            
            addToHistory({ mainCategory, subcategory, itemName, quantity, designCharges: item.designCharges || 0, total: Math.round(total), timestamp: new Date().toLocaleString() });
        }

        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantity').value = '1';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            showNotification('Calculator form cleared', 'info');
        }

        // --- History Management ---
        function addToHistory(calculation) {
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 50) calculationHistory = calculationHistory.slice(0, 50);
            saveAllData();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (calculationHistory.length === 0) { historyList.innerHTML = '<p>No calculations yet</p>'; return; }
            
            historyList.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div class="history-header"><span>${calc.itemName}</span><span>Rs. ${calc.total}</span></div>
                    <div class="history-details">${calc.mainCategory} > ${calc.subcategory} | Qty: ${calc.quantity} | Design: Rs. ${calc.designCharges} | ${calc.timestamp}</div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all calculation history?')) {
                calculationHistory = [];
                saveAllData();
                updateHistoryDisplay();
                showNotification('Calculation history cleared', 'success');
            }
        }

        // =============================================
        // INVOICE LOGIC
        // =============================================
        // --- Item Auto-complete ---
        function setupItemAutocomplete() {
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const input = row.querySelector('.item-name');
                const td = row.querySelector('td:first-child');
                
                let suggestionsContainer = td.querySelector('.item-suggestions');
                if (!suggestionsContainer) {
                    suggestionsContainer = document.createElement('div');
                    suggestionsContainer.className = 'customer-suggestions item-suggestions';
                    td.appendChild(suggestionsContainer);
                }

                input.oninput = function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    suggestionsContainer.innerHTML = '';
                    
                    if (searchTerm.length < 2) { suggestionsContainer.style.display = 'none'; return; }
                    
                    const matches = data.items.filter(item => item.itemName.toLowerCase().includes(searchTerm)).slice(0, 10);
                    
                    if (matches.length > 0) {
                        matches.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'customer-suggestion';
                            const suggestedPrice = item.price; 
                            div.textContent = `${item.itemName} (Rs. ${suggestedPrice.toFixed(2)})`;
                            div.onclick = function() {
                                selectInvoiceItem(row, item, suggestedPrice);
                                suggestionsContainer.style.display = 'none';
                            };
                            suggestionsContainer.appendChild(div);
                        });
                        suggestionsContainer.style.display = 'block';
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                };
            });
        }
        
        function selectInvoiceItem(row, item, price) {
            row.querySelector('.item-name').value = item.itemName;
            row.querySelector('.item-rate').value = price.toFixed(2);
            calculateTotal(); 
        }

        // --- Customer Auto-complete ---
        function setupCustomerAutocomplete() {
            const customerInput = document.getElementById('invoiceCustomerName');
            const suggestionsContainer = document.getElementById('customerSuggestions');
            
            customerInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                suggestionsContainer.innerHTML = '';
                
                if (searchTerm.length < 2) { suggestionsContainer.style.display = 'none'; return; }
                
                const matches = customers.filter(customer => customer.name.toLowerCase().includes(searchTerm));
                
                if (matches.length > 0) {
                    matches.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'customer-suggestion';
                        div.textContent = customer.name;
                        div.onclick = function() { selectCustomerForInvoice(customer); suggestionsContainer.style.display = 'none'; };
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else { suggestionsContainer.style.display = 'none'; }
            });
        }

        function selectCustomerForInvoice(customer) {
            document.getElementById('invoiceCustomerName').value = customer.name;
            document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
            document.getElementById('previousBalance').value = customer.balance || 0;
            currentCustomer = customer;
            calculateTotal();
            showNotification(`Customer ${customer.name} loaded`, 'success');
        }

        // --- Invoice Item/Calculation Management ---
        function loadNextInvoiceNumber() {
            nextInvoiceNumber = parseInt(localStorage.getItem(LOCAL_NEXT_INV_KEY)) || 1001;
            if (invoices.length > 0) {
                const lastInvoiceNo = invoices.reduce((max, inv) => Math.max(max, parseInt(inv.invoiceNo) || 0), nextInvoiceNumber);
                nextInvoiceNumber = lastInvoiceNo + 1;
            }
            document.getElementById('invoiceNo').value = nextInvoiceNumber.toString().padStart(4, '0');
        }

        function addInvoiceItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off">
                    </div>
                </td>
                <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-amount" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
            `;
            setupItemAutocomplete();
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            if (document.querySelectorAll('#itemsTableBody tr').length > 1) {
                row.remove();
                calculateTotal();
            } else {
                showNotification('At least one item is required', 'warning');
            }
        }

        function calculateTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const amount = rate * quantity;
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const totalAmount = subtotal + taxAmount;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = totalAmount + previousBalance - payment;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
        }

        function saveInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const customerPhone = document.getElementById('invoiceCustomerPhone').value.trim();
            
            if (!customerName || !invoiceDate) { 
                showNotification('Please enter customer name and invoice date', 'warning');
                return; 
            }
            
            const items = [];
            let hasValidItem = false;
            
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                if (name && (rate > 0 || quantity > 0)) {
                    items.push({ name, rate, quantity, amount: rate * quantity });
                    hasValidItem = true;
                }
            });
            
            if (!hasValidItem) { 
                showNotification('Please add at least one valid item', 'warning');
                return; 
            }
            calculateTotal();

            let customer = customers.find(c => c.name === customerName);
            if (!customer) {
                customer = { id: Date.now().toString(), name: customerName, phone: customerPhone, balance: 0, invoicesCount: 0 };
                customers.push(customer);
            } else {
                customer.phone = customerPhone;
            }
            
            const invoice = {
                id: Date.now().toString(),
                invoiceNo: document.getElementById('invoiceNo').value,
                date: invoiceDate,
                customerName: customer.name,
                customerPhone: customer.phone,
                items: items,
                total: parseFloat(document.getElementById('totalAmount').textContent),
                previousBalance: parseFloat(document.getElementById('previousBalance').value) || 0,
                payment: parseFloat(document.getElementById('payment').value) || 0,
                remainingBalance: parseFloat(document.getElementById('remainingBalance').textContent),
                status: (parseFloat(document.getElementById('remainingBalance').textContent) <= 0 ? 'paid' : 'pending'),
                created: new Date().toISOString()
            };

            const existingIndex = invoices.findIndex(inv => inv.invoiceNo === invoice.invoiceNo);
            if (existingIndex !== -1) { invoices[existingIndex] = invoice; } else { invoices.push(invoice); }
            
            customer.balance = invoice.remainingBalance;
            customer.invoicesCount = (customer.invoicesCount || 0) + 1;
            
            nextInvoiceNumber++;
            saveAllData(); 
            loadNextInvoiceNumber();
            showNotification('Invoice saved and cloud sync initiated!', 'success');
        }

        function clearInvoice() {
            if (confirm('Are you sure you want to clear the current invoice?')) {
                document.getElementById('invoiceCustomerName').value = '';
                document.getElementById('invoiceCustomerPhone').value = '';
                document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('taxRate').value = '0';
                document.getElementById('previousBalance').value = '0';
                document.getElementById('payment').value = '0';
                
                const tableBody = document.getElementById('itemsTableBody');
                tableBody.innerHTML = '';
                addInvoiceItem();
                loadNextInvoiceNumber();
                calculateTotal();
                showNotification('Invoice form cleared', 'info');
            }
        }

        function loadInvoiceList() {
            const listContainer = document.getElementById('invoiceList');
            if (invoices.length === 0) { listContainer.innerHTML = '<p>No invoices saved yet.</p>'; return; }
            
            const tableHtml = `
                <table class="data-table">
                    <thead><tr><th>#</th><th>Customer</th><th>Total</th><th>Balance</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${invoices.map(inv => `
                            <tr>
                                <td>${inv.invoiceNo}</td>
                                <td>${inv.customerName}</td>
                                <td>Rs. ${inv.total.toFixed(2)}</td>
                                <td>Rs. ${inv.remainingBalance.toFixed(2)}</td>
                                <td>${inv.date}</td>
                                <td><span style="color:${inv.status === 'paid' ? 'green' : 'red'};">${inv.status.toUpperCase()}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="alert('Invoice Details: ' + JSON.stringify(invoices.find(i => i.id === \'${inv.id}\'), null, 2))">View</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${inv.id}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            listContainer.innerHTML = tableHtml;
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice? This cannot be undone.')) {
                invoices = invoices.filter(inv => inv.id !== id);
                saveAllData();
                loadInvoiceList();
                showNotification('Invoice deleted', 'success');
            }
        }

        // =============================================
        // ADMIN DATA MANAGEMENT FUNCTIONS
        // =============================================
        function addNewItem() {
            const mainCategory = document.getElementById('newMainCategory').value.trim();
            const subCategory = document.getElementById('newSubCategory').value.trim();
            const itemName = document.getElementById('newItemName').value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value) || 0;
            const designCharges = parseFloat(document.getElementById('newDesignCharges').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) { 
                showNotification('Please fill in all required fields', 'warning');
                return; 
            }
            
            if (!data.categories.some(cat => cat.mainCategory === mainCategory && cat.subcategory === subCategory)) {
                data.categories.push({ mainCategory, subcategory: subCategory });
            }
            
            data.items.push({ 
                mainCategory, 
                subcategory: subCategory, 
                itemName, 
                price, 
                type: "fixed", 
                designCharges 
            });
            
            document.getElementById('newMainCategory').value = '';
            document.getElementById('newSubCategory').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '0';
            document.getElementById('newDesignCharges').value = '0';
            
            refreshDataTables();
            refreshAllDisplays();
            saveAllData();
            showNotification('Item added successfully!', 'success');
        }

        function refreshDataTables() {
            const itemsTable = document.getElementById('itemsTable');
            itemsTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Main Category</th>
                        <th>Subcategory</th>
                        <th>Item Name</th>
                        <th>Price (Rs.)</th>
                        <th>Design Charges (Rs.)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.items.map((item, index) => `
                        <tr>
                            <td>${item.mainCategory}</td>
                            <td>${item.subcategory}</td>
                            <td>${item.itemName}</td>
                            <td><input type="number" value="${item.price}" onchange="data.items[${index}].price=parseFloat(this.value); saveAllData();"></td>
                            <td><input type="number" value="${item.designCharges}" onchange="data.items[${index}].designCharges=parseFloat(this.value); saveAllData();"></td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function deleteItem(index) { 
            if (confirm('Delete this item?')) { 
                data.items.splice(index, 1); 
                refreshDataTables(); 
                refreshAllDisplays(); 
                saveAllData(); 
                showNotification('Item deleted', 'success');
            } 
        }

        function loadSettings() {
            document.getElementById('rentCost').value = data.settings.rent;
            document.getElementById('profitMargin').value = data.settings.profitMargin;
        }

        function saveSettings() {
            data.settings.rent = parseFloat(document.getElementById('rentCost').value);
            data.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value);
            saveAllData();
            showNotification('Settings saved successfully!', 'success');
        }
        function resetToDefault() {
            if (confirm('WARNING: This will reset all calculator data (items, settings) to default values. Are you sure?')) {
                data = JSON.parse(JSON.stringify(defaultData));
                calculationHistory = [];
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                showNotification('Calculator data reset to default values!', 'success');
            }
        }

        // =============================================
        // INITIALIZATION AND SYNC CHECK
        // =============================================
        function checkInvoiceSyncTrigger() {
            const trigger = localStorage.getItem(LOCAL_EXCEL_TRIGGER_KEY);
            if (trigger === 'true') {
                if (isOnline && currentUser) {
                    localStorage.removeItem(LOCAL_EXCEL_TRIGGER_KEY);
                    console.log("Trigger detected: Starting Invoice/Customer Excel sync.");
                    window.syncAllToExcel(true); 
                } else {
                    document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Invoice Saved: Sign in to sync to Excel.';
                }
            }
        }

        // Initialize MSAL and start the application
        msalInstance.initialize().then(() => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentUser = accounts[0];
                isOnline = true;
                updateUIAfterLogin();
            }
            
            loadAllData();
            refreshAllDisplays();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Tab switching functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
     
            setInterval(checkInvoiceSyncTrigger, 5000); 

            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('item-name') && !e.target.closest('.item-suggestions')) {
                    document.querySelectorAll('.item-suggestions').forEach(box => box.style.display = 'none');
                }
                if (!e.target.id === 'invoiceCustomerName' && !e.target.closest('.customer-suggestions')) {
                    document.getElementById('customerSuggestions').style.display = 'none';
                }
            });
            
        });
    </script>
</body>

</html>

