<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Cloud Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #0078d4;
            --success: #107c10;
            --warning: #ffb900;
            --danger: #d13438;
            --light: #f8f9fa;
            --dark: #323130;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: #323130;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #2c3e50, #0078d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: var(--secondary);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .sync-online {
            background: #dff6dd;
            color: #107c10;
            border: 2px solid #107c10;
        }
        
        .sync-offline {
            background: #fff4ce;
            color: #d13438;
            border: 2px solid #d13438;
        }
        
        .user-info {
            background: #e1f5fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
        }
        
        .calculator-section {
            margin-bottom: 30px;
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--secondary);
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 180px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input { 
            flex: 2; 
            padding: 14px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 14px 28px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover {
            background: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-secondary { 
            background: var(--secondary); 
            color: white; 
        }
        
        .btn-secondary:hover {
            background: #106ebe;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-success:hover {
            background: #0e6b0e;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-warning:hover {
            background: #e6a200;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-danger:hover {
            background: #c02a2e;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-info { 
            background: #17a2b8; 
            color: white; 
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #dff6dd, #e8f5e8);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }
        
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .admin-row {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 4px;
            gap: 10px;
        }
        
        .admin-row label {
            flex: 1;
            min-width: 200px;
            font-weight: 600;
        }
        
        .admin-row input, .admin-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .data-table tr:hover {
            background: #e9ecef;
        }
        
        .data-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-field input, .form-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-section {
            margin-top: 30px;
        }
        
        .history-item {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-details {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .hidden-fields {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border: 1px solid #e1e5e9;
        }
        
        .login-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .login-form label {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .login-form input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            min-width: 250px;
        }
        
        .import-export-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border-left: 4px solid var(--secondary);
        }
        
        /* Invoice Styles */
        .invoices-list {
            margin-top: 20px;
        }

        .invoice-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e5e9;
        }

        .invoice-customer {
            flex: 1;
        }

        .invoice-customer h4 {
            margin: 0 0 5px 0;
            color: var(--primary);
        }

        .invoice-customer p {
            margin: 2px 0;
            color: #666;
            font-size: 0.9em;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-number {
            font-weight: bold;
            color: var(--secondary);
            font-size: 1.1em;
        }

        .invoice-date {
            color: #666;
            font-size: 0.9em;
        }

        .invoice-total {
            font-weight: bold;
            color: var(--success);
            font-size: 1.2em;
        }

        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .invoice-items th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .invoice-items td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .invoice-items tr:nth-child(even) {
            background: #f8f9fa;
        }

        .invoice-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        /* Print styles for invoices */
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-print, .invoice-print * {
                visibility: visible;
            }
            .invoice-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }

        /* Professional Invoice Template */
        .invoice-template {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border: 2px solid #e1e5e9;
        }

        .invoice-header-professional {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .company-info h2 {
            color: var(--primary);
            margin: 0 0 10px 0;
            font-size: 1.8em;
        }

        .company-info p {
            margin: 2px 0;
            color: #666;
        }

        .invoice-title {
            text-align: right;
        }

        .invoice-title h1 {
            color: var(--secondary);
            margin: 0;
            font-size: 2.2em;
        }

        .invoice-title .invoice-number {
            font-size: 1.1em;
            color: #666;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .customer-info, .invoice-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .customer-info h3, .invoice-info h3 {
            margin: 0 0 15px 0;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .invoice-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .invoice-table td {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .invoice-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .invoice-table .total-row {
            background: var(--secondary) !important;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        .invoice-summary {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .terms-conditions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .terms-conditions h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
        }

        .total-section {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }

        .total-amount {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .invoice-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
            text-align: center;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-right: 0;
                margin-bottom: 5px;
                border-radius: 5px;
            }
            
            .form-group, .admin-row, .login-form, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label, .admin-row label {
                margin-bottom: 5px;
                min-width: 100%;
            }
            
            .form-group select, .form-group input, .admin-row input, .admin-row select, .login-form input, .form-field {
                width: 100%;
                margin-right: 0;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .invoice-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .invoice-meta {
                text-align: left;
                margin-top: 10px;
            }
            
            .invoice-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> Arham Printers Calculator</h1>
            <p class="subtitle">Complete Price Calculator with OneDrive Cloud Sync</p>
        </header>

        <!-- Cloud Sync Section -->
        <div class="cloud-section">
            <h2 class="section-title"><i class="fas fa-cloud"></i> OneDrive Cloud Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-cloud"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="loginToOneDrive()" id="loginBtn">
                    <i class="fab fa-microsoft"></i> Sign in with Microsoft
                </button>
                <button class="btn btn-success" onclick="syncToCloud()" id="syncBtn" style="display: none;">
                    <i class="fas fa-cloud-upload-alt"></i> Upload to OneDrive
                </button>
                <button class="btn btn-secondary" onclick="syncFromCloud()" id="downloadBtn" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Download from OneDrive
                </button>
                <button class="btn btn-danger" onclick="logoutFromOneDrive()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data will automatically sync across all devices</p>
            </div>
        </div>

        <!-- Calculator Section -->
        <div class="calculator-section">
            <h2 class="section-title"><i class="fas fa-edit"></i> Calculate Printing Price</h2>
            
            <div class="form-group">
                <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                <select id="mainCategory">
                    <option value="">Select Main Category</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                <select id="subCategory"></select>
            </div>
            
            <div class="form-group">
                <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                <select id="itemName"></select>
            </div>
            
            <div class="hidden-fields" id="offsetFields">
                <div class="form-group">
                    <label for="size"><i class="fas fa-expand"></i> Size:</label>
                    <select id="size"></select>
                </div>
                
                <div class="form-group">
                    <label for="color"><i class="fas fa-palette"></i> Color:</label>
                    <select id="color"></select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quantity"><i class="fas fa-boxes"></i> Quantity:</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="calculatePrice()">
                    <i class="fas fa-calculator"></i> Calculate Price
                </button>
                <button class="btn btn-secondary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Quote
                </button>
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button class="btn btn-danger" onclick="clearForm()">
                    <i class="fas fa-trash"></i> Clear Form
                </button>
            </div>
            
            <div class="result" id="result"></div>
            <div class="price-breakdown" id="priceBreakdown">
                <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                <div id="breakdownContent"></div>
            </div>
        </div>
        
        <!-- Admin Section -->
        <div class="login-section">
            <h2 class="section-title"><i class="fas fa-lock"></i> Administrator Access</h2>
            <div class="login-form">
                <label for="adminPassword">Admin Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
                <button class="btn btn-warning" onclick="toggleAdmin()">
                    <i class="fas fa-key"></i> Admin Login
                </button>
            </div>
        </div>
        
        <div class="admin-panel" id="adminPanel">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Admin Panel</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="data-management">Data Management</div>
                <div class="tab" data-tab="history">Calculation History</div>
                <div class="tab" data-tab="settings">Settings</div>
                <div class="tab" data-tab="import-export">Import/Export</div>
                <div class="tab" data-tab="invoices">Invoices</div>
            </div>
            
            <!-- Data Management Tab -->
            <div class="tab-content active" id="data-management-tab">
                <div class="data-form">
                    <h3>Add New Item</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newMainCategory">Main Category:</label>
                            <input type="text" id="newMainCategory" placeholder="Enter main category">
                        </div>
                        <div class="form-field">
                            <label for="newSubCategory">Subcategory:</label>
                            <input type="text" id="newSubCategory" placeholder="Enter subcategory">
                        </div>
                        <div class="form-field">
                            <label for="newItemName">Item Name:</label>
                            <input type="text" id="newItemName" placeholder="Enter item name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newItemPrice">Price (Rs.):</label>
                            <input type="number" id="newItemPrice" min="0" value="0">
                        </div>
                        <div class="form-field">
                            <label for="newItemType">Item Type:</label>
                            <select id="newItemType">
                                <option value="fixed">Fixed Price</option>
                                <option value="offset">Offset Printing</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="newDesignCharges">Design Charges (Rs.):</label>
                            <input type="number" id="newDesignCharges" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newPaperCost">Paper Cost (Rs.):</label>
                            <input type="number" id="newPaperCost" min="0" value="0">
                        </div>
                        <div class="form-field">
                            <label for="newBindingCost">Binding Cost (Rs.):</label>
                            <input type="number" id="newBindingCost" min="0" value="0">
                        </div>
                        <div class="form-field">
                            <label for="newColorCost">Color Cost (Rs.):</label>
                            <input type="number" id="newColorCost" min="0" value="0">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> Add New Item
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Items</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Main Category</th>
                                <th>Subcategory</th>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Design Charges</th>
                                <th>Paper Cost</th>
                                <th>Binding Cost</th>
                                <th>Color Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable"></tbody>
                    </table>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Sizes</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newSizeName">Size Name:</label>
                            <input type="text" id="newSizeName" placeholder="e.g., A4/2 68g">
                        </div>
                        <div class="form-field">
                            <label for="newSizePaper">Paper Cost (Rs.):</label>
                            <input type="number" id="newSizePaper" min="0" value="0">
                        </div>
                        <button class="btn btn-success" onclick="addNewSize()" style="align-self: flex-end;">
                            <i class="fas fa-plus"></i> Add Size
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Size Name</th>
                                <th>Paper Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sizesTable"></tbody>
                    </table>
                </div>
                
                <div class="admin-section">
                    <h3>Manage Colors</h3>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="newColorName">Color Name:</label>
                            <input type="text" id="newColorName" placeholder="e.g., 1 or Blue">
                        </div>
                        <div class="form-field">
                            <label for="newColorCost">Color Cost (Rs.):</label>
                            <input type="number" id="newColorCost" min="0" value="0">
                        </div>
                        <button class="btn btn-success" onclick="addNewColor()" style="align-self: flex-end;">
                            <i class="fas fa-plus"></i> Add Color
                        </button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Color Name</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="colorsTable"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <h3>Calculation History</h3>
                <div class="actions">
                    <button class="btn btn-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> Clear History
                    </button>
                </div>
                <div id="historyList"></div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <h3>Application Settings</h3>
                
                <div class="admin-section">
                    <h4>Global Settings</h4>
                    <div class="admin-row">
                        <label>Rent Cost (Rs.)</label>
                        <input type="number" id="rentCost" value="200">
                    </div>
                    <div class="admin-row">
                        <label>Profit Margin (%)</label>
                        <input type="number" id="profitMargin" value="25">
                    </div>
                    <div class="admin-row">
                        <label>Default Binding Cost (Rs.)</label>
                        <input type="number" id="defaultBinding" value="40">
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
            
            <!-- Import/Export Tab -->
            <div class="tab-content" id="import-export-tab">
                <h3>Import/Export Data</h3>
                
                <div class="import-export-section">
                    <h4>Download Template</h4>
                    <p>Download a template CSV file to see the correct format for importing data.</p>
                    <div class="actions">
                        <button class="btn btn-info" onclick="downloadTemplate()">
                            <i class="fas fa-download"></i> Download CSV Template
                        </button>
                    </div>
                </div>
                
                <div class="import-export-section">
                    <h4>Export Data</h4>
                    <div class="actions">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="fas fa-file-export"></i> Export All Data to CSV
                        </button>
                        <button class="btn btn-secondary" onclick="exportItemsData()">
                            <i class="fas fa-file-export"></i> Export Items Only
                        </button>
                        <button class="btn btn-warning" onclick="exportCustomerDataForGitHub()">
                            <i class="fas fa-cloud-upload"></i> Export Customer Data
                        </button>
                    </div>
                    <p><small>Export customer data and upload to GitHub to update customer prices</small></p>
                </div>
                
                <div class="import-export-section">
                    <h4>Import Data from CSV</h4>
                    <div class="file-input">
                        <label for="csvFile">Select CSV File:</label>
                        <input type="file" id="csvFile" accept=".csv">
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="importData()">
                            <i class="fas fa-file-import"></i> Import Data from CSV
                        </button>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h4>Reset Data</h4>
                    <p>Reset all data to default values. This cannot be undone.</p>
                    <div class="actions">
                        <button class="btn btn-danger" onclick="resetToDefault()">
                            <i class="fas fa-undo"></i> Reset to Default Data
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Invoices Tab -->
            <div class="tab-content" id="invoices-tab">
                <h3>Invoice Management</h3>
                
                <div class="import-export-section">
                    <h4>Create New Invoice</h4>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="invoiceCustomerName">Customer Name:</label>
                            <input type="text" id="invoiceCustomerName" placeholder="Enter customer name">
                        </div>
                        <div class="form-field">
                            <label for="invoiceCustomerPhone">Phone Number:</label>
                            <input type="text" id="invoiceCustomerPhone" placeholder="Enter phone number">
                        </div>
                        <div class="form-field">
                            <label for="invoiceCustomerAddress">Address:</label>
                            <input type="text" id="invoiceCustomerAddress" placeholder="Enter address">
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="createNewInvoice()">
                            <i class="fas fa-file-invoice"></i> Create New Invoice
                        </button>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h4>Recent Invoices</h4>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="refreshInvoices()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="btn btn-warning" onclick="exportAllInvoices()">
                            <i class="fas fa-file-export"></i> Export All Invoices
                        </button>
                    </div>
                    <div id="invoicesList" class="invoices-list">
                        <!-- Invoices will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Save All Data
                </button>
                <button class="btn btn-secondary" onclick="toggleAdmin()">
                    <i class="fas fa-times"></i> Close Admin Panel
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // AZURE APP CONFIGURATION
        // =============================================
        const AZURE_CLIENT_ID = "26b3dde9-366f-487b-a485-79d1bf1ab857";
        
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: AZURE_CLIENT_ID,
                authority: "https://login.microsoftonline.com/common",
                redirectUri: "https://greenshirt3.github.io/ArhamP/",
                knownAuthorities: ["https://login.microsoftonline.com/common/"]
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let isOnline = false;
        let currentUser = null;

        // Complete Default Data Structure
        const defaultData = {
            categories: [
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads" },
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars" },
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops" },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards" },
                { mainCategory: "Offset Paper Printing", subcategory: "Stickers" },
                { mainCategory: "Offset Paper Printing", subcategory: "Bill Books" },
                { mainCategory: "Offset Paper Printing", subcategory: "PhotoPapers" },
                { mainCategory: "Offset Paper Printing", subcategory: "weddind cards" },
                { mainCategory: "Panaflex", subcategory: "China" },
                { mainCategory: "Panaflex", subcategory: "Star" },
                { mainCategory: "Panaflex", subcategory: "Venyl" },
                { mainCategory: "Panaflex", subcategory: "One Vision" },
                { mainCategory: "Panaflex", subcategory: "Backlit" },
                { mainCategory: "Others", subcategory: "Miscellaneous" },
                { mainCategory: "Social Media Posts", subcategory: "Design Only" }
            ],
            items: [
                // Offset Paper Printing - LetterPads
                { mainCategory: "Offset Paper Printing", subcategory: "LetterPads", itemName: "LetterPads", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 40, colorCost: 0 },
                
                // Offset Paper Printing - Ishtihars
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars", itemName: "Paper Ishtihars", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Ishtihars", itemName: "Art Paper Ishtihars", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Offset Paper Printing - Envelops
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops", itemName: "Envelop 9x4", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Envelops", itemName: "Envelop 7x5", price: 0, type: "offset", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Offset Paper Printing - Visiting Cards (Fixed Prices)
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Shine", price: 1800, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Single Side", price: 1900, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Mat Double Side", price: 2500, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Panaflex - China
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x2", price: 140, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x3", price: 210, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Panaflex", subcategory: "China", itemName: "2x4", price: 280, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                
                // Social Media Posts
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Facebook Post", price: 300, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 },
                { mainCategory: "Social Media Posts", subcategory: "Design Only", itemName: "Instagram Post", price: 400, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 }
            ],
            sizes: {
                "A4/2 68g": 625,
                "A4 68g": 1250,
                "A4/4 68g": 312.5,
                "Legal 100g": 3600,
                "A4 Art Paper 113g": 3700,
                "News Paper 9x3.5": 400
            },
            colors: {
                "1": 700,
                "2": 1400,
                "3": 2100,
                "4": 2800,
                "Blue": 850,
                "Green": 850,
                "Brown": 850
            },
            settings: {
                rent: 200,
                profitMargin: 25,
                defaultBinding: 40
            }
        };

        let data = JSON.parse(JSON.stringify(defaultData));
        let calculationHistory = [];
        const ADMIN_PASSWORD = "admin123";

        // =============================================
        // INVOICE MANAGEMENT SYSTEM
        // =============================================

        let invoices = JSON.parse(localStorage.getItem('arhamPrintersInvoices')) || [];
        let nextInvoiceNumber = parseInt(localStorage.getItem('arhamNextInvoiceNumber')) || 1001;

        // =============================================
        // CUSTOMER DATA EXPORT FOR GITHUB SYNC
        // =============================================

        // Export data for customer sync
        function exportCustomerDataForGitHub() {
            const customerData = {
                categories: data.categories,
                items: data.items,
                sizes: data.sizes,
                colors: data.colors,
                settings: data.settings,
                lastUpdated: new Date().toISOString()
            };
            
            // Create a downloadable JSON file
            const blob = new Blob([JSON.stringify(customerData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'customer-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Customer data exported! Upload this file to GitHub to update customer prices.');
        }

        // =============================================
        // ONEDRIVE CLOUD SYNC FUNCTIONS
        // =============================================

        async function loginToOneDrive() {
            try {
                const loginRequest = {
                    scopes: ["User.Read", "Files.ReadWrite.All"],
                    prompt: "select_account"
                };
                
                const response = await msalInstance.loginPopup(loginRequest);
                currentUser = response.account;
                isOnline = true;
                
                updateUIAfterLogin();
                await checkOneDriveFile();
                
            } catch (error) {
                console.error("Login failed:", error);
                alert("Login failed. Please try again. Error: " + error.message);
            }
        }

        async function logoutFromOneDrive() {
            try {
                await msalInstance.logoutPopup();
                currentUser = null;
                isOnline = false;
                updateUIAfterLogout();
                alert("Successfully signed out from OneDrive.");
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        function updateUIAfterLogin() {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('syncBtn').style.display = 'inline-flex';
            document.getElementById('downloadBtn').style.display = 'inline-flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('syncStatus').className = 'sync-status sync-online';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Online - Connected to OneDrive';
        }

        function updateUIAfterLogout() {
            document.getElementById('loginBtn').style.display = 'inline-flex';
            document.getElementById('syncBtn').style.display = 'none';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncStatus').className = 'sync-status sync-offline';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-cloud"></i> Offline Mode - Data stored locally';
        }

        async function getAccessToken() {
            const request = {
                scopes: ["Files.ReadWrite.All"],
                account: currentUser
            };
            
            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                console.error("Token acquisition failed:", error);
                try {
                    const response = await msalInstance.acquireTokenPopup(request);
                    return response.accessToken;
                } catch (popupError) {
                    console.error("Popup token acquisition failed:", popupError);
                    return null;
                }
            }
        }

        async function checkOneDriveFile() {
            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.status === 200) {
                    if (confirm('Cloud data found! Do you want to download and replace your local data?')) {
                        await syncFromCloud();
                    }
                } else {
                    if (confirm('No cloud data found. Do you want to upload your current data to OneDrive?')) {
                        await syncToCloud();
                    }
                }
            } catch (error) {
                console.error("Error checking OneDrive file:", error);
            }
        }

        async function syncToCloud() {
            if (!isOnline || !currentUser) {
                alert("Please sign in to sync with OneDrive");
                return;
            }

            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const allData = {
                    calculatorData: data,
                    history: calculationHistory,
                    invoices: invoices,
                    nextInvoiceNumber: nextInvoiceNumber,
                    lastSync: new Date().toISOString(),
                    syncDevice: navigator.userAgent
                };

                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(allData)
                    }
                );

                if (response.ok) {
                    alert('✅ Data successfully synced to OneDrive!');
                } else {
                    throw new Error('Failed to upload to OneDrive');
                }
            } catch (error) {
                console.error("Sync failed:", error);
                alert('❌ Failed to sync data to OneDrive: ' + error.message);
            }
        }

        async function syncFromCloud() {
            if (!isOnline || !currentUser) {
                alert("Please sign in to sync with OneDrive");
                return;
            }

            const accessToken = await getAccessToken();
            if (!accessToken) {
                alert("Could not get access token. Please try signing in again.");
                return;
            }

            try {
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/drive/root:/ArhamPrinters/data.json:/content`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const cloudData = await response.json();
                    
                    if (confirm('Do you want to replace your local data with cloud data?')) {
                        data = cloudData.calculatorData || data;
                        calculationHistory = cloudData.history || calculationHistory;
                        invoices = cloudData.invoices || invoices;
                        nextInvoiceNumber = cloudData.nextInvoiceNumber || nextInvoiceNumber;
                        
                        saveAllData();
                        saveInvoices();
                        refreshAllDisplays();
                        refreshDataTables();
                        refreshInvoices();
                        
                        alert('✅ Data successfully synced from OneDrive!');
                    }
                } else {
                    throw new Error('Failed to download from OneDrive');
                }
            } catch (error) {
                console.error("Sync failed:", error);
                alert('❌ Failed to sync data from OneDrive: ' + error.message);
            }
        }

        // =============================================
        // CORE APPLICATION FUNCTIONS
        // =============================================

        // Auto-save function with cloud sync
        function saveAllData() {
            localStorage.setItem('arhamPrintersData', JSON.stringify(data));
            localStorage.setItem('arhamPrintersHistory', JSON.stringify(calculationHistory));
            
            if (isOnline && currentUser) {
                setTimeout(() => {
                    syncToCloud().catch(error => {
                        console.error("Auto-sync failed:", error);
                    });
                }, 1000);
            }
        }

        // Save invoices function
        function saveInvoices() {
            localStorage.setItem('arhamPrintersInvoices', JSON.stringify(invoices));
            localStorage.setItem('arhamNextInvoiceNumber', nextInvoiceNumber.toString());
        }

        // Load invoices function
        function loadInvoices() {
            const savedInvoices = localStorage.getItem('arhamPrintersInvoices');
            const savedNextNumber = localStorage.getItem('arhamNextInvoiceNumber');
            
            if (savedInvoices) {
                try {
                    invoices = JSON.parse(savedInvoices);
                } catch (e) {
                    console.error("Error loading invoices:", e);
                    invoices = [];
                }
            }
            
            if (savedNextNumber) {
                nextInvoiceNumber = parseInt(savedNextNumber);
            }
        }

        // Initialize MSAL and check for existing session
        msalInstance.initialize().then(() => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                currentUser = accounts[0];
                isOnline = true;
                updateUIAfterLogin();
            }
            
            loadAllData();
            loadInvoices();
            setupEventListeners();
            refreshAllDisplays();
        });

        // Load data from localStorage
        function loadAllData() {
            const savedData = localStorage.getItem('arhamPrintersData');
            const savedHistory = localStorage.getItem('arhamPrintersHistory');
            
            if (savedData) {
                try {
                    data = JSON.parse(savedData);
                } catch (e) {
                    console.error("Error loading data:", e);
                    data = JSON.parse(JSON.stringify(defaultData));
                }
            }
            
            if (savedHistory) {
                try {
                    calculationHistory = JSON.parse(savedHistory);
                } catch (e) {
                    console.error("Error loading history:", e);
                    calculationHistory = [];
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (!this.classList.contains('active')) {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                        
                        if (this.dataset.tab === 'data-management') {
                            refreshDataTables();
                        } else if (this.dataset.tab === 'history') {
                            updateHistoryDisplay();
                        } else if (this.dataset.tab === 'settings') {
                            loadSettings();
                        } else if (this.dataset.tab === 'invoices') {
                            refreshInvoices();
                        }
                    }
                });
            });
            
            document.getElementById('mainCategory').addEventListener('change', updateSubcategories);
            document.getElementById('subCategory').addEventListener('change', updateItemsAndFields);
        }

        // Refresh all UI displays
        function refreshAllDisplays() {
            updateMainCategories();
            updateSubcategories();
            updateItemsAndFields();
            updateSizesDropdown();
            updateColorsDropdown();
        }

        // Update main categories dropdown
        function updateMainCategories() {
            const mainSelect = document.getElementById('mainCategory');
            mainSelect.innerHTML = '<option value="">Select Main Category</option>';
            
            const mainCategories = [...new Set(data.categories.map(cat => cat.mainCategory))];
            mainCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                mainSelect.appendChild(option);
            });
        }

        // Update subcategories dropdown
        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subSelect = document.getElementById('subCategory');
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (!mainCategory) return;
            
            const subcategories = [...new Set(
                data.categories
                    .filter(cat => cat.mainCategory === mainCategory)
                    .map(cat => cat.subcategory)
            )];
            
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subSelect.appendChild(option);
            });
            
            updateItemsAndFields();
        }

        // Update items dropdown and field visibility
        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subcategory) {
                const items = data.items.filter(
                    item => item.mainCategory === mainCategory && item.subcategory === subcategory
                );
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemName;
                    option.textContent = item.itemName;
                    itemSelect.appendChild(option);
                });
            }
            
            const offsetFields = document.getElementById('offsetFields');
            if (mainCategory === "Offset Paper Printing" && 
                ["LetterPads", "Ishtihars", "Bill Books"].includes(subcategory)) {
                offsetFields.style.display = 'block';
            } else {
                offsetFields.style.display = 'none';
            }
        }

        // Update sizes dropdown
        function updateSizesDropdown() {
            const sizeSelect = document.getElementById('size');
            sizeSelect.innerHTML = '<option value="">Select Size</option>';
            
            for (let size in data.sizes) {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            }
        }

        // Update colors dropdown
        function updateColorsDropdown() {
            const colorSelect = document.getElementById('color');
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            
            for (let color in data.colors) {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            }
        }

        // Calculate price
        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!mainCategory || !subcategory || !itemName) {
                alert("Please select all required fields");
                return;
            }
            
            const item = data.items.find(i => 
                i.mainCategory === mainCategory && 
                i.subcategory === subcategory && 
                i.itemName === itemName
            );
            
            if (!item) {
                document.getElementById('result').textContent = "Item not found";
                document.getElementById('result').style.display = 'block';
                return;
            }
            
            let basePrice = 0;
            let breakdown = [];
            
            if (item.type === "fixed") {
                basePrice = item.price;
                breakdown.push(`Item Price: Rs. ${basePrice}`);
            } else {
                const size = document.getElementById('size').value;
                const color = document.getElementById('color').value;
                
                if (!size || !color) {
                    alert("Please select size and color for this item");
                    return;
                }
                
                const paperCost = data.sizes[size] || item.paperCost || 0;
                const bindingCost = item.bindingCost || data.settings.defaultBinding || 0;
                const colorCost = data.colors[color] || item.colorCost || 0;
                
                basePrice = paperCost + bindingCost + colorCost + data.settings.rent;
                
                breakdown.push(`Paper Cost: Rs. ${paperCost}`);
                if (bindingCost > 0) breakdown.push(`Binding Cost: Rs. ${bindingCost}`);
                breakdown.push(`Color Cost: Rs. ${colorCost}`);
                breakdown.push(`Rent: Rs. ${data.settings.rent}`);
                breakdown.push(`Base Cost: Rs. ${basePrice}`);
            }
            
            if (item.designCharges > 0) {
                breakdown.push(`Design Charges: Rs. ${item.designCharges}`);
                basePrice += item.designCharges;
            }
            
            const subtotal = basePrice * quantity;
            const profit = subtotal * (data.settings.profitMargin / 100);
            const total = subtotal + profit;
            
            breakdown.push(`Quantity: ${quantity}`);
            breakdown.push(`Subtotal: Rs. ${Math.round(subtotal)}`);
            breakdown.push(`Profit (${data.settings.profitMargin}%): Rs. ${Math.round(profit)}`);
            breakdown.push(`Total: Rs. ${Math.round(total)}`);
            
            document.getElementById('result').textContent = `Total Price: Rs. ${Math.round(total)}`;
            document.getElementById('result').style.display = 'block';
            
            document.getElementById('breakdownContent').innerHTML = breakdown.map(item => 
                `<div class="breakdown-item">${item}</div>`
            ).join('');
            document.getElementById('priceBreakdown').style.display = 'block';
            
            addToHistory({
                mainCategory,
                subcategory,
                itemName,
                quantity,
                designCharges: item.designCharges || 0,
                total: Math.round(total),
                timestamp: new Date().toLocaleString()
            });
        }

        // Add to history
        function addToHistory(calculation) {
            calculationHistory.unshift(calculation);
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            saveAllData();
        }

        // Update history display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<p>No calculations yet</p>';
                return;
            }
            
            historyList.innerHTML = calculationHistory.map(calc => `
                <div class="history-item">
                    <div class="history-header">
                        <span>${calc.itemName}</span>
                        <span>Rs. ${calc.total}</span>
                    </div>
                    <div class="history-details">
                        ${calc.mainCategory} > ${calc.subcategory} | Qty: ${calc.quantity} | 
                        Design: Rs. ${calc.designCharges} | ${calc.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all calculation history?')) {
                calculationHistory = [];
                saveAllData();
                updateHistoryDisplay();
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('size').value = '';
            document.getElementById('color').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
        }

        // Export to Excel
        function exportToExcel() {
            const main = document.getElementById('mainCategory').value;
            const sub = document.getElementById('subCategory').value;
            const item = document.getElementById('itemName').value;
            const qty = parseInt(document.getElementById('quantity').value) || 1;
            const result = document.getElementById('result').textContent;
            
            const exportData = [
                ['Arham Printers - Price Calculation'],
                ['Main Category', main],
                ['Subcategory', sub],
                ['Item', item],
                ['Quantity', qty],
                [result],
                ['Exported on', new Date().toLocaleString()],
                ['Synced with OneDrive', isOnline ? 'Yes' : 'No']
            ];
            
            let csvContent = 'data:text/csv;charset=utf-8,';
            exportData.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\r\n';
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'arham_printers_quote.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =============================================
        // ADMIN PANEL FUNCTIONS
        // =============================================

        function toggleAdmin() {
            const input = document.getElementById('adminPassword').value;
            if (input === ADMIN_PASSWORD) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                refreshDataTables();
                updateHistoryDisplay();
                loadSettings();
                refreshInvoices();
            } else {
                alert('Incorrect admin password');
            }
        }

        // Load settings
        function loadSettings() {
            document.getElementById('rentCost').value = data.settings.rent;
            document.getElementById('profitMargin').value = data.settings.profitMargin;
            document.getElementById('defaultBinding').value = data.settings.defaultBinding;
        }

        // Save settings
        function saveSettings() {
            data.settings.rent = parseFloat(document.getElementById('rentCost').value);
            data.settings.profitMargin = parseFloat(document.getElementById('profitMargin').value);
            data.settings.defaultBinding = parseFloat(document.getElementById('defaultBinding').value);
            saveAllData();
            alert('Settings saved successfully!');
        }

        // Data Management Functions
        function addNewItem() {
            const mainCategory = document.getElementById('newMainCategory').value.trim();
            const subCategory = document.getElementById('newSubCategory').value.trim();
            const itemName = document.getElementById('newItemName').value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value) || 0;
            const type = document.getElementById('newItemType').value;
            const designCharges = parseFloat(document.getElementById('newDesignCharges').value) || 0;
            const paperCost = parseFloat(document.getElementById('newPaperCost').value) || 0;
            const bindingCost = parseFloat(document.getElementById('newBindingCost').value) || 0;
            const colorCost = parseFloat(document.getElementById('newColorCost').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!data.categories.some(cat => cat.mainCategory === mainCategory && cat.subcategory === subCategory)) {
                data.categories.push({ mainCategory, subcategory: subCategory });
            }
            
            data.items.push({
                mainCategory,
                subcategory: subCategory,
                itemName,
                price,
                type,
                designCharges,
                paperCost,
                bindingCost,
                colorCost
            });
            
            document.getElementById('newMainCategory').value = '';
            document.getElementById('newSubCategory').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '0';
            document.getElementById('newDesignCharges').value = '0';
            document.getElementById('newPaperCost').value = '0';
            document.getElementById('newBindingCost').value = '0';
            document.getElementById('newColorCost').value = '0';
            
            refreshDataTables();
            refreshAllDisplays();
            saveAllData();
            alert('Item added successfully!');
        }

        function addNewSize() {
            const sizeName = document.getElementById('newSizeName').value.trim();
            const paperCost = parseFloat(document.getElementById('newSizePaper').value) || 0;
            
            if (!sizeName) {
                alert('Please enter a size name');
                return;
            }
            
            data.sizes[sizeName] = paperCost;
            
            document.getElementById('newSizeName').value = '';
            document.getElementById('newSizePaper').value = '0';
            
            refreshDataTables();
            updateSizesDropdown();
            saveAllData();
            alert('Size added successfully!');
        }

        function addNewColor() {
            const colorName = document.getElementById('newColorName').value.trim();
            const colorCost = parseFloat(document.getElementById('newColorCost').value) || 0;
            
            if (!colorName) {
                alert('Please enter a color name');
                return;
            }
            
            data.colors[colorName] = colorCost;
            
            document.getElementById('newColorName').value = '';
            document.getElementById('newColorCost').value = '0';
            
            refreshDataTables();
            updateColorsDropdown();
            saveAllData();
            alert('Color added successfully!');
        }

        // Refresh data tables
        function refreshDataTables() {
            const itemsTable = document.getElementById('itemsTable');
            itemsTable.innerHTML = '';
            
            data.items.forEach((item, index) => {
                const row = itemsTable.insertRow();
                row.innerHTML = `
                    <td>${item.mainCategory}</td>
                    <td>${item.subcategory}</td>
                    <td>${item.itemName}</td>
                    <td><input type="number" value="${item.price}" onchange="data.items[${index}].price=parseFloat(this.value); saveAllData();"></td>
                    <td>${item.type}</td>
                    <td><input type="number" value="${item.designCharges}" onchange="data.items[${index}].designCharges=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.paperCost}" onchange="data.items[${index}].paperCost=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.bindingCost}" onchange="data.items[${index}].bindingCost=parseFloat(this.value); saveAllData();"></td>
                    <td><input type="number" value="${item.colorCost}" onchange="data.items[${index}].colorCost=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            const sizesTable = document.getElementById('sizesTable');
            sizesTable.innerHTML = '';
            
            for (let sizeName in data.sizes) {
                const row = sizesTable.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${sizeName}" onchange="renameSize('${sizeName}', this.value)"></td>
                    <td><input type="number" value="${data.sizes[sizeName]}" onchange="data.sizes['${sizeName}']=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteSize('${sizeName}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }
            
            const colorsTable = document.getElementById('colorsTable');
            colorsTable.innerHTML = '';
            
            for (let colorName in data.colors) {
                const row = colorsTable.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${colorName}" onchange="renameColor('${colorName}', this.value)"></td>
                    <td><input type="number" value="${data.colors[colorName]}" onchange="data.colors['${colorName}']=parseFloat(this.value); saveAllData();"></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteColor('${colorName}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }
        }

        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                data.items.splice(index, 1);
                refreshDataTables();
                refreshAllDisplays();
                saveAllData();
            }
        }

        function deleteSize(sizeName) {
            if (confirm('Are you sure you want to delete this size?')) {
                delete data.sizes[sizeName];
                refreshDataTables();
                updateSizesDropdown();
                saveAllData();
            }
        }

        function deleteColor(colorName) {
            if (confirm('Are you sure you want to delete this color?')) {
                delete data.colors[colorName];
                refreshDataTables();
                updateColorsDropdown();
                saveAllData();
            }
        }

        function renameSize(oldName, newName) {
            if (oldName !== newName && newName.trim() !== '') {
                data.sizes[newName] = data.sizes[oldName];
                delete data.sizes[oldName];
                refreshDataTables();
                updateSizesDropdown();
                saveAllData();
            }
        }

        function renameColor(oldName, newName) {
            if (oldName !== newName && newName.trim() !== '') {
                data.colors[newName] = data.colors[oldName];
                delete data.colors[oldName];
                refreshDataTables();
                updateColorsDropdown();
                saveAllData();
            }
        }

        // =============================================
        // IMPORT/EXPORT FUNCTIONS
        // =============================================

        function downloadTemplate() {
            const templateContent = `CATEGORIES
Main Category,Subcategory
"Offset Paper Printing","Visiting Cards"
"Panaflex","China"

ITEMS
Main Category,Subcategory,Item Name,Price,Type,Design Charges,Paper Cost,Binding Cost,Color Cost
"Offset Paper Printing","Visiting Cards","Shine",1800,fixed,0,0,0,0
"Offset Paper Printing","Visiting Cards","Mat Single Side",1900,fixed,0,0,0,0
"Panaflex","China","2x2",140,fixed,0,0,0,0

SIZES
Size Name,Paper Cost
"A4/2 68g",625
"A4 68g",1250

COLORS
Color Name,Color Cost
"1",700
"2",1400

IMPORTANT NOTES:
1. Keep the section headers (CATEGORIES, ITEMS, SIZES, COLORS)
2. Don't modify the column headers
3. Keep empty lines between sections
4. Use quotes around text that contains commas
5. For Type, use either "fixed" or "offset"`;

            const blob = new Blob([templateContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'arham_printers_template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Template downloaded! Use this file as a guide for creating your CSV files.');
        }

        function exportAllData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                
                // Export Categories
                csvContent += 'CATEGORIES\r\n';
                csvContent += 'Main Category,Subcategory\r\n';
                data.categories.forEach(cat => {
                    csvContent += `"${cat.mainCategory}","${cat.subcategory}"\r\n`;
                });
                
                // Export Items
                csvContent += '\r\nITEMS\r\n';
                csvContent += 'Main Category,Subcategory,Item Name,Price,Type,Design Charges,Paper Cost,Binding Cost,Color Cost\r\n';
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                // Export Sizes
                csvContent += '\r\nSIZES\r\n';
                csvContent += 'Size Name,Paper Cost\r\n';
                for (let sizeName in data.sizes) {
                    csvContent += `"${sizeName}",${data.sizes[sizeName]}\r\n`;
                }
                
                // Export Colors
                csvContent += '\r\nCOLORS\r\n';
                csvContent += 'Color Name,Color Cost\r\n';
                for (let colorName in data.colors) {
                    csvContent += `"${colorName}",${data.colors[colorName]}\r\n`;
                }
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_all_data.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        function exportItemsData() {
            try {
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'Main Category,Subcategory,Item Name,Price,Type,Design Charges,Paper Cost,Binding Cost,Color Cost\r\n';
                
                data.items.forEach(item => {
                    csvContent += `"${item.mainCategory}","${item.subcategory}","${item.itemName}",${item.price},${item.type},${item.designCharges},${item.paperCost},${item.bindingCost},${item.colorCost}\r\n`;
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'arham_printers_items.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Items exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting items: ' + error.message);
            }
        }

        function importData() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    processCSVData(csvData);
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsText(file);
        }

        function processCSVData(csvData) {
            try {
                const lines = csvData.split('\n').filter(line => line.trim() !== '');
                let currentSection = '';
                let itemsImported = 0;
                let sizesImported = 0;
                let colorsImported = 0;
                let categoriesImported = 0;
                
                const importChoice = prompt(
                    'How do you want to import data?\n\n' +
                    '1 - REPLACE all existing data\n' +
                    '2 - MERGE with existing data (keep existing, add new)\n' +
                    '3 - UPDATE existing items only\n\n' +
                    'Enter 1, 2, or 3:'
                );
                
                if (!importChoice) return;
                
                const replaceData = importChoice === '1';
                const mergeData = importChoice === '2';
                const updateOnly = importChoice === '3';
                
                // Temporary storage for imported data
                const importedCategories = [];
                const importedItems = [];
                const importedSizes = {};
                const importedColors = {};
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') continue;
                    
                    // Detect section headers
                    if (line.toUpperCase().includes('CATEGORIES')) {
                        currentSection = 'categories';
                        continue;
                    } else if (line.toUpperCase().includes('ITEMS')) {
                        currentSection = 'items';
                        continue;
                    } else if (line.toUpperCase().includes('SIZES')) {
                        currentSection = 'sizes';
                        continue;
                    } else if (line.toUpperCase().includes('COLORS')) {
                        currentSection = 'colors';
                        continue;
                    }
                    
                    // Skip empty lines and section headers after detection
                    if (line === '' || 
                        line.toUpperCase().includes('CATEGORIES') ||
                        line.toUpperCase().includes('ITEMS') ||
                        line.toUpperCase().includes('SIZES') ||
                        line.toUpperCase().includes('COLORS')) {
                        continue;
                    }
                    
                    // Parse CSV line properly
                    const values = parseCSVLine(line);
                    
                    // Skip header rows
                    if (values[0] && (
                        values[0].toLowerCase().includes('main category') ||
                        values[0].toLowerCase().includes('size name') ||
                        values[0].toLowerCase().includes('color name')
                    )) {
                        continue;
                    }
                    
                    if (currentSection === 'categories' && values.length >= 2) {
                        const mainCategory = values[0]?.trim() || '';
                        const subcategory = values[1]?.trim() || '';
                        
                        if (mainCategory && subcategory && mainCategory !== 'Main Category') {
                            const categoryExists = importedCategories.some(
                                cat => cat.mainCategory === mainCategory && cat.subcategory === subcategory
                            );
                            
                            if (!categoryExists) {
                                importedCategories.push({ mainCategory, subcategory });
                                categoriesImported++;
                            }
                        }
                        
                    } else if (currentSection === 'items' && values.length >= 3) {
                        const mainCategory = (values[0] || '').trim();
                        const subcategory = (values[1] || '').trim();
                        const itemName = (values[2] || '').trim();
                        
                        // Skip if this looks like a header row
                        if (mainCategory === 'Main Category' || itemName === 'Item Name') {
                            continue;
                        }
                        
                        if (mainCategory && subcategory && itemName) {
                            const item = {
                                mainCategory: mainCategory,
                                subcategory: subcategory,
                                itemName: itemName,
                                price: parseFloat(values[3]) || 0,
                                type: (values[4] || 'fixed').trim(),
                                designCharges: parseFloat(values[5]) || 0,
                                paperCost: parseFloat(values[6]) || 0,
                                bindingCost: parseFloat(values[7]) || 0,
                                colorCost: parseFloat(values[8]) || 0
                            };
                            
                            importedItems.push(item);
                            itemsImported++;
                        }
                        
                    } else if (currentSection === 'sizes' && values.length >= 2) {
                        const sizeName = (values[0] || '').trim();
                        const paperCost = parseFloat(values[1]) || 0;
                        
                        if (sizeName && sizeName !== 'Size Name') {
                            importedSizes[sizeName] = paperCost;
                            sizesImported++;
                        }
                        
                    } else if (currentSection === 'colors' && values.length >= 2) {
                        const colorName = (values[0] || '').trim();
                        const colorCost = parseFloat(values[1]) || 0;
                        
                        if (colorName && colorName !== 'Color Name') {
                            importedColors[colorName] = colorCost;
                            colorsImported++;
                        }
                    }
                }
                
                // Apply the imported data based on user choice
                if (replaceData) {
                    // Replace all data
                    data.categories = importedCategories;
                    data.items = importedItems;
                    data.sizes = importedSizes;
                    data.colors = importedColors;
                } else if (mergeData) {
                    // Merge data - add new items, keep existing
                    importedCategories.forEach(cat => {
                        const exists = data.categories.some(
                            existing => existing.mainCategory === cat.mainCategory && existing.subcategory === cat.subcategory
                        );
                        if (!exists) {
                            data.categories.push(cat);
                        }
                    });
                    
                    importedItems.forEach(item => {
                        const existingIndex = data.items.findIndex(
                            existing => existing.mainCategory === item.mainCategory && 
                                       existing.subcategory === item.subcategory && 
                                       existing.itemName === item.itemName
                        );
                        
                        if (existingIndex === -1) {
                            data.items.push(item);
                        } else {
                            // Update existing item
                            data.items[existingIndex] = item;
                        }
                    });
                    
                    Object.assign(data.sizes, importedSizes);
                    Object.assign(data.colors, importedColors);
                    
                } else if (updateOnly) {
                    // Update only existing items
                    importedItems.forEach(item => {
                        const existingIndex = data.items.findIndex(
                            existing => existing.mainCategory === item.mainCategory && 
                                       existing.subcategory === item.subcategory && 
                                       existing.itemName === item.itemName
                        );
                        
                        if (existingIndex !== -1) {
                            data.items[existingIndex] = item;
                        }
                    });
                }
                
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                
                let message = `✅ Data imported successfully!\n\n`;
                if (replaceData) message += 'All existing data was REPLACED.\n\n';
                if (mergeData) message += 'Data was MERGED with existing data.\n\n';
                if (updateOnly) message += 'Existing items were UPDATED.\n\n';
                
                message += `📊 Import Summary:\n`;
                message += `• Categories: ${categoriesImported}\n`;
                message += `• Items: ${itemsImported}\n`;
                message += `• Sizes: ${sizesImported}\n`;
                message += `• Colors: ${colorsImported}\n\n`;
                message += `📈 Current Totals:\n`;
                message += `• Total categories: ${data.categories.length}\n`;
                message += `• Total items: ${data.items.length}\n`;
                message += `• Total sizes: ${Object.keys(data.sizes).length}\n`;
                message += `• Total colors: ${Object.keys(data.colors).length}`;
                
                alert(message);
                
                document.getElementById('csvFile').value = '';
                
            } catch (error) {
                console.error('Process CSV error:', error);
                alert('❌ Error processing CSV file: ' + error.message + '\n\nPlease check:\n• File is a valid CSV\n• No empty rows between data\n• Column headers match expected format');
            }
        }

        // Helper function to properly parse CSV lines with quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // =============================================
        // INVOICE FUNCTIONS
        // =============================================

        // Create new invoice
        function createNewInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value.trim();
            const customerPhone = document.getElementById('invoiceCustomerPhone').value.trim();
            const customerAddress = document.getElementById('invoiceCustomerAddress').value.trim();
            
            if (!customerName) {
                alert('Please enter customer name');
                return;
            }
            
            const invoice = {
                id: generateInvoiceId(),
                invoiceNumber: `INV-${nextInvoiceNumber.toString().padStart(4, '0')}`,
                date: new Date().toISOString().split('T')[0],
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    address: customerAddress
                },
                items: [],
                subtotal: 0,
                tax: 0,
                total: 0,
                status: 'draft',
                created: new Date().toISOString()
            };
            
            nextInvoiceNumber++;
            invoices.unshift(invoice);
            saveInvoices();
            
            // Clear form
            document.getElementById('invoiceCustomerName').value = '';
            document.getElementById('invoiceCustomerPhone').value = '';
            document.getElementById('invoiceCustomerAddress').value = '';
            
            // Refresh display
            refreshInvoices();
            alert(`Invoice ${invoice.invoiceNumber} created! You can now add items to it.`);
        }

        function generateInvoiceId() {
            return 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Refresh invoices list
        function refreshInvoices() {
            const invoicesList = document.getElementById('invoicesList');
            
            if (invoices.length === 0) {
                invoicesList.innerHTML = '<p>No invoices created yet.</p>';
                return;
            }
            
            invoicesList.innerHTML = invoices.map(invoice => `
                <div class="invoice-item">
                    <div class="invoice-header">
                        <div class="invoice-customer">
                            <h4>${invoice.customer.name}</h4>
                            <p>${invoice.customer.phone || 'No phone'}</p>
                            <p>${invoice.customer.address || 'No address'}</p>
                        </div>
                        <div class="invoice-meta">
                            <div class="invoice-number">${invoice.invoiceNumber}</div>
                            <div class="invoice-date">${new Date(invoice.date).toLocaleDateString()}</div>
                            <div class="invoice-total">Rs. ${invoice.total.toFixed(2)}</div>
                            <div class="invoice-status" style="color: ${getStatusColor(invoice.status)}">${invoice.status.toUpperCase()}</div>
                        </div>
                    </div>
                    
                    ${invoice.items.length > 0 ? `
                        <table class="invoice-items">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>Rs. ${item.price.toFixed(2)}</td>
                                        <td>Rs. ${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #666; padding: 20px;">No items added yet</p>'}
                    
                    <div class="invoice-actions">
                        <button class="btn btn-primary" onclick="addItemsToInvoice('${invoice.id}')">
                            <i class="fas fa-plus"></i> Add Items
                        </button>
                        <button class="btn btn-secondary" onclick="viewInvoice('${invoice.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-success" onclick="printInvoice('${invoice.id}')">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-warning" onclick="editInvoice('${invoice.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteInvoice('${invoice.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'draft': return '#ffb900';
                case 'sent': return '#0078d4';
                case 'paid': return '#107c10';
                case 'overdue': return '#d13438';
                default: return '#666';
            }
        }

        // Add items from current calculation to invoice
        function addItemsToInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const result = document.getElementById('result').textContent;
            
            if (!mainCategory || !subcategory || !itemName) {
                alert('Please calculate a price first before adding to invoice');
                return;
            }
            
            // Extract total from result text
            const totalMatch = result.match(/Rs\.?\s*(\d+)/);
            const total = totalMatch ? parseFloat(totalMatch[1]) : 0;
            
            if (total === 0) {
                alert('Please calculate a valid price first');
                return;
            }
            
            const price = total / quantity;
            
            const invoiceItem = {
                id: 'item_' + Date.now(),
                description: `${mainCategory} - ${subcategory} - ${itemName}`,
                quantity: quantity,
                price: price,
                total: total,
                category: mainCategory,
                subcategory: subcategory,
                item: itemName
            };
            
            invoice.items.push(invoiceItem);
            updateInvoiceTotals(invoice);
            saveInvoices();
            refreshInvoices();
            
            alert(`Item added to invoice ${invoice.invoiceNumber}`);
        }

        function updateInvoiceTotals(invoice) {
            invoice.subtotal = invoice.items.reduce((sum, item) => sum + item.total, 0);
            invoice.tax = 0; // You can add tax calculation if needed
            invoice.total = invoice.subtotal + invoice.tax;
        }

        // View invoice in modal
        function viewInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const invoiceHTML = generateInvoiceHTML(invoice);
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 10px;">
                    <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Invoice ${invoice.invoiceNumber}</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
                    </div>
                    <div style="padding: 30px;">
                        ${invoiceHTML}
                    </div>
                    <div style="padding: 20px; border-top: 1px solid #ddd; text-align: center;">
                        <button class="btn btn-success" onclick="printInvoice('${invoice.id}')">
                            <i class="fas fa-print"></i> Print Invoice
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Print invoice
        function printInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const invoiceHTML = generateInvoiceHTML(invoice);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoice.invoiceNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
                        .invoice-template { max-width: 800px; margin: 0 auto; background: white; padding: 40px; }
                        .invoice-header-professional { display: flex; justify-content: space-between; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2c3e50; }
                        .company-info h2 { color: #2c3e50; margin: 0 0 10px 0; font-size: 1.8em; }
                        .invoice-title h1 { color: #0078d4; margin: 0; font-size: 2.2em; }
                        .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
                        .customer-info, .invoice-info { background: #f8f9fa; padding: 20px; border-radius: 8px; }
                        .invoice-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .invoice-table th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
                        .invoice-table td { padding: 15px; border-bottom: 1px solid #e1e5e9; }
                        .invoice-table tr:nth-child(even) { background: #f8f9fa; }
                        .invoice-table .total-row { background: #0078d4 !important; color: white; font-weight: bold; }
                        .invoice-summary { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 30px; }
                        .total-section { background: #2c3e50; color: white; padding: 25px; border-radius: 8px; text-align: center; }
                        .total-amount { font-size: 2em; font-weight: bold; margin: 10px 0; }
                        .invoice-footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e1e5e9; text-align: center; color: #666; }
                        @media print { body { margin: 0; } .invoice-template { padding: 20px; } }
                    </style>
                </head>
                <body>
                    ${invoiceHTML}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Generate professional invoice HTML
        function generateInvoiceHTML(invoice) {
            return `
                <div class="invoice-template invoice-print">
                    <div class="invoice-header-professional">
                        <div class="company-info">
                            <h2>Arham Printers</h2>
                            <p>Professional Printing Services</p>
                            <p>Your Address Here</p>
                            <p>Phone: [Your Phone Number]</p>
                            <p>Email: [Your Email]</p>
                        </div>
                        <div class="invoice-title">
                            <h1>INVOICE</h1>
                            <div class="invoice-number">${invoice.invoiceNumber}</div>
                            <div class="invoice-date">Date: ${new Date(invoice.date).toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div class="invoice-details">
                        <div class="customer-info">
                            <h3>Bill To:</h3>
                            <p><strong>${invoice.customer.name}</strong></p>
                            <p>${invoice.customer.phone || ''}</p>
                            <p>${invoice.customer.address || ''}</p>
                        </div>
                        <div class="invoice-info">
                            <h3>Invoice Details:</h3>
                            <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                            <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                            <p><strong>Status:</strong> <span style="color: ${getStatusColor(invoice.status)}">${invoice.status.toUpperCase()}</span></p>
                        </div>
                    </div>
                    
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>Rs. ${item.price.toFixed(2)}</td>
                                    <td>Rs. ${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                                <td><strong>Rs. ${invoice.subtotal.toFixed(2)}</strong></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;"><strong>Tax:</strong></td>
                                <td><strong>Rs. ${invoice.tax.toFixed(2)}</strong></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                                <td><strong>Rs. ${invoice.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="invoice-summary">
                        <div class="terms-conditions">
                            <h4>Terms & Conditions</h4>
                            <p>• Payment due within 15 days</p>
                            <p>• Late fees may apply for overdue payments</p>
                            <p>• All prices in Pakistani Rupees (Rs.)</p>
                            <p>• Thank you for your business!</p>
                        </div>
                        <div class="total-section">
                            <h3>TOTAL AMOUNT</h3>
                            <div class="total-amount">Rs. ${invoice.total.toFixed(2)}</div>
                            <p>Due Date: ${new Date(new Date(invoice.date).getTime() + 15 * 24 * 60 * 60 * 1000).toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="invoice-footer">
                        <p>For any queries, please contact us at [Your Phone Number] or [Your Email]</p>
                        <p><strong>Thank you for choosing Arham Printers!</strong></p>
                    </div>
                </div>
            `;
        }

        // Edit invoice
        function editInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const newName = prompt('Enter customer name:', invoice.customer.name);
            if (newName !== null) {
                invoice.customer.name = newName.trim();
            }
            
            const newPhone = prompt('Enter phone number:', invoice.customer.phone);
            if (newPhone !== null) {
                invoice.customer.phone = newPhone.trim();
            }
            
            const newAddress = prompt('Enter address:', invoice.customer.address);
            if (newAddress !== null) {
                invoice.customer.address = newAddress.trim();
            }
            
            saveInvoices();
            refreshInvoices();
        }

        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                invoices = invoices.filter(inv => inv.id !== invoiceId);
                saveInvoices();
                refreshInvoices();
            }
        }

        // Export all invoices
        function exportAllInvoices() {
            const exportData = {
                invoices: invoices,
                exportDate: new Date().toISOString(),
                totalInvoices: invoices.length
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `arham_invoices_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${invoices.length} invoices successfully!`);
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset all data to default? This cannot be undone.')) {
                data = JSON.parse(JSON.stringify(defaultData));
                calculationHistory = [];
                saveAllData();
                refreshAllDisplays();
                refreshDataTables();
                alert('Data reset to default values!');
            }
        }

        // Initialize the application
        window.onload = function() {
            console.log('Arham Printers Complete Calculator loaded successfully!');
        };
    </script>
</body>
</html>