<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Complete Shop Management</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Arham Printers">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3c4e60;
            --secondary: #4285F4; /* Google Blue */
            --secondary-light: #5a95f5;
            --success: #0F9D58;   /* Google Green */
            --success-light: #11ac62;
            --warning: #F4B400;  /* Google Yellow */
            --warning-light: #f6c231;
            --danger: #DB4437;   /* Google Red */
            --danger-light: #e05a4e;
            --light: #f8f9fa;
            --dark: #323130;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, #2c3e50, #4285F4);
            --gradient-light: linear-gradient(135deg, #3c4e60, #5a95f5);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e5e9;
            position: relative;
        }
        
        h1 { 
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .cloud-section {
            background: linear-gradient(135deg, #e8f0fe, #f1e8fe);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .sync-status {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-online {
            background: #e6f4ea;
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .sync-offline {
            background: #fde2e2;
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        .user-info {
            background: #e8f0fe;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        /* Updated Grid for 3 Panels */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 30px;
        }

        /* Adjustments for smaller screens */
        @media (max-width: 1400px) {
            .content-grid {
                grid-template-columns: 1fr 1fr; /* Switch to 2 columns on medium screens */
            }
        }
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr; /* Switch to 1 column on small screens */
            }
        }
        
        .section-panel {
            padding: 25px;
            background: var(--light);
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .section-panel:hover {
            box-shadow: var(--box-shadow-hover);
            transform: translateY(-3px);
        }
        
        .section-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 10px;
            border-bottom: 3px solid var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .form-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-bottom: 20px; 
            align-items: center;
            gap: 15px;
        }
        
        .form-group label { 
            flex: 1; 
            padding: 8px; 
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .form-group select, .form-group input, .form-group textarea { 
            flex: 2; 
            padding: 12px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1.1rem;
            transition: var(--transition);
            background: white;
        }
        
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .actions { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn { 
            padding: 12px 24px; 
            cursor: pointer; 
            border-radius: 6px;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: var(--secondary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: var(--primary); color: white; }
        .btn-secondary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: var(--success-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-warning { background: var(--warning); color: #222; }
        .btn-warning:hover { background: var(--warning-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: var(--danger-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Calculator Result Styling */
        .result { 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 1.4em;
            padding: 25px;
            background: linear-gradient(135deg, #e6f4ea, #d0e8d0);
            border-radius: var(--border-radius);
            border-left: 6px solid var(--success);
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .price-breakdown {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
            color: var(--success);
        }

        /* Invoice Specific Styling */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .items-table th, .items-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .items-table th {
            background: var(--primary);
            color: white;
        }
        
        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .totals-section {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ccc;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .customer-suggestions, .item-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .customer-suggestion {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .customer-suggestion:hover {
            background: #f5f5f5;
        }
        
        .suggestion-container {
            position: relative;
            flex: 2;
        }

        /* Financial Hub Styling */
        .dashboard-metric {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
        }
        
        .dashboard-metric span {
            display: block;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .metric-income {
            border-color: var(--success);
            background-color: #e6f4ea;
        }
        
        .metric-expense {
            border-color: var(--danger);
            background-color: #fde2e2;
        }
        
        .metric-profit {
            border-color: var(--secondary);
            background-color: #e8f0fe;
        }
        
        .metric-net {
            border-color: var(--warning);
            background-color: #fff8e1;
        }

        /* Admin Panel Styling */
        .admin-panel { 
            display: none; 
            margin-top: 30px; 
            background: #f8f9fa; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            border: 2px solid #e1e5e9;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background: #fff;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 8px;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--primary);
            color: white;
        }
        
        .data-table input {
            padding: 4px;
            font-size: 0.9em;
            width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .login-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e1e5e9;
        }
        
        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .login-form label {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .login-form input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .history-details {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .import-export-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: var(--box-shadow);
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .notification.info {
            background: var(--secondary);
        }

        /* Item Editor Specific Styles */
        #itemEditor {
            border-top: 4px solid var(--warning);
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }
        
        .tier-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        
        .tier-row input {
            padding: 8px;
            font-size: 1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-group, .form-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label, .form-row label, .form-field {
                min-width: 100%;
                width: 100%;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-radius: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Arham Printers Shop Management</h1>
            <p class="subtitle">Complete Price Calculator, Invoicing, and Financial Management</p>
        </header>

        <div class="cloud-section">
            <h2 class="section-title"><i class="fab fa-google-drive"></i> Google Drive & Sheets Sync</h2>
            <div id="syncStatus" class="sync-status sync-offline">
                <i class="fas fa-exclamation-circle"></i> Offline Mode - Data stored locally
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="signIn()" id="loginBtn">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                <button class="btn btn-success" onclick="saveAllData(true)" id="syncBtn" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Force Sync Now
                </button>
                <button class="btn btn-danger" onclick="signOut()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
            
            <div id="userInfo" class="user-info" style="display: none;">
                <h3><i class="fas fa-user"></i> Signed in as: <span id="userName"></span></h3>
                <p>Your data is synced across all devices via Google Drive.</p>
            </div>
        </div>

        <div class="content-grid">
            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Price Calculator</h2>
                
                <div class="form-group">
                    <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                    <select id="mainCategory" onchange="updateSubcategories()">
                        <option value="">Select Main Category</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                    <select id="subCategory" onchange="updateItemsAndFields()"></select>
                </div>
                
                <div class="form-group">
                    <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                    <select id="itemName" onchange="updateQuantityInput()"></select>
                </div>
                
                <div class="form-group">
                    <label for="quantityInputContainer"><i class="fas fa-boxes"></i> Quantity / Set:</label>
                    <div id="quantityInputContainer" style="flex: 2;">
                        <input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">
                    </div>
                </div>
                
                <div class="form-group" id="priceTierTagGroup" style="margin-top: -10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f9f9f9; display: none;">
                    <label><i class="fas fa-tag"></i> Selected Set:</label>
                    <span id="priceTierTag" style="font-weight: bold; color: var(--danger);">Select a set.</span>
                </div>
                
                <div class="form-group">
                    <label for="designCharges"><i class="fas fa-paint-brush"></i> Design Charges (Rs.):</label>
                    <input type="number" id="designCharges" value="0" min="0" step="0.01">
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" onclick="calculatePrice()">
                        <i class="fas fa-calculator"></i> Calculate Price
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Quote
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear Form
                    </button>
                </div>
                
                <div class="result" id="result"></div>
                <div class="price-breakdown" id="priceBreakdown">
                    <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                    <div id="breakdownContent"></div>
                </div>
            </div>

            <div class="section-panel">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> Invoice System</h2>
                
                <div class="form-group">
                    <label for="invoiceCustomerName"><i class="fas fa-user"></i> Customer Name:</label>
                    <div class="suggestion-container">
                        <input type="text" id="invoiceCustomerName" placeholder="Start typing customer name..." autocomplete="off" list="customerNameList">
                        <div id="customerSuggestions" class="customer-suggestions" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invoiceCustomerPhone"><i class="fas fa-phone"></i> Phone:</label>
                    <input type="tel" id="invoiceCustomerPhone" placeholder="Customer phone number" list="customerPhoneList">
                </div>
                
                <div class="form-group">
                    <label for="invoiceNo"><i class="fas fa-hashtag"></i> Invoice Number:</label>
                    <input type="text" id="invoiceNo" readonly>
                </div>
                
                <div class="form-group">
                    <label for="invoiceDate"><i class="fas fa-calendar"></i> Invoice Date:</label>
                    <input type="date" id="invoiceDate">
                </div>

                <h3>Invoice Items</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Rate (Rs.)</th>
                            <th>Qty</th>
                            <th>Design Charges (Rs.)</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td>
                                <div style="position: relative;">
                                    <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                                </div>
                            </td>
                            <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                            <td><input type="number" class="item-amount" value="0" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="addInvoiceItem()">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                    <button class="btn btn-secondary" onclick="calculateTotal()">
                        <i class="fas fa-calculator"></i> Recalculate
                    </button>
                </div>

                <div class="totals-section">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Invoice Totals</h3>
                    
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>Rs. <span id="subtotalAmount">0.00</span></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="taxRate">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="0" min="0" max="100" step="0.1" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Total Amount:</strong></span>
                        <span><strong>Rs. <span id="totalAmount">0.00</span></strong></span>
                    </div>
                    
                    <div class="form-group">
                        <label for="previousBalance">Previous Balance (Rs.):</label>
                        <input type="number" id="previousBalance" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label for="payment">Payment Received (Rs.):</label>
                        <input type="number" id="payment" value="0" min="0" step="0.01" oninput="calculateTotal()">
                    </div>
                    
                    <div class="total-row">
                        <span><strong>Remaining Balance:</strong></span>
                        <span><strong>Rs. <span id="remainingBalance">0.00</span></strong></span>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" onclick="saveInvoice()">
                        <i class="fas fa-save"></i> Save & Sync Invoice
                    </button>
                    <button class="btn btn-warning" onclick="clearInvoice()">
                        <i class="fas fa-trash"></i> Clear Invoice Form
                    </button>
                </div>
            </div>
            
            <div class="section-panel" id="FinancialHub">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Financial Hub</h2>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchFinancialTab(this, 'dashboard')">Dashboard</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'logTransaction')">Log Transaction</div>
                    <div class="tab" onclick="switchFinancialTab(this, 'managePayables')">Manage Payables</div>
                </div>

                <div id="dashboard" class="tab-content active" style="padding-top: 20px;">
                    <h4>Summary for <span id="dashboardMonth"></span></h4>
                    <div id="financialDashboardContainer"></div>
                </div>

                <div id="logTransaction" class="tab-content">
                    <div class="form-group">
                        <label for="entryType">Entry Type:</label>
                        <select id="entryType" onchange="togglePaymentPayable()">
                            <option value="Income">Income</option>
                            <option value="Expense">General Expense</option>
                            <option value="Payment">Payment (for Payable)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="paymentPayableGroup" style="display:none;">
                        <label for="paymentPayableSelect">For:</label>
                        <select id="paymentPayableSelect"></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryCategory">Category:</label>
                        <select id="entryCategory">
                            <option value="Income: Invoice Payment">Income: Invoice Payment</option>
                            <option value="Income: Army Pension">Income: Army Pension</option>
                            <option value="Income: Other">Income: Other</option>
                            <option value="Expense: Business Materials">Expense: Business Materials</option>
                            <option value="Expense: Business Rent">Expense: Business Rent</option>
                            <option value="Expense: Business Salaries">Expense: Business Salaries</option>
                            <option value="Expense: Business Other">Expense: Business Other</option>
                            <option value="Expense: Personal Groceries">Expense: Personal Groceries</option>
                            <option value="Expense: Personal Transport">Expense: Personal Transport</option>
                            <option value="Expense: Personal Bills">Expense: Personal Bills</option>
                            <option value="Expense: Personal Other">Expense: Personal Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDate">Date:</label>
                        <input type="date" id="entryDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryAmount">Amount (Rs.):</label>
                        <input type="number" id="entryAmount" value="0" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="entryDescription">Description:</label>
                        <textarea id="entryDescription" placeholder="e.g., Monthly shop loan, School fee" list="expenseDescriptionList"></textarea>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" onclick="saveFinancialEntry()">
                            <i class="fas fa-save"></i> Save Entry
                        </button>
                    </div>
                </div>

                <div id="managePayables" class="tab-content">
                    <div class="admin-section">
                        <h4>Add New Payable</h4>
                        <div class="form-group">
                            <label for="payableName">Name:</label>
                            <input type="text" id="payableName" placeholder="Mobile, Business Loan...">
                        </div>
                        <div class="form-group">
                            <label for="payableAmount">Amount (Rs.):</label>
                            <input type="number" id="payableAmount" value="0" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="payableDueDate">Due Date:</label>
                            <input type="date" id="payableDueDate">
                        </div>
                        <div class="actions">
                            <button class="btn btn-success" onclick="addPayable()">
                                <i class="fas fa-plus"></i> Add Payable
                            </button>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Payables</h4>
                        <div id="payablesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-panel">
            <h2 class="section-title"><i class="fas fa-history"></i> Recent Calculations & Invoices</h2>
            <div id="historyContainer"></div>
        </div>

        <div class="section-panel">
            <h2 class="section-title"><i class="fas fa-cogs"></i> Admin Panel</h2>
            
            <div class="login-section" id="adminLoginSection">
                <h3><i class="fas fa-lock"></i> Admin Login</h3>
                <div class="login-form">
                    <div class="form-field">
                        <label for="adminPassword">Admin Password:</label>
                        <input type="password" id="adminPassword" placeholder="Enter admin password">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
            
            <div class="admin-panel" id="adminPanel">
                <h3><i class="fas fa-tools"></i> Admin Controls</h3>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(this, 'manageItems')">Manage Items</div>
                    <div class="tab" onclick="switchTab(this, 'manageCustomers')">Manage Customers</div>
                    <div class="tab" onclick="switchTab(this, 'manageInvoices')">Manage Invoices</div>
                    <div class="tab" onclick="switchTab(this, 'manageFinancial')">Manage Financial</div>
                    <div class="tab" onclick="switchTab(this, 'importExport')">Import/Export</div>
                </div>
                
                <div id="manageItems" class="tab-content active">
                    <div class="admin-section">
                        <h4>Add New Item</h4>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newMainCategory">Main Category:</label>
                                <input type="text" id="newMainCategory" placeholder="e.g., Visiting Cards">
                            </div>
                            <div class="form-field">
                                <label for="newSubCategory">Subcategory:</label>
                                <input type="text" id="newSubCategory" placeholder="e.g., Plastic Cards">
                            </div>
                            <div class="form-field">
                                <label for="newItemName">Item Name:</label>
                                <input type="text" id="newItemName" placeholder="e.g., Plastic Visiting Card">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newItemUnit">Unit:</label>
                                <input type="text" id="newItemUnit" placeholder="e.g., Set, Piece, Box">
                            </div>
                            <div class="form-field">
                                <label for="newItemBasePrice">Base Price (Rs.):</label>
                                <input type="number" id="newItemBasePrice" value="0" min="0" step="0.01">
                            </div>
                        </div>
                        <h5>Price Tiers</h5>
                        <div id="newItemTiers">
                            <div class="tier-row">
                                <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                                <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                                <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-success" onclick="addTier()">
                                <i class="fas fa-plus"></i> Add Tier
                            </button>
                            <button class="btn btn-primary" onclick="addNewItem()">
                                <i class="fas fa-save"></i> Save Item
                            </button>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Items</h4>
                        <div id="itemsList"></div>
                    </div>
                </div>
                
                <div id="manageCustomers" class="tab-content">
                    <div class="admin-section">
                        <h4>Add New Customer</h4>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="newCustomerName">Customer Name:</label>
                                <input type="text" id="newCustomerName" placeholder="Customer full name">
                            </div>
                            <div class="form-field">
                                <label for="newCustomerPhone">Phone:</label>
                                <input type="tel" id="newCustomerPhone" placeholder="Phone number">
                            </div>
                            <div class="form-field">
                                <label for="newCustomerAddress">Address:</label>
                                <input type="text" id="newCustomerAddress" placeholder="Customer address">
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="addNewCustomer()">
                                <i class="fas fa-save"></i> Save Customer
                            </button>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h4>Current Customers</h4>
                        <div id="customersList"></div>
                    </div>
                </div>
                
                <div id="manageInvoices" class="tab-content">
                    <div class="admin-section">
                        <h4>All Invoices</h4>
                        <div id="invoicesList"></div>
                    </div>
                </div>
                
                <div id="manageFinancial" class="tab-content">
                    <div class="admin-section">
                        <h4>Financial Entries</h4>
                        <div id="financialEntriesList"></div>
                    </div>
                </div>
                
                <div id="importExport" class="tab-content">
                    <div class="import-export-section">
                        <h4>Export Data</h4>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="exportData('items')">
                                <i class="fas fa-download"></i> Export Items
                            </button>
                            <button class="btn btn-primary" onclick="exportData('customers')">
                                <i class="fas fa-download"></i> Export Customers
                            </button>
                            <button class="btn btn-primary" onclick="exportData('invoices')">
                                <i class="fas fa-download"></i> Export Invoices
                            </button>
                            <button class="btn btn-primary" onclick="exportData('financial')">
                                <i class="fas fa-download"></i> Export Financial Data
                            </button>
                            <button class="btn btn-success" onclick="exportAllData()">
                                <i class="fas fa-file-archive"></i> Export All Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="import-export-section">
                        <h4>Import Data</h4>
                        <div class="form-group">
                            <label for="importFile">Select File:</label>
                            <input type="file" id="importFile" accept=".json">
                        </div>
                        <div class="actions">
                            <button class="btn btn-warning" onclick="importData()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="import-export-section">
                        <h4>Backup & Restore</h4>
                        <div class="actions">
                            <button class="btn btn-success" onclick="createBackup()">
                                <i class="fas fa-database"></i> Create Backup
                            </button>
                            <button class="btn btn-danger" onclick="restoreBackup()">
                                <i class="fas fa-history"></i> Restore Backup
                            </button>
                            <button class="btn btn-danger" onclick="clearAllData()">
                                <i class="fas fa-trash"></i> Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let isOnline = false;
        let isAdmin = false;
        let priceData = {};
        let customers = [];
        let invoices = [];
        let financialEntries = [];
        let payables = [];
        let calculationHistory = [];
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            document.getElementById('payableDueDate').valueAsDate = new Date();
            
            // Load data from localStorage
            loadAllData();
            
            // Initialize Google API
            initializeGoogleAPI();
            
            // Update UI
            updateDashboardMonth();
            updateFinancialDashboard();
            updatePayablesList();
            updateHistory();
            
            // Generate next invoice number
            generateNextInvoiceNumber();
            
            // Add event listeners for customer suggestions
            document.getElementById('invoiceCustomerName').addEventListener('input', showCustomerSuggestions);
            
            // Add event listeners for item suggestions in invoice
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-name')) {
                    showItemSuggestions(e.target);
                }
            });
        });

        // Initialize Google API
        function initializeGoogleAPI() {
            // Load the Google API client library
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: 'AIzaSyC7pzqjXGvQvQr7kY8QyY8QyY8QyY8QyY8Q', // This is a dummy key
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    });
                    gapiInited = true;
                    maybeEnableButtons();
                } catch (error) {
                    console.error('Error initializing Google API:', error);
                }
            });

            // Load the Google Identity Services library
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com', // Replace with your actual client ID
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets',
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('loginBtn').style.display = 'inline-block';
            }
        }

        // Google Drive integration functions
        async function signIn() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw new Error(resp.error);
                }
                
                currentUser = gapi.client.getToken();
                isOnline = true;
                
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('syncStatus').className = 'sync-status sync-online';
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check-circle"></i> Online - Synced with Google Drive';
                
                // Get user info
                try {
                    const userInfo = await gapi.client.oauth2.userinfo.get();
                    document.getElementById('userName').textContent = userInfo.result.name || userInfo.result.email;
                } catch (error) {
                    console.error('Error getting user info:', error);
                    document.getElementById('userName').textContent = 'User';
                }
                
                // Sync data with Google Drive
                await syncAllData();
                
                showNotification('Successfully signed in and synced with Google Drive!', 'success');
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            currentUser = null;
            isOnline = false;
            
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncStatus').className = 'sync-status sync-offline';
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> Offline Mode - Data stored locally';
            
            showNotification('Signed out successfully. Data is now stored locally.', 'warning');
        }

        // Data management functions
        function loadAllData() {
            // Load price data
            const savedPriceData = localStorage.getItem('arhamPrintersPriceData');
            if (savedPriceData) {
                priceData = JSON.parse(savedPriceData);
                populateCategories();
            } else {
                // Initialize with default data
                initializeDefaultPriceData();
            }
            
            // Load customers
            const savedCustomers = localStorage.getItem('arhamPrintersCustomers');
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            }
            
            // Load invoices
            const savedInvoices = localStorage.getItem('arhamPrintersInvoices');
            if (savedInvoices) {
                invoices = JSON.parse(savedInvoices);
            }
            
            // Load financial entries
            const savedFinancial = localStorage.getItem('arhamPrintersFinancial');
            if (savedFinancial) {
                financialEntries = JSON.parse(savedFinancial);
            }
            
            // Load payables
            const savedPayables = localStorage.getItem('arhamPrintersPayables');
            if (savedPayables) {
                payables = JSON.parse(savedPayables);
            }
            
            // Load calculation history
            const savedHistory = localStorage.getItem('arhamPrintersHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
        }

        function saveAllData(syncToDrive = false) {
            // Save to localStorage
            localStorage.setItem('arhamPrintersPriceData', JSON.stringify(priceData));
            localStorage.setItem('arhamPrintersCustomers', JSON.stringify(customers));
            localStorage.setItem('arhamPrintersInvoices', JSON.stringify(invoices));
            localStorage.setItem('arhamPrintersFinancial', JSON.stringify(financialEntries));
            localStorage.setItem('arhamPrintersPayables', JSON.stringify(payables));
            localStorage.setItem('arhamPrintersHistory', JSON.stringify(calculationHistory));
            
            if (syncToDrive && isOnline) {
                syncAllData();
            }
            
            showNotification('Data saved successfully!', 'success');
        }

        async function syncAllData() {
            if (!isOnline) return;
            
            try {
                // In a real implementation, this would sync with Google Sheets
                // For now, we'll just simulate the sync
                showNotification('Data synced with Google Drive!', 'success');
            } catch (error) {
                console.error('Error syncing data:', error);
                showNotification('Error syncing data with Google Drive', 'error');
            }
        }

        function initializeDefaultPriceData() {
            priceData = {
                "Visiting Cards": {
                    "Plastic Cards": {
                        "Plastic Visiting Card": {
                            "unit": "Set",
                            "basePrice": 100,
                            "tiers": [
                                { "min": 1, "max": 50, "price": 100 },
                                { "min": 51, "max": 100, "price": 90 },
                                { "min": 101, "max": 200, "price": 80 }
                            ]
                        }
                    },
                    "Paper Cards": {
                        "Standard Paper Card": {
                            "unit": "Set",
                            "basePrice": 50,
                            "tiers": [
                                { "min": 1, "max": 100, "price": 50 },
                                { "min": 101, "max": 500, "price": 45 },
                                { "min": 501, "max": 1000, "price": 40 }
                            ]
                        }
                    }
                },
                "Banners": {
                    "Vinyl Banners": {
                        "3x6 Vinyl Banner": {
                            "unit": "Piece",
                            "basePrice": 500,
                            "tiers": [
                                { "min": 1, "max": 5, "price": 500 },
                                { "min": 6, "max": 10, "price": 450 }
                            ]
                        }
                    }
                }
            };
            
            populateCategories();
            saveAllData();
        }

        // Category and item management
        function populateCategories() {
            const mainCategorySelect = document.getElementById('mainCategory');
            mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
            
            for (const category in priceData) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                mainCategorySelect.appendChild(option);
            }
        }

        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            subCategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (mainCategory && priceData[mainCategory]) {
                for (const subcategory in priceData[mainCategory]) {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subCategorySelect.appendChild(option);
                }
            }
            
            // Clear items
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantityInputContainer').innerHTML = '<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">';
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            if (mainCategory && subCategory && priceData[mainCategory] && priceData[mainCategory][subCategory]) {
                for (const itemName in priceData[mainCategory][subCategory]) {
                    const option = document.createElement('option');
                    option.value = itemName;
                    option.textContent = itemName;
                    itemSelect.appendChild(option);
                }
            }
            
            updateQuantityInput();
        }

        function updateQuantityInput() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantityContainer = document.getElementById('quantityInputContainer');
            
            if (mainCategory && subCategory && itemName && 
                priceData[mainCategory] && 
                priceData[mainCategory][subCategory] && 
                priceData[mainCategory][subCategory][itemName]) {
                
                const item = priceData[mainCategory][subCategory][itemName];
                quantityContainer.innerHTML = `<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">`;
                
                // Show unit
                const unitLabel = document.querySelector('label[for="quantityInputContainer"]');
                unitLabel.innerHTML = `<i class="fas fa-boxes"></i> Quantity (${item.unit}):`;
            } else {
                quantityContainer.innerHTML = `<input type="number" id="quantity" value="1" min="1" oninput="clearTierTag()">`;
                const unitLabel = document.querySelector('label[for="quantityInputContainer"]');
                unitLabel.innerHTML = `<i class="fas fa-boxes"></i> Quantity / Set:`;
            }
            
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        function clearTierTag() {
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        // Price calculation
        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const designCharges = parseFloat(document.getElementById('designCharges').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName) {
                showNotification('Please select a category and item', 'error');
                return;
            }
            
            const item = priceData[mainCategory][subCategory][itemName];
            if (!item) {
                showNotification('Selected item not found', 'error');
                return;
            }
            
            // Find the appropriate price tier
            let unitPrice = item.basePrice;
            let selectedTier = null;
            
            if (item.tiers && item.tiers.length > 0) {
                for (const tier of item.tiers) {
                    if (quantity >= tier.min && quantity <= tier.max) {
                        unitPrice = tier.price;
                        selectedTier = tier;
                        break;
                    }
                }
            }
            
            // Calculate total price
            const itemTotal = unitPrice * quantity;
            const totalPrice = itemTotal + designCharges;
            
            // Display results
            const resultDiv = document.getElementById('result');
            const breakdownDiv = document.getElementById('priceBreakdown');
            const breakdownContent = document.getElementById('breakdownContent');
            
            resultDiv.innerHTML = `
                <h3><i class="fas fa-file-invoice-dollar"></i> Price Calculation Result</h3>
                <p><strong>Item:</strong> ${itemName}</p>
                <p><strong>Quantity:</strong> ${quantity} ${item.unit}</p>
                <p><strong>Unit Price:</strong> Rs. ${unitPrice.toFixed(2)}</p>
                <p><strong>Design Charges:</strong> Rs. ${designCharges.toFixed(2)}</p>
                <p style="font-size: 1.6em; color: var(--success); margin-top: 15px;"><strong>Total Price: Rs. ${totalPrice.toFixed(2)}</strong></p>
            `;
            
            breakdownContent.innerHTML = `
                <div class="breakdown-item">
                    <span>Item Price (${quantity} ${item.unit} Ã— Rs. ${unitPrice.toFixed(2)}):</span>
                    <span>Rs. ${itemTotal.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span>Design Charges:</span>
                    <span>Rs. ${designCharges.toFixed(2)}</span>
                </div>
                <div class="breakdown-item">
                    <span><strong>Total Amount:</strong></span>
                    <span><strong>Rs. ${totalPrice.toFixed(2)}</strong></span>
                </div>
            `;
            
            resultDiv.style.display = 'block';
            breakdownDiv.style.display = 'block';
            
            // Show selected tier if applicable
            if (selectedTier) {
                document.getElementById('priceTierTag').textContent = `Set ${selectedTier.min}-${selectedTier.max} (Rs. ${selectedTier.price}/${item.unit})`;
                document.getElementById('priceTierTagGroup').style.display = 'flex';
            }
            
            // Add to history
            addToHistory({
                type: 'calculation',
                mainCategory,
                subCategory,
                itemName,
                quantity,
                unitPrice,
                designCharges,
                totalPrice,
                timestamp: new Date().toISOString()
            });
            
            showNotification('Price calculated successfully!', 'success');
        }

        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('quantity').value = 1;
            document.getElementById('designCharges').value = 0;
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            document.getElementById('priceTierTagGroup').style.display = 'none';
        }

        // Invoice system
        function addInvoiceItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <div style="position: relative;">
                        <input type="text" class="item-name" placeholder="Enter item description" autocomplete="off" list="invoiceItemList">
                    </div>
                </td>
                <td><input type="number" class="item-rate" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-quantity" value="1" min="1" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-design-charges" value="0" min="0" step="0.01" oninput="calculateTotal()"></td>
                <td><input type="number" class="item-amount" value="0" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)"><i class="fas fa-trash"></i></button></td>
            `;
            tableBody.appendChild(newRow);
            calculateTotal();
        }

        function removeInvoiceItem(button) {
            const row = button.closest('tr');
            if (document.getElementById('itemsTableBody').children.length > 1) {
                row.remove();
                calculateTotal();
            } else {
                showNotification('Invoice must have at least one item', 'warning');
            }
        }

        function calculateTotal() {
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = (rate * quantity) + designCharges;
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const totalAmount = subtotal + taxAmount;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = (totalAmount + previousBalance) - payment;
            
            document.getElementById('subtotalAmount').textContent = subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            document.getElementById('remainingBalance').textContent = remainingBalance.toFixed(2);
        }

        function generateNextInvoiceNumber() {
            const lastInvoice = invoices.length > 0 ? 
                Math.max(...invoices.map(inv => parseInt(inv.invoiceNo.replace('INV-', '')) || 0)) : 0;
            const nextNumber = lastInvoice + 1;
            document.getElementById('invoiceNo').value = `INV-${nextNumber.toString().padStart(4, '0')}`;
        }

        function saveInvoice() {
            const customerName = document.getElementById('invoiceCustomerName').value.trim();
            const customerPhone = document.getElementById('invoiceCustomerPhone').value.trim();
            const invoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            
            if (!customerName) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            if (!invoiceDate) {
                showNotification('Please select invoice date', 'error');
                return;
            }
            
            // Collect items
            const items = [];
            const rows = document.querySelectorAll('#itemsTableBody tr');
            rows.forEach(row => {
                const itemName = row.querySelector('.item-name').value.trim();
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const designCharges = parseFloat(row.querySelector('.item-design-charges').value) || 0;
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                
                if (itemName) {
                    items.push({
                        itemName,
                        rate,
                        quantity,
                        designCharges,
                        amount
                    });
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one item to the invoice', 'error');
                return;
            }
            
            // Calculate totals
            const subtotal = parseFloat(document.getElementById('subtotalAmount').textContent) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const totalAmount = parseFloat(document.getElementById('totalAmount').textContent) || 0;
            const previousBalance = parseFloat(document.getElementById('previousBalance').value) || 0;
            const payment = parseFloat(document.getElementById('payment').value) || 0;
            const remainingBalance = parseFloat(document.getElementById('remainingBalance').textContent) || 0;
            
            // Create invoice object
            const invoice = {
                invoiceNo,
                invoiceDate,
                customerName,
                customerPhone,
                items,
                subtotal,
                taxRate,
                taxAmount,
                totalAmount,
                previousBalance,
                payment,
                remainingBalance,
                timestamp: new Date().toISOString()
            };
            
            // Add to invoices array
            invoices.push(invoice);
            
            // Update customer if exists, or create new one
            let customer = customers.find(c => c.name === customerName);
            if (customer) {
                customer.phone = customerPhone || customer.phone;
                customer.lastInvoiceDate = invoiceDate;
                customer.totalInvoices = (customer.totalInvoices || 0) + 1;
                customer.totalAmount = (customer.totalAmount || 0) + totalAmount;
                customer.balance = (customer.balance || 0) + remainingBalance;
            } else {
                customer = {
                    name: customerName,
                    phone: customerPhone,
                    firstInvoiceDate: invoiceDate,
                    lastInvoiceDate: invoiceDate,
                    totalInvoices: 1,
                    totalAmount: totalAmount,
                    balance: remainingBalance
                };
                customers.push(customer);
            }
            
            // Save data
            saveAllData(true);
            
            // Add to financial entries as income if payment > 0
            if (payment > 0) {
                const financialEntry = {
                    type: 'Income',
                    category: 'Income: Invoice Payment',
                    date: invoiceDate,
                    amount: payment,
                    description: `Payment for invoice ${invoiceNo} - ${customerName}`,
                    timestamp: new Date().toISOString()
                };
                financialEntries.push(financialEntry);
                saveAllData(true);
            }
            
            // Add to history
            addToHistory({
                type: 'invoice',
                invoiceNo,
                customerName,
                totalAmount,
                timestamp: new Date().toISOString()
            });
            
            showNotification(`Invoice ${invoiceNo} saved successfully!`, 'success');
            
            // Clear form and generate next invoice number
            clearInvoice();
            generateNextInvoiceNumber();
            
            // Update financial dashboard
            updateFinancialDashboard();
        }

        function clearInvoice() {
            document.getElementById('invoiceCustomerName').value = '';
            document.getElementById('invoiceCustomerPhone').value = '';
            document.getElementById('taxRate').value = 0;
            document.getElementById('previousBalance').value = 0;
            document.getElementById('payment').value = 0;
            
            // Keep only one row in items table
            const tableBody = document.getElementById('itemsTableBody');
            while (tableBody.children.length > 1) {
                tableBody.removeChild(tableBody.lastChild);
            }
            
            // Clear the first row
            const firstRow = tableBody.children[0];
            firstRow.querySelector('.item-name').value = '';
            firstRow.querySelector('.item-rate').value = 0;
            firstRow.querySelector('.item-quantity').value = 1;
            firstRow.querySelector('.item-design-charges').value = 0;
            firstRow.querySelector('.item-amount').value = 0;
            
            calculateTotal();
        }

        // Customer suggestions
        function showCustomerSuggestions() {
            const input = document.getElementById('invoiceCustomerName');
            const suggestionsDiv = document.getElementById('customerSuggestions');
            const value = input.value.toLowerCase();
            
            suggestionsDiv.innerHTML = '';
            
            if (value.length < 1) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const matchingCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(value)
            );
            
            if (matchingCustomers.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            matchingCustomers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-suggestion';
                div.textContent = customer.name;
                div.onclick = function() {
                    input.value = customer.name;
                    document.getElementById('invoiceCustomerPhone').value = customer.phone || '';
                    suggestionsDiv.style.display = 'none';
                };
                suggestionsDiv.appendChild(div);
            });
            
            suggestionsDiv.style.display = 'block';
        }

        function showItemSuggestions(input) {
            // This would show suggestions based on existing items in priceData
            // For simplicity, we're not implementing the full suggestion dropdown here
        }

        // Financial Hub functions
        function switchFinancialTab(tabElement, tabId) {
            // Hide all tab contents
            document.querySelectorAll('#FinancialHub .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('#FinancialHub .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
            
            // Update specific tab content if needed
            if (tabId === 'dashboard') {
                updateFinancialDashboard();
            } else if (tabId === 'managePayables') {
                updatePayablesList();
            }
        }

        function updateDashboardMonth() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('dashboardMonth').textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        }

        function updateFinancialDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Filter entries for current month
            const monthEntries = financialEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
            });
            
            // Calculate totals
            const income = monthEntries
                .filter(entry => entry.type === 'Income')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const expenses = monthEntries
                .filter(entry => entry.type === 'Expense' || entry.type === 'Payment')
                .reduce((sum, entry) => sum + entry.amount, 0);
                
            const profit = income - expenses;
            
            // Update dashboard
            const dashboardContainer = document.getElementById('financialDashboardContainer');
            dashboardContainer.innerHTML = `
                <div class="dashboard-metric metric-income">
                    <span>Total Income</span>
                    <span class="metric-value">Rs. ${income.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-expense">
                    <span>Total Expenses</span>
                    <span class="metric-value">Rs. ${expenses.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-profit">
                    <span>Net Profit</span>
                    <span class="metric-value">Rs. ${profit.toFixed(2)}</span>
                </div>
                <div class="dashboard-metric metric-net">
                    <span>Monthly Balance</span>
                    <span class="metric-value">Rs. ${profit.toFixed(2)}</span>
                </div>
            `;
        }

        function togglePaymentPayable() {
            const entryType = document.getElementById('entryType').value;
            const paymentPayableGroup = document.getElementById('paymentPayableGroup');
            
            if (entryType === 'Payment') {
                paymentPayableGroup.style.display = 'flex';
                updatePaymentPayableSelect();
            } else {
                paymentPayableGroup.style.display = 'none';
            }
        }

        function updatePaymentPayableSelect() {
            const select = document.getElementById('paymentPayableSelect');
            select.innerHTML = '';
            
            payables.forEach(payable => {
                if (payable.remaining > 0) {
                    const option = document.createElement('option');
                    option.value = payable.id;
                    option.textContent = `${payable.name} - Rs. ${payable.remaining.toFixed(2)}`;
                    select.appendChild(option);
                }
            });
        }

        function saveFinancialEntry() {
            const entryType = document.getElementById('entryType').value;
            const category = document.getElementById('entryCategory').value;
            const date = document.getElementById('entryDate').value;
            const amount = parseFloat(document.getElementById('entryAmount').value) || 0;
            const description = document.getElementById('entryDescription').value.trim();
            
            if (!date) {
                showNotification('Please select a date', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!description) {
                showNotification('Please enter a description', 'error');
                return;
            }
            
            const entry = {
                type: entryType,
                category,
                date,
                amount,
                description,
                timestamp: new Date().toISOString()
            };
            
            // If it's a payment for a payable, update the payable
            if (entryType === 'Payment') {
                const payableSelect = document.getElementById('paymentPayableSelect');
                const payableId = payableSelect.value;
                
                if (payableId) {
                    const payable = payables.find(p => p.id === payableId);
                    if (payable) {
                        payable.paid = (payable.paid || 0) + amount;
                        payable.remaining = payable.amount - payable.paid;
                        
                        if (payable.remaining <= 0) {
                            payable.status = 'Paid';
                        }
                        
                        entry.payableId = payableId;
                        entry.payableName = payable.name;
                    }
                }
            }
            
            financialEntries.push(entry);
            saveAllData(true);
            
            // Clear form
            document.getElementById('entryAmount').value = 0;
            document.getElementById('entryDescription').value = '';
            
            // Update dashboard
            updateFinancialDashboard();
            
            showNotification('Financial entry saved successfully!', 'success');
        }

        function addPayable() {
            const name = document.getElementById('payableName').value.trim();
            const amount = parseFloat(document.getElementById('payableAmount').value) || 0;
            const dueDate = document.getElementById('payableDueDate').value;
            
            if (!name) {
                showNotification('Please enter a name for the payable', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }
            
            if (!dueDate) {
                showNotification('Please select a due date', 'error');
                return;
            }
            
            const payable = {
                id: 'payable_' + Date.now(),
                name,
                amount,
                paid: 0,
                remaining: amount,
                dueDate,
                status: 'Pending',
                timestamp: new Date().toISOString()
            };
            
            payables.push(payable);
            saveAllData(true);
            
            // Clear form
            document.getElementById('payableName').value = '';
            document.getElementById('payableAmount').value = 0;
            document.getElementById('payableDueDate').valueAsDate = new Date();
            
            // Update list
            updatePayablesList();
            
            showNotification('Payable added successfully!', 'success');
        }

        function updatePayablesList() {
            const payablesList = document.getElementById('payablesList');
            payablesList.innerHTML = '';
            
            if (payables.length === 0) {
                payablesList.innerHTML = '<p>No payables found.</p>';
                return;
            }
            
            payables.forEach(payable => {
                const payableDiv = document.createElement('div');
                payableDiv.className = 'history-item';
                payableDiv.innerHTML = `
                    <div class="history-header">
                        <span>${payable.name}</span>
                        <span>Rs. ${payable.amount.toFixed(2)}</span>
                    </div>
                    <div class="history-details">
                        <div>Due: ${new Date(payable.dueDate).toLocaleDateString()}</div>
                        <div>Paid: Rs. ${payable.paid.toFixed(2)} | Remaining: Rs. ${payable.remaining.toFixed(2)}</div>
                        <div>Status: <strong>${payable.status}</strong></div>
                    </div>
                `;
                payablesList.appendChild(payableDiv);
            });
        }

        // History management
        function addToHistory(entry) {
            calculationHistory.unshift(entry);
            
            // Keep only last 50 entries
            if (calculationHistory.length > 50) {
                calculationHistory = calculationHistory.slice(0, 50);
            }
            
            saveAllData();
            updateHistory();
        }

        function updateHistory() {
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.innerHTML = '';
            
            if (calculationHistory.length === 0) {
                historyContainer.innerHTML = '<p>No recent calculations or invoices.</p>';
                return;
            }
            
            calculationHistory.slice(0, 10).forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                if (entry.type === 'calculation') {
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <span><i class="fas fa-calculator"></i> Price Calculation</span>
                            <span>Rs. ${entry.totalPrice.toFixed(2)}</span>
                        </div>
                        <div class="history-details">
                            <div>${entry.itemName} (${entry.quantity} ${priceData[entry.mainCategory]?.[entry.subCategory]?.[entry.itemName]?.unit || 'units'})</div>
                            <div>${new Date(entry.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                } else if (entry.type === 'invoice') {
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <span><i class="fas fa-file-invoice"></i> Invoice ${entry.invoiceNo}</span>
                            <span>Rs. ${entry.totalAmount.toFixed(2)}</span>
                        </div>
                        <div class="history-details">
                            <div>${entry.customerName}</div>
                            <div>${new Date(entry.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                historyContainer.appendChild(historyItem);
            });
        }

        // Admin panel functions
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            // In a real application, this would be a secure server-side check
            // For demo purposes, we're using a simple hardcoded password
            if (password === 'admin123') {
                isAdmin = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                
                // Load admin data
                updateItemsList();
                updateCustomersList();
                updateInvoicesList();
                updateFinancialEntriesList();
                
                showNotification('Admin login successful!', 'success');
            } else {
                showNotification('Invalid admin password', 'error');
            }
        }

        function switchTab(tabElement, tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabId).classList.add('active');
            tabElement.classList.add('active');
        }

        function addTier() {
            const tiersContainer = document.getElementById('newItemTiers');
            const tierRow = document.createElement('div');
            tierRow.className = 'tier-row';
            tierRow.innerHTML = `
                <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
            `;
            tiersContainer.appendChild(tierRow);
        }

        function removeTier(button) {
            const tierRow = button.closest('.tier-row');
            if (document.getElementById('newItemTiers').children.length > 1) {
                tierRow.remove();
            } else {
                showNotification('Item must have at least one price tier', 'warning');
            }
        }

        function addNewItem() {
            const mainCategory = document.getElementById('newMainCategory').value.trim();
            const subCategory = document.getElementById('newSubCategory').value.trim();
            const itemName = document.getElementById('newItemName').value.trim();
            const unit = document.getElementById('newItemUnit').value.trim();
            const basePrice = parseFloat(document.getElementById('newItemBasePrice').value) || 0;
            
            if (!mainCategory || !subCategory || !itemName || !unit) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            if (basePrice <= 0) {
                showNotification('Please enter a valid base price', 'error');
                return;
            }
            
            // Collect tiers
            const tiers = [];
            const tierRows = document.querySelectorAll('#newItemTiers .tier-row');
            tierRows.forEach(row => {
                const min = parseInt(row.querySelector('.tier-min').value) || 0;
                const max = parseInt(row.querySelector('.tier-max').value) || 0;
                const price = parseFloat(row.querySelector('.tier-price').value) || 0;
                
                if (min > 0 && max > 0 && price > 0) {
                    tiers.push({ min, max, price });
                }
            });
            
            if (tiers.length === 0) {
                showNotification('Please add at least one valid price tier', 'error');
                return;
            }
            
            // Create category structure if it doesn't exist
            if (!priceData[mainCategory]) {
                priceData[mainCategory] = {};
            }
            
            if (!priceData[mainCategory][subCategory]) {
                priceData[mainCategory][subCategory] = {};
            }
            
            // Add item
            priceData[mainCategory][subCategory][itemName] = {
                unit,
                basePrice,
                tiers
            };
            
            // Save data
            saveAllData(true);
            
            // Clear form
            document.getElementById('newMainCategory').value = '';
            document.getElementById('newSubCategory').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemBasePrice').value = 0;
            
            // Reset tiers
            document.getElementById('newItemTiers').innerHTML = `
                <div class="tier-row">
                    <input type="number" class="tier-min" placeholder="Min Qty" min="1">
                    <input type="number" class="tier-max" placeholder="Max Qty" min="1">
                    <input type="number" class="tier-price" placeholder="Price" min="0" step="0.01">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeTier(this)"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            // Update categories in calculator
            populateCategories();
            
            // Update items list in admin panel
            updateItemsList();
            
            showNotification('Item added successfully!', 'success');
        }

        function updateItemsList() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';
            
            for (const mainCategory in priceData) {
                for (const subCategory in priceData[mainCategory]) {
                    for (const itemName in priceData[mainCategory][subCategory]) {
                        const item = priceData[mainCategory][subCategory][itemName];
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'history-item';
                        itemDiv.innerHTML = `
                            <div class="history-header">
                                <span>${itemName}</span>
                                <span>${mainCategory} > ${subCategory}</span>
                            </div>
                            <div class="history-details">
                                <div>Unit: ${item.unit} | Base Price: Rs. ${item.basePrice.toFixed(2)}</div>
                                <div>Tiers: ${item.tiers.map(tier => `${tier.min}-${tier.max} (Rs. ${tier.price})`).join(', ')}</div>
                            </div>
                            <div class="actions" style="margin-top: 10px;">
                                <button class="btn btn-warning btn-sm" onclick="editItem('${mainCategory}', '${subCategory}', '${itemName}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteItem('${mainCategory}', '${subCategory}', '${itemName}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        itemsList.appendChild(itemDiv);
                    }
                }
            }
        }

        function editItem(mainCategory, subCategory, itemName) {
            // This would open an edit form for the item
            // For simplicity, we're just showing a notification
            showNotification(`Edit functionality for ${itemName} would open here`, 'info');
        }

        function deleteItem(mainCategory, subCategory, itemName) {
            if (confirm(`Are you sure you want to delete "${itemName}"?`)) {
                delete priceData[mainCategory][subCategory][itemName];
                
                // If subcategory is empty, remove it
                if (Object.keys(priceData[mainCategory][subCategory]).length === 0) {
                    delete priceData[mainCategory][subCategory];
                }
                
                // If main category is empty, remove it
                if (Object.keys(priceData[mainCategory]).length === 0) {
                    delete priceData[mainCategory];
                }
                
                saveAllData(true);
                populateCategories();
                updateItemsList();
                
                showNotification('Item deleted successfully!', 'success');
            }
        }

        function addNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            
            if (!name) {
                showNotification('Please enter customer name', 'error');
                return;
            }
            
            // Check if customer already exists
            if (customers.some(c => c.name === name)) {
                showNotification('Customer with this name already exists', 'error');
                return;
            }
            
            const customer = {
                name,
                phone,
                address,
                firstInvoiceDate: null,
                lastInvoiceDate: null,
                totalInvoices: 0,
                totalAmount: 0,
                balance: 0,
                timestamp: new Date().toISOString()
            };
            
            customers.push(customer);
            saveAllData(true);
            
            // Clear form
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerAddress').value = '';
            
            // Update customers list
            updateCustomersList();
            
            showNotification('Customer added successfully!', 'success');
        }

        function updateCustomersList() {
            const customersList = document.getElementById('customersList');
            customersList.innerHTML = '';
            
            if (customers.length === 0) {
                customersList.innerHTML = '<p>No customers found.</p>';
                return;
            }
            
            customers.forEach(customer => {
                const customerDiv = document.createElement('div');
                customerDiv.className = 'history-item';
                customerDiv.innerHTML = `
                    <div class="history-header">
                        <span>${customer.name}</span>
                        <span>${customer.phone || 'No phone'}</span>
                    </div>
                    <div class="history-details">
                        <div>${customer.address || 'No address'}</div>
                        <div>Invoices: ${customer.totalInvoices} | Total: Rs. ${customer.totalAmount.toFixed(2)} | Balance: Rs. ${customer.balance.toFixed(2)}</div>
                    </div>
                `;
                customersList.appendChild(customerDiv);
            });
        }

        function updateInvoicesList() {
            const invoicesList = document.getElementById('invoicesList');
            invoicesList.innerHTML = '';
            
            if (invoices.length === 0) {
                invoicesList.innerHTML = '<p>No invoices found.</p>';
                return;
            }
            
            invoices.slice().reverse().forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.className = 'history-item';
                invoiceDiv.innerHTML = `
                    <div class="history-header">
                        <span>${invoice.invoiceNo} - ${invoice.customerName}</span>
                        <span>Rs. ${invoice.totalAmount.toFixed(2)}</span>
                    </div>
                    <div class="history-details">
                        <div>Date: ${new Date(invoice.invoiceDate).toLocaleDateString()}</div>
                        <div>Items: ${invoice.items.length} | Balance: Rs. ${invoice.remainingBalance.toFixed(2)}</div>
                    </div>
                `;
                invoicesList.appendChild(invoiceDiv);
            });
        }

        function updateFinancialEntriesList() {
            const financialEntriesList = document.getElementById('financialEntriesList');
            financialEntriesList.innerHTML = '';
            
            if (financialEntries.length === 0) {
                financialEntriesList.innerHTML = '<p>No financial entries found.</p>';
                return;
            }
            
            financialEntries.slice().reverse().forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'history-item';
                const amountClass = entry.type === 'Income' ? 'metric-income' : 'metric-expense';
                entryDiv.innerHTML = `
                    <div class="history-header">
                        <span>${entry.type} - ${entry.category.split(':')[1]}</span>
                        <span class="${amountClass}">Rs. ${entry.amount.toFixed(2)}</span>
                    </div>
                    <div class="history-details">
                        <div>${entry.description}</div>
                        <div>Date: ${new Date(entry.date).toLocaleDateString()}</div>
                    </div>
                `;
                financialEntriesList.appendChild(entryDiv);
            });
        }

        // Import/Export functions
        function exportData(type) {
            let data, filename;
            
            switch(type) {
                case 'items':
                    data = priceData;
                    filename = 'arham-printers-items.json';
                    break;
                case 'customers':
                    data = customers;
                    filename = 'arham-printers-customers.json';
                    break;
                case 'invoices':
                    data = invoices;
                    filename = 'arham-printers-invoices.json';
                    break;
                case 'financial':
                    data = financialEntries;
                    filename = 'arham-printers-financial.json';
                    break;
                default:
                    return;
            }
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            showNotification(`${type} exported successfully!`, 'success');
        }

        function exportAllData() {
            const allData = {
                priceData,
                customers,
                invoices,
                financialEntries,
                payables,
                calculationHistory,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `arham-printers-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('All data exported successfully!', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Determine what type of data was imported
                    if (importedData.priceData) {
                        // Full backup
                        priceData = importedData.priceData || priceData;
                        customers = importedData.customers || customers;
                        invoices = importedData.invoices || invoices;
                        financialEntries = importedData.financialEntries || financialEntries;
                        payables = importedData.payables || payables;
                        calculationHistory = importedData.calculationHistory || calculationHistory;
                    } else if (importedData[0] && importedData[0].name) {
                        // Customers array
                        customers = importedData;
                    } else if (importedData[0] && importedData[0].invoiceNo) {
                        // Invoices array
                        invoices = importedData;
                    } else if (importedData[0] && importedData[0].type) {
                        // Financial entries array
                        financialEntries = importedData;
                    } else {
                        // Assume it's items data
                        priceData = importedData;
                    }
                    
                    saveAllData(true);
                    populateCategories();
                    
                    if (isAdmin) {
                        updateItemsList();
                        updateCustomersList();
                        updateInvoicesList();
                        updateFinancialEntriesList();
                    }
                    
                    showNotification('Data imported successfully!', 'success');
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Error importing data:', error);
                    showNotification('Error importing data. Please check the file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function createBackup() {
            exportAllData();
        }

        function restoreBackup() {
            document.getElementById('importFile').click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone!')) {
                localStorage.clear();
                priceData = {};
                customers = [];
                invoices = [];
                financialEntries = [];
                payables = [];
                calculationHistory = [];
                
                initializeDefaultPriceData();
                
                if (isAdmin) {
                    updateItemsList();
                    updateCustomersList();
                    updateInvoicesList();
                    updateFinancialEntriesList();
                }
                
                updateFinancialDashboard();
                updatePayablesList();
                updateHistory();
                generateNextInvoiceNumber();
                
                showNotification('All data cleared successfully!', 'success');
            }
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Close notification when clicked
        document.getElementById('notification').addEventListener('click', function() {
            this.classList.remove('show');
        });
    </script>
</body>
</html>
