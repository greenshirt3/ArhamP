<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Stock & Ream Price Utility</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Style for the sidebar buttons */
        .config-button {
            transition-duration: 150ms;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            border-radius: 0.5rem;
            color: #d1d5db; /* gray-300 */
            border: 1px solid #374151; /* gray-700 */
            margin-bottom: 0.5rem;
        }
        .config-button:hover {
            background-color: rgba(29, 78, 216, 0.5); /* blue-800/50 */
        }
        .config-button.active {
            background-color: #1d4ed8; /* blue-700 */
            border-color: #60a5fa; /* blue-400 */
            font-weight: 600;
        }
        .config-button.active:hover {
            background-color: rgba(29, 78, 216, 0.8);
        }

        /* Input styling */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Custom scrollbar styling for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #2a61e8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #161b22;
        }
        .tab-button {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition-duration: 150ms;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        .tab-button.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .tab-button:not(.active) {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        .tab-button:not(.active):hover {
            background-color: #4b5563; /* gray-600 */
        }
        .notification-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background-color: #107c10; /* success */
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-6xl">
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-white">Paper Stock & Ream Price Utility</h1>
            <p class="text-gray-400 text-sm mt-1">Local calculation and storage utility.</p>
        </div>
        
        <div class="flex space-x-2 mb-6 justify-center">
            <button id="tabCalculator" class="tab-button active" onclick="switchTab('calculator')">Calculator</button>
            <button id="tabPaperDatabase" class="tab-button" onclick="switchTab('paperDatabase')">Paper Database</button>
            <a href="index.html" class="tab-button bg-red-600 hover:bg-red-700 text-white">Back to Admin</a>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <div class="lg:col-span-1 bg-gray-900 p-5 rounded-xl shadow-lg h-full">
                <h2 class="text-xl font-bold text-blue-400 mb-4 border-b border-gray-700 pb-2">Saved Configurations</h2>
                <button 
                    onclick="clearFormAndStartNew()" 
                    class="w-full bg-green-600 text-white p-3 rounded-lg mb-4 hover:bg-green-700 transition font-bold"
                >
                    + New Configuration
                </button>
                <div id="configsList" class="max-h-96 overflow-y-auto pr-2">
                    <p class="text-gray-500 italic text-center">No configs found or loading...</p>
                </div>

                <button 
                    onclick="toggleJsonImporter()" 
                    class="w-full bg-purple-600 text-white p-3 rounded-lg mt-4 hover:bg-purple-700 transition font-bold"
                >
                    Batch JSON Importer
                </button>
                <button 
                    onclick="clearLocalStorage()" 
                    class="w-full bg-red-700 text-white p-3 rounded-lg mt-2 hover:bg-red-800 transition font-bold text-sm"
                >
                    Clear All Local Data
                </button>
            </div>

            <div class="lg:col-span-3 bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-blue-700/50">

                <div id="calculatorTab" class="tab-content">
                    <div id="jsonImporter" class="hidden mb-8 p-6 bg-purple-900/40 rounded-lg border border-purple-600">
                        <h2 class="text-xl font-bold text-purple-300 mb-3">Batch Importer Instructions</h2>
                        <p class="text-sm text-gray-300 mb-4">Paste your paper data here in **JSON Array** format. It will be processed and saved to LocalStorage.</p>
                        
                        <pre class="bg-gray-700 p-3 rounded-lg text-xs text-green-400 overflow-auto mb-3 border border-purple-400/50">
[
    {
        "name": "A4 from 23x36 - 80GSM",
        "largeSheetPrice": 25,
        "smallParts": 8,
        "largeReamQty": 500,
        "smallReamQty": 500
    },
    ...
]
                        </pre>
                        <textarea 
                            id="jsonInput" 
                            rows="10" 
                            placeholder="Paste your JSON data here..." 
                            class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 transition shadow-md"
                        ></textarea>
                        <button 
                            onclick="importJsonData()" 
                            class="w-full bg-purple-600 text-white p-3 rounded-lg mt-3 hover:bg-purple-700 transition font-bold"
                        >
                            Process and Save All Items to LocalStorage
                        </button>
                    </div>
                    <div class="mb-6 p-4 bg-gray-700 rounded-lg flex flex-col sm:flex-row gap-3 items-center">
                        <div class="flex-grow">
                            <label for="configName" class="block text-xs font-medium text-gray-300 uppercase">Configuration Name / Item ID</label>
                            <input
                                type="text"
                                id="configName"
                                placeholder="e.g., A4 from 23x36 - 80GSM"
                                oninput="calculatePrices()"
                                class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 transition shadow-md text-lg font-semibold"
                            >
                        </div>
                        <button 
                            onclick="saveConfig()" 
                            class="w-full sm:w-auto flex-shrink-0 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-bold"
                        >
                            Save Current Config
                        </button>
                        <button 
                            onclick="deleteCurrentConfig()" 
                            class="w-full sm:w-auto flex-shrink-0 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition font-bold"
                        >
                            Delete Config
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-gray-900 p-5 rounded-lg shadow-inner">
                            <h2 class="text-xl font-bold text-blue-400 mb-4 border-b border-gray-700 pb-2">Source Data (Large Sheet)</h2>

                            <div class="mb-4">
                                <label for="largeSheetPrice" class="block text-sm font-medium text-gray-300 mb-1">Price of 1 Large Sheet (Currency Symbol)</label>
                                <input
                                    type="number"
                                    id="largeSheetPrice"
                                    value="25"
                                    min="0.01"
                                    step="0.01"
                                    oninput="calculatePrices()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition shadow-md"
                                >
                            </div>

                            <div class="mb-4">
                                <label for="smallParts" class="block text-sm font-medium text-gray-300 mb-1">
                                    Small Sheets that fit in 1 Large Sheet (Factor)
                                </label>
                                <input
                                    type="number"
                                    id="smallParts"
                                    value="8"
                                    min="1"
                                    step="1"
                                    oninput="calculatePrices()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition shadow-md"
                                >
                            </div>

                            <div class="mb-4">
                                <label for="largeReamQty" class="block text-sm font-medium text-gray-300 mb-1">Sheets in 1 Large Ream (Quantity)</label>
                                <input
                                    type="number"
                                    id="largeReamQty"
                                    value="500"
                                    min="1"
                                    step="1"
                                    oninput="calculatePrices()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition shadow-md"
                                >
                            </div>

                            <div>
                                <label for="smallReamQty" class="block text-sm font-medium text-gray-300 mb-1">Sheets in 1 Small Ream (Quantity)</label>
                                <input
                                    type="number"
                                    id="smallReamQty"
                                    value="500"
                                    min="1"
                                    step="1"
                                    oninput="calculatePrices()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition shadow-md"
                                >
                            </div>
                        </div>

                        <div class="bg-blue-900/40 p-5 rounded-lg border border-blue-600 shadow-xl flex flex-col justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-blue-200 mb-4 border-b border-blue-600 pb-2">Calculated Results</h2>

                                <div class="mb-6 p-4 bg-blue-900 rounded-lg">
                                    <p class="text-sm font-medium text-blue-300 uppercase">Price per 1 Small Sheet</p>
                                    <p id="unitPriceDisplay" class="text-4xl font-extrabold text-green-400 mt-1">$0.000</p>
                                </div>

                                <div class="mb-6 p-4 bg-blue-900 rounded-lg">
                                    <p class="text-sm font-medium text-blue-300 uppercase">Price per 1 Small Ream</p>
                                    <p id="reamPriceDisplay" class="text-4xl font-extrabold text-yellow-400 mt-1">$0.00</p>
                                </div>
                            </div>

                            <div class="mt-4 p-4 bg-blue-900 rounded-lg border-l-4 border-pink-500">
                                <p class="text-sm font-medium text-pink-300">Small Reams Yielded from 1 Large Ream:</p>
                                <p id="reamYieldDisplay" class="text-3xl font-extrabold text-pink-400 mt-1">0 Reams</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="paperDatabaseTab" class="tab-content hidden">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-blue-400 mb-4">Paper Database</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Search Papers</label>
                                <input
                                    type="text"
                                    id="paperSearch"
                                    placeholder="Search by name, code, or GSM..."
                                    oninput="filterPapers()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Filter by Type</label>
                                <select
                                    id="paperTypeFilter"
                                    onchange="filterPapers()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition"
                                >
                                    <option value="">All Types</option>
                                    <option value="CARD">Card Stock</option>
                                    <option value="PAPER">Paper</option>
                                    <option value="CRYSTAL">Crystal/Glossy</option>
                                    <option value="TRACING">Tracing</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Sort By</label>
                                <select
                                    id="paperSort"
                                    onchange="filterPapers()"
                                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 transition"
                                >
                                    <option value="name">Name</option>
                                    <option value="gsm">GSM</option>
                                    <option value="price">Price</option>
                                    <option value="code">Code</option>
                                </select>
                            </div>
                        </div>

                        <div id="paperList" class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 italic text-center">Loading paper database...</p>
                        </div>

                        <div class="mt-6 p-4 bg-green-900/40 rounded-lg border border-green-600">
                            <h3 class="text-lg font-bold text-green-300 mb-3">Quick Import</h3>
                            <p class="text-sm text-gray-300 mb-3">Select papers to import directly into your local configurations:</p>
                            <div class="flex space-x-3">
                                <button 
                                    onclick="importSelectedPapers()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium"
                                >
                                    Import Selected
                                </button>
                                <button 
                                    onclick="selectAllPapers()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
                                >
                                    Select All
                                </button>
                                <button 
                                    onclick="deselectAllPapers()" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition font-medium"
                                >
                                    Deselect All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="mt-8 p-4 bg-gray-700 rounded-lg text-sm text-gray-300 w-full max-w-4xl mx-auto">
            <h3 class="font-bold text-white mb-1">Formulas Used:</h3>
            <ul class="list-disc list-inside space-y-1">
                <li><strong class="text-blue-300">Unit Price:</strong> (Large Sheet Price) / (Small Sheets per Large Sheet)</li>
                <li><strong class="text-blue-300">Small Ream Price:</strong> Unit Price $\times$ (Sheets in Small Ream)</li>
                <li><strong class="text-blue-300">Ream Yield:</strong> [(Sheets in Large Ream) $\times$ (Small Sheets per Large Sheet)] / (Sheets in Small Ream)</li>
            </ul>
        </div>
        
    </div>

    <script>
        // LocalStorage Key
        const LOCAL_CONFIG_KEY = 'arhamPrintersPaperConfigs';

        // PAPER DATABASE - Fixed data (as provided in the original file)
        const paperDatabase = [
            { code: "9K", name: "CREAM KOHLER LINEN 265GSM", type: "CARD", gsm: 265, size: "22 X 30", price: 66, unit: "sheet" },
            { code: "7A", name: "CAPRI WHITE 235GSM", type: "CARD", gsm: 235, size: "22 X 28", price: 56, unit: "sheet" },
            { code: "9A+", name: "LINEN EMBOSSED 285GSM", type: "CARD", gsm: 285, size: "22 X 28", price: 76, unit: "sheet" },
            { code: "12D", name: "EGGSHELL EMBOSSED DRY 235GSM", type: "CARD", gsm: 235, size: "22 X 28", price: 60, unit: "sheet" },
            { code: "12L", name: "MATRESS CREAM 280GSM", type: "CARD", gsm: 280, size: "22 X 30", price: 66, unit: "sheet" },
            { code: "17L", name: "CHAMOIS CREAM CHECK 300GSM", type: "CARD", gsm: 300, size: "22 X 28", price: 81, unit: "sheet" },
            { code: "19A", name: "IVORY WHITE IK 150GSM", type: "CARD", gsm: 150, size: "22 X 28", price: 27, unit: "sheet" },
            { code: "21Q", name: "GLOSSY ART CARD 350GSM", type: "CARD", gsm: 350, size: "23 X 36", price: 70, unit: "sheet" },
            { code: "25F", name: "BIANCO WHITE 285GSM", type: "CARD", gsm: 285, size: "22 X 28", price: 76, unit: "sheet" },
            { code: "35G", name: "JET BLACK VELVET 350GSM", type: "CARD", gsm: 350, size: "21.5 X 31", price: 155, unit: "sheet" },
            { code: "84", name: "TRACING CARD 150GSM", type: "CARD", gsm: 150, size: "25 X 36", price: 180, unit: "sheet" },
            { code: "7F", name: "LAID CREAM 90GSM", type: "PAPER", gsm: 90, size: "18 X 25", price: 555, unit: "packet", packetSheets: 25 },
            { code: "20H+", name: "SNOWHITE CHECK 120GSM", type: "PAPER", gsm: 120, size: "21 X 27", price: 830, unit: "packet", packetSheets: 25 },
            { code: "45A", name: "CRINCLE WHITE 120GSM", type: "PAPER", gsm: 120, size: "20.5 X 28", price: 680, unit: "packet", packetSheets: 25 },
            { code: "49L", name: "PLAIN CREAM 75GSM", type: "PAPER", gsm: 75, size: "20 X 30", price: 350, unit: "packet", packetSheets: 25 },
            { code: "133", name: "GOLD CRYSTAL 120GSM", type: "CRYSTAL", gsm: 120, size: "28 X 39", price: 165, unit: "sheet" },
            { code: "158D", name: "ROSE GOLD CRYSTAL 125GSM", type: "CRYSTAL", gsm: 125, size: "28 X 40", price: 71, unit: "sheet" },
            { code: "786", name: "TRACING PAPER 100GSM", type: "TRACING", gsm: 100, size: "10 X 36", price: 43, unit: "sheet" },
            { code: "787", name: "TRACING PAPER 90GSM", type: "TRACING", gsm: 90, size: "18 X 25", price: 1255, unit: "packet", packetSheets: 25 }
        ];

        // Utility: Generic notification bar
        function showNotification(message, type = 'success') {
            const container = document.createElement('div');
            container.className = `notification-bar bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-600`;
            container.textContent = message;
            document.body.appendChild(container);
            
            setTimeout(() => {
                container.remove();
            }, 3000);
        }

        // --- Core Calculator Logic ---

        window.calculatePrices = function() {
            const largeSheetPrice = parseFloat(document.getElementById('largeSheetPrice').value) || 0;
            const smallParts = parseFloat(document.getElementById('smallParts').value) || 1; 
            const largeReamQty = parseFloat(document.getElementById('largeReamQty').value) || 1;
            const smallReamQty = parseFloat(document.getElementById('smallReamQty').value) || 1;

            const calculated = performCalculation({ largeSheetPrice, smallParts, largeReamQty, smallReamQty });

            document.getElementById('unitPriceDisplay').textContent = `$${calculated.unitPrice.toFixed(3)}`; 
            document.getElementById('reamPriceDisplay').textContent = `$${calculated.reamPrice.toFixed(2)}`; 
            document.getElementById('reamYieldDisplay').textContent = `${calculated.reamYield.toFixed(2)} Reams`;
        }

        function performCalculation(data) {
            const largeSheetPrice = data.largeSheetPrice || 0;
            const smallParts = data.smallParts || 1; 
            const largeReamQty = data.largeReamQty || 1;
            const smallReamQty = data.smallReamQty || 1;

            let unitPrice = 0;
            if (smallParts > 0) {
                unitPrice = largeSheetPrice / smallParts;
            }

            const reamPrice = unitPrice * smallReamQty;
            
            let reamYield = 0;
            if (smallReamQty > 0) {
                const totalSmallSheets = largeReamQty * smallParts;
                reamYield = totalSmallSheets / smallReamQty;
            }

            return { unitPrice, reamPrice, reamYield };
        }

        // --- LocalStorage Logic ---
        
        function loadConfigs() {
            const stored = localStorage.getItem(LOCAL_CONFIG_KEY);
            let configs = stored ? JSON.parse(stored) : {};
            
            const configsListElement = document.getElementById('configsList');
            configsListElement.innerHTML = '';
            let firstConfig = null;
            let activeConfigId = document.querySelector('.config-button.active')?.id.replace('btn-', '') || null;

            if (Object.keys(configs).length === 0) {
                configsListElement.innerHTML = '<p class="text-gray-500 italic text-center p-4">No saved configurations.</p>';
                // Clear form on empty load
                clearFormAndStartNew(); 
                return;
            }
            
            Object.values(configs).sort((a, b) => a.name.localeCompare(b.name)).forEach(data => {
                if (!firstConfig) firstConfig = data;

                const button = document.createElement('button');
                button.id = `btn-${data.id}`;
                button.className = 'config-button';
                
                if (data.id === activeConfigId) {
                    button.classList.add('active');
                }
                
                const unitPrice = data.unitPrice !== undefined ? data.unitPrice.toFixed(3) : 'N/A';
                const reamPrice = data.reamPrice !== undefined ? data.reamPrice.toFixed(2) : 'N/A';
                
                button.innerHTML = `
                    <div class="font-semibold text-white">${data.name}</div>
                    <div class="text-xs text-green-400">Unit: $${unitPrice}</div>
                    <div class="text-xs text-yellow-400">Ream: $${reamPrice}</div>
                `;
                button.onclick = () => loadSelectedConfig(data);
                configsListElement.appendChild(button);
            });

            // Load first config if none is active
            if (!activeConfigId && firstConfig) {
                loadSelectedConfig(firstConfig);
            }
        }

        window.saveConfig = function() {
            const configName = document.getElementById('configName').value.trim();
            if (!configName) {
                showNotification("Missing Name. Please enter a Configuration Name.", 'error');
                return;
            }

            const configId = configName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            
            const inputData = {
                name: configName,
                largeSheetPrice: parseFloat(document.getElementById('largeSheetPrice').value) || 0,
                smallParts: parseFloat(document.getElementById('smallParts').value) || 1,
                largeReamQty: parseFloat(document.getElementById('largeReamQty').value) || 1,
                smallReamQty: parseFloat(document.getElementById('smallReamQty').value) || 1,
            };

            const calculated = performCalculation(inputData);
            
            const dataToSave = {
                id: configId,
                ...inputData,
                unitPrice: calculated.unitPrice,
                reamPrice: calculated.reamPrice,
                reamYield: calculated.reamYield,
                timestamp: new Date().toISOString()
            };

            // Save to LocalStorage
            const stored = localStorage.getItem(LOCAL_CONFIG_KEY);
            let configs = stored ? JSON.parse(stored) : {};
            
            configs[configId] = dataToSave;
            localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configs));
            
            showNotification(`Configuration "${configName}" saved successfully.`, 'success');
            loadConfigs(); // Reload sidebar
        }
        
        window.deleteCurrentConfig = function() {
            const configName = document.getElementById('configName').value.trim();
            if (!configName) {
                showNotification("No configuration loaded to delete.", 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete the configuration "${configName}"?`)) {
                return;
            }
            
            const configId = configName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const stored = localStorage.getItem(LOCAL_CONFIG_KEY);
            let configs = stored ? JSON.parse(stored) : {};

            if (configs[configId]) {
                delete configs[configId];
                localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configs));
                showNotification(`Configuration "${configName}" deleted.`, 'info');
                clearFormAndStartNew();
                loadConfigs();
            } else {
                showNotification(`Configuration "${configName}" not found.`, 'error');
            }
        }

        window.loadSelectedConfig = function(configData) {
            document.getElementById('configName').value = configData.name || '';
            document.getElementById('largeSheetPrice').value = configData.largeSheetPrice !== undefined ? configData.largeSheetPrice : '0';
            document.getElementById('smallParts').value = configData.smallParts !== undefined ? configData.smallParts : '1';
            document.getElementById('largeReamQty').value = configData.largeReamQty !== undefined ? configData.largeReamQty : '500';
            document.getElementById('smallReamQty').value = configData.smallReamQty !== undefined ? configData.smallReamQty : '500';
            
            calculatePrices();
            
            document.querySelectorAll('.config-button').forEach(btn => btn.classList.remove('active'));
            const configId = configData.id;
            const button = document.getElementById(`btn-${configId}`);
            if (button) {
                button.classList.add('active');
            }
        }
        
        window.clearFormAndStartNew = function() {
            document.getElementById('configName').value = '';
            document.getElementById('largeSheetPrice').value = '0';
            document.getElementById('smallParts').value = '8';
            document.getElementById('largeReamQty').value = '500';
            document.getElementById('smallReamQty').value = '500';
            
            document.querySelectorAll('.config-button').forEach(btn => btn.classList.remove('active'));
            calculatePrices();
            showNotification('New configuration started.', 'info');
        }
        
        window.clearLocalStorage = function() {
             if (confirm('WARNING: This will permanently delete ALL saved paper configurations in this utility. Are you sure?')) {
                localStorage.removeItem(LOCAL_CONFIG_KEY);
                loadConfigs();
                showNotification('All local data cleared.', 'info');
            }
        }


        // --- Paper Database Tab Logic ---

        window.switchTab = function(tabName) {
            document.getElementById('tabCalculator').classList.toggle('active', tabName === 'calculator');
            document.getElementById('tabPaperDatabase').classList.toggle('active', tabName === 'paperDatabase');
            
            document.getElementById('calculatorTab').classList.toggle('hidden', tabName !== 'calculator');
            document.getElementById('paperDatabaseTab').classList.toggle('hidden', tabName !== 'paperDatabase');
            
            if (tabName === 'paperDatabase') {
                filterPapers(); // Initial display/filter
            }
        }

        window.displayPaperDatabase = function() {
            const paperList = document.getElementById('paperList');
            const filteredPapers = filterPapers(true); 
            
            if (filteredPapers.length === 0) {
                paperList.innerHTML = '<p class="text-gray-500 italic text-center">No papers found matching your criteria.</p>';
                return;
            }
            
            let html = '<div class="grid gap-2">';
            
            filteredPapers.forEach(paper => {
                const priceDisplay = paper.unit === 'packet' ? 
                    `₹${paper.price}/- per ${paper.packetSheets || 25} sheets` : 
                    `₹${paper.price}/- per sheet`;
                
                html += `
                    <div class="paper-item bg-gray-800 p-3 rounded-lg border border-gray-700 hover:border-blue-500 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" class="paper-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" data-code="${paper.code}">
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <span class="font-bold text-blue-300">${paper.code}</span>
                                        <span class="text-white font-medium">${paper.name}</span>
                                    </div>
                                    <div class="text-sm text-gray-400">
                                        ${paper.size} • ${paper.gsm} GSM • ${paper.type} • ${priceDisplay}
                                    </div>
                                </div>
                            </div>
                            <button 
                                onclick="quickLoadPaper('${paper.code}')" 
                                class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition text-sm"
                            >
                                Quick Load
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            paperList.innerHTML = html;
        }

        window.filterPapers = function(returnArray = false) {
            const searchTerm = document.getElementById('paperSearch')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('paperTypeFilter')?.value || '';
            const sortBy = document.getElementById('paperSort')?.value || 'name';
            
            let filtered = paperDatabase.filter(paper => {
                const matchesSearch = !searchTerm || 
                    paper.name.toLowerCase().includes(searchTerm) ||
                    paper.code.toLowerCase().includes(searchTerm) ||
                    paper.gsm.toString().includes(searchTerm);
                
                const matchesType = !typeFilter || paper.type === typeFilter;
                
                return matchesSearch && matchesType;
            });
            
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'gsm': return a.gsm - b.gsm;
                    case 'price': return a.price - b.price;
                    case 'code': return a.code.localeCompare(b.code);
                    default: return 0;
                }
            });
            
            if (returnArray) {
                 return filtered;
            }
            
            displayPaperDatabase();
        }

        window.quickLoadPaper = function(code) {
            const paper = paperDatabase.find(p => p.code === code);
            if (!paper) return;
            
            switchTab('calculator');
            clearFormAndStartNew();
            
            document.getElementById('configName').value = `${paper.code} - ${paper.name} (${paper.gsm}GSM)`;
            
            // For papers sold in packets, calculate the per-sheet price to use as the base for the 'Large Sheet Price' input.
            let sheetPrice = paper.price;
            if (paper.unit === 'packet') {
                sheetPrice = paper.price / (paper.packetSheets || 25);
            }
            
            document.getElementById('largeSheetPrice').value = sheetPrice.toFixed(3);
            
            // Recalculate
            calculatePrices();
            
            showNotification(`Paper ${paper.code} loaded into calculator.`, 'success');
        }

        window.selectAllPapers = function() {
            document.querySelectorAll('#paperList .paper-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        window.deselectAllPapers = function() {
            document.querySelectorAll('#paperList .paper-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        window.importSelectedPapers = function() {
            const selectedCheckboxes = document.querySelectorAll('#paperList .paper-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification("No papers selected to import.", 'error');
                return;
            }

            const stored = localStorage.getItem(LOCAL_CONFIG_KEY);
            let configs = stored ? JSON.parse(stored) : {};
            let importedCount = 0;
            
            selectedCheckboxes.forEach(checkbox => {
                const paperCode = checkbox.dataset.code;
                const paper = paperDatabase.find(p => p.code === paperCode);
                
                if (paper) {
                    const configName = `${paper.code} - ${paper.name} (${paper.gsm}GSM)`;
                    const configId = configName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    
                    if (!configs[configId]) {
                        let sheetPrice = paper.price;
                        if (paper.unit === 'packet') {
                            sheetPrice = paper.price / (paper.packetSheets || 25);
                        }
                        
                        const dataToSave = {
                            name: configName,
                            largeSheetPrice: sheetPrice,
                            smallParts: 8, // Default A4 conversion factor
                            largeReamQty: 500,
                            smallReamQty: 500,
                            paperData: paper,
                            timestamp: new Date().toISOString()
                        };
                        
                        const calculated = performCalculation(dataToSave);
                        dataToSave.unitPrice = calculated.unitPrice;
                        dataToSave.reamPrice = calculated.reamPrice;
                        dataToSave.reamYield = calculated.reamYield;

                        configs[configId] = dataToSave;
                        importedCount++;
                    }
                }
            });
            
            if (importedCount > 0) {
                localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configs));
                showNotification(`Successfully imported ${importedCount} paper configurations!`, 'success');
                loadConfigs();
            } else {
                showNotification('All selected papers already exist in your configurations.', 'info');
            }
        }
        
        window.toggleJsonImporter = function() {
            document.getElementById('jsonImporter').classList.toggle('hidden');
        }
        
        window.importJsonData = function() {
            const jsonString = document.getElementById('jsonInput').value.trim();
            if (!jsonString) {
                showNotification("Empty Input. Paste JSON data first.", 'error');
                return;
            }

            let dataArray;
            try {
                dataArray = JSON.parse(jsonString);
                if (!Array.isArray(dataArray)) {
                    throw new Error("JSON is not a valid array.");
                }
            } catch (e) {
                showNotification(`JSON Error: Failed to parse data. Error: ${e.message}`, 'error');
                return;
            }
            
            const stored = localStorage.getItem(LOCAL_CONFIG_KEY);
            let configs = stored ? JSON.parse(stored) : {};
            let successCount = 0;
            
            dataArray.forEach(item => {
                 if (!item.name || item.largeSheetPrice === undefined || item.smallParts === undefined) {
                    return; 
                 }
                 
                const configName = String(item.name).trim();
                const configId = configName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                
                const dataToSave = {
                    name: configName,
                    largeSheetPrice: parseFloat(item.largeSheetPrice) || 0,
                    smallParts: parseFloat(item.smallParts) || 1,
                    largeReamQty: parseFloat(item.largeReamQty) || 1,
                    smallReamQty: parseFloat(item.smallReamQty) || 1,
                    timestamp: new Date().toISOString()
                };

                const calculated = performCalculation(dataToSave);
                dataToSave.unitPrice = calculated.unitPrice;
                dataToSave.reamPrice = calculated.reamPrice;
                dataToSave.reamYield = calculated.reamYield;

                configs[configId] = dataToSave;
                successCount++;
            });

            localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configs));
            showNotification(`Successfully saved ${successCount} items to LocalStorage!`, 'success');
            document.getElementById('jsonInput').value = '';
            toggleJsonImporter();
            loadConfigs();
        }

        // Initialize the application on window load
        window.onload = function() {
            loadConfigs();
            calculatePrices(); // Perform initial calculation on default values
        };
    </script>
</body>
</html>