<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arham Printers - Price Calculator</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§®</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c3e50; --secondary: #0078d4; --success: #107c10; --warning: #ffb900; 
            --dark: #323130; --light: #f8f9fa; --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1); --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e3e9f7 100%); min-height: 100vh; padding: 20px; color: var(--dark); }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e1e5e9; }
        h1 { color: var(--primary); font-size: 2.2rem; background: linear-gradient(135deg, #2c3e50, #0078d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .calculator-section { padding: 25px; background: var(--light); border-radius: var(--border-radius); border: 1px solid #e1e5e9; }
        .section-title { font-size: 1.3rem; margin-bottom: 20px; border-bottom: 3px solid var(--secondary); display: flex; align-items: center; gap: 10px; padding-bottom: 10px; }
        .form-group { display: flex; flex-wrap: wrap; margin-bottom: 20px; align-items: center; gap: 15px; }
        .form-group label { flex: 1; padding: 8px; font-weight: 600; min-width: 150px; }
        .form-group select, .form-group input { flex: 2; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 1rem; background: white; transition: var(--transition); }
        .form-group select:focus, .form-group input:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.2); }
        .actions { display: flex; flex-wrap: wrap; gap: 12px; margin: 25px 0; }
        .btn { padding: 12px 24px; cursor: pointer; border-radius: 6px; font-weight: 600; transition: var(--transition); border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .result { margin-top: 20px; font-weight: bold; font-size: 1.3em; padding: 20px; background: linear-gradient(135deg, #dff6dd, #e8f5e8); border-radius: var(--border-radius); border-left: 6px solid var(--success); display: none; }
        .price-breakdown { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); border: 1px solid #dee2e6; display: none; }
        .breakdown-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .breakdown-item:last-child { border-bottom: none; font-weight: bold; font-size: 1.1em; color: var(--success); }
        .hidden-fields { display: none; background: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin: 12px 0; border: 1px solid #e1e5e9; }
        .sync-info { background: #e8f4fd; padding: 15px; border-radius: var(--border-radius); margin: 15px 0; text-align: center; border-left: 4px solid var(--secondary); }
        .update-notification { background: var(--success); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9em; margin-top: 5px; display: inline-block; }
        @media (max-width: 768px) { .form-group { flex-direction: column; align-items: stretch; } .actions { flex-direction: column; } .btn { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> Arham Printers Calculator</h1>
            <p class="subtitle">Instant Printing Price Calculator</p>
        </header>

        <div class="sync-info">
            <p><i class="fas fa-sync-alt"></i> <strong>Live Prices:</strong> Always updated with latest pricing</p>
            <div class="loading" id="loadingStatus">Loading latest prices...</div>
            <div id="updateNotification" style="display: none;"></div>
        </div>

        <div class="calculator-section">
            <h2 class="section-title"><i class="fas fa-edit"></i> Calculate Printing Price</h2>
            
            <div class="form-group">
                <label for="mainCategory"><i class="fas fa-folder"></i> Main Category:</label>
                <select id="mainCategory">
                    <option value="">Select Main Category</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="subCategory"><i class="fas fa-folder-open"></i> Subcategory:</label>
                <select id="subCategory"></select>
            </div>
            
            <div class="form-group">
                <label for="itemName"><i class="fas fa-cube"></i> Item Name:</label>
                <select id="itemName"></select>
            </div>
            
            <div class="hidden-fields" id="offsetFields">
                <div class="form-group">
                    <label for="size"><i class="fas fa-expand"></i> Size:</label>
                    <select id="size"></select>
                </div>
                
                <div class="form-group">
                    <label for="color"><i class="fas fa-palette"></i> Color:</label>
                    <select id="color"></select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quantity"><i class="fas fa-boxes"></i> Quantity:</label>
                <input type="number" id="quantity" value="1" min="1">
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="calculatePrice()">
                    <i class="fas fa-calculator"></i> Calculate Price
                </button>
                <button class="btn btn-secondary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Quote
                </button>
                <button class="btn btn-success" onclick="clearForm()">
                    <i class="fas fa-trash"></i> Clear Form
                </button>
            </div>
            
            <div class="result" id="result"></div>
            <div class="price-breakdown" id="priceBreakdown">
                <h4><i class="fas fa-receipt"></i> Price Breakdown</h4>
                <div id="breakdownContent"></div>
            </div>
        </div>

        <div class="contact-info" style="display:none;">
            </div>
    </div>

    <script>
        // --- 1. CORE DATA STRUCTURES ---
        let data = {
            categories: [], items: [], sizes: {}, colors: {},
            settings: { rent: 200, profitMargin: 25, defaultBinding: 40 },
            lastUpdated: null 
        };

        let lastUpdateTime = null;

        const defaultData = {
            categories: [{ mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards" }],
            items: [{ mainCategory: "Offset Paper Printing", subcategory: "Visiting Cards", itemName: "Shine", price: 1800, type: "fixed", designCharges: 0, paperCost: 0, bindingCost: 0, colorCost: 0 }],
            sizes: { "A4": 1250 }, colors: { "4 Colors": 2800 },
            settings: { rent: 200, profitMargin: 25, defaultBinding: 40 },
            lastUpdated: new Date().toISOString()
        };

        // --- 2. DATA LOADING AND SYNCHRONIZATION ---

        async function loadFromDataFile() {
            try {
                // IMPORTANT: Change this URL to the raw link of your customer-data.json file if hosted externally (e.g., GitHub).
                const dataUrl = 'customer-data.json?t=' + new Date().getTime(); 
                const response = await fetch(dataUrl);
                
                if (response.ok) {
                    const latestData = await response.json();
                    
                    // Check if this is a new update
                    if (lastUpdateTime && latestData.lastUpdated !== lastUpdateTime) {
                        showUpdateNotification();
                    }
                    data = latestData;
                    lastUpdateTime = data.lastUpdated;
                    
                    document.getElementById('loadingStatus').innerHTML = '<i class="fas fa-check-circle"></i> Live prices loaded';
                    return true;
                }
            } catch (error) {
                console.log('Data file load failed:', error);
            }
            return false;
        }

        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            notification.innerHTML = `<span class="update-notification"><i class="fas fa-bell"></i> Prices updated! (${new Date(data.lastUpdated).toLocaleTimeString()})</span>`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function loadDefaultData() {
            data = defaultData;
            refreshAllDisplays();
            document.getElementById('loadingStatus').innerHTML = '<i class="fas fa-info-circle"></i> Using default prices (Failed to sync)';
        }

        async function initializeApp() {
            document.getElementById('loadingStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Loading latest prices...';
            
            let dataLoaded = await loadFromDataFile();
            
            if (!dataLoaded) {
                loadDefaultData();
            }
            
            setupEventListeners();
            refreshAllDisplays();

            // Setup auto-refresh
            setInterval(async () => {
                const success = await loadFromDataFile();
                if (success) {
                    refreshAllDisplays();
                    console.log('Prices updated from external file');
                }
            }, 120000); // 2 minutes
        }

        // --- 3. UI DISPLAY AND EVENT HANDLERS ---

        function setupEventListeners() {
            document.getElementById('mainCategory').addEventListener('change', updateSubcategories);
            document.getElementById('subCategory').addEventListener('change', updateItemsAndFields);
            document.getElementById('itemName').addEventListener('change', () => {
                // Clear result when item changes
                document.getElementById('result').style.display = 'none';
                document.getElementById('priceBreakdown').style.display = 'none';
            });
        }

        function refreshAllDisplays() {
            updateMainCategories();
            updateSubcategories();
            updateItemsAndFields();
            updateSizesDropdown();
            updateColorsDropdown();
        }

        function updateMainCategories() {
            const mainSelect = document.getElementById('mainCategory');
            const currentValue = mainSelect.value;
            mainSelect.innerHTML = '<option value="">Select Main Category</option>';
            
            const mainCategories = [...new Set(data.categories.map(cat => cat.mainCategory))];
            mainCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                mainSelect.appendChild(option);
            });
            mainSelect.value = currentValue; // Try to retain current selection
        }

        function updateSubcategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subSelect = document.getElementById('subCategory');
            const currentValue = subSelect.value;
            subSelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            if (mainCategory) {
                const subcategories = [...new Set(
                    data.categories
                        .filter(cat => cat.mainCategory === mainCategory)
                        .map(cat => cat.subcategory)
                )];
                
                subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subSelect.appendChild(option);
                });
            }
            subSelect.value = currentValue; // Try to retain current selection
            updateItemsAndFields();
        }

        function updateItemsAndFields() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemName');
            const currentValue = itemSelect.value;
            itemSelect.innerHTML = '<option value="">Select Item</option>';
            
            let currentItemType = '';

            if (mainCategory && subcategory) {
                const items = data.items.filter(
                    item => item.mainCategory === mainCategory && item.subcategory === subcategory
                );
                
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemName;
                    option.textContent = item.itemName;
                    itemSelect.appendChild(option);
                    
                    if (item.itemName === currentValue) {
                         currentItemType = item.type;
                    }
                });
            }

            // Determine if hidden fields should be shown
            const offsetFields = document.getElementById('offsetFields');
            const isOffsetType = data.items.some(
                item => item.mainCategory === mainCategory && 
                        item.subcategory === subcategory &&
                        item.type === 'offset'
            );
            
            if (isOffsetType) {
                offsetFields.style.display = 'block';
            } else {
                offsetFields.style.display = 'none';
            }
            itemSelect.value = currentValue; // Try to retain current selection
        }

        function updateSizesDropdown() {
            const sizeSelect = document.getElementById('size');
            sizeSelect.innerHTML = '<option value="">Select Size</option>';
            for (let size in data.sizes) {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            }
        }

        function updateColorsDropdown() {
            const colorSelect = document.getElementById('color');
            colorSelect.innerHTML = '<option value="">Select Color</option>';
            for (let color in data.colors) {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                colorSelect.appendChild(option);
            }
        }

        // --- 4. CALCULATION LOGIC ---

        function calculatePrice() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subcategory = document.getElementById('subCategory').value;
            const itemName = document.getElementById('itemName').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!mainCategory || !subcategory || !itemName) {
                alert("Please select all Category and Item fields.");
                return;
            }
            
            const item = data.items.find(i => 
                i.mainCategory === mainCategory && 
                i.subcategory === subcategory && 
                i.itemName === itemName
            );
            
            if (!item) return;

            let baseCost = 0;
            let breakdown = [];
            
            // --- Determine Base Cost ---
            if (item.type === "fixed") {
                baseCost = item.price;
                breakdown.push(['Fixed Item Price', item.price]);
            } else if (item.type === "offset") {
                const size = document.getElementById('size').value;
                const color = document.getElementById('color').value;
                
                if (!size || !color) {
                    alert("Please select a Size and Color for this Offset Printing item.");
                    return;
                }
                
                // Get costs, using item-specific values as overrides if available (though usually 0 in the list)
                const paperCost = data.sizes[size] || item.paperCost || 0;
                const bindingCost = item.bindingCost || data.settings.defaultBinding || 0;
                const colorCost = data.colors[color] || item.colorCost || 0;
                const rent = data.settings.rent || 0;
                
                baseCost = paperCost + bindingCost + colorCost + rent;
                
                breakdown.push(['Paper Cost', paperCost]);
                if (bindingCost > 0) breakdown.push(['Binding Cost', bindingCost]);
                breakdown.push(['Color Cost', colorCost]);
                breakdown.push(['Rent/Overhead', rent]);
                breakdown.push(['Total Base Cost (per unit)', baseCost]);
            }

            // --- Add Design Charges ---
            if (item.designCharges > 0) {
                baseCost += item.designCharges;
                breakdown.push(['Design Charges', item.designCharges]);
            }
            
            // --- Final Calculation ---
            const subtotal = baseCost * quantity;
            const profit = subtotal * (data.settings.profitMargin / 100);
            const total = subtotal + profit;
            
            // --- Render Results ---
            
            const totalDisplay = `Total Price: Rs. ${Math.round(total).toLocaleString()}`;
            document.getElementById('result').textContent = totalDisplay;
            document.getElementById('result').style.display = 'block';
            
            let breakdownHTML = breakdown.map(([label, value]) => 
                `<div class="breakdown-item"><span>${label}:</span><span>Rs. ${Math.round(value).toLocaleString()}</span></div>`
            ).join('');

            breakdownHTML += `<hr style="margin: 10px 0;">`;
            breakdownHTML += `<div class="breakdown-item"><span>Quantity:</span><span>${quantity.toLocaleString()}</span></div>`;
            breakdownHTML += `<div class="breakdown-item"><span>Subtotal:</span><span>Rs. ${Math.round(subtotal).toLocaleString()}</span></div>`;
            breakdownHTML += `<div class="breakdown-item"><span>Profit (${data.settings.profitMargin}%):</span><span>Rs. ${Math.round(profit).toLocaleString()}</span></div>`;
            breakdownHTML += `<div class="breakdown-item" style="font-size: 1.2em;"><span>FINAL TOTAL:</span><span>Rs. ${Math.round(total).toLocaleString()}</span></div>`;

            document.getElementById('breakdownContent').innerHTML = breakdownHTML;
            document.getElementById('priceBreakdown').style.display = 'block';
        }

        function clearForm() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').innerHTML = '<option value="">Select Subcategory</option>';
            document.getElementById('itemName').innerHTML = '<option value="">Select Item</option>';
            document.getElementById('size').value = '';
            document.getElementById('color').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('result').style.display = 'none';
            document.getElementById('priceBreakdown').style.display = 'none';
            document.getElementById('offsetFields').style.display = 'none';
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
